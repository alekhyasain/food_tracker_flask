<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Food Diary - Volume Based Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        
        /* Tab styling */
        .add-tab-btn, .log-tab-btn {
            transition: all 0.2s ease;
        }
        
        .add-tab-btn:hover, .log-tab-btn:hover {
            border-color: #fb923c !important;
            color: #ea580c !important;
        }
        
        /* Responsive tab navigation */
        @media (max-width: 640px) {
            .add-tab-btn, .log-tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }
        }
        
        /* Modal content animations */
        .add-tab-content, .log-tab-content {
            animation: fadeInTab 0.3s ease-in-out;
        }
        
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced button styling */
        .unified-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .unified-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üçõ Indian Food Diary</h1>
            <p class="text-lg text-gray-600">Volume-Based Tracking - Cups, Tablespoons & More!</p>
            
            <!-- Date Navigation -->
            <div class="bg-white rounded-lg shadow-lg p-4 mt-4 mb-4">
                <div class="flex items-center justify-center space-x-4 mb-3">
                    <button onclick="navigateDate(-1)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition duration-200">
                        ‚Üê Previous Day
                    </button>
                    <div class="text-center">
                        <input type="date" id="dateSelector" class="text-lg font-semibold text-gray-800 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="selectDate()">
                        <div id="selectedDateDisplay" class="text-sm text-gray-600 mt-1"></div>
                    </div>
                    <button onclick="navigateDate(1)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition duration-200">
                        Next Day ‚Üí
                    </button>
                </div>
                <div class="flex justify-center space-x-2">
                    <button onclick="goToToday()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                        Today
                    </button>
                    <button onclick="goToYesterday()" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm transition duration-200">
                        Yesterday
                    </button>
                </div>
            </div>
            
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded">
                <p class="font-semibold">üìè Easy Volume Measurements</p>
                <p>Track with simple measurements like "1 cup rice" or "2 tbsp oil" - no weighing required!</p>
            </div>
            <!-- Simplified Main Action Buttons -->
            <div class="mt-6 space-y-4">
                <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-2xl mx-auto">
                    <button onclick="openUnifiedAddModal()" class="unified-btn flex-1 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-8 py-4 rounded-xl">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ûï</div>
                            <div class="font-semibold text-lg">Add Meal or Ingredient</div>
                            <div class="text-sm opacity-90">Create meals, manage ingredients, or add recipes</div>
                        </div>
                    </button>
                    <button onclick="openUnifiedLogModal()" class="unified-btn flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-8 py-4 rounded-xl">
                        <div class="text-center">
                            <div class="text-2xl mb-1">üìù</div>
                            <div class="font-semibold text-lg">Log Today's Meals</div>
                            <div class="text-sm opacity-90">View daily summary and export data</div>
                        </div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 text-center">Everything you need in just two buttons - simplified and organized!</p>
            </div>
        </div>

        <!-- Simplified Interface - Content moved to modals -->

        <!-- Daily Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="dailySummaryTitle">üìä Daily Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600" id="totalCalories">0</div>
                    <div class="text-sm text-gray-600">Total Calories</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="mealCount">0</div>
                    <div class="text-sm text-gray-600">Meals Logged</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="totalProtein">0g</div>
                    <div class="text-sm text-gray-600">Protein</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="totalFiber">0g</div>
                    <div class="text-sm text-gray-600">Fiber</div>
                </div>
            </div>
        </div>

        <!-- Food Log -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã Your Food Log</h2>
            <div id="foodLog" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <p>No meals logged yet. Try adding a dish above!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Builder Modal -->
    <div id="recipeModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Create New Recipe</h3>
                <button onclick="closeRecipeBuilder()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recipe Details -->
                <div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Name:</label>
                            <input type="text" id="recipeName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., My Special Dal">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                                <select id="recipeCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="dal">Dal</option>
                                    <option value="sabji">Sabji</option>
                                    <option value="sambar">Sambar</option>
                                    <option value="rice">Rice Dish</option>
                                    <option value="bread">Bread</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Servings:</label>
                                <input type="number" id="recipeServings" value="4" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Ingredient Builder -->
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Add Ingredients:</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-3 gap-2">
                                <select id="recipeIngredientSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select ingredient...</option>
                                </select>
                                <select id="recipeMeasurementSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                                    <option value="">Select ingredient first...</option>
                                </select>
                                <input type="number" id="recipeQuantity" placeholder="Qty" value="1" min="0.25" step="0.25" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="addRecipeIngredient()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Recipe Actions -->
                    <div class="mt-6 space-y-3">
                        <button onclick="saveRecipe()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Recipe
                        </button>
                        <button onclick="addRecipeToLog()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save & Add to Today's Log
                        </button>
                    </div>
                </div>

                <!-- Recipe Preview -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Recipe Preview:</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div id="recipePreview" class="space-y-2">
                            <p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Ingredient Management Modal -->
    <div id="ingredientModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Ingredient Management</h3>
                <button onclick="closeIngredientModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Add New Ingredient Form -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Add New Ingredient</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ingredient Name:</label>
                            <input type="text" id="ingredientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Bitter Gourd">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                            <select id="ingredientCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select category...</option>
                                <option value="grains">Grains</option>
                                <option value="dals_legumes">Dals & Legumes</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="spices_seasonings">Spices & Seasonings</option>
                                <option value="oils_fats">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h5 class="font-semibold text-gray-800 mb-3">Nutritional Information</h5>
                            <div id="measurementInputs" class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                    </div>
                                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                                </div>
                            </div>
                            
                            <button onclick="addMeasurementInput()" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                + Add Another Measurement
                            </button>
                        </div>
                        
                        <div class="space-y-3 pt-4">
                            <button onclick="saveIngredient()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Save Ingredient
                            </button>
                            <button onclick="clearIngredientForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Clear Form
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Existing Ingredients List -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Existing Ingredients</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category:</label>
                            <select id="filterCategory" onchange="filterIngredients()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">All Categories</option>
                                <option value="grains">Grains</option>
                                <option value="dals_legumes">Dals & Legumes</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="spices_seasonings">Spices & Seasonings</option>
                                <option value="oils_fats">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div id="ingredientsList" class="max-h-96 overflow-y-auto space-y-2">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Meal Builder Modal -->
        <div id="mealModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-gray-800">üçΩÔ∏è Create Meal from Ingredients</h3>
                    <button onclick="closeMealBuilder()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Meal Details & Ingredient Selection -->
                    <div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Meal Name:</label>
                                <input type="text" id="mealName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., My Custom Lunch">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Servings:</label>
                                    <input type="number" id="mealServings" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Servings to Log:</label>
                                    <input type="number" id="mealServingsToLog" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                            </div>
                        </div>
    
                        <!-- Ingredient Selection -->
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Add Ingredients:</h4>
                            <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-3 mb-4 rounded">
                                <p class="text-sm"><strong>Simple workflow:</strong> Type ingredient names like "Egg", "Rice", "Oil" in the search box below, set quantity, then click "Add" - no dropdown selection required!</p>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Ingredients:</label>
                                    <div class="relative">
                                        <input type="text" id="mealIngredientSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Type ingredient name (e.g., rice, oil, onion)..." oninput="filterMealIngredients()">
                                        <div id="mealIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                            <!-- Dropdown options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2" id="mealIngredientInputs" style="display: none;">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Selected Ingredient:</label>
                                        <input type="text" id="selectedMealIngredient" class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-gray-100" readonly>
                                    </div>
                                    <select id="mealMeasurementSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">Select measurement...</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <input type="number" id="mealQuantity" placeholder="Qty" value="1" min="0.25" step="0.25" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <button onclick="addMealIngredient()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Meal Actions -->
                        <div class="mt-6 space-y-3">
                            <button onclick="addMealToLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Add Meal to Today's Log
                            </button>
                            <button onclick="clearMealBuilder()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Clear All
                            </button>
                        </div>
                    </div>
    
                    <!-- Meal Preview -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Meal Preview:</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div id="mealPreview" class="space-y-2">
                                <p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Excel Export Modal -->
            <div id="exportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-800">üìä Export to Excel</h3>
                        <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Export Options -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Export Options</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Range:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="all" checked class="mr-2">
                                            <span>All available data</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="month" class="mr-2">
                                            <span>Current month only</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="custom" class="mr-2">
                                            <span>Custom date range</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Custom Date Range -->
                                <div id="customDateRange" class="hidden">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date:</label>
                                            <input type="date" id="exportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date:</label>
                                            <input type="date" id="exportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Filename -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filename (optional):</label>
                                    <input type="text" id="exportFilename" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Food_Diary_Export.xlsx">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty for auto-generated filename</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Preview -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Export Preview</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div id="exportPreview" class="space-y-2">
                                    <p class="text-gray-600">Select export options to see preview...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Actions -->
                        <div class="flex space-x-3">
                            <button onclick="startExport()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" id="exportButton">
                                üìä Export to Excel
                            </button>
                            <button onclick="closeExportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                Cancel
                            </button>
                        </div>
                        
                        <!-- Export Progress -->
                        <div id="exportProgress" class="hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                                    <div>
                                        <p class="font-semibold text-blue-800">Generating Excel file...</p>
                                        <p class="text-sm text-blue-600" id="exportProgressText">Preparing data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            </div>
        </div>
    </div>

    <!-- Unified Add Modal -->
    <div id="unifiedAddModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">‚ûï Add Meal or Ingredient</h3>
                <button onclick="closeUnifiedAddModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchAddTab('quickDishes')" id="quickDishesTab" class="add-tab-btn py-2 px-1 border-b-2 border-orange-500 text-orange-600 whitespace-nowrap font-medium text-sm">
                        üçΩÔ∏è Quick Add Dishes
                    </button>
                    <button onclick="switchAddTab('addIngredient')" id="addIngredientTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ü•¨ Add Ingredient
                    </button>
                    <button onclick="switchAddTab('customEntry')" id="customEntryTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ‚úèÔ∏è Custom Entry
                    </button>
                    <button onclick="switchAddTab('recipeBuilder')" id="recipeBuilderTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üë®‚Äçüç≥ Create Recipe
                    </button>
                    <button onclick="switchAddTab('mealBuilder')" id="mealBuilderTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üçΩÔ∏è Create Meal
                    </button>
                    <button onclick="switchAddTab('manageIngredients')" id="manageIngredientsTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ü•¨ Manage Ingredients
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="addTabContent">
                <!-- Quick Dishes Tab -->
                <div id="quickDishesContent" class="add-tab-content">
                    <div class="space-y-3" id="quickDishesInModal">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Add Ingredient Tab -->
                <div id="addIngredientContent" class="add-tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded">
                            <p class="font-semibold">ü•¨ Enhanced Ingredient Addition</p>
                            <p class="text-sm">Select from real ingredient database with proper measurements and accurate nutrition data!</p>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Ingredient Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search Ingredient:</label>
                                <div class="relative">
                                    <input type="text" id="enhancedIngredientSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Type ingredient name (e.g., Rice, Egg, Onion)..." oninput="filterEnhancedIngredients()">
                                    <div id="enhancedIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                        <!-- Dropdown options will be populated here -->
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Search from our ingredient database for accurate nutrition data</p>
                            </div>
                            
                            <!-- Selected Ingredient Display -->
                            <div id="selectedIngredientSection" class="hidden">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-800">Selected:</span>
                                        <button onclick="clearEnhancedIngredientSelection()" class="text-red-500 hover:text-red-700 text-sm">Clear</button>
                                    </div>
                                    <div id="selectedIngredientName" class="text-lg font-semibold text-green-700"></div>
                                </div>
                            </div>
                            
                            <!-- Measurement Selection -->
                            <div id="measurementSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Measurement:</label>
                                <select id="enhancedMeasurementSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">Choose measurement...</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select the appropriate measurement for this ingredient</p>
                            </div>
                            
                            <!-- Quantity Input -->
                            <div id="quantitySection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity:</label>
                                <input type="number" id="enhancedIngredientQuantity" value="1" min="0.25" step="0.25" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="1">
                                <p class="text-xs text-gray-500 mt-1">How many of the selected measurement?</p>
                            </div>
                            
                            <!-- Nutrition Preview -->
                            <div id="nutritionPreview" class="hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-800 mb-2">üìä Nutrition Preview:</h4>
                                    <div id="nutritionDetails" class="grid grid-cols-2 gap-2 text-sm text-blue-700">
                                        <!-- Will be populated with nutrition info -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add Button -->
                            <div id="addButtonSection" class="hidden pt-4">
                                <button onclick="addEnhancedIngredientToLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-lg">
                                    ‚úÖ Add to Daily Log
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="clearEnhancedIngredientForm()" class="text-gray-500 hover:text-gray-700 text-sm underline">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">üí° How it works:</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Search for ingredients from our database</li>
                                <li>‚Ä¢ Select the appropriate measurement (1 cup, 1 medium, etc.)</li>
                                <li>‚Ä¢ Enter quantity and see real nutrition data</li>
                                <li>‚Ä¢ Add with accurate calories, protein, and more!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Custom Entry Tab -->
                <div id="customEntryContent" class="add-tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dish Description:</label>
                                <input type="text" id="modalCustomDish" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g., Homemade rajma with 2 chapatis">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Servings:</label>
                                    <input type="number" id="modalCustomServings" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Calories (optional):</label>
                                    <input type="number" id="modalCustomCalories" placeholder="Auto-calc" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                            </div>
                            <button onclick="addCustomEntryFromModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Add Custom Entry
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recipe Builder Tab -->
                <div id="recipeBuilderContent" class="add-tab-content hidden">
                    <div class="text-center py-8">
                        <p class="text-gray-600 mb-4">Create reusable recipes like dal, sabji, or sambar with precise nutrition calculations.</p>
                        <button onclick="openRecipeBuilderFromModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-200">
                            Open Recipe Builder
                        </button>
                    </div>
                </div>

                <!-- Meal Builder Tab -->
                <div id="mealBuilderContent" class="add-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Meal Details & Item Selection -->
                        <div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Meal Name:</label>
                                    <input type="text" id="inlineMealName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., My Custom Lunch">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Total Servings:</label>
                                        <input type="number" id="inlineMealServings" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Servings to Log:</label>
                                        <input type="number" id="inlineMealServingsToLog" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                </div>
                            </div>
        
                            
                            <!-- Add Items Section -->
                            <div class="mt-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3">Add Items to Meal:</h4>
                                <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-3 mb-4 rounded">
                                    <p class="text-sm"><strong>Simple & Fast:</strong> Type ingredient names like "Egg", "Rice", "Oil" and click Add - no complex selection needed!</p>
                                </div>
                                
                                
                                <!-- Recipes Section -->
                                <div id="recipesItemSection" class="meal-item-section">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Recipes:</label>
                                            <div class="relative">
                                                <input type="text" id="inlineMealRecipeSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Type recipe name (e.g., dal tadka, sambar, aloo gobi)..." oninput="filterInlineMealRecipes()">
                                                <div id="inlineMealRecipeDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                                    <!-- Dropdown options will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-2" id="inlineMealRecipeInputs" style="display: none;">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Selected Recipe:</label>
                                                <input type="text" id="inlineSelectedMealRecipe" class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-gray-100" readonly>
                                            </div>
                                            <div class="flex gap-2">
                                                <input type="number" id="inlineMealRecipeServings" placeholder="Servings" value="1" min="0.25" step="0.25" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                                <button onclick="addInlineMealRecipe()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md transition duration-200">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
        
                            <!-- Meal Actions -->
                            <div class="mt-6 space-y-3">
                                <button onclick="addInlineMealToLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                    Add Meal to Today's Log
                                </button>
                                <button onclick="clearInlineMealBuilder()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                    Clear All
                                </button>
                            </div>
                        </div>
        
                        <!-- Meal Preview -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Meal Preview:</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div id="inlineMealPreview" class="space-y-2">
                                    <p class="text-gray-500">Add recipes and ingredients to see nutritional breakdown...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Ingredients Tab -->
                <div id="manageIngredientsContent" class="add-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Add New Ingredient Form -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Add New Ingredient</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ingredient Name:</label>
                                    <input type="text" id="simpleIngredientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Bitter Gourd">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                                    <select id="simpleIngredientCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">Select category...</option>
                                        <option value="grains">Grains</option>
                                        <option value="dals_legumes">Dals & Legumes</option>
                                        <option value="vegetables">Vegetables</option>
                                        <option value="fruits">Fruits</option>
                                        <option value="spices_seasonings">Spices & Seasonings</option>
                                        <option value="oils_fats">Oils & Fats</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Add Measurement</h5>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Measurement Key:</label>
                                                <input type="text" id="simpleMeasurementKey" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                                                <input type="text" id="simpleMeasurementDisplay" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-5 gap-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                                                <input type="number" id="simpleCalories" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                                                <input type="number" id="simpleProtein" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                                                <input type="number" id="simpleCarbs" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                                                <input type="number" id="simpleFat" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                                                <input type="number" id="simpleFiber" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3 pt-4">
                                    <button onclick="simpleAddIngredient()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                        Add Ingredient
                                    </button>
                                    <button onclick="simpleClearForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                        Clear Form
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Existing Ingredients List -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-semibold text-gray-800">Existing Ingredients</h4>
                                <button onclick="simpleReloadIngredients()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                    üîÑ Reload
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category:</label>
                                    <select id="simpleFilterCategory" onchange="simpleFilterIngredients()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">All Categories</option>
                                        <option value="grains">Grains</option>
                                        <option value="dals_legumes">Dals & Legumes</option>
                                        <option value="vegetables">Vegetables</option>
                                        <option value="fruits">Fruits</option>
                                        <option value="spices_seasonings">Spices & Seasonings</option>
                                        <option value="oils_fats">Oils & Fats</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div id="simpleIngredientsList" class="max-h-96 overflow-y-auto space-y-2 border border-gray-200 rounded-lg p-3">
                                    <div class="text-center text-gray-500 py-4">
                                        Click "Reload" to load ingredients
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Log Modal -->
    <div id="unifiedLogModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">üìù Log Today's Meals</h3>
                <button onclick="closeUnifiedLogModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchLogTab('todaysMeals')" id="todaysMealsTab" class="log-tab-btn py-2 px-1 border-b-2 border-orange-500 text-orange-600 whitespace-nowrap font-medium text-sm">
                        üçΩÔ∏è Today's Meals
                    </button>
                    <button onclick="switchLogTab('dailySummary')" id="dailySummaryTab" class="log-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üìä Daily Summary
                    </button>
                    <button onclick="switchLogTab('exportData')" id="exportDataTab" class="log-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üì§ Export Data
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="logTabContent">
                <!-- Today's Meals Tab -->
                <div id="todaysMealsContent" class="log-tab-content">
                    <div id="modalFoodLog" class="space-y-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Daily Summary Tab -->
                <div id="dailySummaryContent" class="log-tab-content hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="modalTotalCalories">0</div>
                            <div class="text-sm text-gray-600">Total Calories</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="modalMealCount">0</div>
                            <div class="text-sm text-gray-600">Meals Logged</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="modalTotalProtein">0g</div>
                            <div class="text-sm text-gray-600">Protein</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="modalTotalFiber">0g</div>
                            <div class="text-sm text-gray-600">Fiber</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">Detailed nutritional breakdown for <span id="modalSelectedDate"></span></p>
                    </div>
                </div>

                <!-- Export Data Tab -->
                <div id="exportDataContent" class="log-tab-content hidden">
                    <div class="text-center py-8">
                        <p class="text-gray-600 mb-4">Export your food diary data to Excel for analysis and record keeping.</p>
                        <button onclick="openExportModalFromModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition duration-200">
                            üìä Export to Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let foodDatabase = {};
        let rawIngredients = {};
        let mealsByDate = {}; // New date-based storage structure
        let selectedDate = new Date(); // Currently selected date
        let customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
        let currentRecipeIngredients = [];
        let currentMealIngredients = [];
        let selectedMealIngredient = null;
        let databaseLoadingPromise = null; // Track database loading state

        // Date management functions
        function formatDateKey(date) {
            return date.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

        function formatDateDisplay(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('en-US', options);
        }

        function initializeDateSystem() {
            // Set initial date to today
            selectedDate = new Date();
            
            // Migrate existing data if needed
            migrateExistingData();
            
            // Update UI
            updateDateDisplay();
            updateDailySummary();
            displayMeals();
        }

        function migrateExistingData() {
            // Check if old format data exists
            const oldMeals = localStorage.getItem('indianFoodMeals');
            if (oldMeals) {
                try {
                    const meals = JSON.parse(oldMeals);
                    console.log('üîÑ Migrating existing meal data to date-based format...');
                    
                    // Load existing date-based data if any
                    const existingDateData = localStorage.getItem('indianFoodMealsByDate');
                    if (existingDateData) {
                        mealsByDate = JSON.parse(existingDateData);
                    }
                    
                    // Migrate old meals to date-based structure
                    meals.forEach(meal => {
                        const mealDate = new Date(meal.timestamp);
                        const dateKey = formatDateKey(mealDate);
                        
                        if (!mealsByDate[dateKey]) {
                            mealsByDate[dateKey] = [];
                        }
                        
                        // Check if meal already exists (avoid duplicates)
                        const existingMeal = mealsByDate[dateKey].find(m => m.id === meal.id);
                        if (!existingMeal) {
                            mealsByDate[dateKey].push(meal);
                        }
                    });
                    
                    // Save migrated data
                    localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));
                    
                    // Keep old data for backup but rename it
                    localStorage.setItem('indianFoodMeals_backup', oldMeals);
                    localStorage.removeItem('indianFoodMeals');
                    
                    console.log('‚úÖ Migration completed successfully!');
                    showSuccessMessage('üìÖ Data migrated to new date-based system!');
                } catch (error) {
                    console.error('‚ùå Error during migration:', error);
                    showErrorMessage('Error migrating data: ' + error.message);
                }
            } else {
                // Load existing date-based data
                const existingDateData = localStorage.getItem('indianFoodMealsByDate');
                if (existingDateData) {
                    mealsByDate = JSON.parse(existingDateData);
                }
            }
        }

        function updateDateDisplay() {
            const dateSelector = document.getElementById('dateSelector');
            const dateDisplay = document.getElementById('selectedDateDisplay');
            const summaryTitle = document.getElementById('dailySummaryTitle');
            
            // Update date input
            dateSelector.value = formatDateKey(selectedDate);
            
            // Update display text
            const displayText = formatDateDisplay(selectedDate);
            dateDisplay.textContent = displayText;
            
            // Update summary title
            const today = new Date();
            const isToday = formatDateKey(selectedDate) === formatDateKey(today);
            const isYesterday = formatDateKey(selectedDate) === formatDateKey(new Date(today.getTime() - 24 * 60 * 60 * 1000));
            
            let titleText = 'üìä Daily Summary';
            if (isToday) {
                titleText += ' - Today';
            } else if (isYesterday) {
                titleText += ' - Yesterday';
            } else {
                titleText += ` - ${selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            
            summaryTitle.textContent = titleText;
        }

        function navigateDate(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            updateDateDisplay();
            updateDailySummary();
            displayMeals();
        }

        function selectDate() {
            const dateSelector = document.getElementById('dateSelector');
            selectedDate = new Date(dateSelector.value + 'T00:00:00');
            updateDateDisplay();
            updateDailySummary();
            displayMeals();
        }

        function goToToday() {
            selectedDate = new Date();
            updateDateDisplay();
            updateDailySummary();
            displayMeals();
        }

        function goToYesterday() {
            selectedDate = new Date();
            selectedDate.setDate(selectedDate.getDate() - 1);
            updateDateDisplay();
            updateDailySummary();
            displayMeals();
        }

        function getCurrentDateMeals() {
            const dateKey = formatDateKey(selectedDate);
            return mealsByDate[dateKey] || [];
        }

        function addMealToDate(meal) {
            const dateKey = formatDateKey(selectedDate);
            if (!mealsByDate[dateKey]) {
                mealsByDate[dateKey] = [];
            }
            
            // Add date information to meal
            meal.date = dateKey;
            meal.timestamp = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(),
                                    new Date().getHours(), new Date().getMinutes(), new Date().getSeconds()).toISOString();
            
            mealsByDate[dateKey].push(meal);
            saveMealsToStorage();
        }

        function removeMealFromDate(mealId) {
            const dateKey = formatDateKey(selectedDate);
            if (mealsByDate[dateKey]) {
                mealsByDate[dateKey] = mealsByDate[dateKey].filter(meal => meal.id !== mealId);
                if (mealsByDate[dateKey].length === 0) {
                    delete mealsByDate[dateKey];
                }
                saveMealsToStorage();
            }
        }

        function saveMealsToStorage() {
            localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));
        }

        // Enhanced database loading with robust error handling and loading indicators
        function loadDatabases() {
            // Return existing promise if already loading
            if (databaseLoadingPromise) {
                console.log('üîÑ LOADDB: Database loading already in progress, returning existing promise');
                return databaseLoadingPromise;
            }

            const timestamp = new Date().getTime();
            console.log('üîÑ LOADDB: Starting loadDatabases() with timestamp:', timestamp);
            console.log('üîÑ LOADDB: Current rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Show loading indicator
            showLoadingIndicator('Loading ingredients and recipes...');
            
            // Create a single promise that handles both API and file loading
            databaseLoadingPromise = Promise.resolve()
                .then(async () => {
                    console.log('üîÑ LOADDB: Starting ingredient loading process...');
                    updateLoadingIndicator('Loading ingredients...');
                    
                    // Try API first, then fallback to file
                    let rawData;
                    try {
                        console.log('üîÑ LOADDB: Attempting API load...');
                        const apiResponse = await fetch('/api/ingredients', {
                            timeout: 10000 // 10 second timeout
                        });
                        if (apiResponse.ok) {
                            const apiData = await apiResponse.json();
                            console.log('‚úÖ LOADDB: API load successful');
                            rawData = { basic_ingredients: apiData.basic_ingredients };
                        } else {
                            throw new Error(`API failed: ${apiResponse.status} ${apiResponse.statusText}`);
                        }
                    } catch (apiError) {
                        console.log('‚ö†Ô∏è LOADDB: API failed, trying file load:', apiError.message);
                        updateLoadingIndicator('API unavailable, loading from local files...');
                        try {
                            const fileResponse = await fetch(`rawingredients.json?v=${timestamp}`);
                            if (!fileResponse.ok) {
                                throw new Error(`File load failed: ${fileResponse.status} ${fileResponse.statusText}`);
                            }
                            rawData = await fileResponse.json();
                            console.log('‚úÖ LOADDB: File load successful');
                        } catch (fileError) {
                            console.error('‚ùå LOADDB: Both API and file loading failed');
                            hideLoadingIndicator();
                            throw new Error(`Failed to load ingredients: API error (${apiError.message}), File error (${fileError.message})`);
                        }
                    }
                    
                    // Load recipes from server API first, then fallback to file
                    console.log('üîÑ LOADDB: Loading recipes database...');
                    updateLoadingIndicator('Loading recipes...');
                    let foodData;
                    try {
                        console.log('üîÑ LOADDB: Attempting recipes API load...');
                        const recipesApiResponse = await fetch('/api/recipes', {
                            timeout: 10000 // 10 second timeout
                        });
                        if (recipesApiResponse.ok) {
                            foodData = await recipesApiResponse.json();
                            console.log('‚úÖ LOADDB: Recipes API load successful');
                        } else {
                            throw new Error(`Recipes API failed: ${recipesApiResponse.status} ${recipesApiResponse.statusText}`);
                        }
                    } catch (recipesApiError) {
                        console.log('‚ö†Ô∏è LOADDB: Recipes API failed, trying file load:', recipesApiError.message);
                        updateLoadingIndicator('Loading recipes from local files...');
                        try {
                            const foodResponse = await fetch(`recipes.json?v=${timestamp}`);
                            if (!foodResponse.ok) {
                                throw new Error(`Failed to load recipes.json: ${foodResponse.status} ${foodResponse.statusText}`);
                            }
                            foodData = await foodResponse.json();
                            console.log('‚úÖ LOADDB: Recipes file load successful');
                        } catch (fileError) {
                            console.error('‚ùå LOADDB: Both recipes API and file loading failed');
                            hideLoadingIndicator();
                            throw new Error(`Failed to load recipes: API error (${recipesApiError.message}), File error (${fileError.message})`);
                        }
                    }
                    
                    return { rawData, foodData };
                })
                .then(({ rawData, foodData }) => {
                    console.log('üéâ LOADDB: Both databases loaded, processing data...');
                    updateLoadingIndicator('Processing data...');
                    
                    // Safely assign the data
                    const newRawIngredients = rawData.basic_ingredients;
                    const newFoodDatabase = foodData;
                    
                    // Validate the data before assignment
                    if (!newRawIngredients || typeof newRawIngredients !== 'object') {
                        hideLoadingIndicator();
                        throw new Error('Invalid rawIngredients data structure');
                    }
                    
                    if (!newFoodDatabase || typeof newFoodDatabase !== 'object') {
                        hideLoadingIndicator();
                        throw new Error('Invalid foodDatabase data structure');
                    }
                    
                    // Merge server recipes with local recipes
                    console.log('üîÑ LOADDB: Merging server recipes with local recipes...');
                    updateLoadingIndicator('Merging recipes...');
                    
                    // Load local recipes from localStorage
                    const localRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
                    console.log('üì± LOADDB: Local recipes loaded:', Object.keys(localRecipes).length);
                    
                    // Update customRecipes with merged data
                    // Server recipes take precedence, but keep local-only recipes
                    customRecipes = { ...localRecipes };
                    
                    // Add server recipes to customRecipes for unified access
                    if (newFoodDatabase.dishes) {
                        Object.entries(newFoodDatabase.dishes).forEach(([key, recipe]) => {
                            // Only add server recipes that aren't already in customRecipes
                            // This allows local modifications to take precedence
                            if (!customRecipes[key]) {
                                customRecipes[key] = recipe;
                            }
                        });
                    }
                    
                    console.log('‚úÖ LOADDB: Recipe merging completed');
                    console.log('üìä LOADDB: Total recipes available:', Object.keys(customRecipes).length);
                    
                    // Atomic assignment to prevent race conditions
                    rawIngredients = newRawIngredients;
                    foodDatabase = newFoodDatabase;
                    
                    console.log('‚úÖ LOADDB: Data assigned successfully');
                    console.log('üìä LOADDB: Categories loaded:', Object.keys(rawIngredients));
                    console.log('üìä LOADDB: Total ingredients:',
                        Object.values(rawIngredients).reduce((total, category) =>
                            total + Object.keys(category).length, 0));
                    
                    // Verify critical ingredients
                    if (rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                        console.log('‚úÖ LOADDB: Lauki verified:', rawIngredients.vegetables.lauki.name);
                    } else {
                        console.warn('‚ö†Ô∏è LOADDB: Lauki not found in loaded data');
                    }
                    
                    // Initialize app components that depend on the data
                    console.log('üîÑ LOADDB: Initializing dependent components...');
                    updateLoadingIndicator('Initializing components...');
                    initializeApp();
                    
                    // Hide loading indicator on success
                    hideLoadingIndicator();
                    showSuccessMessage('‚úÖ All data loaded successfully!');
                    
                    return { rawIngredients, foodDatabase };
                })
                .catch(error => {
                    console.error('üí• LOADDB: Critical error loading databases:', error);
                    console.log('üîÑ LOADDB: Attempting fallback to embedded data...');
                    updateLoadingIndicator('Loading fallback data...');
                    
                    try {
                        initializeWithFallback();
                        console.log('‚úÖ LOADDB: Fallback initialization completed');
                        hideLoadingIndicator();
                        showErrorMessage('‚ö†Ô∏è Using offline data - some features may be limited');
                        return { rawIngredients, foodDatabase };
                    } catch (fallbackError) {
                        console.error('üí• LOADDB: Fallback also failed:', fallbackError);
                        hideLoadingIndicator();
                        showCriticalError(`Failed to load food data: ${error.message}. Please refresh the page or check your internet connection.`);
                        throw new Error(`All loading methods failed: ${error.message}`);
                    }
                })
                .finally(() => {
                    // Clear the promise when complete (success or failure)
                    console.log('üèÅ LOADDB: Database loading process completed');
                    databaseLoadingPromise = null;
                });

            return databaseLoadingPromise;
        }

        // Loading indicator functions
        function showLoadingIndicator(message) {
            // Remove existing indicator
            hideLoadingIndicator();
            
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3';
            indicator.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                <span id="loadingMessage">${message}</span>
            `;
            document.body.appendChild(indicator);
        }

        function updateLoadingIndicator(message) {
            const messageElement = document.getElementById('loadingMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showCriticalError(message) {
            // Remove any existing critical error
            const existingError = document.getElementById('criticalError');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'criticalError';
            errorDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            errorDiv.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
                    <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Critical Error</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="space-y-3">
                        <button onclick="location.reload()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üîÑ Refresh Page
                        </button>
                        <button onclick="document.getElementById('criticalError').remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Continue Anyway
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
        }

        // Initial load with comprehensive logging
        console.log('üöÄ INITIALIZATION: Starting app initialization...');
        console.log('üöÄ INITIALIZATION: Calling loadDatabases()...');
        loadDatabases();

        // Improved reload function with proper error handling
        function reloadIngredients() {
            console.log('üîÑ RELOAD: Manual reload requested...');
            console.log('üîÑ RELOAD: Current state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
            
            showSuccessMessage('üîÑ Reloading ingredients...');
            
            // Force a fresh load by clearing existing data
            rawIngredients = null;
            foodDatabase = null;
            
            return loadDatabases()
                .then(() => {
                    console.log('‚úÖ RELOAD: Reload completed successfully');
                    console.log('‚úÖ RELOAD: New state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
                    
                    // Verify critical data
                    if (rawIngredients && rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                        console.log('‚úÖ RELOAD: Lauki verified after reload:', rawIngredients.vegetables.lauki.name);
                    } else {
                        console.warn('‚ö†Ô∏è RELOAD: Lauki verification failed after reload');
                    }
                    
                    // Update all UI components that depend on ingredients
                    console.log('üîÑ RELOAD: Updating UI components...');
                    populateQuickDishes();
                    populateIngredientSelect();
                    
                    showSuccessMessage('‚úÖ Ingredients reloaded successfully!');
                    return { rawIngredients, foodDatabase };
                })
                .catch(error => {
                    console.error('‚ùå RELOAD: Manual reload failed:', error);
                    showErrorMessage('Failed to reload ingredients: ' + error.message);
                    throw error;
                });
        }

        function initializeWithFallback() {
            // Embedded fallback data for raw ingredients
            rawIngredients = {
                grains: {
                    rice: {
                        name: "Rice",
                        measurements: {
                            "1_cup_cooked": { calories: 205, protein: 4.3, carbs: 45, fat: 0.4, fiber: 0.6 },
                            "1_cup_uncooked": { calories: 685, protein: 12.9, carbs: 150, fat: 1.1, fiber: 2.2 }
                        }
                    },
                    quinoa: {
                        name: "Quinoa",
                        measurements: {
                            "1_cup_cooked": { calories: 222, protein: 8, carbs: 39, fat: 3.6, fiber: 5.2 }
                        }
                    }
                },
                dals_legumes: {
                    toor_dal: {
                        name: "Toor Dal",
                        measurements: {
                            "1_cup_cooked": { calories: 230, protein: 15, carbs: 38, fat: 1, fiber: 10 },
                            "1_cup_uncooked": { calories: 343, protein: 22, carbs: 57, fat: 1.5, fiber: 15 }
                        }
                    }
                },
                spices_seasonings: {
                    turmeric: {
                        name: "Turmeric Powder",
                        measurements: {
                            "1_tsp": { calories: 8, protein: 0.2, carbs: 1.8, fat: 0.2, fiber: 0.4 },
                            "1_tbsp": { calories: 24, protein: 0.6, carbs: 5.4, fat: 0.7, fiber: 1.4 }
                        }
                    }
                },
                oils_fats: {
                    cooking_oil: {
                        name: "Cooking Oil",
                        measurements: {
                            "1_tsp": { calories: 40, protein: 0, carbs: 0, fat: 4.5, fiber: 0 },
                            "1_tbsp": { calories: 120, protein: 0, carbs: 0, fat: 13.5, fiber: 0 }
                        }
                    }
                }
            };

            // Embedded fallback data (subset of the full database)
            foodDatabase = {
                dishes: {
                    dal_tadka: {
                        name: "Dal Tadka",
                        category: "dal",
                        servings: 4,
                        total_per_serving: { calories: 175, protein: 6.6, carbs: 20.4, fat: 7.4, fiber: 5.1 }
                    },
                    sambar: {
                        name: "Sambar",
                        category: "sambar", 
                        servings: 6,
                        total_per_serving: { calories: 129, protein: 4.6, carbs: 18.0, fat: 5.1, fiber: 4.7 }
                    },
                    aloo_gobi: {
                        name: "Aloo Gobi",
                        category: "sabji",
                        servings: 4,
                        total_per_serving: { calories: 209, protein: 5.4, carbs: 25.9, fat: 10.8, fiber: 5.4 }
                    },
                    rajma: {
                        name: "Rajma",
                        category: "dal",
                        servings: 4,
                        total_per_serving: { calories: 194, protein: 7.5, carbs: 25.7, fat: 7.3, fiber: 6.6 }
                    },
                    rice_plain: {
                        name: "Plain Rice",
                        category: "rice",
                        servings: 4,
                        total_per_serving: { calories: 171, protein: 3.2, carbs: 37.5, fat: 0.3, fiber: 0.6 }
                    },
                    chapati: {
                        name: "Chapati",
                        category: "bread",
                        servings: 1,
                        total_per_serving: { calories: 122, protein: 3.6, carbs: 20.7, fat: 2.8, fiber: 2.7 }
                    }
                },
                ingredients_database: {
                    vegetables: {
                        onion_medium: {calories: 44, protein: 1.2, carbs: 10, fat: 0.1, fiber: 1.9},
                        tomato_medium: {calories: 22, protein: 1.1, carbs: 4.8, fat: 0.2, fiber: 1.4},
                        potato_medium: {calories: 77, protein: 2.1, carbs: 17.6, fat: 0.1, fiber: 1.6}
                    },
                    dals_legumes: {
                        toor_dal_100g: {calories: 343, protein: 22, carbs: 57, fat: 1.5, fiber: 15}
                    },
                    spices_condiments: {
                        oil_1tbsp: {calories: 120, protein: 0, carbs: 0, fat: 13.5, fiber: 0}
                    }
                }
            };
            initializeApp();
        }

        function initializeApp() {
            console.log('üöÄ INITAPP: Starting initializeApp()...');
            console.log('üöÄ INITAPP: rawIngredients state:', rawIngredients ? 'LOADED' : 'NOT_LOADED');
            console.log('üöÄ INITAPP: foodDatabase state:', foodDatabase ? 'LOADED' : 'NOT_LOADED');
            
            populateIngredientSelect();
            initializeDateSystem();
            
            console.log('‚úÖ INITAPP: initializeApp() completed');
        }


        function populateQuickDishes() {
            const container = document.getElementById('quickDishes');
            if (!container) {
                console.log('‚ö†Ô∏è populateQuickDishes: quickDishes element not found, skipping population');
                return;
            }
            
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            
            container.innerHTML = Object.entries(allDishes).map(([key, dish]) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-200">
                    <div>
                        <div class="font-medium text-gray-800">${dish.name}</div>
                        <div class="text-sm text-gray-600">${dish.total_per_serving.calories} cal/serving ‚Ä¢ ${dish.category}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${customRecipes[key] ? `<button onclick="editRecipe('${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>` : ''}
                        <input type="number" value="1" min="0.5" step="0.5" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm" id="servings_${key}">
                        <button onclick="addQuickDish('${key}')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Add
                        </button>
                        ${customRecipes[key] ? `<button onclick="deleteRecipe('${key}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">&times;</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function populateIngredientSelect() {
            console.log('üîÑ POPULATE: populateIngredientSelect() called');
            console.log('üîÑ POPULATE: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            const select = document.getElementById('recipeIngredientSelect');
            if (!select) {
                console.log('‚ùå POPULATE: Recipe ingredient select not found');
                return;
            }
            
            // Check if ingredients are loaded
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('‚ö†Ô∏è POPULATE: Raw ingredients not available, setting up listener...');
                select.innerHTML = '<option value="">Loading ingredients...</option>';
                
                // Set up a one-time listener for when ingredients are ready
                const handleIngredientsReady = () => {
                    console.log('‚úÖ POPULATE: Ingredients ready event received');
                    populateIngredientSelectInternal(select);
                    window.removeEventListener('ingredientsReady', handleIngredientsReady);
                };
                
                window.addEventListener('ingredientsReady', handleIngredientsReady);
                
                // Also try to load databases if not already loading
                if (!databaseLoadingPromise) {
                    console.log('üîÑ POPULATE: Triggering database load...');
                    loadDatabases().catch(error => {
                        console.error('‚ùå POPULATE: Failed to load databases:', error);
                        select.innerHTML = '<option value="">Failed to load ingredients</option>';
                    });
                }
                return;
            }
            
            console.log('‚úÖ POPULATE: Raw ingredients available, proceeding with population');
            populateIngredientSelectInternal(select);
        }
        
        function populateIngredientSelectInternal(select) {
            console.log('üîÑ POPULATE_INTERNAL: Starting internal population');
            console.log('üîÑ POPULATE_INTERNAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üîÑ POPULATE_INTERNAL: rawIngredients categories:', rawIngredients ? Object.keys(rawIngredients) : 'N/A');
            
            let options = '<option value="">Select ingredient...</option>';
            let totalIngredients = 0;
            
            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                console.log(`üîÑ POPULATE_INTERNAL: Processing category ${categoryName} with ${Object.keys(items).length} items`);
                options += `<optgroup label="${categoryName}">`;
                Object.entries(items).forEach(([key, item]) => {
                    options += `<option value="${category}.${key}">${item.name}</option>`;
                    totalIngredients++;
                });
                options += '</optgroup>';
            });
            
            select.innerHTML = options;
            // Remove existing event listener to avoid duplicates
            select.removeEventListener('change', onRecipeIngredientChange);
            select.addEventListener('change', onRecipeIngredientChange);
            console.log('‚úÖ POPULATE_INTERNAL: Recipe ingredient select populated with', Object.keys(rawIngredients).length, 'categories and', totalIngredients, 'total ingredients');
            
            // Test if lauki is in the select
            const laukiOption = select.querySelector('option[value="vegetables.lauki"]');
            if (laukiOption) {
                console.log('‚úÖ POPULATE_INTERNAL: Lauki option found in select:', laukiOption.textContent);
            } else {
                console.warn('‚ö†Ô∏è POPULATE_INTERNAL: Lauki option NOT found in select');
            }
        }

        function onRecipeIngredientChange() {
            const select = document.getElementById('recipeIngredientSelect');
            const measurementSelect = document.getElementById('recipeMeasurementSelect');
            
            if (!select.value) {
                measurementSelect.innerHTML = '<option value="">Select ingredient first...</option>';
                measurementSelect.disabled = true;
                return;
            }

            const [category, ingredientKey] = select.value.split('.');
            const ingredient = rawIngredients[category][ingredientKey];
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
            measurementSelect.disabled = false;
        }

        function addRecipeIngredient() {
            const ingredientSelect = document.getElementById('recipeIngredientSelect');
            const measurementSelect = document.getElementById('recipeMeasurementSelect');
            const quantityInput = document.getElementById('recipeQuantity');
            
            if (!ingredientSelect.value || !measurementSelect.value || !quantityInput.value) {
                alert('Please select ingredient, measurement, and quantity');
                return;
            }

            const quantity = parseFloat(quantityInput.value);
            const [category, ingredientKey] = ingredientSelect.value.split('.');
            const ingredient = rawIngredients[category][ingredientKey];
            const measurement = ingredient.measurements[measurementSelect.value];
            
            const ingredientEntry = {
                key: ingredientSelect.value,
                name: ingredient.name,
                amount: `${quantity}x ${measurementSelect.options[measurementSelect.selectedIndex].text}`,
                nutrition: {
                    calories: measurement.calories * quantity,
                    protein: measurement.protein * quantity,
                    carbs: measurement.carbs * quantity,
                    fat: measurement.fat * quantity,
                    fiber: measurement.fiber * quantity
                }
            };

            currentRecipeIngredients.push(ingredientEntry);
            
            // Clear inputs
            ingredientSelect.value = '';
            measurementSelect.innerHTML = '<option value="">Select ingredient first...</option>';
            measurementSelect.disabled = true;
            quantityInput.value = 1;
            
            updateRecipePreview();
        }

        function addQuickDish(dishKey) {
            console.log('üçΩÔ∏è QUICKDISH: addQuickDish() called for:', dishKey);
            console.log('üçΩÔ∏è QUICKDISH: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üçΩÔ∏è QUICKDISH: foodDatabase state:', foodDatabase ? 'EXISTS' : 'NULL');
            
            const servings = parseFloat(document.getElementById(`servings_${dishKey}`).value);
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            const dish = allDishes[dishKey];
            
            if (!dish) return;
            
            const nutrition = dish.total_per_serving;
            const meal = {
                id: Date.now(),
                description: `${dish.name} (${servings} serving${servings !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(nutrition.calories * servings),
                    protein: Math.round(nutrition.protein * servings * 10) / 10,
                    carbs: Math.round(nutrition.carbs * servings * 10) / 10,
                    fat: Math.round(nutrition.fat * servings * 10) / 10,
                    fiber: Math.round(nutrition.fiber * servings * 10) / 10
                },
                source: 'database'
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            // Reset serving size
            document.getElementById(`servings_${dishKey}`).value = 1;
            
            showSuccessMessage(`Added ${dish.name}!`);
        }

        function addCustomEntry() {
            const description = document.getElementById('customDish').value.trim();
            const servings = parseFloat(document.getElementById('customServings').value);
            const calories = parseInt(document.getElementById('customCalories').value) || estimateCalories(description);
            
            if (!description) {
                alert('Please enter a dish description');
                return;
            }
            
            const meal = {
                id: Date.now(),
                description: description,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(calories * servings),
                    protein: Math.round(calories * 0.15 / 4), // Rough estimate
                    carbs: Math.round(calories * 0.55 / 4),
                    fat: Math.round(calories * 0.30 / 9),
                    fiber: Math.round(calories * 0.02)
                },
                source: 'custom'
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            // Clear form
            document.getElementById('customDish').value = '';
            document.getElementById('customServings').value = 1;
            document.getElementById('customCalories').value = '';
            
            showSuccessMessage('Added custom entry!');
        }

        function estimateCalories(description) {
            // Simple calorie estimation based on keywords
            const desc = description.toLowerCase();
            let calories = 200; // Base calories
            
            if (desc.includes('dal') || desc.includes('sambar')) calories = 150;
            if (desc.includes('rice')) calories += 170;
            if (desc.includes('chapati') || desc.includes('roti')) calories += 120;
            if (desc.includes('paneer')) calories += 200;
            if (desc.includes('oil') || desc.includes('ghee')) calories += 100;
            if (desc.includes('large') || desc.includes('big')) calories *= 1.5;
            if (desc.includes('small')) calories *= 0.7;
            
            return Math.round(calories);
        }

        function openRecipeBuilder() {
            console.log('üë®‚Äçüç≥ RECIPE: openRecipeBuilder() called');
            console.log('üë®‚Äçüç≥ RECIPE: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Always ensure databases are loaded before opening recipe builder
            console.log('üîÑ RECIPE: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ RECIPE: Databases loaded, opening recipe builder');
                document.getElementById('recipeModal').classList.add('active');
                currentRecipeIngredients = [];
                updateRecipePreview();
                // Ensure ingredient select is populated with loaded data
                populateIngredientSelect();
                showSuccessMessage('‚úÖ Recipe builder ready!');
            }).catch(error => {
                console.error('‚ùå RECIPE: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function closeRecipeBuilder() {
            document.getElementById('recipeModal').classList.remove('active');
            // Clear form
            document.getElementById('recipeName').value = '';
            document.getElementById('recipeServings').value = 4;
            currentRecipeIngredients = [];
            // Reset modal to create mode
            resetRecipeBuilderModal();
        }

        // This function is now replaced by addRecipeIngredient above

        function updateRecipePreview() {
            const preview = document.getElementById('recipePreview');
            const servings = parseInt(document.getElementById('recipeServings').value) || 4;
            
            if (currentRecipeIngredients.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving
            const perServing = {
                calories: Math.round(totals.calories / servings),
                protein: Math.round(totals.protein / servings * 10) / 10,
                carbs: Math.round(totals.carbs / servings * 10) / 10,
                fat: Math.round(totals.fat / servings * 10) / 10,
                fiber: Math.round(totals.fiber / servings * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Ingredients:</h5>
                    ${currentRecipeIngredients.map(ing => `
                        <div class="flex justify-between items-center text-sm">
                            <span>${ing.name} (${ing.amount})</span>
                            <button onclick="removeIngredient('${ing.key}')" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${servings} total):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function removeIngredient(key) {
            currentRecipeIngredients = currentRecipeIngredients.filter(ing => ing.key !== key);
            updateRecipePreview();
        }

        async function saveRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const category = document.getElementById('recipeCategory').value;
            const servings = parseInt(document.getElementById('recipeServings').value);
            
            if (!name || currentRecipeIngredients.length === 0) {
                alert('Please enter recipe name and add ingredients');
                return;
            }
            
            // Calculate nutrition per serving
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            const recipeKey = name.toLowerCase().replace(/\s+/g, '_');
            const recipe = {
                name: name,
                category: category,
                servings: servings,
                ingredients: currentRecipeIngredients,
                total_per_serving: {
                    calories: Math.round(totals.calories / servings),
                    protein: Math.round(totals.protein / servings * 10) / 10,
                    carbs: Math.round(totals.carbs / servings * 10) / 10,
                    fat: Math.round(totals.fat / servings * 10) / 10,
                    fiber: Math.round(totals.fiber / servings * 10) / 10
                }
            };
            
            try {
                // Try to save to server first
                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipeKey: recipeKey,
                        recipeData: recipe
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe saved to server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${name}" saved to server!`);
                    
                    // Also save to localStorage as backup/cache
                    customRecipes[recipeKey] = recipe;
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to save recipe to server, saving to localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe saved locally only');
                
                // Fallback to localStorage only
                customRecipes[recipeKey] = recipe;
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${name}" saved locally!`);
            }
            
            populateQuickDishes();
            closeRecipeBuilder();
        }

        function addRecipeToLog() {
            saveRecipe();
            // Add the recipe to today's log
            const name = document.getElementById('recipeName').value.trim();
            const recipeKey = name.toLowerCase().replace(/\s+/g, '_');
            if (customRecipes[recipeKey]) {
                addQuickDish(recipeKey);
            }
        }

        // Edit Recipe Function
        function editRecipe(key) {
            console.log('‚úèÔ∏è EDIT: editRecipe() called for key:', key);
            
            // Check if the recipe exists in customRecipes
            if (!customRecipes[key]) {
                showErrorMessage('Recipe not found: ' + key);
                return;
            }
            
            const recipe = customRecipes[key];
            console.log('‚úèÔ∏è EDIT: Found recipe:', recipe.name);
            
            // Ensure databases are loaded before opening recipe builder
            loadDatabases().then(() => {
                console.log('‚úÖ EDIT: Databases loaded, opening recipe builder in edit mode');
                
                // Open the recipe builder modal
                document.getElementById('recipeModal').classList.add('active');
                
                // Update modal title to indicate edit mode
                const modalTitle = document.querySelector('#recipeModal h3');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Recipe';
                }
                
                // Populate form with existing recipe data
                document.getElementById('recipeName').value = recipe.name;
                document.getElementById('recipeCategory').value = recipe.category;
                document.getElementById('recipeServings').value = recipe.servings;
                
                // Clear and populate ingredients
                currentRecipeIngredients = [...recipe.ingredients];
                
                // Update the save button to handle editing
                const saveButton = document.querySelector('button[onclick="saveRecipe()"]');
                if (saveButton) {
                    saveButton.textContent = 'Update Recipe';
                    saveButton.onclick = () => updateExistingRecipe(key);
                }
                
                // Update the save & add button
                const saveAddButton = document.querySelector('button[onclick="addRecipeToLog()"]');
                if (saveAddButton) {
                    saveAddButton.textContent = 'Update & Add to Today\'s Log';
                    saveAddButton.onclick = () => updateAndAddRecipeToLog(key);
                }
                
                // Ensure ingredient select is populated
                populateIngredientSelect();
                
                // Update preview
                updateRecipePreview();
                
                showSuccessMessage('‚úÖ Recipe loaded for editing!');
                
            }).catch(error => {
                console.error('‚ùå EDIT: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        // Delete Recipe Function
        async function deleteRecipe(key) {
            console.log('üóëÔ∏è DELETE: deleteRecipe() called for key:', key);
            
            // Check if the recipe exists in customRecipes
            if (!customRecipes[key]) {
                showErrorMessage('Recipe not found: ' + key);
                return;
            }
            
            const recipe = customRecipes[key];
            console.log('üóëÔ∏è DELETE: Found recipe:', recipe.name);
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete the recipe "${recipe.name}"?\n\nThis action cannot be undone.`)) {
                console.log('üóëÔ∏è DELETE: User cancelled deletion');
                return;
            }
            
            try {
                // Try to delete from server first
                const response = await fetch(`/api/recipes/${key}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe deleted from server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${recipe.name}" deleted from server!`);
                    
                    // Also remove from localStorage
                    delete customRecipes[key];
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to delete recipe from server, deleting from localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe deleted locally only');
                
                // Fallback to localStorage only
                delete customRecipes[key];
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${recipe.name}" deleted locally!`);
            }
            
            console.log('‚úÖ DELETE: Recipe deletion completed');
            
            // Refresh the quick dishes display
            populateQuickDishes();
            
            // Also update modal quick dishes if it exists
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
        }

        // Helper function to update existing recipe
        async function updateExistingRecipe(originalKey) {
            const name = document.getElementById('recipeName').value.trim();
            const category = document.getElementById('recipeCategory').value;
            const servings = parseInt(document.getElementById('recipeServings').value);
            
            if (!name || currentRecipeIngredients.length === 0) {
                alert('Please enter recipe name and add ingredients');
                return;
            }
            
            // Calculate nutrition per serving
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            const recipe = {
                name: name,
                category: category,
                servings: servings,
                ingredients: currentRecipeIngredients,
                total_per_serving: {
                    calories: Math.round(totals.calories / servings),
                    protein: Math.round(totals.protein / servings * 10) / 10,
                    carbs: Math.round(totals.carbs / servings * 10) / 10,
                    fat: Math.round(totals.fat / servings * 10) / 10,
                    fiber: Math.round(totals.fiber / servings * 10) / 10
                }
            };
            
            try {
                // Try to update on server first
                const response = await fetch(`/api/recipes/${originalKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipeData: recipe
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe updated on server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${name}" updated on server!`);
                    
                    // Also update localStorage as backup/cache
                    customRecipes[originalKey] = recipe;
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to update recipe on server, updating localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe updated locally only');
                
                // Fallback to localStorage only
                customRecipes[originalKey] = recipe;
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${name}" updated locally!`);
            }
            
            // Refresh displays
            populateQuickDishes();
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
            
            // Reset the modal
            resetRecipeBuilderModal();
            closeRecipeBuilder();
        }

        // Helper function to update and add recipe to log
        function updateAndAddRecipeToLog(originalKey) {
            updateExistingRecipe(originalKey);
            // Add the updated recipe to today's log
            if (customRecipes[originalKey]) {
                addQuickDish(originalKey);
            }
        }

        // Helper function to reset recipe builder modal to create mode
        function resetRecipeBuilderModal() {
            // Reset modal title
            const modalTitle = document.querySelector('#recipeModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'Create New Recipe';
            }
            
            // Reset save button
            const saveButton = document.querySelector('button[onclick*="updateExistingRecipe"], button[onclick="saveRecipe()"]');
            if (saveButton) {
                saveButton.textContent = 'Save Recipe';
                saveButton.onclick = saveRecipe;
            }
            
            // Reset save & add button
            const saveAddButton = document.querySelector('button[onclick*="updateAndAddRecipeToLog"], button[onclick="addRecipeToLog()"]');
            if (saveAddButton) {
                saveAddButton.textContent = 'Save & Add to Today\'s Log';
                saveAddButton.onclick = addRecipeToLog;
            }
        }

        function updateDailySummary() {
            const currentMeals = getCurrentDateMeals();

            const totals = currentMeals.reduce((acc, meal) => {
                acc.calories += meal.nutrition.calories;
                acc.protein += meal.nutrition.protein;
                acc.fiber += meal.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, fiber: 0});

            document.getElementById('totalCalories').textContent = totals.calories;
            document.getElementById('mealCount').textContent = currentMeals.length;
            document.getElementById('totalProtein').textContent = Math.round(totals.protein * 10) / 10 + 'g';
            document.getElementById('totalFiber').textContent = Math.round(totals.fiber * 10) / 10 + 'g';
        }

        function displayMeals() {
            const foodLog = document.getElementById('foodLog');
            const currentMeals = getCurrentDateMeals();
            
            if (currentMeals.length === 0) {
                foodLog.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No meals logged yet. Try adding a dish above!</p>
                    </div>
                `;
                return;
            }

            const sortedMeals = [...currentMeals].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            foodLog.innerHTML = sortedMeals.map(meal => `
                <div class="border border-gray-200 rounded-lg p-4 fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${meal.description}</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${formatTime(new Date(meal.timestamp))}</span>
                            <button onclick="removeMeal(${meal.id})" class="text-red-500 hover:text-red-700 text-sm">&times;</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2 text-sm">
                        <div class="bg-orange-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-orange-600">${meal.nutrition.calories}</div>
                            <div class="text-orange-500 text-xs">Calories</div>
                        </div>
                        <div class="bg-blue-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-blue-600">${meal.nutrition.protein}g</div>
                            <div class="text-blue-500 text-xs">Protein</div>
                        </div>
                        <div class="bg-yellow-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-yellow-600">${meal.nutrition.carbs}g</div>
                            <div class="text-yellow-500 text-xs">Carbs</div>
                        </div>
                        <div class="bg-green-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-green-600">${meal.nutrition.fat}g</div>
                            <div class="text-green-500 text-xs">Fat</div>
                        </div>
                        <div class="bg-purple-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-purple-600">${meal.nutrition.fiber}g</div>
                            <div class="text-purple-500 text-xs">Fiber</div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        Source: ${meal.source === 'database' ? 'Indian Food Database' : meal.source === 'ingredients' ? 'Basic Ingredients' : 'Custom Entry'}
                        ${meal.ingredients ? `
                            <details class="mt-2">
                                <summary class="cursor-pointer text-gray-600 hover:text-gray-800">View ingredients (${meal.ingredients.length})</summary>
                                <div class="mt-1 space-y-1 pl-4">
                                    ${meal.ingredients.map(ing => `
                                        <div class="flex justify-between text-xs">
                                            <span>${ing.name} (${ing.quantity}x ${ing.measurement})</span>
                                            <span class="text-gray-500">${ing.nutrition.calories} cal</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function removeMeal(mealId) {
            removeMealFromDate(mealId);
            updateDailySummary();
            displayMeals();
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function showSuccessMessage(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            successMsg.textContent = '‚úÖ ' + message;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM: DOMContentLoaded event fired');
            console.log('üöÄ DOM: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üöÄ DOM: foodDatabase state:', foodDatabase ? 'EXISTS' : 'NULL');
            // Initialize the new date-based system
            initializeDateSystem();
            console.log('‚úÖ DOM: DOMContentLoaded initialization completed');
        });

        // Ingredient Management Functions
        let currentIngredients = {};
        let serverMode = false;

        // Check if server is available
        async function checkServerMode() {
            try {
                // Check if we're running from file:// protocol
                if (window.location.protocol === 'file:') {
                    console.log('‚ö†Ô∏è Running from file system - server features disabled');
                    console.log('üí° To enable ingredient management, access via: http://localhost:3000');
                    serverMode = false;
                    showServerModeWarning();
                    return;
                }

                const response = await fetch('/api/ingredients');
                if (response.ok) {
                    serverMode = true;
                    console.log('‚úÖ Server mode enabled - ingredient management available');
                    hideServerModeWarning();
                } else {
                    serverMode = false;
                    console.log('‚ö†Ô∏è Server responded with error - ingredient management disabled');
                    showServerModeWarning();
                }
            } catch (error) {
                serverMode = false;
                console.log('‚ö†Ô∏è Server not available - ingredient management disabled');
                console.log('üí° Make sure server is running with "npm start" and access via: http://localhost:3000');
                showServerModeWarning();
            }
        }

        // Show warning about server mode
        function showServerModeWarning() {
            const existingWarning = document.getElementById('serverModeWarning');
            if (existingWarning) return; // Don't show multiple warnings

            const warning = document.createElement('div');
            warning.id = 'serverModeWarning';
            warning.className = 'fixed top-4 left-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-lg z-50';
            warning.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-yellow-800">Server Mode Required</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>Ingredient management features are disabled. To enable them:</p>
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                <li>Make sure the server is running with <code class="bg-yellow-200 px-1 rounded">npm start</code></li>
                                <li>Access the app via <a href="http://localhost:3000" class="underline font-semibold">http://localhost:3000</a></li>
                            </ol>
                        </div>
                        <div class="mt-3">
                            <button onclick="retryServerConnection()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                                üîÑ Retry Connection
                            </button>
                            <button onclick="hideServerModeWarning()" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(warning);
        }

        // Hide server mode warning
        function hideServerModeWarning() {
            const warning = document.getElementById('serverModeWarning');
            if (warning) {
                warning.remove();
            }
        }

        // Retry server connection
        async function retryServerConnection() {
            console.log('üîÑ Retrying server connection...');
            await checkServerMode();
            if (serverMode) {
                showSuccessMessage('‚úÖ Server connection established!');
            }
        }

        // Initialize server check
        checkServerMode();

        function openIngredientModal() {
            console.log('ü•¨ MODAL: openIngredientModal() called');
            console.log('ü•¨ MODAL: serverMode:', serverMode);
            console.log('ü•¨ MODAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            if (!serverMode) {
                // Show a more helpful message based on the current context
                if (window.location.protocol === 'file:') {
                    showErrorMessage('Please access the app via http://localhost:3000 to use ingredient management features.');
                } else {
                    showErrorMessage('Server connection required. Make sure the server is running with "npm start".');
                }
                // Also show the server mode warning if it's not already visible
                showServerModeWarning();
                return;
            }
            
            // Always ensure databases are loaded before opening modal
            console.log('üîÑ MODAL: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MODAL: Databases loaded, opening modal');
                // Now open the modal with loaded data
                document.getElementById('ingredientModal').classList.add('active');
                showIngredientLoadingState();
                loadExistingIngredients();
                showSuccessMessage('‚úÖ Ingredients loaded successfully!');
            }).catch(error => {
                console.error('‚ùå MODAL: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function showIngredientLoadingState() {
            console.log('üîÑ LOADING_STATE: showIngredientLoadingState() called');
            const container = document.getElementById('ingredientsList');
            console.log('üîÑ LOADING_STATE: ingredientsList element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è LOADING_STATE: ingredientsList not found - skipping loading state display');
                return;
            }
            
            container.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mr-3"></div>
                    <span class="text-gray-600">Loading ingredients...</span>
                </div>
            `;
        }

        function closeIngredientModal() {
            document.getElementById('ingredientModal').classList.remove('active');
            clearIngredientForm();
        }

        async function loadExistingIngredients() {
            try {
                console.log('üîÑ LOAD_EXISTING: Loading ingredients from server...');
                console.log('üîÑ LOAD_EXISTING: Checking if ingredientsList element exists...');
                const container = document.getElementById('ingredientsList');
                console.log('üîÑ LOAD_EXISTING: ingredientsList element:', container ? 'EXISTS' : 'NULL');
                
                if (!container) {
                    console.error('‚ùå LOAD_EXISTING: ingredientsList element not found - this will cause innerHTML error');
                    throw new Error('ingredientsList container not found in DOM');
                }
                
                const startTime = performance.now();
                
                const response = await fetch('/api/ingredients');
                if (!response.ok) throw new Error('Failed to load ingredients');
                
                const data = await response.json();
                currentIngredients = data.basic_ingredients;
                
                const loadTime = performance.now() - startTime;
                console.log(`‚úÖ LOAD_EXISTING: Ingredients loaded in ${loadTime.toFixed(2)}ms`);
                
                // Use setTimeout to allow UI to update before processing
                setTimeout(() => {
                    displayIngredientsList();
                }, 10);
                
            } catch (error) {
                console.error('‚ùå LOAD_EXISTING: Error loading ingredients:', error);
                const container = document.getElementById('ingredientsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-red-500 mb-2">‚ùå Failed to load ingredients</div>
                            <div class="text-sm text-gray-600">${error.message}</div>
                            <button onclick="loadExistingIngredients()" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                Retry
                            </button>
                        </div>
                    `;
                } else {
                    console.error('‚ùå LOAD_EXISTING: Cannot display error - ingredientsList container not found');
                }
                showErrorMessage('Failed to load ingredients: ' + error.message);
            }
        }

        function displayIngredientsList() {
            console.log('üé® DISPLAY_LIST: displayIngredientsList() called');
            const container = document.getElementById('ingredientsList');
            console.log('üé® DISPLAY_LIST: ingredientsList element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è DISPLAY_LIST: ingredientsList not found - skipping ingredients list display');
                return;
            }
            
            const filterCategory = document.getElementById('filterCategory')?.value || '';
            
            console.log('üé® DISPLAY_LIST: Rendering ingredients list...');
            const startTime = performance.now();
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            let hasContent = false;
            
            Object.entries(currentIngredients).forEach(([category, ingredients]) => {
                if (filterCategory && category !== filterCategory) return;
                
                const categoryName = category.replace(/_/g, ' ').toUpperCase();
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-4';
                
                const categoryHeader = document.createElement('h6');
                categoryHeader.className = 'font-semibold text-gray-700 mb-2';
                categoryHeader.textContent = categoryName;
                categoryDiv.appendChild(categoryHeader);
                
                Object.entries(ingredients).forEach(([key, ingredient]) => {
                    hasContent = true;
                    const measurementCount = Object.keys(ingredient.measurements).length;
                    
                    const ingredientDiv = document.createElement('div');
                    ingredientDiv.className = 'bg-gray-50 p-3 rounded-lg mb-2';
                    ingredientDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-gray-800">${ingredient.name}</div>
                                <div class="text-sm text-gray-600">${measurementCount} measurement${measurementCount !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editIngredient('${category}', '${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>
                                <button onclick="deleteIngredient('${category}', '${key}', '${ingredient.name}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Delete</button>
                            </div>
                        </div>
                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">View measurements</summary>
                            <div class="mt-1 space-y-1 pl-4">
                                ${Object.entries(ingredient.measurements).map(([measureKey, nutrition]) => `
                                    <div class="flex justify-between text-xs">
                                        <span>${measureKey.replace(/_/g, ' ')}</span>
                                        <span class="text-gray-500">${nutrition.calories} cal</span>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    `;
                    
                    categoryDiv.appendChild(ingredientDiv);
                });
                
                if (categoryDiv.children.length > 1) { // Has header + ingredients
                    fragment.appendChild(categoryDiv);
                }
            });
            
            // Clear container and add content
            container.innerHTML = '';
            
            if (!hasContent) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No ingredients found</p>';
            } else {
                container.appendChild(fragment);
            }
            
            const renderTime = performance.now() - startTime;
            console.log(`‚úÖ DISPLAY_LIST: Ingredients rendered in ${renderTime.toFixed(2)}ms`);
        }

        function filterIngredients() {
            displayIngredientsList();
        }

        function addMeasurementInput() {
            const container = document.getElementById('measurementInputs');
            const measurementDiv = document.createElement('div');
            measurementDiv.className = 'bg-gray-50 p-4 rounded-lg';
            measurementDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                        <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                        <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-2">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                        <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                        <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                        <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                        <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                        <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                </div>
                <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
            `;
            container.appendChild(measurementDiv);
        }

        function removeMeasurement(button) {
            const container = document.getElementById('measurementInputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('At least one measurement is required');
            }
        }

        function clearIngredientForm() {
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientCategory').value = '';
            
            // Reset to single measurement input
            const container = document.getElementById('measurementInputs');
            container.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                    </div>
                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                </div>
            `;
        }

        async function saveIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const category = document.getElementById('ingredientCategory').value;
            
            if (!name || !category) {
                alert('Please enter ingredient name and select a category');
                return;
            }
            
            // Collect measurements
            const measurementInputs = document.getElementById('measurementInputs').children;
            const measurements = {};
            
            for (let i = 0; i < measurementInputs.length; i++) {
                const measurementDiv = measurementInputs[i];
                const measurementName = measurementDiv.querySelector('.measurement-name').value.trim();
                const calories = parseFloat(measurementDiv.querySelector('.nutrition-calories').value) || 0;
                const protein = parseFloat(measurementDiv.querySelector('.nutrition-protein').value) || 0;
                const carbs = parseFloat(measurementDiv.querySelector('.nutrition-carbs').value) || 0;
                const fat = parseFloat(measurementDiv.querySelector('.nutrition-fat').value) || 0;
                const fiber = parseFloat(measurementDiv.querySelector('.nutrition-fiber').value) || 0;
                
                if (!measurementName) {
                    alert(`Please enter measurement name for measurement ${i + 1}`);
                    return;
                }
                
                measurements[measurementName] = {
                    calories,
                    protein,
                    carbs,
                    fat,
                    fiber
                };
            }
            
            const ingredientKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const ingredientData = {
                name,
                measurements
            };
            
            try {
                const response = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category,
                        ingredientKey,
                        ingredientData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`Ingredient "${name}" added successfully!`);
                    clearIngredientForm();
                    loadExistingIngredients();
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to save ingredient');
                }
            } catch (error) {
                console.error('Error saving ingredient:', error);
                showErrorMessage('Failed to save ingredient: ' + error.message);
            }
        }

        async function deleteIngredient(category, ingredientKey, ingredientName) {
            if (!confirm(`Are you sure you want to delete "${ingredientName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ingredients/${category}/${ingredientKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`Ingredient "${ingredientName}" deleted successfully!`);
                    loadExistingIngredients();
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to delete ingredient');
                }
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                showErrorMessage('Failed to delete ingredient: ' + error.message);
            }
        }

        function editIngredient(category, ingredientKey) {
            const ingredient = currentIngredients[category][ingredientKey];
            
            // Fill form with existing data
            document.getElementById('ingredientName').value = ingredient.name;
            document.getElementById('ingredientCategory').value = category;
            
            // Clear and populate measurements
            const container = document.getElementById('measurementInputs');
            container.innerHTML = '';
            
            Object.entries(ingredient.measurements).forEach(([measureKey, nutrition]) => {
                const measurementDiv = document.createElement('div');
                measurementDiv.className = 'bg-gray-50 p-4 rounded-lg';
                measurementDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${measureKey}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${measureKey.replace(/_/g, ' ')}">
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.calories}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.protein}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.carbs}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.fat}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.fiber}" min="0" step="0.1">
                        </div>
                    </div>
                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                `;
                container.appendChild(measurementDiv);
            });
            
            // Change save button to update mode
            const saveButton = document.querySelector('button[onclick="saveIngredient()"]');
            saveButton.textContent = 'Update Ingredient';
            saveButton.onclick = () => updateIngredient(category, ingredientKey);
        }

        async function updateIngredient(originalCategory, originalKey) {
            const name = document.getElementById('ingredientName').value.trim();
            const category = document.getElementById('ingredientCategory').value;
            
            if (!name || !category) {
                alert('Please enter ingredient name and select a category');
                return;
            }
            
            // Collect measurements
            const measurementInputs = document.getElementById('measurementInputs').children;
            const measurements = {};
            
            for (let i = 0; i < measurementInputs.length; i++) {
                const measurementDiv = measurementInputs[i];
                const measurementName = measurementDiv.querySelector('.measurement-name').value.trim();
                const calories = parseFloat(measurementDiv.querySelector('.nutrition-calories').value) || 0;
                const protein = parseFloat(measurementDiv.querySelector('.nutrition-protein').value) || 0;
                const carbs = parseFloat(measurementDiv.querySelector('.nutrition-carbs').value) || 0;
                const fat = parseFloat(measurementDiv.querySelector('.nutrition-fat').value) || 0;
                const fiber = parseFloat(measurementDiv.querySelector('.nutrition-fiber').value) || 0;
                
                if (!measurementName) {
                    alert(`Please enter measurement name for measurement ${i + 1}`);
                    return;
                }
                
                measurements[measurementName] = {
                    calories,
                    protein,
                    carbs,
                    fat,
                    fiber
                };
            }
            
            const ingredientData = {
                name,
                measurements
            };
            
            try {
                const response = await fetch(`/api/ingredients/${originalCategory}/${originalKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingredientData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`Ingredient "${name}" updated successfully!`);
                    clearIngredientForm();
                    loadExistingIngredients();
                    // Reset save button
                    const saveButton = document.querySelector('button[onclick*="updateIngredient"]');
                    if (saveButton) {
                        saveButton.textContent = 'Save Ingredient';
                        saveButton.onclick = saveIngredient;
                    }
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to update ingredient');
                }
            } catch (error) {
                console.error('Error updating ingredient:', error);
                showErrorMessage('Failed to update ingredient: ' + error.message);
            }
        }

        function showErrorMessage(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            errorMsg.textContent = '‚ùå ' + message;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 5000);
        }

        // Meal Builder Functions
        function openMealBuilder() {
            console.log('üçΩÔ∏è MEAL: openMealBuilder() called');
            console.log('üçΩÔ∏è MEAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Always ensure databases are loaded before opening meal builder
            console.log('üîÑ MEAL: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MEAL: Databases loaded, opening meal builder');
                document.getElementById('mealModal').classList.add('active');
                currentMealIngredients = [];
                selectedMealIngredient = null;
                clearMealForm();
                updateMealPreview();
                populateMealIngredientDropdown();
                showSuccessMessage('‚úÖ Meal builder ready!');
            }).catch(error => {
                console.error('‚ùå MEAL: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function closeMealBuilder() {
            document.getElementById('mealModal').classList.remove('active');
            clearMealForm();
        }

        function clearMealForm() {
            document.getElementById('mealName').value = '';
            document.getElementById('mealServings').value = 1;
            document.getElementById('mealServingsToLog').value = 1;
            document.getElementById('mealIngredientSearch').value = '';
            document.getElementById('selectedMealIngredient').value = '';
            document.getElementById('mealQuantity').value = 1;
            document.getElementById('mealIngredientDropdown').classList.add('hidden');
            document.getElementById('mealIngredientInputs').style.display = 'none';
            selectedMealIngredient = null;
        }

        function clearMealBuilder() {
            currentMealIngredients = [];
            clearMealForm();
            updateMealPreview();
        }

        function populateMealIngredientDropdown() {
            const dropdown = document.getElementById('mealIngredientDropdown');
            if (!rawIngredients) {
                console.log('Raw ingredients not loaded yet');
                return;
            }

            let html = '';
            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    html += `
                        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             onclick="selectMealIngredient('${category}', '${key}', '${item.name}')">
                            <div class="font-medium text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500">${categoryName}</div>
                        </div>
                    `;
                });
            });
            dropdown.innerHTML = html;
        }

        function filterMealIngredients() {
            const searchTerm = document.getElementById('mealIngredientSearch').value.toLowerCase();
            const dropdown = document.getElementById('mealIngredientDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                document.getElementById('mealIngredientInputs').style.display = 'none';
                return;
            }

            if (!rawIngredients) {
                console.log('Raw ingredients not loaded yet');
                return;
            }

            let html = '';
            let hasResults = false;

            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    if (item.name.toLowerCase().includes(searchTerm)) {
                        hasResults = true;
                        html += `
                            <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                                 onclick="selectMealIngredient('${category}', '${key}', '${item.name}')">
                                <div class="font-medium text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500">${categoryName}</div>
                            </div>
                        `;
                    }
                });
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No ingredients found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function selectMealIngredient(category, key, name) {
            selectedMealIngredient = { category, key, name };
            
            // Update the search input and hide dropdown
            document.getElementById('mealIngredientSearch').value = name;
            document.getElementById('mealIngredientDropdown').classList.add('hidden');
            
            // Show the ingredient inputs
            document.getElementById('selectedMealIngredient').value = name;
            document.getElementById('mealIngredientInputs').style.display = 'grid';
            
            // Populate measurements
            populateMealMeasurements(category, key);
        }

        function populateMealMeasurements(category, key) {
            const measurementSelect = document.getElementById('mealMeasurementSelect');
            const ingredient = rawIngredients[category][key];
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
        }

        function addMealIngredient() {
            if (!selectedMealIngredient) {
                alert('Please select an ingredient first');
                return;
            }

            const measurementSelect = document.getElementById('mealMeasurementSelect');
            const quantityInput = document.getElementById('mealQuantity');
            
            if (!measurementSelect.value || !quantityInput.value) {
                alert('Please select measurement and enter quantity');
                return;
            }

            const quantity = parseFloat(quantityInput.value);
            const { category, key, name } = selectedMealIngredient;
            const ingredient = rawIngredients[category][key];
            const measurement = ingredient.measurements[measurementSelect.value];
            
            const ingredientEntry = {
                key: `${category}.${key}`,
                name: name,
                category: category,
                ingredientKey: key,
                measurementKey: measurementSelect.value,
                measurementDisplay: measurementSelect.options[measurementSelect.selectedIndex].text,
                quantity: quantity,
                nutrition: {
                    calories: measurement.calories * quantity,
                    protein: measurement.protein * quantity,
                    carbs: measurement.carbs * quantity,
                    fat: measurement.fat * quantity,
                    fiber: measurement.fiber * quantity
                }
            };

            currentMealIngredients.push(ingredientEntry);
            
            // Clear inputs
            clearMealForm();
            updateMealPreview();
            
            showSuccessMessage(`Added ${name} to meal!`);
        }

        function removeMealIngredient(index) {
            currentMealIngredients.splice(index, 1);
            updateMealPreview();
        }

        function updateMealPreview() {
            const preview = document.getElementById('mealPreview');
            const totalServings = parseFloat(document.getElementById('mealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('mealServingsToLog').value) || 1;
            
            if (currentMealIngredients.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = currentMealIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Ingredients (${currentMealIngredients.length}):</h5>
                    ${currentMealIngredients.map((ing, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <span>${ing.name} (${ing.quantity}x ${ing.measurementDisplay})</span>
                            <button onclick="removeMealIngredient(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addMealToLog() {
            const mealName = document.getElementById('mealName').value.trim();
            const totalServings = parseFloat(document.getElementById('mealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('mealServingsToLog').value) || 1;
            
            if (currentMealIngredients.length === 0) {
                alert('Please add ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${currentMealIngredients.length} ingredients)`;
            
            // Calculate totals for the entire meal
            const totals = currentMealIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'ingredients',
                ingredients: currentMealIngredients.map(ing => ({
                    name: ing.name,
                    quantity: ing.quantity,
                    measurement: ing.measurementDisplay,
                    nutrition: ing.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            closeMealBuilder();
            showSuccessMessage(`Added "${finalMealName}" to your food log!`);
        }

        // Add event listeners for real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            // Update meal preview when servings change
            const mealServingsInput = document.getElementById('mealServings');
            const mealServingsToLogInput = document.getElementById('mealServingsToLog');
            
            if (mealServingsInput) {
                mealServingsInput.addEventListener('input', updateMealPreview);
            }
            if (mealServingsToLogInput) {
                mealServingsToLogInput.addEventListener('input', updateMealPreview);
            }

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('mealIngredientDropdown');
                const searchInput = document.getElementById('mealIngredientSearch');
                
                if (dropdown && searchInput && !dropdown.contains(event.target) && event.target !== searchInput) {
                    dropdown.classList.add('hidden');
                }
            });
        });

        // Excel Export Functions
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
            updateExportPreview();
            
            // Set default dates
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('exportStartDate').value = formatDateKey(firstOfMonth);
            document.getElementById('exportEndDate').value = formatDateKey(today);
            
            // Add event listeners for export range radio buttons
            const rangeInputs = document.querySelectorAll('input[name="exportRange"]');
            rangeInputs.forEach(input => {
                input.addEventListener('change', handleExportRangeChange);
            });
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('exportProgress').classList.add('hidden');
            document.getElementById('exportButton').disabled = false;
            
            // Remove event listeners
            const rangeInputs = document.querySelectorAll('input[name="exportRange"]');
            rangeInputs.forEach(input => {
                input.removeEventListener('change', handleExportRangeChange);
            });
        }

        function handleExportRangeChange() {
            const selectedRange = document.querySelector('input[name="exportRange"]:checked').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (selectedRange === 'custom') {
                customDateRange.classList.remove('hidden');
            } else {
                customDateRange.classList.add('hidden');
            }
            
            updateExportPreview();
        }

        function updateExportPreview() {
            const selectedRange = document.querySelector('input[name="exportRange"]:checked')?.value || 'all';
            const preview = document.getElementById('exportPreview');
            
            // Get data to export based on selection
            const dataToExport = getExportData(selectedRange);
            const totalDates = Object.keys(dataToExport).length;
            const totalMeals = Object.values(dataToExport).reduce((total, meals) => total + meals.length, 0);
            
            // Group by months for preview
            const monthsMap = {};
            Object.keys(dataToExport).forEach(dateKey => {
                const date = new Date(dateKey + 'T00:00:00');
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                if (!monthsMap[monthKey]) {
                    monthsMap[monthKey] = 0;
                }
                monthsMap[monthKey] += dataToExport[dateKey].length;
            });
            
            const monthsList = Object.entries(monthsMap).map(([month, count]) =>
                `<li class="flex justify-between"><span>${month}</span><span>${count} meals</span></li>`
            ).join('');
            
            let previewHtml = '';
            if (totalDates === 0) {
                previewHtml = '<p class="text-gray-500">No data found for selected range</p>';
            } else {
                previewHtml = `
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-white p-3 rounded border">
                                <div class="font-semibold text-gray-800">üìÖ Total Days</div>
                                <div class="text-2xl font-bold text-purple-600">${totalDates}</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-semibold text-gray-800">üçΩÔ∏è Total Meals</div>
                                <div class="text-2xl font-bold text-purple-600">${totalMeals}</div>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold text-gray-800 mb-2">üìä Excel Sheets to be created:</h5>
                            <ul class="text-sm space-y-1 bg-white p-3 rounded border max-h-32 overflow-y-auto">
                                ${monthsList || '<li class="text-gray-500">No months to export</li>'}
                            </ul>
                        </div>
                        
                        <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
                            <strong>üìã Export will include:</strong> Date, time, meal descriptions, detailed nutrition info (calories, protein, carbs, fat, fiber), ingredient lists, daily summaries, and monthly totals with averages.
                        </div>
                    </div>
                `;
            }
            
            preview.innerHTML = previewHtml;
        }

        function getExportData(rangeType) {
            let dataToExport = {};
            const today = new Date();
            
            switch (rangeType) {
                case 'all':
                    dataToExport = { ...mealsByDate };
                    break;
                    
                case 'month':
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    
                    Object.entries(mealsByDate).forEach(([dateKey, meals]) => {
                        const date = new Date(dateKey + 'T00:00:00');
                        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                            dataToExport[dateKey] = meals;
                        }
                    });
                    break;
                    
                case 'custom':
                    const startDate = document.getElementById('exportStartDate').value;
                    const endDate = document.getElementById('exportEndDate').value;
                    
                    if (startDate && endDate) {
                        Object.entries(mealsByDate).forEach(([dateKey, meals]) => {
                            if (dateKey >= startDate && dateKey <= endDate) {
                                dataToExport[dateKey] = meals;
                            }
                        });
                    }
                    break;
            }
            
            return dataToExport;
        }

        async function startExport() {
            const exportButton = document.getElementById('exportButton');
            const exportProgress = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            
            try {
                // Disable button and show progress
                exportButton.disabled = true;
                exportProgress.classList.remove('hidden');
                progressText.textContent = 'Preparing data...';
                
                // Get export data
                const selectedRange = document.querySelector('input[name="exportRange"]:checked').value;
                const dataToExport = getExportData(selectedRange);
                
                if (Object.keys(dataToExport).length === 0) {
                    throw new Error('No data found for the selected date range');
                }
                
                // Get filename
                let filename = document.getElementById('exportFilename').value.trim();
                if (!filename) {
                    const today = new Date();
                    const dateStr = today.toISOString().split('T')[0];
                    filename = `Food_Diary_Export_${dateStr}.xlsx`;
                }
                
                // Ensure .xlsx extension
                if (!filename.toLowerCase().endsWith('.xlsx')) {
                    filename += '.xlsx';
                }
                
                progressText.textContent = 'Sending data to server...';
                
                // Prepare request data
                const requestData = {
                    mealsByDate: dataToExport,
                    startDate: selectedRange === 'custom' ? document.getElementById('exportStartDate').value : null,
                    endDate: selectedRange === 'custom' ? document.getElementById('exportEndDate').value : null,
                    filename: filename
                };
                
                console.log('üì§ Sending export request:', {
                    totalDates: Object.keys(dataToExport).length,
                    totalMeals: Object.values(dataToExport).reduce((total, meals) => total + meals.length, 0),
                    filename: filename
                });
                
                progressText.textContent = 'Generating Excel file...';
                
                // Make request to server
                const response = await fetch('/api/export-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                progressText.textContent = 'Downloading file...';
                
                // Handle file download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('‚úÖ Excel export completed successfully');
                showSuccessMessage(`üìä Excel file "${filename}" downloaded successfully!`);
                
                // Close modal after successful export
                setTimeout(() => {
                    closeExportModal();
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                showErrorMessage('Export failed: ' + error.message);
                
                // Re-enable button and hide progress
                exportButton.disabled = false;
                exportProgress.classList.add('hidden');
            }
        }

        // Add event listeners for export preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Update preview when custom dates change
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', updateExportPreview);
                endDateInput.addEventListener('change', updateExportPreview);
            }
        });

        // Unified Modal Functions
        function openUnifiedAddModal() {
            document.getElementById('unifiedAddModal').classList.add('active');
            // Default to quick dishes tab
            switchAddTab('quickDishes');
            // Populate quick dishes in modal
            populateQuickDishesInModal();
        }

        function closeUnifiedAddModal() {
            document.getElementById('unifiedAddModal').classList.remove('active');
            // Clear any form data
            clearModalForms();
        }

        function openUnifiedLogModal() {
            document.getElementById('unifiedLogModal').classList.add('active');
            // Default to today's meals tab
            switchLogTab('todaysMeals');
            // Update modal content
            updateModalContent();
        }

        function closeUnifiedLogModal() {
            document.getElementById('unifiedLogModal').classList.remove('active');
        }

        // Tab switching functions
        function switchAddTab(tabName) {
            console.log('üîÑ TAB: Switching to tab:', tabName);
            
            // Hide all tab contents
            const contents = document.querySelectorAll('.add-tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('.add-tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-orange-500', 'text-orange-600');
            
            // Handle specific tab initialization
            if (tabName === 'addIngredient') {
                console.log('ü•¨ TAB: Enhanced Add Ingredient tab opened');
                // Ensure ingredients are loaded for the enhanced functionality
                if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                    console.log('üîÑ TAB: Loading ingredients for enhanced ingredient tab...');
                    showSuccessMessage('üîÑ Loading ingredient database...');
                    
                    loadDatabases().then(() => {
                        console.log('‚úÖ TAB: Ingredients loaded for enhanced tab');
                        showSuccessMessage('‚úÖ Enhanced ingredient selection ready! Search for ingredients with real nutrition data.');
                        // Focus on the search input
                        setTimeout(() => {
                            const searchInput = document.getElementById('enhancedIngredientSearch');
                            if (searchInput) {
                                searchInput.focus();
                            }
                        }, 100);
                    }).catch(error => {
                        console.error('‚ùå TAB: Failed to load ingredients:', error);
                        showErrorMessage('Failed to load ingredients: ' + error.message);
                    });
                } else {
                    console.log('‚úÖ TAB: Ingredients already loaded');
                    showSuccessMessage('‚úÖ Enhanced ingredient selection ready! Search from our ingredient database.');
                    // Focus on the search input for immediate use
                    setTimeout(() => {
                        const searchInput = document.getElementById('enhancedIngredientSearch');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 100);
                }
            }
            // If switching to meal builder tab, ensure ingredients are loaded
            else if (tabName === 'mealBuilder') {
                console.log('üîÑ TAB: Meal builder tab opened, checking ingredients...');
                console.log('üîÑ TAB: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
                
                // Always ensure ingredients are loaded for meal builder
                if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                    console.log('‚ö†Ô∏è TAB: Ingredients not loaded, loading now...');
                    showSuccessMessage('üîÑ Loading ingredients for meal builder...');
                    
                    loadDatabases().then(() => {
                        console.log('‚úÖ TAB: Ingredients loaded successfully');
                        console.log('üìä TAB: Available categories:', rawIngredients ? Object.keys(rawIngredients) : 'NONE');
                        
                        // Verify specific ingredients for testing
                        if (rawIngredients && rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                            console.log('‚úÖ TAB: Test ingredient "Lauki" found:', rawIngredients.vegetables.lauki.name);
                        }
                        
                        showSuccessMessage('‚úÖ Ingredients loaded! You can now search for ingredients like "Egg", "Rice", etc.');
                    }).catch(error => {
                        console.error('‚ùå TAB: Failed to load ingredients:', error);
                        showErrorMessage('Failed to load ingredients: ' + error.message);
                    });
                } else {
                    console.log('‚úÖ TAB: Ingredients already loaded');
                    console.log('üìä TAB: Available categories:', Object.keys(rawIngredients));
                    
                    // Show helpful message to user
                    showSuccessMessage('‚úÖ Meal builder ready! Search for ingredients to get started.');
                }
                
            }
        }

        function switchLogTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.log-tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('.log-tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-orange-500', 'text-orange-600');
            
            // Update content based on tab
            if (tabName === 'todaysMeals') {
                updateModalFoodLog();
            } else if (tabName === 'dailySummary') {
                updateModalDailySummary();
            }
        }

        // Populate quick dishes in modal
        function populateQuickDishesInModal() {
            console.log('üçΩÔ∏è MODAL_DISHES: populateQuickDishesInModal() called');
            const container = document.getElementById('quickDishesInModal');
            console.log('üçΩÔ∏è MODAL_DISHES: quickDishesInModal element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è MODAL_DISHES: quickDishesInModal not found - skipping population');
                return;
            }
            
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            
            container.innerHTML = Object.entries(allDishes).map(([key, dish]) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-200">
                    <div>
                        <div class="font-medium text-gray-800">${dish.name}</div>
                        <div class="text-sm text-gray-600">${dish.total_per_serving.calories} cal/serving ‚Ä¢ ${dish.category}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${customRecipes[key] ? `<button onclick="editRecipe('${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>` : ''}
                        <input type="number" value="1" min="0.5" step="0.5" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm" id="modal_servings_${key}">
                        <button onclick="addQuickDishFromModal('${key}')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Add
                        </button>
                        ${customRecipes[key] ? `<button onclick="deleteRecipe('${key}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">&times;</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            console.log('‚úÖ MODAL_DISHES: Quick dishes populated successfully');
        }

        // Modal-specific functions
        function addQuickDishFromModal(dishKey) {
            const servings = parseFloat(document.getElementById(`modal_servings_${dishKey}`).value);
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            const dish = allDishes[dishKey];
            
            if (!dish) return;
            
            const nutrition = dish.total_per_serving;
            const meal = {
                id: Date.now(),
                description: `${dish.name} (${servings} serving${servings !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(nutrition.calories * servings),
                    protein: Math.round(nutrition.protein * servings * 10) / 10,
                    carbs: Math.round(nutrition.carbs * servings * 10) / 10,
                    fat: Math.round(nutrition.fat * servings * 10) / 10,
                    fiber: Math.round(nutrition.fiber * servings * 10) / 10
                },
                source: 'database'
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            updateModalContent(); // Update modal content too
            
            // Reset serving size
            document.getElementById(`modal_servings_${dishKey}`).value = 1;
            
            showSuccessMessage(`Added ${dish.name}!`);
        }

        function addCustomEntryFromModal() {
            const description = document.getElementById('modalCustomDish').value.trim();
            const servings = parseFloat(document.getElementById('modalCustomServings').value);
            const calories = parseInt(document.getElementById('modalCustomCalories').value) || estimateCalories(description);
            
            if (!description) {
                alert('Please enter a dish description');
                return;
            }
            
            const meal = {
                id: Date.now(),
                description: description,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(calories * servings),
                    protein: Math.round(calories * 0.15 / 4), // Rough estimate
                    carbs: Math.round(calories * 0.55 / 4),
                    fat: Math.round(calories * 0.30 / 9),
                    fiber: Math.round(calories * 0.02)
                },
                source: 'custom'
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            updateModalContent(); // Update modal content too
            
            // Clear form
            document.getElementById('modalCustomDish').value = '';
            document.getElementById('modalCustomServings').value = 1;
            document.getElementById('modalCustomCalories').value = '';
            
            showSuccessMessage('Added custom entry!');
        }

        // Functions to open existing modals from unified modal
        function openRecipeBuilderFromModal() {
            closeUnifiedAddModal();
            openRecipeBuilder();
        }

        function openMealBuilderFromModal() {
            closeUnifiedAddModal();
            openMealBuilder();
        }

        function openIngredientModalFromModal() {
            closeUnifiedAddModal();
            openIngredientModal();
        }

        function reloadIngredientsFromModal() {
            console.log('üîÑ MODAL_RELOAD: reloadIngredientsFromModal() called');
            console.log('üîÑ MODAL_RELOAD: This function should only reload the database, not update UI elements');
            
            // Only reload the database without trying to update UI elements that don't exist in this context
            console.log('üîÑ MODAL_RELOAD: Reloading database only...');
            showSuccessMessage('üîÑ Reloading ingredients database...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MODAL_RELOAD: Database reload completed successfully');
                showSuccessMessage('‚úÖ Ingredients database reloaded successfully!');
                // Update any UI elements that exist in the current modal context
                const quickDishesContainer = document.getElementById('quickDishesInModal');
                if (quickDishesContainer) {
                    populateQuickDishesInModal();
                } else {
                    console.log('‚ö†Ô∏è MODAL_RELOAD: quickDishesInModal not found, skipping UI update');
                }
            }).catch(error => {
                console.error('‚ùå MODAL_RELOAD: Database reload failed:', error);
                showErrorMessage('Error reloading ingredients database: ' + error.message);
            });
        }

        function openExportModalFromModal() {
            closeUnifiedLogModal();
            openExportModal();
        }

        // Update modal content
        function updateModalContent() {
            updateModalFoodLog();
            updateModalDailySummary();
        }

        function updateModalFoodLog() {
            const modalFoodLog = document.getElementById('modalFoodLog');
            const currentMeals = getCurrentDateMeals();
            
            if (currentMeals.length === 0) {
                modalFoodLog.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No meals logged yet. Use the "Add Meal or Ingredient" button to add meals!</p>
                    </div>
                `;
                return;
            }

            const sortedMeals = [...currentMeals].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            modalFoodLog.innerHTML = sortedMeals.map(meal => `
                <div class="border border-gray-200 rounded-lg p-4 fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${meal.description}</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${formatTime(new Date(meal.timestamp))}</span>
                            <button onclick="removeMeal(${meal.id}); updateModalContent();" class="text-red-500 hover:text-red-700 text-sm">&times;</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2 text-sm">
                        <div class="bg-orange-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-orange-600">${meal.nutrition.calories}</div>
                            <div class="text-orange-500 text-xs">Calories</div>
                        </div>
                        <div class="bg-blue-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-blue-600">${meal.nutrition.protein}g</div>
                            <div class="text-blue-500 text-xs">Protein</div>
                        </div>
                        <div class="bg-yellow-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-yellow-600">${meal.nutrition.carbs}g</div>
                            <div class="text-yellow-500 text-xs">Carbs</div>
                        </div>
                        <div class="bg-green-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-green-600">${meal.nutrition.fat}g</div>
                            <div class="text-green-500 text-xs">Fat</div>
                        </div>
                        <div class="bg-purple-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-purple-600">${meal.nutrition.fiber}g</div>
                            <div class="text-purple-500 text-xs">Fiber</div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        Source: ${meal.source === 'database' ? 'Indian Food Database' : meal.source === 'ingredients' ? 'Basic Ingredients' : 'Custom Entry'}
                        ${meal.ingredients ? `
                            <details class="mt-2">
                                <summary class="cursor-pointer text-gray-600 hover:text-gray-800">View ingredients (${meal.ingredients.length})</summary>
                                <div class="mt-1 space-y-1 pl-4">
                                    ${meal.ingredients.map(ing => `
                                        <div class="flex justify-between text-xs">
                                            <span>${ing.name} (${ing.quantity}x ${ing.measurement})</span>
                                            <span class="text-gray-500">${ing.nutrition.calories} cal</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateModalDailySummary() {
            const currentMeals = getCurrentDateMeals();

            const totals = currentMeals.reduce((acc, meal) => {
                acc.calories += meal.nutrition.calories;
                acc.protein += meal.nutrition.protein;
                acc.fiber += meal.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, fiber: 0});

            document.getElementById('modalTotalCalories').textContent = totals.calories;
            document.getElementById('modalMealCount').textContent = currentMeals.length;
            document.getElementById('modalTotalProtein').textContent = Math.round(totals.protein * 10) / 10 + 'g';
            document.getElementById('modalTotalFiber').textContent = Math.round(totals.fiber * 10) / 10 + 'g';
            
            // Update selected date display
            const modalSelectedDate = document.getElementById('modalSelectedDate');
            if (modalSelectedDate) {
                modalSelectedDate.textContent = formatDateDisplay(selectedDate);
            }
        }

        function clearModalForms() {
            // Clear custom entry form
            const customDish = document.getElementById('modalCustomDish');
            const customServings = document.getElementById('modalCustomServings');
            const customCalories = document.getElementById('modalCustomCalories');
            
            if (customDish) customDish.value = '';
            if (customServings) customServings.value = 1;
            if (customCalories) customCalories.value = '';
        }

        // Update populateQuickDishes to also update modal when called
        const originalPopulateQuickDishes = populateQuickDishes;
        populateQuickDishes = function() {
            originalPopulateQuickDishes();
            // Also update modal if it exists
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
        };

        // ========================================
        // SIMPLE INGREDIENT MANAGEMENT FUNCTIONS
        // ========================================
        
        // Global variable to store simple ingredients data
        let simpleIngredientsData = null;
        
        // Simple function to load ingredients from server
        async function simpleLoadIngredients() {
            console.log('üîÑ SIMPLE: Loading ingredients from server...');
            
            try {
                const response = await fetch('/api/ingredients');
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                simpleIngredientsData = data.basic_ingredients;
                
                console.log('‚úÖ SIMPLE: Ingredients loaded successfully');
                console.log('üìä SIMPLE: Categories:', Object.keys(simpleIngredientsData));
                
                return simpleIngredientsData;
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Failed to load ingredients:', error);
                throw error;
            }
        }
        
        // Simple function to display ingredients in the list
        function simpleDisplayIngredients() {
            console.log('üé® SIMPLE: Displaying ingredients...');
            
            const container = document.getElementById('simpleIngredientsList');
            if (!container) {
                console.error('‚ùå SIMPLE: simpleIngredientsList container not found');
                return;
            }
            
            if (!simpleIngredientsData) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No ingredients loaded. Click "Reload" to load ingredients.</div>';
                return;
            }
            
            const filterCategory = document.getElementById('simpleFilterCategory')?.value || '';
            let html = '';
            let totalCount = 0;
            
            Object.entries(simpleIngredientsData).forEach(([category, ingredients]) => {
                if (filterCategory && category !== filterCategory) return;
                
                const categoryName = category.replace(/_/g, ' ').toUpperCase();
                html += `<div class="mb-4">`;
                html += `<h6 class="font-semibold text-gray-700 mb-2 text-sm">${categoryName}</h6>`;
                
                Object.entries(ingredients).forEach(([key, ingredient]) => {
                    const measurementCount = Object.keys(ingredient.measurements).length;
                    totalCount++;
                    
                    html += `
                        <div class="bg-gray-50 p-3 rounded-lg mb-2 border">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-gray-800">${ingredient.name}</div>
                                    <div class="text-sm text-gray-600">${measurementCount} measurement${measurementCount !== 1 ? 's' : ''}</div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="simpleEditIngredient('${category}', '${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>
                                    <button onclick="simpleDeleteIngredient('${category}', '${key}', '${ingredient.name}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Delete</button>
                                </div>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">View measurements</summary>
                                <div class="mt-1 space-y-1 pl-4">
                                    ${Object.entries(ingredient.measurements).map(([measureKey, nutrition]) => `
                                        <div class="flex justify-between text-xs">
                                            <span>${measureKey.replace(/_/g, ' ')}</span>
                                            <span class="text-gray-500">${nutrition.calories} cal</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            if (totalCount === 0) {
                html = '<div class="text-center text-gray-500 py-4">No ingredients found for the selected category.</div>';
            }
            
            container.innerHTML = html;
            console.log(`‚úÖ SIMPLE: Displayed ${totalCount} ingredients`);
        }
        
        // Simple reload function
        async function simpleReloadIngredients() {
            console.log('üîÑ SIMPLE: Reload requested...');
            
            const container = document.getElementById('simpleIngredientsList');
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-gray-600">Loading ingredients...</span>
                    </div>
                `;
            }
            
            try {
                await simpleLoadIngredients();
                simpleDisplayIngredients();
                
                // Also update the main app's ingredients if needed
                rawIngredients = simpleIngredientsData;
                populateIngredientSelect();
                
                showSuccessMessage('‚úÖ Ingredients reloaded successfully!');
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Reload failed:', error);
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-red-500 mb-2">‚ùå Failed to load ingredients</div>
                            <div class="text-sm text-gray-600">${error.message}</div>
                            <button onclick="simpleReloadIngredients()" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                Retry
                            </button>
                        </div>
                    `;
                }
                showErrorMessage('Failed to reload ingredients: ' + error.message);
            }
        }
        
        // Simple filter function
        function simpleFilterIngredients() {
            simpleDisplayIngredients();
        }
        
        // Simple add ingredient function
        async function simpleAddIngredient() {
            const name = document.getElementById('simpleIngredientName').value.trim();
            const category = document.getElementById('simpleIngredientCategory').value;
            const measurementKey = document.getElementById('simpleMeasurementKey').value.trim();
            const calories = parseFloat(document.getElementById('simpleCalories').value) || 0;
            const protein = parseFloat(document.getElementById('simpleProtein').value) || 0;
            const carbs = parseFloat(document.getElementById('simpleCarbs').value) || 0;
            const fat = parseFloat(document.getElementById('simpleFat').value) || 0;
            const fiber = parseFloat(document.getElementById('simpleFiber').value) || 0;
            
            if (!name || !category || !measurementKey) {
                alert('Please fill in ingredient name, category, and measurement key');
                return;
            }
            
            const ingredientKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const ingredientData = {
                name: name,
                measurements: {
                    [measurementKey]: {
                        calories: calories,
                        protein: protein,
                        carbs: carbs,
                        fat: fat,
                        fiber: fiber
                    }
                }
            };
            
            try {
                const response = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category: category,
                        ingredientKey: ingredientKey,
                        ingredientData: ingredientData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`‚úÖ Ingredient "${name}" added successfully!`);
                    simpleClearForm();
                    simpleReloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to add ingredient');
                }
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Failed to add ingredient:', error);
                showErrorMessage('Failed to add ingredient: ' + error.message);
            }
        }
        
        // Simple delete ingredient function
        async function simpleDeleteIngredient(category, ingredientKey, ingredientName) {
            if (!confirm(`Are you sure you want to delete "${ingredientName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ingredients/${category}/${ingredientKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`‚úÖ Ingredient "${ingredientName}" deleted successfully!`);
                    simpleReloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to delete ingredient');
                }
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Failed to delete ingredient:', error);
                showErrorMessage('Failed to delete ingredient: ' + error.message);
            }
        }
        
        // Simple edit ingredient function (basic implementation)
        function simpleEditIngredient(category, ingredientKey) {
            const ingredient = simpleIngredientsData[category][ingredientKey];
            
            // Fill form with existing data
            document.getElementById('simpleIngredientName').value = ingredient.name;
            document.getElementById('simpleIngredientCategory').value = category;
            
            // For simplicity, just fill with the first measurement
            const firstMeasurement = Object.entries(ingredient.measurements)[0];
            if (firstMeasurement) {
                const [measureKey, nutrition] = firstMeasurement;
                document.getElementById('simpleMeasurementKey').value = measureKey;
                document.getElementById('simpleCalories').value = nutrition.calories;
                document.getElementById('simpleProtein').value = nutrition.protein;
                document.getElementById('simpleCarbs').value = nutrition.carbs;
                document.getElementById('simpleFat').value = nutrition.fat;
                document.getElementById('simpleFiber').value = nutrition.fiber;
            }
            
            showSuccessMessage(`üìù Loaded "${ingredient.name}" for editing. Modify and click "Add Ingredient" to update.`);
        }
        
        // Simple clear form function
        function simpleClearForm() {
            document.getElementById('simpleIngredientName').value = '';
            document.getElementById('simpleIngredientCategory').value = '';
            document.getElementById('simpleMeasurementKey').value = '';
            document.getElementById('simpleCalories').value = '';
            document.getElementById('simpleProtein').value = '';
            document.getElementById('simpleCarbs').value = '';
            document.getElementById('simpleFat').value = '';
            document.getElementById('simpleFiber').value = '';
        }

        // ========================================
        // INLINE MEAL BUILDER FUNCTIONS
        // ========================================
        
        let inlineCurrentMealIngredients = [];

        function clearInlineMealBuilder() {
            // Clear both arrays to ensure compatibility
            inlineCurrentMealIngredients = [];
            inlineMealItems = [];
            document.getElementById('inlineMealName').value = '';
            document.getElementById('inlineMealServings').value = 1;
            document.getElementById('inlineMealServingsToLog').value = 1;
            clearInlineMealRecipeForm();
            updateInlineMealPreview();
        }

        function removeInlineMealItem(index) {
            // Remove from both arrays to maintain compatibility
            if (inlineCurrentMealIngredients.length > index) {
                inlineCurrentMealIngredients.splice(index, 1);
            }
            if (inlineMealItems.length > index) {
                inlineMealItems.splice(index, 1);
            }
            updateInlineMealPreview();
        }

        // Keep the old function name for backward compatibility
        function removeInlineMealIngredient(index) {
            removeInlineMealItem(index);
        }

        function updateInlineMealPreview() {
            const preview = document.getElementById('inlineMealPreview');
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add recipes to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Items in Meal (${inlineMealItems.length}):</h5>
                    ${inlineMealItems.map((item, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <div>
                                <span class="font-medium">${item.displayText || (item.name + ' (' + item.quantity + 'x ' + item.measurementDisplay + ')')}</span>
                                <span class="text-xs text-gray-500 ml-2">${item.type === 'recipe' ? 'üçΩÔ∏è' : 'ü•¨'} ${Math.round(item.nutrition.calories)} cal</span>
                            </div>
                            <button onclick="removeInlineMealItem(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addInlineMealToLog() {
            const mealName = document.getElementById('inlineMealName').value.trim();
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                alert('Please add recipes or ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${inlineMealItems.length} items)`;
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'mixed_meal',
                items: inlineMealItems.map(item => ({
                    type: item.type,
                    name: item.name,
                    displayText: item.displayText,
                    nutrition: item.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            clearInlineMealBuilder();
            showSuccessMessage(`Added "${finalMealName}" to your food log!`);
        }

        // ========================================
        // ENHANCED MEAL BUILDER WITH RECIPES & INGREDIENTS
        // ========================================
        
        let inlineMealItems = []; // Combined array for both recipes and ingredients
        let inlineSelectedMealRecipe = null;
        let currentMealItemType = 'recipes'; // 'recipes' or 'ingredients'
        
        
        // Ensure recipes are loaded
        function ensureRecipesLoaded() {
            if (!foodDatabase || !foodDatabase.dishes || Object.keys(foodDatabase.dishes).length === 0) {
                console.log('üîÑ RECIPES: Loading recipes database...');
                loadDatabases().then(() => {
                    console.log('‚úÖ RECIPES: Recipes loaded successfully');
                }).catch(error => {
                    console.error('‚ùå RECIPES: Failed to load recipes:', error);
                    showErrorMessage('Failed to load recipes: ' + error.message);
                });
            }
        }
        
        // Ensure ingredients are loaded
        function ensureIngredientsLoaded() {
            console.log('üîÑ ENSURE_INGREDIENTS: ensureIngredientsLoaded() called');
            console.log('üîÑ ENSURE_INGREDIENTS: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('üîÑ ENSURE_INGREDIENTS: Loading ingredients database...');
                showSuccessMessage('üîÑ Loading ingredients for meal builder...');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ ENSURE_INGREDIENTS: Ingredients loaded successfully');
                    console.log('üìä ENSURE_INGREDIENTS: Categories loaded:', rawIngredients ? Object.keys(rawIngredients) : 'NONE');
                    showSuccessMessage('‚úÖ Ingredients loaded! You can now search and add ingredients.');
                }).catch(error => {
                    console.error('‚ùå ENSURE_INGREDIENTS: Failed to load ingredients:', error);
                    showErrorMessage('Failed to load ingredients: ' + error.message);
                });
            } else {
                console.log('‚úÖ ENSURE_INGREDIENTS: Ingredients already loaded');
                console.log('üìä ENSURE_INGREDIENTS: Categories available:', Object.keys(rawIngredients));
            }
        }
        
        // Filter recipes for meal builder
        function filterInlineMealRecipes() {
            const searchTerm = document.getElementById('inlineMealRecipeSearch').value.toLowerCase();
            const dropdown = document.getElementById('inlineMealRecipeDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                document.getElementById('inlineMealRecipeInputs').style.display = 'none';
                return;
            }

            if (!foodDatabase || !foodDatabase.dishes || Object.keys(foodDatabase.dishes).length === 0) {
                console.log('üîÑ FILTER_RECIPES: Recipes not loaded, loading now...');
                dropdown.innerHTML = '<div class="px-3 py-2 text-blue-600 text-center">üîÑ Loading recipes...</div>';
                dropdown.classList.remove('hidden');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ FILTER_RECIPES: Recipes loaded, retrying filter');
                    filterInlineMealRecipes();
                }).catch(error => {
                    console.error('‚ùå FILTER_RECIPES: Failed to load recipes:', error);
                    dropdown.innerHTML = '<div class="px-3 py-2 text-red-600 text-center">‚ùå Failed to load recipes</div>';
                });
                return;
            }

            let html = '';
            let hasResults = false;
            
            // Combine server recipes and custom recipes
            const allRecipes = {...foodDatabase.dishes, ...customRecipes};

            Object.entries(allRecipes).forEach(([key, recipe]) => {
                if (recipe.name.toLowerCase().includes(searchTerm)) {
                    hasResults = true;
                    html += `
                        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             onclick="selectInlineMealRecipe('${key}', '${recipe.name}')">
                            <div class="font-medium text-gray-800">${recipe.name}</div>
                            <div class="text-xs text-gray-500">${recipe.total_per_serving.calories} cal/serving ‚Ä¢ ${recipe.category}</div>
                        </div>
                    `;
                }
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No recipes found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }
        
        // Select a recipe for the meal
        function selectInlineMealRecipe(recipeKey, recipeName) {
            inlineSelectedMealRecipe = { key: recipeKey, name: recipeName };
            
            // Update the search input and hide dropdown
            document.getElementById('inlineMealRecipeSearch').value = recipeName;
            document.getElementById('inlineMealRecipeDropdown').classList.add('hidden');
            
            // Show the recipe inputs
            document.getElementById('inlineSelectedMealRecipe').value = recipeName;
            document.getElementById('inlineMealRecipeInputs').style.display = 'grid';
        }
        
        // Add recipe to meal
        function addInlineMealRecipe() {
            console.log('üîÑ ADD_RECIPE: addInlineMealRecipe() called');
            
            if (!inlineSelectedMealRecipe) {
                showErrorMessage('Please search for and select a recipe first');
                return;
            }
            
            const servingsInput = document.getElementById('inlineMealRecipeServings');
            if (!servingsInput.value) {
                showErrorMessage('Please enter number of servings');
                return;
            }
            
            const servings = parseFloat(servingsInput.value);
            const { key, name } = inlineSelectedMealRecipe;
            
            // Get recipe data
            const allRecipes = {...foodDatabase.dishes, ...customRecipes};
            const recipe = allRecipes[key];
            
            if (!recipe) {
                showErrorMessage(`Recipe ${name} not found`);
                return;
            }
            
            const recipeEntry = {
                type: 'recipe',
                key: key,
                name: name,
                servings: servings,
                nutrition: {
                    calories: recipe.total_per_serving.calories * servings,
                    protein: recipe.total_per_serving.protein * servings,
                    carbs: recipe.total_per_serving.carbs * servings,
                    fat: recipe.total_per_serving.fat * servings,
                    fiber: recipe.total_per_serving.fiber * servings
                },
                displayText: `${name} (${servings} serving${servings !== 1 ? 's' : ''})`
            };
            
            inlineMealItems.push(recipeEntry);
            
            // Clear inputs
            clearInlineMealRecipeForm();
            updateEnhancedInlineMealPreview();
            
            showSuccessMessage(`‚úÖ Added ${name} to meal!`);
        }
        
        // Clear recipe form
        function clearInlineMealRecipeForm() {
            document.getElementById('inlineMealRecipeSearch').value = '';
            document.getElementById('inlineSelectedMealRecipe').value = '';
            document.getElementById('inlineMealRecipeServings').value = 1;
            document.getElementById('inlineMealRecipeDropdown').classList.add('hidden');
            document.getElementById('inlineMealRecipeInputs').style.display = 'none';
            inlineSelectedMealRecipe = null;
        }
        
        // Enhanced clear function (this will override the previous one)
        function clearInlineMealBuilder() {
            inlineMealItems = [];
            inlineCurrentMealIngredients = []; // Keep compatibility with old system
            document.getElementById('inlineMealName').value = '';
            document.getElementById('inlineMealServings').value = 1;
            document.getElementById('inlineMealServingsToLog').value = 1;
            clearInlineMealRecipeForm();
            clearInlineMealIngredientForm();
            updateInlineMealPreview(); // Use the overridden version that handles both systems
        }
        
        // Remove item from meal
        function removeInlineMealItem(index) {
            inlineMealItems.splice(index, 1);
            updateEnhancedInlineMealPreview();
        }
        
        // Enhanced preview function
        function updateEnhancedInlineMealPreview() {
            const preview = document.getElementById('inlineMealPreview');
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add recipes and ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Items in Meal (${inlineMealItems.length}):</h5>
                    ${inlineMealItems.map((item, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <div>
                                <span class="font-medium">${item.displayText}</span>
                                <span class="text-xs text-gray-500 ml-2">${item.type === 'recipe' ? 'üçΩÔ∏è' : 'ü•¨'} ${Math.round(item.nutrition.calories)} cal</span>
                            </div>
                            <button onclick="removeInlineMealItem(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Enhanced add to log function
        function addInlineMealToLog() {
            const mealName = document.getElementById('inlineMealName').value.trim();
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                alert('Please add recipes or ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${inlineMealItems.length} items)`;
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'mixed_meal',
                items: inlineMealItems.map(item => ({
                    type: item.type,
                    name: item.name,
                    displayText: item.displayText,
                    nutrition: item.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            clearInlineMealBuilder();
            showSuccessMessage(`‚úÖ Added "${finalMealName}" to your food log!`);
        }
        
        

        // ========================================
        // ENHANCED DATA LOADING FOR MEAL CREATION
        // ========================================
        
        // Function to ensure data is loaded before meal creation operations
        async function ensureDataLoadedForMealCreation() {
            console.log('üîÑ ENSURE_DATA: ensureDataLoadedForMealCreation() called');
            console.log('üîÑ ENSURE_DATA: Current state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üîÑ ENSURE_DATA: Current state - foodDatabase:', foodDatabase ? 'EXISTS' : 'NULL');
            
            // Check if data is already loaded
            const ingredientsLoaded = rawIngredients && Object.keys(rawIngredients).length > 0;
            const recipesLoaded = foodDatabase && foodDatabase.dishes && Object.keys(foodDatabase.dishes).length > 0;
            
            if (ingredientsLoaded && recipesLoaded) {
                console.log('‚úÖ ENSURE_DATA: All data already loaded');
                return { success: true, message: 'Data already loaded' };
            }
            
            console.log('üîÑ ENSURE_DATA: Loading missing data...');
            showLoadingIndicator('Preparing meal creation tools...');
            
            try {
                await loadDatabases();
                
                // Verify data was loaded successfully
                const finalIngredientsCheck = rawIngredients && Object.keys(rawIngredients).length > 0;
                const finalRecipesCheck = foodDatabase && foodDatabase.dishes && Object.keys(foodDatabase.dishes).length > 0;
                
                if (!finalIngredientsCheck) {
                    throw new Error('Failed to load ingredients database');
                }
                
                if (!finalRecipesCheck) {
                    throw new Error('Failed to load recipes database');
                }
                
                console.log('‚úÖ ENSURE_DATA: All data loaded successfully');
                console.log('üìä ENSURE_DATA: Ingredients categories:', Object.keys(rawIngredients));
                console.log('üìä ENSURE_DATA: Recipes count:', Object.keys(foodDatabase.dishes).length);
                
                hideLoadingIndicator();
                return {
                    success: true,
                    message: 'All data loaded successfully',
                    ingredientsCount: Object.values(rawIngredients).reduce((total, category) => total + Object.keys(category).length, 0),
                    recipesCount: Object.keys(foodDatabase.dishes).length
                };
                
            } catch (error) {
                console.error('‚ùå ENSURE_DATA: Failed to load data:', error);
                hideLoadingIndicator();
                return {
                    success: false,
                    error: error.message,
                    message: 'Failed to load required data for meal creation'
                };
            }
        }
        
        // Enhanced meal creation workflow with data validation
        async function startMealCreationWorkflow(workflowType = 'ingredient') {
            console.log('üöÄ WORKFLOW: Starting meal creation workflow:', workflowType);
            
            // Show immediate feedback
            showSuccessMessage('üîÑ Preparing meal creation tools...');
            
            try {
                // Ensure all required data is loaded
                const dataResult = await ensureDataLoadedForMealCreation();
                
                if (!dataResult.success) {
                    throw new Error(dataResult.message || 'Failed to load required data');
                }
                
                console.log('‚úÖ WORKFLOW: Data validation passed');
                
                // Provide success feedback with data stats
                if (dataResult.ingredientsCount && dataResult.recipesCount) {
                    showSuccessMessage(`‚úÖ Ready! Loaded ${dataResult.ingredientsCount} ingredients and ${dataResult.recipesCount} recipes.`);
                } else {
                    showSuccessMessage('‚úÖ Meal creation tools ready!');
                }
                
                // Return success status for calling functions
                return { success: true, data: dataResult };
                
            } catch (error) {
                console.error('‚ùå WORKFLOW: Meal creation workflow failed:', error);
                
                // Show user-friendly error with actionable guidance
                const errorMessage = error.message.includes('internet') || error.message.includes('network')
                    ? 'Network connection issue. Please check your internet connection and try again.'
                    : error.message.includes('server')
                    ? 'Server connection issue. Please make sure the server is running and try again.'
                    : `Unable to load meal creation data: ${error.message}`;
                
                showCriticalError(`${errorMessage}\n\nTry these solutions:\n‚Ä¢ Refresh the page\n‚Ä¢ Check your internet connection\n‚Ä¢ Make sure the server is running\n‚Ä¢ Contact support if the issue persists`);
                
                return { success: false, error: error.message };
            }
        }
        
        // Enhanced error messages for specific meal creation scenarios
        function showMealCreationError(errorType, context = {}) {
            console.log('‚ùå MEAL_ERROR: showMealCreationError() called:', errorType, context);
            
            let title = 'Meal Creation Error';
            let message = 'An error occurred while creating your meal.';
            let suggestions = [];
            
            switch (errorType) {
                case 'ingredients_not_loaded':
                    title = 'Ingredients Not Available';
                    message = 'The ingredients database is not loaded yet.';
                    suggestions = [
                        'Wait a moment for ingredients to load automatically',
                        'Click "Reload" to manually refresh ingredients',
                        'Check your internet connection',
                        'Refresh the page if the problem persists'
                    ];
                    break;
                    
                case 'recipes_not_loaded':
                    title = 'Recipes Not Available';
                    message = 'The recipes database is not loaded yet.';
                    suggestions = [
                        'Wait a moment for recipes to load automatically',
                        'Try refreshing the page',
                        'Check your internet connection',
                        'Contact support if the issue continues'
                    ];
                    break;
                    
                case 'ingredient_not_found':
                    title = 'Ingredient Not Found';
                    message = `The ingredient "${context.ingredientName || 'selected ingredient'}" could not be found in the database.`;
                    suggestions = [
                        'Try searching for a different ingredient',
                        'Check the spelling of the ingredient name',
                        'Reload ingredients to refresh the database',
                        'Add the ingredient manually if you have server access'
                    ];
                    break;
                    
                case 'measurement_not_found':
                    title = 'Measurement Not Available';
                    message = `The measurement "${context.measurement || 'selected measurement'}" is not available for "${context.ingredientName || 'this ingredient'}".`;
                    suggestions = [
                        'Try selecting a different measurement option',
                        'Check if the ingredient data is complete',
                        'Contact support to add missing measurements'
                    ];
                    break;
                    
                case 'network_error':
                    title = 'Connection Problem';
                    message = 'Unable to connect to the server to load meal data.';
                    suggestions = [
                        'Check your internet connection',
                        'Make sure the server is running (npm start)',
                        'Try refreshing the page',
                        'Wait a moment and try again'
                    ];
                    break;
                    
                case 'validation_error':
                    title = 'Input Validation Error';
                    message = context.message || 'Please check your input and try again.';
                    suggestions = [
                        'Make sure all required fields are filled',
                        'Check that quantities are positive numbers',
                        'Verify that measurements are selected',
                        'Try clearing the form and starting over'
                    ];
                    break;
                    
                default:
                    title = 'Unexpected Error';
                    message = context.message || 'An unexpected error occurred during meal creation.';
                    suggestions = [
                        'Try refreshing the page',
                        'Clear your browser cache',
                        'Check the browser console for more details',
                        'Contact support if the problem persists'
                    ];
            }
            
            // Create enhanced error display
            const errorHtml = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-red-600 text-5xl mb-3">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 class="font-semibold text-blue-800 mb-2">üí° Try these solutions:</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            ${suggestions.map(suggestion => `<li>‚Ä¢ ${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="location.reload()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üîÑ Refresh Page
                        </button>
                        <button onclick="reloadIngredients().catch(console.error)" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üì• Reload Data
                        </button>
                        <button onclick="document.getElementById('mealCreationError').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Continue Anyway
                        </button>
                    </div>
                </div>
            `;
            
            // Remove existing error if present
            const existingError = document.getElementById('mealCreationError');
            if (existingError) {
                existingError.remove();
            }
            
            // Create and show error modal
            const errorDiv = document.createElement('div');
            errorDiv.id = 'mealCreationError';
            errorDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            errorDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    ${errorHtml}
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Also show a toast notification
            showErrorMessage(`${title}: ${message}`);
        }



        // ========================================
        // ENHANCED INGREDIENT ADDITION FUNCTIONS
        // ========================================
        
        let selectedEnhancedIngredient = null;
        
        function filterEnhancedIngredients() {
            console.log('üîÑ ENHANCED_INGREDIENT: filterEnhancedIngredients() called');
            const searchTerm = document.getElementById('enhancedIngredientSearch').value.toLowerCase();
            const dropdown = document.getElementById('enhancedIngredientDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                clearEnhancedIngredientSelection();
                return;
            }

            // Check if rawIngredients is loaded
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('üîÑ ENHANCED_INGREDIENT: Raw ingredients not loaded, loading now...');
                dropdown.innerHTML = '<div class="px-3 py-2 text-blue-600 text-center">üîÑ Loading ingredients...</div>';
                dropdown.classList.remove('hidden');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ ENHANCED_INGREDIENT: Ingredients loaded, retrying filter');
                    filterEnhancedIngredients();
                }).catch(error => {
                    console.error('‚ùå ENHANCED_INGREDIENT: Failed to load ingredients:', error);
                    dropdown.innerHTML = '<div class="px-3 py-2 text-red-600 text-center">‚ùå Failed to load ingredients</div>';
                });
                return;
            }

            let html = '';
            let hasResults = false;

            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    if (item.name.toLowerCase().includes(searchTerm)) {
                        hasResults = true;
                        html += `
                            <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                                 onclick="selectEnhancedIngredient('${category}', '${key}', '${item.name.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500">${categoryName} ‚Ä¢ ${Object.keys(item.measurements).length} measurement${Object.keys(item.measurements).length !== 1 ? 's' : ''}</div>
                            </div>
                        `;
                    }
                });
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No ingredients found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }
        
        function selectEnhancedIngredient(category, key, name) {
            console.log('üîÑ ENHANCED_INGREDIENT: selectEnhancedIngredient() called', { category, key, name });
            
            // Validate that ingredient exists
            if (!rawIngredients || !rawIngredients[category] || !rawIngredients[category][key]) {
                console.error('‚ùå ENHANCED_INGREDIENT: Ingredient not found:', { category, key, name });
                showErrorMessage(`Ingredient "${name}" not found. Please try reloading ingredients.`);
                return;
            }
            
            selectedEnhancedIngredient = { category, key, name };
            const ingredient = rawIngredients[category][key];
            
            // Update search input and hide dropdown
            document.getElementById('enhancedIngredientSearch').value = name;
            document.getElementById('enhancedIngredientDropdown').classList.add('hidden');
            
            // Show selected ingredient section
            document.getElementById('selectedIngredientSection').classList.remove('hidden');
            document.getElementById('selectedIngredientName').textContent = name;
            
            // Populate measurements
            populateEnhancedMeasurements(ingredient);
            
            // Show measurement section
            document.getElementById('measurementSection').classList.remove('hidden');
            
            console.log('‚úÖ ENHANCED_INGREDIENT: Ingredient selected successfully');
            showSuccessMessage(`‚úÖ Selected "${name}" - choose measurement and quantity!`);
        }
        
        function populateEnhancedMeasurements(ingredient) {
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
            
            // Add event listener for measurement selection
            measurementSelect.onchange = function() {
                if (this.value) {
                    document.getElementById('quantitySection').classList.remove('hidden');
                    updateEnhancedNutritionPreview();
                } else {
                    document.getElementById('quantitySection').classList.add('hidden');
                    document.getElementById('nutritionPreview').classList.add('hidden');
                    document.getElementById('addButtonSection').classList.add('hidden');
                }
            };
            
            // Add event listener for quantity changes
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            quantityInput.oninput = updateEnhancedNutritionPreview;
        }
        
        function updateEnhancedNutritionPreview() {
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            
            if (!selectedEnhancedIngredient || !measurementSelect.value || !quantityInput.value) {
                document.getElementById('nutritionPreview').classList.add('hidden');
                document.getElementById('addButtonSection').classList.add('hidden');
                return;
            }
            
            const ingredient = rawIngredients[selectedEnhancedIngredient.category][selectedEnhancedIngredient.key];
            const measurement = ingredient.measurements[measurementSelect.value];
            const quantity = parseFloat(quantityInput.value) || 1;
            
            // Calculate nutrition
            const nutrition = {
                calories: Math.round(measurement.calories * quantity),
                protein: Math.round(measurement.protein * quantity * 10) / 10,
                carbs: Math.round(measurement.carbs * quantity * 10) / 10,
                fat: Math.round(measurement.fat * quantity * 10) / 10,
                fiber: Math.round(measurement.fiber * quantity * 10) / 10
            };
            
            // Update nutrition preview
            const nutritionDetails = document.getElementById('nutritionDetails');
            nutritionDetails.innerHTML = `
                <div>Calories: <span class="font-semibold">${nutrition.calories}</span></div>
                <div>Protein: <span class="font-semibold">${nutrition.protein}g</span></div>
                <div>Carbs: <span class="font-semibold">${nutrition.carbs}g</span></div>
                <div>Fat: <span class="font-semibold">${nutrition.fat}g</span></div>
                <div>Fiber: <span class="font-semibold">${nutrition.fiber}g</span></div>
            `;
            
            // Show preview and add button
            document.getElementById('nutritionPreview').classList.remove('hidden');
            document.getElementById('addButtonSection').classList.remove('hidden');
        }
        
        function addEnhancedIngredientToLog() {
            console.log('ü•¨ ENHANCED_INGREDIENT: addEnhancedIngredientToLog() called');
            
            if (!selectedEnhancedIngredient) {
                showErrorMessage('Please select an ingredient first');
                return;
            }
            
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            
            if (!measurementSelect.value) {
                showErrorMessage('Please select a measurement');
                return;
            }
            
            if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                showErrorMessage('Please enter a valid quantity');
                return;
            }
            
            const ingredient = rawIngredients[selectedEnhancedIngredient.category][selectedEnhancedIngredient.key];
            const measurement = ingredient.measurements[measurementSelect.value];
            const quantity = parseFloat(quantityInput.value);
            const measurementDisplay = measurementSelect.options[measurementSelect.selectedIndex].text;
            
            // Create ingredient entry with real nutrition data
            const ingredientMeal = {
                id: Date.now(),
                description: `${selectedEnhancedIngredient.name} (${quantity}x ${measurementDisplay})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(measurement.calories * quantity),
                    protein: Math.round(measurement.protein * quantity * 10) / 10,
                    carbs: Math.round(measurement.carbs * quantity * 10) / 10,
                    fat: Math.round(measurement.fat * quantity * 10) / 10,
                    fiber: Math.round(measurement.fiber * quantity * 10) / 10
                },
                source: 'enhanced_ingredient',
                ingredient_data: {
                    category: selectedEnhancedIngredient.category,
                    key: selectedEnhancedIngredient.key,
                    measurement: measurementSelect.value,
                    quantity: quantity
                }
            };
            
            // Add to today's meals
            addMealToDate(ingredientMeal);
            
            // Update displays
            updateDailySummary();
            displayMeals();
            updateModalContent();
            
            console.log('‚úÖ ENHANCED_INGREDIENT: Ingredient added successfully with real nutrition data');
            
            // Clear form
            clearEnhancedIngredientForm();
            
            // Show success message
            showSuccessMessage(`‚úÖ Added ${selectedEnhancedIngredient.name} with accurate nutrition data!`);
        }
        
        function clearEnhancedIngredientSelection() {
            selectedEnhancedIngredient = null;
            document.getElementById('selectedIngredientSection').classList.add('hidden');
            document.getElementById('measurementSection').classList.add('hidden');
            document.getElementById('quantitySection').classList.add('hidden');
            document.getElementById('nutritionPreview').classList.add('hidden');
            document.getElementById('addButtonSection').classList.add('hidden');
        }
        
        function clearEnhancedIngredientForm() {
            console.log('üßπ ENHANCED_INGREDIENT: Clearing form');
            
            document.getElementById('enhancedIngredientSearch').value = '';
            document.getElementById('enhancedIngredientDropdown').classList.add('hidden');
            document.getElementById('enhancedMeasurementSelect').innerHTML = '<option value="">Choose measurement...</option>';
            document.getElementById('enhancedIngredientQuantity').value = 1;
            
            clearEnhancedIngredientSelection();
            
            // Focus on search input for easy next entry
            document.getElementById('enhancedIngredientSearch').focus();
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('enhancedIngredientDropdown');
            const searchInput = document.getElementById('enhancedIngredientSearch');
            
            if (dropdown && searchInput && !dropdown.contains(event.target) && event.target !== searchInput) {
                dropdown.classList.add('hidden');
            }
        });

        // ========================================
        // SIMPLE INGREDIENT ADDITION FUNCTIONS (LEGACY)
        // ========================================
        
        function addSimpleIngredientToLog() {
            console.log('ü•¨ SIMPLE_INGREDIENT: addSimpleIngredientToLog() called');
            
            // Get form values
            const nameInput = document.getElementById('simpleIngredientName');
            const quantityInput = document.getElementById('simpleIngredientQuantity');
            
            if (!nameInput || !quantityInput) {
                alert('Form elements not found. Please refresh the page.');
                return;
            }
            
            const ingredientName = nameInput.value.trim();
            const quantity = parseFloat(quantityInput.value) || 1;
            
            // Simple validation
            if (!ingredientName) {
                alert('Please enter an ingredient name (e.g., "Egg", "Rice", "Oil")');
                nameInput.focus();
                return;
            }
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                quantityInput.focus();
                return;
            }
            
            // Create ingredient entry using the SAME SIMPLE PATTERN as the working test button
            const ingredientMeal = {
                id: Date.now(),
                description: `${ingredientName} (${quantity} serving${quantity !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    // Use simple default nutrition values (like test button)
                    calories: Math.round(50 * quantity), // 50 calories per serving default
                    protein: Math.round(3 * quantity * 10) / 10,
                    carbs: Math.round(5 * quantity * 10) / 10,
                    fat: Math.round(2 * quantity * 10) / 10,
                    fiber: Math.round(1 * quantity * 10) / 10
                },
                source: 'simple_ingredient'
            };
            
            // Add to today's meals using the SAME FUNCTION as the working test button
            addMealToDate(ingredientMeal);
            
            // Update displays using the SAME FUNCTIONS as the working test button
            updateDailySummary();
            displayMeals();
            
            // Update modal content if it's open
            updateModalContent();
            
            console.log('‚úÖ SIMPLE_INGREDIENT: Ingredient added successfully');
            
            // Clear form
            clearSimpleIngredientForm();
            
            // Show success message using the SAME FUNCTION as the working test button
            showSuccessMessage(`‚úÖ Added ${ingredientName} to your daily log!`);
        }
        
        function clearSimpleIngredientForm() {
            console.log('üßπ SIMPLE_INGREDIENT: Clearing form');
            
            const nameInput = document.getElementById('simpleIngredientName');
            const quantityInput = document.getElementById('simpleIngredientQuantity');
            
            if (nameInput) nameInput.value = '';
            if (quantityInput) quantityInput.value = 1;
            
            // Focus on name input for easy next entry
            if (nameInput) nameInput.focus();
        }

    </script>
</body>
</html>