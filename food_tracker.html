<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Food Diary - Volume Based Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 200; /* Above other UI including AI panel */
            overflow: auto; /* Allow overlay to scroll on small screens */
        }

        /* Ensure all modal cards auto-fit viewport across devices */
        .modal > div {
            box-sizing: border-box;
            width: 95vw;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            margin: 1rem;
        }
        /* Modal content layout: header + scrollable body */
        .modal-card {
            display: flex;
            flex-direction: column;
        }
        .modal-card .modal-body {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0; /* Enables flex scrolling */
        }
        @media (min-width: 1024px) {
            .modal > div {
                max-width: 64rem; /* ~max-w-4xl */
                width: auto;
            }
        }

        /* Ingredient dropdown should not exceed viewport */
        #recipeIngredientDropdown {
            max-height: 30vh !important;
            overflow-y: auto;
        }
        
        /* Recipe management specific styles */
        #manageRecipesModal, #recipeEditModal, #jsonExportModal, #jsonImportModal {
            display: none;
        }
        
        #recipeEditModal {
            z-index: 200; /* Ensure edit modal is above other modals/UI */
        }
        .modal.active, #manageRecipesModal.active, #recipeEditModal.active, #jsonExportModal.active, #jsonImportModal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Tab styling */
        .add-tab-btn, .log-tab-btn {
            transition: all 0.2s ease;
        }
        
        .add-tab-btn:hover, .log-tab-btn:hover {
            border-color: #fb923c !important;
            color: #ea580c !important;
        }
        
        /* Responsive tab navigation */
        @media (max-width: 640px) {
            .add-tab-btn, .log-tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }
        }
        
        /* Modal content animations */
        .add-tab-content, .log-tab-content {
            animation: fadeInTab 0.3s ease-in-out;
        }
        
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced button styling */
        .unified-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .unified-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üçõ Indian Food Diary</h1>
            <p class="text-lg text-gray-600">Volume-Based Tracking - Cups, Tablespoons & More!</p>
            
            <!-- Date Navigation & Meal Type -->
            <div class="bg-white rounded-lg shadow-lg p-4 mt-4 mb-4">
                <div class="flex items-center justify-center space-x-4 mb-3">
                    <button onclick="navigateDate(-1)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition duration-200">
                        ‚Üê Previous Day
                    </button>
                    <div class="text-center">
                        <input type="date" id="dateSelector" class="text-lg font-semibold text-gray-800 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="selectDate()">
                        <div id="selectedDateDisplay" class="text-sm text-gray-600 mt-1"></div>
                    </div>
                    <button onclick="navigateDate(1)" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition duration-200">
                        Next Day ‚Üí
                    </button>
                </div>
                <div class="flex justify-center items-center gap-4">
                    <div class="flex space-x-2">
                        <button onclick="goToToday()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Today
                        </button>
                        <button onclick="goToYesterday()" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Yesterday
                        </button>
                        <button onclick="refreshMealsFromDB()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Refresh from DB
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4 rounded">
                <p class="font-semibold">üìè Easy Volume Measurements</p>
                <p>Track with simple measurements like "1 cup rice" or "2 tbsp oil" - no weighing required!</p>
            </div>
            <!-- Simplified Main Action Buttons -->
            <div class="mt-6 space-y-4">
                <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-4xl mx-auto">
                    <button onclick="openUnifiedAddModal()" class="unified-btn flex-1 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white px-8 py-4 rounded-xl">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ûï</div>
                            <div class="font-semibold text-lg">Add Meal or Ingredient</div>
                            <div class="text-sm opacity-90">Create meals, manage ingredients, or add recipes</div>
                        </div>
                    </button>
                    <button onclick="syncAllToDatabase()" class="unified-btn flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-8 py-4 rounded-xl" id="syncButton">
                        <div class="text-center">
                            <div class="text-2xl mb-1">üîÑ</div>
                            <div class="font-semibold text-lg">Sync to Database</div>
                            <div class="text-sm opacity-90">Push all meals to database for AI</div>
                        </div>
                    </button>
                </div>
                <p class="text-sm text-gray-500 text-center">New meals auto-sync! Click sync for existing meals.</p>
                
                <!-- Export Status Display -->
                <div id="exportStatusDisplay" class="hidden mt-4 max-w-md mx-auto">
                    <div id="exportStatusContent" class="p-4 rounded-lg border text-center">
                        <div id="exportStatusIcon" class="text-2xl mb-2"></div>
                        <div id="exportStatusMessage" class="font-medium"></div>
                        <div id="exportStatusDetails" class="text-sm mt-1 opacity-75"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simplified Interface - Content moved to modals -->

        <!-- Daily Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="dailySummaryTitle">üìä Daily Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600" id="totalCalories">0</div>
                    <div class="text-sm text-gray-600">Total Calories</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="mealCount">0</div>
                    <div class="text-sm text-gray-600">Meals Logged</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="totalProtein">0g</div>
                    <div class="text-sm text-gray-600">Protein</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="totalFiber">0g</div>
                    <div class="text-sm text-gray-600">Fiber</div>
                </div>
            </div>
        </div>

        <!-- Weight Tracking Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800" id="weightTrackingTitle">‚öñÔ∏è Weight Tracking & Goals</h2>
                <div class="flex space-x-2">
                    <button onclick="openGoalSettingModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        üéØ Set Goals
                    </button>
                    <button onclick="openWeightEntryModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        üìä Log Weight
                    </button>
                </div>
            </div>
            
            <!-- Weekly Deficit Tracking -->
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">üìà Weekly Deficit Progress</h3>
                    <div class="text-sm text-gray-600" id="weeklyDeficitDate">Current Week</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-xl font-bold text-green-600" id="weeklyDeficitCurrent">0</div>
                        <div class="text-sm text-gray-600">Weekly Deficit</div>
                        <div class="text-xs text-gray-500">calories</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-xl font-bold text-blue-600" id="weeklyDeficitGoal">3,500</div>
                        <div class="text-sm text-gray-600">Weekly Goal</div>
                        <div class="text-xs text-gray-500">1 lb loss</div>
                    </div>
                    <div class="text-center p-3 bg-white rounded-lg">
                        <div class="text-xl font-bold text-purple-600" id="dailyDeficitAvg">500</div>
                        <div class="text-sm text-gray-600">Daily Target</div>
                        <div class="text-xs text-gray-500">avg needed</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-3">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Progress to Weekly Goal</span>
                        <span id="weeklyDeficitPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500"
                             style="width: 0%" id="weeklyDeficitProgressBar"></div>
                    </div>
                </div>
                
                <!-- Daily Breakdown -->
                <div class="grid grid-cols-7 gap-1 text-xs">
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit0">
                        <div class="font-semibold">Mon</div>
                        <div class="text-gray-600" id="dayDeficitValue0">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit1">
                        <div class="font-semibold">Tue</div>
                        <div class="text-gray-600" id="dayDeficitValue1">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit2">
                        <div class="font-semibold">Wed</div>
                        <div class="text-gray-600" id="dayDeficitValue2">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit3">
                        <div class="font-semibold">Thu</div>
                        <div class="text-gray-600" id="dayDeficitValue3">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit4">
                        <div class="font-semibold">Fri</div>
                        <div class="text-gray-600" id="dayDeficitValue4">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit5">
                        <div class="font-semibold">Sat</div>
                        <div class="text-gray-600" id="dayDeficitValue5">--</div>
                    </div>
                    <div class="text-center p-2 bg-white rounded" id="dayDeficit6">
                        <div class="font-semibold">Sun</div>
                        <div class="text-gray-600" id="dayDeficitValue6">--</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Current Weight Card -->
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="currentWeight">--</div>
                    <div class="text-sm text-gray-600">Current Weight (lbs)</div>
                    <div class="text-xs text-gray-500 mt-1" id="weightDate">No data</div>
                </div>
                
                <!-- BMI Card -->
                <div class="text-center p-4 bg-indigo-50 rounded-lg">
                    <div class="text-2xl font-bold text-indigo-600" id="currentBMI">--</div>
                    <div class="text-sm text-gray-600">BMI</div>
                    <div class="text-xs mt-1" id="bmiCategory">No data</div>
                </div>
                
                <!-- BMR Card -->
                <div class="text-center p-4 bg-orange-50 rounded-lg relative">
                    <div class="flex items-center justify-center mb-1">
                        <div class="text-2xl font-bold text-orange-600" id="currentBMR">--</div>
                        <button onclick="showBMRExplanation()" class="ml-2 text-orange-500 hover:text-orange-700 text-sm" title="Click for BMR explanation" id="bmrInfoButton" style="display: none;">
                            ‚ÑπÔ∏è
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">BMR</div>
                    <div class="text-xs text-gray-500 mt-1" id="bmrMethod">No data</div>
                </div>
                
                <!-- Enhanced Calorie Goals Card -->
                <div class="text-center p-4 bg-blue-50 rounded-lg relative">
                    <div class="flex items-center justify-center mb-1">
                        <div class="text-2xl font-bold text-blue-600" id="calorieGoal">--</div>
                        <button onclick="showGoalExplanation()" class="ml-2 text-blue-500 hover:text-blue-700 text-sm" title="Click for explanation">
                            ‚ÑπÔ∏è
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">Daily Goal</div>
                    <div class="text-xs text-gray-500 mt-1" id="calorieDeficit">Deficit: --</div>
                    <div class="text-xs text-blue-600 mt-1" id="goalSource">--</div>
                    <div class="text-xs text-green-600 mt-1" id="exerciseAdjustmentStatus">--</div>
                </div>
                
                <!-- Exercise Card -->
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="caloriesBurned">0</div>
                    <div class="text-sm text-gray-600">Calories Burned</div>
                    <div class="text-xs text-gray-500 mt-1">
                        <button onclick="openExerciseModal()" class="text-green-600 hover:text-green-800 underline">
                            + Add Exercise
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Today's Exercises Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8" id="exercisesSection">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800" id="exercisesSectionTitle">üèÉ‚Äç‚ôÇÔ∏è Today's Exercises</h2>
                    <div class="flex space-x-2">
                        <button onclick="openExerciseModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üí™ Add Exercise
                        </button>
                        <button onclick="clearAllExercises()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üóëÔ∏è Clear All
                        </button>
                    </div>
                </div>
                
                <div id="exercisesList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <p>No exercises logged yet. Add an exercise to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Log -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã Your Food Log</h2>
            <div id="foodLog" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <p>No meals logged yet. Try adding a dish above!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Builder Modal -->
    <div id="recipeModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="modal-card bg-white rounded-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Create New Recipe</h3>
                <button onclick="closeRecipeBuilder()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="modal-body grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recipe Details -->
                <div>
                    <div class="space-y-4">
                        <!-- Start from Template Section -->
                        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-3">üìã Start with a Base Recipe (Optional)</h5>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Choose a base recipe:</label>
                                    <select id="recipeTemplateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" onchange="loadRecipeTemplate()">
                                        <option value="">-- Select a recipe --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">How many servings?</label>
                                    <input type="number" id="recipeTemplateServings" value="1" min="0.25" step="0.25" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" onchange="loadRecipeTemplate()">
                                </div>
                                <p class="text-xs text-gray-600">üí° Example: Select "Dosa" + 1 serving, then add butter, chutney, etc. Save as "Dosa with Butter" for quick access!</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Name:</label>
                            <input type="text" id="recipeName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., My Special Dal">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                                <select id="recipeCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="dal">Dal</option>
                                    <option value="sabji">Sabji</option>
                                    <option value="sambar">Sambar</option>
                                    <option value="rice">Rice Dish</option>
                                    <option value="bread">Bread</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Servings:</label>
                                <input type="number" id="recipeServings" value="4" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Ingredient Builder -->
                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">Add Ingredients:</h4>
                            <button onclick="reloadIngredientsInModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition duration-200" title="Reload ingredients if you need to refresh the list">
                                üîÑ Reload Ingredients
                            </button>
                        </div>
                        
                        <!-- Quick Search Ingredient Selector -->
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-3">üîç Quick Add Ingredients</h5>
                            <div class="space-y-3">
                                <!-- Search Box -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Ingredient:</label>
                                    <input type="text" id="recipeIngredientSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type ingredient name (e.g., onion, tomato, lentil)..." oninput="filterRecipeIngredients()">
                                    <div id="recipeIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto hidden mt-1"></div>
                                </div>
                                
                                <!-- Selected Ingredient Display -->
                                <div id="selectedRecipeIngredientDisplay" class="hidden bg-white p-3 rounded border border-gray-300">
                                    <div class="flex justify-between items-center">
                                        <span id="selectedRecipeIngredientName" class="font-medium text-gray-800"></span>
                                        <button onclick="clearRecipeIngredientSelection()" class="text-red-500 hover:text-red-700 text-sm">Clear</button>
                                    </div>
                                </div>
                                
                                <!-- Measurement and Quantity -->
                                <div id="recipeIngredientMeasurementSection" class="hidden space-y-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                                        <select id="recipeIngredientMeasurement" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Select measurement...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity:</label>
                                        <input type="number" id="recipeIngredientQuantity" value="1" min="0.25" step="0.25" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <button onclick="addRecipeIngredientFromSearch()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                        ‚ûï Add to Recipe
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Original Dropdown Method (Optional) -->
                        <details class="mb-4 p-3 bg-gray-50 rounded border border-gray-200">
                            <summary class="cursor-pointer font-medium text-gray-700">üìã Or use dropdown selector</summary>
                            <div class="mt-3 space-y-3">
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="recipeIngredientSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select ingredient...</option>
                                    </select>
                                    <select id="recipeMeasurementSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                                        <option value="">Select ingredient first...</option>
                                    </select>
                                    <input type="number" id="recipeQuantity" placeholder="Qty" value="1" min="0.25" step="0.25" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="addRecipeIngredient()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200">Add</button>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- Recipe Actions -->
                    <div class="mt-6 space-y-3">
                        <button onclick="saveRecipe()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save Recipe
                        </button>
                        <button onclick="addRecipeToLog()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Save & Add to Today's Log
                        </button>
                    </div>
                </div>

                <!-- Recipe Preview -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Recipe Preview:</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div id="recipePreview" class="space-y-2">
                            <p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Ingredient Management Modal -->
    <div id="ingredientModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="modal-card bg-white rounded-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Ingredient Management</h3>
                <button onclick="closeIngredientModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="modal-body grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Add New Ingredient Form -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Add New Ingredient</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ingredient Name:</label>
                            <input type="text" id="ingredientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Bitter Gourd">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                            <select id="ingredientCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select category...</option>
                                <option value="grains">Grains</option>
                                <option value="dals_legumes">Dals & Legumes</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="spices_seasonings">Spices & Seasonings</option>
                                <option value="oils_fats">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h5 class="font-semibold text-gray-800 mb-3">Nutritional Information</h5>
                            <div id="measurementInputs" class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-5 gap-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                        </div>
                                    </div>
                                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                                </div>
                            </div>
                            
                            <button onclick="addMeasurementInput()" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                + Add Another Measurement
                            </button>
                        </div>
                        
                        <div class="space-y-3 pt-4">
                            <button onclick="saveIngredient()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Save Ingredient
                            </button>
                            <button onclick="clearIngredientForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Clear Form
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Existing Ingredients List -->
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Existing Ingredients</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category:</label>
                            <select id="filterCategory" onchange="filterIngredients()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">All Categories</option>
                                <option value="grains">Grains</option>
                                <option value="dals_legumes">Dals & Legumes</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                                <option value="spices_seasonings">Spices & Seasonings</option>
                                <option value="oils_fats">Oils & Fats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div id="ingredientsList" class="max-h-96 overflow-y-auto space-y-2">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Meal Builder Modal -->
        <div id="mealModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-gray-800">üçΩÔ∏è Create Meal from Ingredients</h3>
                    <button onclick="closeMealBuilder()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Meal Details & Ingredient Selection -->
                    <div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Meal Name:</label>
                                <input type="text" id="mealName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., My Custom Lunch">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Servings:</label>
                                    <input type="number" id="mealServings" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Servings to Log:</label>
                                    <input type="number" id="mealServingsToLog" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                            </div>
                        </div>
    
                        <!-- Ingredient Selection -->
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Add Ingredients:</h4>
                            <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-3 mb-4 rounded">
                                <p class="text-sm"><strong>Simple workflow:</strong> Type ingredient names like "Egg", "Rice", "Oil" in the search box below, set quantity, then click "Add" - no dropdown selection required!</p>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Ingredients:</label>
                                    <div class="relative">
                                        <input type="text" id="mealIngredientSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Type ingredient name (e.g., rice, oil, onion)..." oninput="filterMealIngredients()">
                                        <div id="mealIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                            <!-- Dropdown options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2" id="mealIngredientInputs" style="display: none;">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Selected Ingredient:</label>
                                        <input type="text" id="selectedMealIngredient" class="w-full px-2 py-1 border border-gray-300 rounded text-sm bg-gray-100" readonly>
                                    </div>
                                    <select id="mealMeasurementSelect" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">Select measurement...</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <input type="number" id="mealQuantity" placeholder="Qty" value="1" min="0.25" step="0.25" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <button onclick="addMealIngredient()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Meal Actions -->
                        <div class="mt-6 space-y-3">
                            <button onclick="addMealToLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Add Meal to Today's Log
                            </button>
                            <button onclick="clearMealBuilder()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Clear All
                            </button>
                        </div>
                    </div>
    
                    <!-- Meal Preview -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Meal Preview:</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div id="mealPreview" class="space-y-2">
                                <p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Excel Export Modal -->
            <div id="exportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-800">üìä Export to Excel</h3>
                        <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Export Options -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Export Options</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Range:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="all" checked class="mr-2">
                                            <span>All available data</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="month" class="mr-2">
                                            <span>Current month only</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="exportRange" value="custom" class="mr-2">
                                            <span>Custom date range</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Custom Date Range -->
                                <div id="customDateRange" class="hidden">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date:</label>
                                            <input type="date" id="exportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date:</label>
                                            <input type="date" id="exportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Filename -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filename (optional):</label>
                                    <input type="text" id="exportFilename" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="2025-12.xlsx">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty for auto-generated monthly filename (YYYY-MM.xlsx)</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Preview -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Export Preview</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div id="exportPreview" class="space-y-2">
                                    <p class="text-gray-600">Select export options to see preview...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Actions -->
                        <div class="flex space-x-3">
                            <button onclick="startExport()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" id="exportButton">
                                üìä Export to Excel
                            </button>
                            <button onclick="closeExportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                Cancel
                            </button>
                        </div>
                        
                        <!-- Export Progress -->
                        <div id="exportProgress" class="hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                                    <div>
                                        <p class="font-semibold text-blue-800">Generating Excel file...</p>
                                        <p class="text-sm text-blue-600" id="exportProgressText">Preparing data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- JSON Export Modal -->
            <div id="jsonExportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-800">üíæ Export Daily Logs as JSON</h3>
                        <button onclick="closeJsonExportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Export Range:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="jsonExportRange" value="all" checked class="mr-2">
                                    <span>All meal logs</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jsonExportRange" value="month" class="mr-2">
                                    <span>Current month only</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jsonExportRange" value="custom" class="mr-2">
                                    <span>Custom date range</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Custom Date Range -->
                        <div id="jsonCustomDateRange" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date:</label>
                                    <input type="date" id="jsonExportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date:</label>
                                    <input type="date" id="jsonExportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview -->
                        <div>
                            <p id="jsonExportPreview" class="text-sm text-gray-600 bg-gray-50 p-3 rounded">Preparing export...</p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="exportMealsAsJson()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                                üíæ Export JSON
                            </button>
                            <button onclick="closeJsonExportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- JSON Import Modal -->
            <div id="jsonImportModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-800">üì• Import Daily Logs from JSON</h3>
                        <button onclick="closeJsonImportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select JSON File:</label>
                            <input type="file" id="jsonImportFile" accept=".json" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <p class="text-xs text-gray-500 mt-1">Select a JSON export file from another device</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Merge Strategy:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="mergeStrategy" value="merge" checked class="mr-2">
                                    <span>Merge (keep existing, add new meals)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="mergeStrategy" value="merge-duplicates" class="mr-2">
                                    <span>Merge & Replace (update if same meal exists)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="mergeStrategy" value="replace" class="mr-2">
                                    <span>Replace All (use imported data only)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Preview -->
                        <div>
                            <p id="jsonImportPreview" class="text-sm text-gray-600 bg-gray-50 p-3 rounded">Select a file to see preview...</p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-3">
                            <button onclick="importMealsFromJson()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                                üì• Import JSON
                            </button>
                            <button onclick="closeJsonImportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>

    <!-- Unified Add Modal -->
    <div id="unifiedAddModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">‚ûï Add Meal or Ingredient</h3>
                <button onclick="closeUnifiedAddModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Meal Type Selector -->
            <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-4 mb-6 border border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-1">üçΩÔ∏è Meal Type</h4>
                        <p class="text-sm text-gray-600">Choose when you're eating this meal</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="mealTypeSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-800 font-medium">
                            <option value="Breakfast">üåÖ Breakfast</option>
                            <option value="Morning Snack">ü•® Morning Snack</option>
                            <option value="Lunch" selected>üçΩÔ∏è Lunch</option>
                            <option value="Evening Snack">üç™ Evening Snack</option>
                            <option value="Dessert">üç∞ Dessert</option>
                            <option value="Dinner">üåô Dinner</option>
                        </select>
                        <button onclick="setTimeBasedMealType()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm transition duration-200" title="Auto-select based on current time">
                            üïê Auto
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchAddTab('quickDishes')" id="quickDishesTab" class="add-tab-btn py-2 px-1 border-b-2 border-orange-500 text-orange-600 whitespace-nowrap font-medium text-sm">
                        üçΩÔ∏è Quick Add Dishes
                    </button>
                    <button onclick="switchAddTab('addIngredient')" id="addIngredientTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ü•¨ Add Ingredient
                    </button>
                    <button onclick="switchAddTab('customEntry')" id="customEntryTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ‚úèÔ∏è Custom Entry
                    </button>
                    <button onclick="switchAddTab('recipeBuilder')" id="recipeBuilderTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üë®‚Äçüç≥ Create Recipe
                    </button>
                    <button onclick="switchAddTab('manageIngredients')" id="manageIngredientsTab" class="add-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        ü•¨ Manage Ingredients
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="addTabContent">
                <!-- Quick Dishes Tab -->
                <div id="quickDishesContent" class="add-tab-content">
                    <!-- Recipe Search Box -->
                    <div class="mb-4">
                        <label for="recipeSearchBox" class="block text-sm font-medium text-gray-700 mb-1">Search Recipe:</label>
                        <input type="text" id="recipeSearchBox" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type recipe name..." autocomplete="off" oninput="showRecipeSuggestions()">
                        <div id="recipeSuggestions" class="absolute z-20 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                        <div id="selectedRecipeActions" class="mt-4 hidden">
                            <!-- Quantity Section -->
                            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <label for="recipeSearchQuantity" class="block text-sm font-medium text-gray-700 mb-2">Servings:</label>
                                <input type="number" id="recipeSearchQuantity" value="1" min="0.25" step="0.25" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">How many servings to add?</p>
                            </div>
                            <!-- Action Buttons -->
                            <div class="flex flex-col gap-2 w-full">
                                <button id="addRecipeToLogBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-lg">‚úÖ Add to Daily Log</button>
                                <button id="editRecipeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-lg">üìù Edit Recipe</button>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3" id="quickDishesInModal">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Add Ingredient Tab -->
                <div id="addIngredientContent" class="add-tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded">
                            <p class="font-semibold">ü•¨ Enhanced Ingredient Addition</p>
                            <p class="text-sm">Select from real ingredient database with proper measurements and accurate nutrition data!</p>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Ingredient Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search Ingredient:</label>
                                <div class="relative">
                                    <input type="text" id="enhancedIngredientSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Type ingredient name (e.g., Rice, Egg, Onion)..." oninput="filterEnhancedIngredients()">
                                    <div id="enhancedIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                        <!-- Dropdown options will be populated here -->
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Search from our ingredient database for accurate nutrition data</p>
                            </div>
                            
                            <!-- Selected Ingredient Display -->
                            <div id="selectedIngredientSection" class="hidden">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-800">Selected:</span>
                                        <button onclick="clearEnhancedIngredientSelection()" class="text-red-500 hover:text-red-700 text-sm">Clear</button>
                                    </div>
                                    <div id="selectedIngredientName" class="text-lg font-semibold text-green-700"></div>
                                </div>
                            </div>
                            
                            <!-- Measurement Selection -->
                            <div id="measurementSection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Measurement:</label>
                                <select id="enhancedMeasurementSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">Choose measurement...</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select the appropriate measurement for this ingredient</p>
                            </div>
                            
                            <!-- Quantity Input -->
                            <div id="quantitySection" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity:</label>
                                <input type="number" id="enhancedIngredientQuantity" value="1" min="0.25" step="0.25" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="1">
                                <p class="text-xs text-gray-500 mt-1">How many of the selected measurement?</p>
                            </div>
                            
                            <!-- Nutrition Preview -->
                            <div id="nutritionPreview" class="hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-800 mb-2">üìä Nutrition Preview:</h4>
                                    <div id="nutritionDetails" class="grid grid-cols-2 gap-2 text-sm text-blue-700">
                                        <!-- Will be populated with nutrition info -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add Button -->
                            <div id="addButtonSection" class="hidden pt-4">
                                <button onclick="addEnhancedIngredientToLog()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-lg">
                                    ‚úÖ Add to Daily Log
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="clearEnhancedIngredientForm()" class="text-gray-500 hover:text-gray-700 text-sm underline">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">üí° How it works:</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Search for ingredients from our database</li>
                                <li>‚Ä¢ Select the appropriate measurement (1 cup, 1 medium, etc.)</li>
                                <li>‚Ä¢ Enter quantity and see real nutrition data</li>
                                <li>‚Ä¢ Add with accurate calories, protein, and more!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Custom Entry Tab -->
                <div id="customEntryContent" class="add-tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dish Description:</label>
                                <input type="text" id="modalCustomDish" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g., Homemade rajma with 2 chapatis">
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type:</label>
                                    <select id="modalCustomMealType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white text-gray-800">
                                        <option value="Breakfast">üåÖ Breakfast</option>
                                        <option value="Morning Snack">ü•® Morning Snack</option>
                                        <option value="Lunch" selected>üçΩÔ∏è Lunch</option>
                                        <option value="Evening Snack">üç™ Evening Snack</option>
                                        <option value="Dinner">üåô Dinner</option>
                                        <option value="Dessert">üç∞ Dessert</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Serving Size:</label>
                                    <input type="number" id="modalCustomServings" value="1" min="0.5" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Calories per Serving:</label>
                                    <input type="number" id="modalCustomCalories" placeholder="Required" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" min="0">
                                </div>
                            </div>
                            <button onclick="addCustomEntryFromModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Add Custom Entry
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recipe Builder Tab -->
                <div id="recipeBuilderContent" class="add-tab-content hidden">
                    <div class="text-center py-8">
                        <p class="text-gray-600 mb-4">Create reusable recipes like dal, sabji, or sambar with precise nutrition calculations.</p>
                        <button onclick="openRecipeBuilderFromModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-200">
                            Open Recipe Builder
                        </button>
                    </div>
                </div>


                <!-- Manage Ingredients Tab -->
                <div id="manageIngredientsContent" class="add-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Add New Ingredient Form -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Add New Ingredient</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ingredient Name:</label>
                                    <input type="text" id="simpleIngredientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Bitter Gourd">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category:</label>
                                    <select id="simpleIngredientCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">Select category...</option>
                                        <option value="grains">Grains</option>
                                        <option value="dals_legumes">Dals & Legumes</option>
                                        <option value="vegetables">Vegetables</option>
                                        <option value="fruits">Fruits</option>
                                        <option value="spices_seasonings">Spices & Seasonings</option>
                                        <option value="oils_fats">Oils & Fats</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h5 class="font-semibold text-gray-800 mb-3">Add Measurement</h5>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Measurement Key:</label>
                                                <input type="text" id="simpleMeasurementKey" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                                                <input type="text" id="simpleMeasurementDisplay" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-5 gap-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                                                <input type="number" id="simpleCalories" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                                                <input type="number" id="simpleProtein" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                                                <input type="number" id="simpleCarbs" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                                                <input type="number" id="simpleFat" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                                                <input type="number" id="simpleFiber" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3 pt-4">
                                    <button onclick="simpleAddIngredient()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                        Add Ingredient
                                    </button>
                                    <button onclick="simpleClearForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                        Clear Form
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Existing Ingredients List -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-semibold text-gray-800">Existing Ingredients</h4>
                                <button onclick="simpleReloadIngredients()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                    üîÑ Reload
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category:</label>
                                    <select id="simpleFilterCategory" onchange="simpleFilterIngredients()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="">All Categories</option>
                                        <option value="grains">Grains</option>
                                        <option value="dals_legumes">Dals & Legumes</option>
                                        <option value="vegetables">Vegetables</option>
                                        <option value="fruits">Fruits</option>
                                        <option value="spices_seasonings">Spices & Seasonings</option>
                                        <option value="oils_fats">Oils & Fats</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div id="simpleIngredientsList" class="max-h-96 overflow-y-auto space-y-2 border border-gray-200 rounded-lg p-3">
                                    <div class="text-center text-gray-500 py-4">
                                        Click "Reload" to load ingredients
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Log Modal -->
    <div id="unifiedLogModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">üìù Log Today's Meals</h3>
                <button onclick="closeUnifiedLogModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchLogTab('todaysMeals')" id="todaysMealsTab" class="log-tab-btn py-2 px-1 border-b-2 border-orange-500 text-orange-600 whitespace-nowrap font-medium text-sm">
                        üçΩÔ∏è Today's Meals
                    </button>
                    <button onclick="switchLogTab('dailySummary')" id="dailySummaryTab" class="log-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üìä Daily Summary
                    </button>
                    <button onclick="switchLogTab('exportData')" id="exportDataTab" class="log-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap font-medium text-sm">
                        üì§ Export Data
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="logTabContent">
                <!-- Today's Meals Tab -->
                <div id="todaysMealsContent" class="log-tab-content">
                    <div id="modalFoodLog" class="space-y-4">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Daily Summary Tab -->
                <div id="dailySummaryContent" class="log-tab-content hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="modalTotalCalories">0</div>
                            <div class="text-sm text-gray-600">Total Calories</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="modalMealCount">0</div>
                            <div class="text-sm text-gray-600">Meals Logged</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="modalTotalProtein">0g</div>
                            <div class="text-sm text-gray-600">Protein</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="modalTotalFiber">0g</div>
                            <div class="text-sm text-gray-600">Fiber</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">Detailed nutritional breakdown for <span id="modalSelectedDate"></span></p>
                    </div>
                </div>

                <!-- Export Data Tab -->
                <div id="exportDataContent" class="log-tab-content hidden">
                    <div class="text-center py-8">
                        <p class="text-gray-600 mb-4">Export your food diary data to Excel for analysis and record keeping.</p>
                        <button onclick="openExportModalFromModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition duration-200">
                            üìä Export to Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weight Entry Modal -->
    <div id="weightEntryModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">‚öñÔ∏è Log Weight Entry</h3>
                <button onclick="closeWeightEntryModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Unit Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit System:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="unitSystem" value="metric" id="metricUnits" class="mr-2" onchange="switchUnits()">
                            <span>Metric (kg, cm)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="unitSystem" value="imperial" id="imperialUnits" class="mr-2" onchange="switchUnits()" checked>
                            <span>Imperial (lbs, ft/in)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Weight Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="weightLabel">Current Weight (lbs):</label>
                    <input type="number" id="weightInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter weight" min="50" max="500" step="0.1">
                </div>
                
                <!-- Height Input (Imperial) -->
                <div id="imperialHeightSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <input type="number" id="heightFeet" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Feet" min="3" max="8" step="1">
                            <p class="text-xs text-gray-500 mt-1">Feet</p>
                        </div>
                        <div>
                            <input type="number" id="heightInches" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Inches" min="0" max="11" step="0.5">
                            <p class="text-xs text-gray-500 mt-1">Inches</p>
                        </div>
                    </div>
                </div>
                
                <!-- Height Input (Metric) -->
                <div id="metricHeightSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm):</label>
                    <input type="number" id="heightCm" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter height in centimeters" min="100" max="250" step="0.5">
                    <p class="text-xs text-gray-500 mt-1">Height is saved and reused for future BMI calculations</p>
                </div>
                
                <!-- Age and Gender Input -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Age:</label>
                        <input type="number" id="ageInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter age" min="10" max="120" step="1">
                        <p class="text-xs text-gray-500 mt-1">Required for BMR calculation</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender:</label>
                        <select id="genderSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Select gender...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Required for BMR calculation</p>
                    </div>
                </div>
                
                <!-- Nursing Mother Checkbox -->
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="nursingMotherCheckbox" class="mr-2 rounded border-pink-300 text-pink-600 focus:ring-pink-500">
                        <span class="text-sm font-medium text-gray-700">I am currently nursing/breastfeeding</span>
                    </label>
                    <div id="nursingWarning" class="hidden mt-2 p-3 bg-pink-50 border-l-4 border-pink-500 text-pink-700 rounded">
                        <div class="text-sm">
                            <p class="font-semibold">ü§± Important for Nursing Mothers:</p>
                            <p class="mt-1">Nursing mothers need an additional 300-500 calories per day and should not consume less than 1,800 calories daily to maintain milk production and maternal health.</p>
                        </div>
                    </div>
                </div>
                
                <!-- BMI Preview -->
                <div id="bmiPreviewSection" class="hidden">
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <h4 class="font-semibold text-indigo-800 mb-2">üìä BMI Preview:</h4>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-indigo-700">BMI: <span id="previewBMI" class="font-bold">--</span></span>
                            <span id="previewBMICategory" class="text-sm px-2 py-1 rounded">--</span>
                        </div>
                        <!-- BMI Visual Scale -->
                        <div class="relative h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div class="absolute inset-0 flex">
                                <div class="bg-blue-400 flex-1"></div>
                                <div class="bg-green-400 flex-1"></div>
                                <div class="bg-yellow-400 flex-1"></div>
                                <div class="bg-red-400 flex-1"></div>
                            </div>
                            <div id="bmiIndicator" class="absolute top-0 w-1 h-full bg-black transition-all duration-300" style="left: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>Underweight</span>
                            <span>Normal</span>
                            <span>Overweight</span>
                            <span>Obese</span>
                        </div>
                    </div>
                </div>
                
                <!-- BMR Preview -->
                <div id="bmrPreviewSection" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2">üî• BMR Preview:</h4>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-green-700">Mifflin-St Jeor:</span>
                                <span id="previewBMRMifflin" class="font-bold text-green-800">-- cal/day</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-green-700">Harris-Benedict:</span>
                                <span id="previewBMRHarris" class="font-bold text-green-800">-- cal/day</span>
                            </div>
                            <div class="text-xs text-green-600 mt-2 p-2 bg-green-100 rounded">
                                <strong>BMR</strong> = calories your body burns at rest. Add activity calories for total daily needs.
                            </div>
                            <div id="tdeePreview" class="hidden">
                                <div class="border-t border-green-200 pt-2 mt-2">
                                    <div class="text-xs text-green-700 mb-1">Estimated Daily Calories (TDEE):</div>
                                    <div class="grid grid-cols-2 gap-1 text-xs">
                                        <div>Sedentary: <span id="tdeeSedentary" class="font-semibold">--</span></div>
                                        <div>Light: <span id="tdeeLight" class="font-semibold">--</span></div>
                                        <div>Moderate: <span id="tdeeModerate" class="font-semibold">--</span></div>
                                        <div>Active: <span id="tdeeActive" class="font-semibold">--</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calorie Goal Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daily Calorie Goal (optional):</label>
                    <input type="number" id="calorieGoalInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., 2000" min="800" max="5000" step="50" oninput="validateCalorieGoalInput()">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to auto-calculate based on BMI and activity level</p>
                    <div id="calorieGoalWarning" class="hidden mt-2 p-2 bg-red-50 border-l-4 border-red-500 text-red-700 rounded text-sm">
                        <span id="calorieGoalWarningText"></span>
                    </div>
                </div>
                
                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional):</label>
                    <textarea id="weightNotesInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" rows="2" placeholder="Any notes about this weight entry..."></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveWeightEntry()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üíæ Save Weight Entry
                    </button>
                    <button onclick="closeWeightEntryModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exercise Modal -->
    <div id="exerciseModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">üèÉ‚Äç‚ôÇÔ∏è Log Exercise</h3>
                <button onclick="closeExerciseModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Exercise Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Exercise Type:</label>
                    <select id="exerciseTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" onchange="updateExerciseCalories()">
                        <option value="">Select exercise type...</option>
                        <option value="walking" data-calories="4">Walking (4 cal/min)</option>
                        <option value="jogging" data-calories="8">Jogging (8 cal/min)</option>
                        <option value="running" data-calories="12">Running (12 cal/min)</option>
                        <option value="cycling" data-calories="10">Cycling (10 cal/min)</option>
                        <option value="swimming" data-calories="11">Swimming (11 cal/min)</option>
                        <option value="yoga" data-calories="3">Yoga (3 cal/min)</option>
                        <option value="weightlifting" data-calories="6">Weight Lifting (6 cal/min)</option>
                        <option value="dancing" data-calories="5">Dancing (5 cal/min)</option>
                        <option value="hiking" data-calories="7">Hiking (7 cal/min)</option>
                        <option value="custom" data-calories="0">Custom Exercise</option>
                    </select>
                </div>
                
                <!-- Duration -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Duration (minutes):</label>
                    <input type="number" id="exerciseDuration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter duration in minutes" min="1" max="300" step="1" oninput="updateExerciseCalories()">
                </div>
                
                <!-- Custom Exercise Name (shown only for custom) -->
                <div id="customExerciseSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Exercise Name:</label>
                    <input type="text" id="customExerciseName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., Rock Climbing, Martial Arts">
                </div>
                
                <!-- Calories Burned (auto-calculated or manual for custom) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Calories Burned:</label>
                    <input type="number" id="exerciseCalories" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Calories burned" min="1" max="2000" step="1">
                    <p class="text-xs text-gray-500 mt-1" id="calorieHint">Select exercise type and duration for auto-calculation</p>
                </div>
                
                <!-- Exercise Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional):</label>
                    <textarea id="exerciseNotesInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" rows="2" placeholder="Any notes about this exercise session..."></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveExerciseEntry()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        üí™ Save Exercise
                    </button>
                    <button onclick="closeExerciseModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Recipes Modal -->
    <div id="manageRecipesModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">üë®‚Äçüç≥ Manage Recipes</h3>
                <button onclick="closeManageRecipesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600">View and manage all your custom recipes</p>
                    <button onclick="openUnifiedAddModal('recipe')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        ‚ûï Create New Recipe
                    </button>
                </div>
                
                <!-- Search/Filter Box -->
                <div class="mb-4">
                    <input 
                        type="text" 
                        id="recipeSearchBox" 
                        placeholder="üîç Search recipes by name..." 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        oninput="filterRecipes()"
                    >
                </div>
                
                <!-- Recipe Count Display -->
                <div id="recipeCountDisplay" class="text-sm text-gray-600 mb-3">
                    <!-- Count will be displayed here -->
                </div>
                
                <!-- Recipe List -->
                <div id="recipeListContainer" class="space-y-4">
                    <!-- Recipes will be populated here -->
                </div>
                
                <!-- Empty State -->
                <div id="emptyRecipeState" class="text-center py-12 text-gray-500" style="display: none;">
                    <div class="text-6xl mb-4">üë®‚Äçüç≥</div>
                    <h3 class="text-xl font-semibold mb-2">No recipes yet</h3>
                    <p class="mb-4">Create your first custom recipe to get started!</p>
                    <button onclick="openUnifiedAddModal('recipe')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                        Create Your First Recipe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Edit Modal -->
    <div id="recipeEditModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-60">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">‚úèÔ∏è Edit Recipe</h3>
                <button onclick="closeRecipeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="editRecipeForm" class="space-y-6">
                <!-- Recipe Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Name</label>
                    <input type="text" id="editRecipeName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <!-- Servings -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Servings</label>
                    <input type="number" id="editRecipeServings" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <!-- Add Ingredient Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-blue-900 mb-3">Add Ingredients</h4>
                    <div class="space-y-3">
                        <!-- Search and Select Ingredient -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Ingredient:</label>
                            <div class="relative">
                                <input type="text" id="editIngredientSearch" placeholder="Type ingredient name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="filterEditRecipeIngredients()">
                                <div id="editIngredientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden mt-1">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Ingredient Display -->
                        <div id="editSelectedIngredientDisplay" class="hidden bg-white p-3 rounded border border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-800" id="editSelectedIngredientName"></span>
                                <button type="button" onclick="clearEditIngredientSelection()" class="text-red-500 hover:text-red-700 text-sm">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Quantity Input -->
                        <div id="editIngredientQuantitySection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity:</label>
                            <input type="number" id="editIngredientQuantity" min="0.1" step="0.1" value="1" placeholder="e.g., 1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- Add Button -->
                        <button type="button" id="editAddIngredientBtn" onclick="addEditIngredientToForm()" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg hidden">
                            ‚úÖ Add to Recipe
                        </button>
                    </div>
                </div>
                
                <!-- Ingredients List -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recipe Ingredients</label>
                    <div id="editIngredientsContainer" class="space-y-3 bg-gray-50 p-4 rounded-lg">
                        <!-- Ingredients will be populated here -->
                    </div>
                </div>
                
                <!-- Nutrition Summary -->
                <div id="editNutritionSummary" class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">Nutrition per Serving</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>Calories: <span id="editCalories">0</span></div>
                        <div>Protein: <span id="editProtein">0</span>g</div>
                        <div>Carbs: <span id="editCarbs">0</span>g</div>
                        <div>Fat: <span id="editFat">0</span>g</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeRecipeEditModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
                // --- Recipe Search & Suggestion Logic for Quick Dishes ---
                let recipeSearchSelected = null;
                function showRecipeSuggestions() {
                    const input = document.getElementById('recipeSearchBox');
                    const suggestionsDiv = document.getElementById('recipeSuggestions');
                    const actionsDiv = document.getElementById('selectedRecipeActions');
                    const addBtn = document.getElementById('addRecipeToLogBtn');
                    const editBtn = document.getElementById('editRecipeBtn');
                    const query = input.value.trim().toLowerCase();
                    recipeSearchSelected = null;
                    actionsDiv.classList.add('hidden');
                    if (!query) {
                        suggestionsDiv.innerHTML = '';
                        suggestionsDiv.classList.add('hidden');
                        return;
                    }
                    // Get all recipe names from customRecipes and (if available) from recipes.json loaded in foodDatabase
                    let recipeNames = [];
                    if (typeof customRecipes === 'object') {
                        recipeNames = recipeNames.concat(Object.keys(customRecipes));
                    }
                    if (foodDatabase && foodDatabase.recipes) {
                        recipeNames = recipeNames.concat(Object.keys(foodDatabase.recipes));
                    }
                    // Remove duplicates
                    recipeNames = [...new Set(recipeNames)];
                    // Filter by query
                    const matches = recipeNames.filter(name => name.toLowerCase().includes(query));
                    if (matches.length === 0) {
                        suggestionsDiv.innerHTML = '<div class="px-3 py-2 text-gray-500">No recipes found.</div>';
                        suggestionsDiv.classList.remove('hidden');
                        return;
                    }
                    suggestionsDiv.innerHTML = matches.map(name => `<div class='px-3 py-2 hover:bg-blue-100 cursor-pointer' onclick='selectRecipeSuggestion("${name.replace(/"/g, "&quot;")}")'>${name}</div>`).join('');
                    suggestionsDiv.classList.remove('hidden');
                }

                function selectRecipeSuggestion(recipeName) {
                    const input = document.getElementById('recipeSearchBox');
                    const suggestionsDiv = document.getElementById('recipeSuggestions');
                    const actionsDiv = document.getElementById('selectedRecipeActions');
                    recipeSearchSelected = recipeName;
                    input.value = recipeName;
                    suggestionsDiv.classList.add('hidden');
                    actionsDiv.classList.remove('hidden');
                }

                // Add Recipe from Search - uses same logic as addQuickDishFromModal
                function addRecipeFromSearch() {
                    if (!recipeSearchSelected) {
                        showErrorMessage('Please select a recipe first');
                        return;
                    }
                    
                    // Find the recipe in either customRecipes or foodDatabase.dishes
                    let recipe = null;
                    let recipeKey = recipeSearchSelected;
                    
                    if (customRecipes && customRecipes[recipeKey]) {
                        recipe = customRecipes[recipeKey];
                    } else if (foodDatabase && foodDatabase.dishes && foodDatabase.dishes[recipeKey]) {
                        recipe = foodDatabase.dishes[recipeKey];
                    } else {
                        // Try to find by name
                        if (customRecipes) {
                            for (let key in customRecipes) {
                                if (customRecipes[key].name === recipeSearchSelected) {
                                    recipe = customRecipes[key];
                                    recipeKey = key;
                                    break;
                                }
                            }
                        }
                        if (!recipe && foodDatabase && foodDatabase.dishes) {
                            for (let key in foodDatabase.dishes) {
                                if (foodDatabase.dishes[key].name === recipeSearchSelected) {
                                    recipe = foodDatabase.dishes[key];
                                    recipeKey = key;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!recipe) {
                        showErrorMessage('Recipe not found');
                        return;
                    }
                    
                    // Get servings from the quantity input
                    const servings = parseFloat(document.getElementById('recipeSearchQuantity')?.value) || 1;
                    const selectedMealType = document.getElementById('mealTypeSelector')?.value || 'Lunch';
                    
                    const nutrition = recipe.total_per_serving;
                    const meal = {
                        id: Date.now(),
                        description: `${recipe.name} (${servings} serving${servings !== 1 ? 's' : ''})`,
                        timestamp: new Date().toISOString(),
                        nutrition: {
                            calories: Math.round(nutrition.calories * servings),
                            protein: Math.round(nutrition.protein * servings * 10) / 10,
                            carbs: Math.round(nutrition.carbs * servings * 10) / 10,
                            fat: Math.round(nutrition.fat * servings * 10) / 10,
                            fiber: Math.round(nutrition.fiber * servings * 10) / 10
                        },
                        source: 'database',
                        mealType: selectedMealType
                    };
                    
                    addMealToDate(meal);
                    updateDailySummary();
                    displayMeals();
                    saveMealsToServer('meal_added');
                    updateModalContent();
                    
                    showSuccessMessage(`Added ${recipe.name} to ${selectedMealType}!`);
                    
                    // Reset the search and quantity
                    document.getElementById('recipeSearchBox').value = '';
                    document.getElementById('recipeSearchQuantity').value = '1';
                    document.getElementById('selectedRecipeActions').classList.add('hidden');
                    recipeSearchSelected = null;
                }
                
                // Edit Recipe from Search - uses same function as quickDishes
                function editRecipeFromSearch() {
                    if (!recipeSearchSelected) {
                        showErrorMessage('Please select a recipe first');
                        return;
                    }
                    
                    // Find the recipe key
                    let recipeKey = recipeSearchSelected;
                    
                    // Check if it's in customRecipes
                    if (customRecipes && customRecipes[recipeKey]) {
                        editRecipe(recipeKey);
                    } else {
                        // Try to find by name
                        let found = false;
                        if (customRecipes) {
                            for (let key in customRecipes) {
                                if (customRecipes[key].name === recipeSearchSelected) {
                                    editRecipe(key);
                                    found = true;
                                    break;
                                }
                            }
                        }
                        
                        if (!found) {
                            showErrorMessage('Only custom recipes can be edited. This recipe is from the database.');
                        }
                    }
                    
                    // Close the modal after opening the recipe editor
                    setTimeout(() => {
                        closeUnifiedAddModal();
                    }, 200);
                }
                
                // Attach event listeners for recipe search buttons
                document.addEventListener('DOMContentLoaded', function() {
                    const addBtn = document.getElementById('addRecipeToLogBtn');
                    const editBtn = document.getElementById('editRecipeBtn');
                    
                    if (addBtn) {
                        addBtn.onclick = addRecipeFromSearch;
                    }
                    if (editBtn) {
                        editBtn.onclick = editRecipeFromSearch;
                    }
                });
        // Global variables
        let foodDatabase = {};
        let rawIngredients = {};
        let mealsByDate = {}; // New date-based storage structure
        let selectedDate = new Date(); // Initialize with current date
        let customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
        let currentRecipeIngredients = [];
        let currentMealIngredients = [];
        let selectedMealIngredient = null;
        let databaseLoadingPromise = null; // Track database loading state

        // Weight tracking variables
        let weightByDate = JSON.parse(localStorage.getItem('weightByDate') || '{}');
        let exerciseByDate = JSON.parse(localStorage.getItem('exerciseByDate') || '{}');
        let userHeight = parseFloat(localStorage.getItem('userHeight') || '0'); // Store height in inches
        let userCalorieGoal = parseInt(localStorage.getItem('userCalorieGoal') || '0');
        let userUnitSystem = localStorage.getItem('userUnitSystem') || 'imperial'; // 'metric' or 'imperial'
        let userHeightCm = parseFloat(localStorage.getItem('userHeightCm') || '0'); // Store height in cm for metric users

        // Exercise calorie settings for dynamic goal adjustment
        let exerciseCalorieSettings = JSON.parse(localStorage.getItem('exerciseCalorieSettings') || JSON.stringify({
            eatBackExercise: false,
            eatBackPercentage: 50,
            lastUpdated: new Date().toISOString()
        }));

        // Unit conversion functions
        function kgToLbs(kg) {
            const result = kg * 2.20462;
            console.log('üîÑ CONVERT: kgToLbs', { kg, lbs: result.toFixed(3) });
            return result;
        }

        function lbsToKg(lbs) {
            const result = lbs / 2.20462;
            console.log('üîÑ CONVERT: lbsToKg', { lbs, kg: result.toFixed(3) });
            return result;
        }

        function cmToInches(cm) {
            const result = cm / 2.54;
            console.log('üîÑ CONVERT: cmToInches', { cm, inches: result.toFixed(3) });
            return result;
        }

        function inchesToCm(inches) {
            const result = inches * 2.54;
            console.log('üîÑ CONVERT: inchesToCm', { inches, cm: result.toFixed(3) });
            return result;
        }

        function feetInchesToCm(feet, inches) {
            const totalInches = (feet * 12) + inches;
            return inchesToCm(totalInches);
        }

        function cmToFeetInches(cm) {
            const totalInches = cmToInches(cm);
            const feet = Math.floor(totalInches / 12);
            const inches = totalInches % 12;
            return { feet: feet, inches: inches };
        }

        // Date management functions
        function formatDateKey(date) {
            // Use local timezone components to avoid UTC day shifts
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                console.warn('‚ö†Ô∏è DATE_KEY: Invalid date provided, using current local date as fallback:', date);
                console.warn('‚ö†Ô∏è DATE_KEY: Stack trace:', new Error().stack);
                date = new Date();
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${day}`;
            console.log('üìÖ DATE_KEY: Generated local date key:', dateKey);
            return dateKey;
        }

        function formatDateDisplay(date) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return date.toLocaleDateString('en-US', options);
        }

        function getSafeSelectedDate() {
            // Safely return selectedDate or fallback to current date
            if (selectedDate && selectedDate instanceof Date && !isNaN(selectedDate.getTime())) {
                return selectedDate;
            }
            
            console.warn('‚ö†Ô∏è getSafeSelectedDate: selectedDate is invalid, using current date as fallback');
            return new Date();
        }

        function initializeDateSystem() {
            console.log('üìÖ DATE_INIT: Initializing date system...');
            console.log('üìÖ DATE_INIT: Current time:', new Date().toISOString());
            console.log('üìÖ DATE_INIT: User timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
            
            // Ensure selectedDate is properly initialized to today (local)
            if (!selectedDate || !(selectedDate instanceof Date) || isNaN(selectedDate.getTime())) {
                console.log('üìÖ DATE_INIT: selectedDate was invalid, setting to today');
                selectedDate = new Date();
                console.log('üìÖ DATE_INIT: New selectedDate set to:', selectedDate.toString());
            } else {
                console.log('üìÖ DATE_INIT: selectedDate already valid:', selectedDate.toISOString().split('T')[0]);
            }
            
            // Log the date key that will be generated
            const todayKey = formatDateKey(selectedDate);
            console.log('üìÖ DATE_INIT: Today\'s date key will be:', todayKey);
            console.log('üìÖ DATE_INIT: Available meal dates:', Object.keys(mealsByDate));
            
            // Migrate existing data if needed
            migrateExistingData();
            
            // Update UI
            updateDateDisplay();
            // Auto-refresh initial date from DB
            refreshMealsFromDB();
            updateDailySummary();
            displayMeals();
            displayTodaysExercises();
            
            // Auto-sync meals to server on load
            autoSyncMealsToServer();
            
            console.log('‚úÖ DATE_INIT: Date system initialized successfully');
        }

        function migrateExistingData() {
            // Check if old format data exists
            const oldMeals = localStorage.getItem('indianFoodMeals');
            if (oldMeals) {
                try {
                    const meals = JSON.parse(oldMeals);
                    console.log('üîÑ Migrating existing meal data to date-based format...');
                    
                    // Load existing date-based data if any
                    const existingDateData = localStorage.getItem('indianFoodMealsByDate');
                    if (existingDateData) {
                        mealsByDate = JSON.parse(existingDateData);
                    }
                    
                    // Migrate old meals to date-based structure
                    meals.forEach(meal => {
                        const mealDate = new Date(meal.timestamp);
                        const dateKey = formatDateKey(mealDate);
                        
                        if (!mealsByDate[dateKey]) {
                            mealsByDate[dateKey] = [];
                        }
                        
                        // Check if meal already exists (avoid duplicates)
                        const existingMeal = mealsByDate[dateKey].find(m => m.id === meal.id);
                        if (!existingMeal) {
                            mealsByDate[dateKey].push(meal);
                        }
                    });
                    
                    // Save migrated data
                    localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));
                    
                    // Keep old data for backup but rename it
                    localStorage.setItem('indianFoodMeals_backup', oldMeals);
                    localStorage.removeItem('indianFoodMeals');
                    
                    console.log('‚úÖ Migration completed successfully!');
                    showSuccessMessage('üìÖ Data migrated to new date-based system!');
                } catch (error) {
                    console.error('‚ùå Error during migration:', error);
                    showErrorMessage('Error migrating data: ' + error.message);
                }
            } else {
                // Load existing date-based data
                const existingDateData = localStorage.getItem('indianFoodMealsByDate');
                if (existingDateData) {
                    mealsByDate = JSON.parse(existingDateData);
                }
            }
        }

        function updateDateDisplay() {
            const dateSelector = document.getElementById('dateSelector');
            const dateDisplay = document.getElementById('selectedDateDisplay');
            const summaryTitle = document.getElementById('dailySummaryTitle');
            
            // Update date input
            const safeDate = getSafeSelectedDate();
            const dateKey = formatDateKey(safeDate);
            dateSelector.value = dateKey;
            console.log('üìÖ UPDATE_DATE_DISPLAY: Set date selector to:', dateKey);
            
            // Update display text
            const displayText = formatDateDisplay(selectedDate);
            dateDisplay.textContent = displayText;
            console.log('üìÖ UPDATE_DATE_DISPLAY: Set date display to:', displayText);
            
            // Update summary title
            const today = new Date();
            const todayKey = formatDateKey(today);
            const selectedKey = dateKey; // Reuse the dateKey we already calculated
            const isToday = selectedKey === todayKey;
            const isYesterday = selectedKey === formatDateKey(new Date(today.getTime() - 24 * 60 * 60 * 1000));
            
            console.log('üìÖ UPDATE_DATE_DISPLAY: Today key:', todayKey);
            console.log('üìÖ UPDATE_DATE_DISPLAY: Selected key:', selectedKey);
            console.log('üìÖ UPDATE_DATE_DISPLAY: Is today?', isToday);
            console.log('üìÖ UPDATE_DATE_DISPLAY: Is yesterday?', isYesterday);
            
            let titleText = 'üìä Daily Summary';
            if (isToday) {
                titleText += ' - Today';
            } else if (isYesterday) {
                titleText += ' - Yesterday';
            } else {
                titleText += ` - ${safeDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
            
            // Add nursing indicator to summary title if applicable
            const weightData = weightByDate[dateKey] || getRecentWeightData(); // Reuse dateKey
            if (weightData && weightData.isNursing) {
                titleText += ' ü§±';
            }
            
            summaryTitle.textContent = titleText;
            console.log('üìÖ UPDATE_DATE_DISPLAY: Set summary title to:', titleText);
        }

        function navigateDate(days) {
            selectedDate.setDate(selectedDate.getDate() + days);
            updateDateDisplay();
            // Auto-refresh from DB for the new date
            refreshMealsFromDB();
            updateDailySummary();
            displayMeals();
            displayTodaysExercises();
        }

        function selectDate() {
            const dateSelector = document.getElementById('dateSelector');
            // Parse as local date to avoid timezone confusion
            const [y, m, d] = (dateSelector.value || '').split('-').map(Number);
            if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
                selectedDate = new Date(y, m - 1, d);
            } else {
                console.warn('‚ö†Ô∏è selectDate: Invalid date value in selector, falling back to today');
                selectedDate = new Date();
            }
            updateDateDisplay();
            // Auto-refresh from DB when date is selected
            refreshMealsFromDB();
            updateDailySummary();
            displayMeals();
            displayTodaysExercises();
        }

        function goToToday() {
            selectedDate = new Date();
            updateDateDisplay();
            // Auto-refresh today from DB
            refreshMealsFromDB();
            updateDailySummary();
            displayMeals();
            displayTodaysExercises();
        }

        function goToYesterday() {
            selectedDate = new Date();
            selectedDate.setDate(selectedDate.getDate() - 1);
            updateDateDisplay();
            // Auto-refresh yesterday from DB
            refreshMealsFromDB();
            updateDailySummary();
            displayMeals();
            displayTodaysExercises();
        }

        function getCurrentDateMeals() {
            console.log('üìÖ GET_MEALS: getCurrentDateMeals() called');
            console.log('üìÖ GET_MEALS: selectedDate state:', selectedDate ? selectedDate.toISOString().split('T')[0] : 'NULL');
            
            const safeDate = getSafeSelectedDate();
            console.log('üìÖ GET_MEALS: Safe date retrieved:', safeDate.toISOString().split('T')[0]);
            
            const dateKey = formatDateKey(safeDate);
            console.log('üìÖ GET_MEALS: Generated date key:', dateKey);
            
            // Validate mealsByDate structure
            if (!mealsByDate || typeof mealsByDate !== 'object') {
                console.error('‚ùå GET_MEALS: mealsByDate is invalid:', typeof mealsByDate);
                console.error('‚ùå GET_MEALS: Initializing empty mealsByDate object');
                mealsByDate = {};
                return [];
            }
            
            const meals = mealsByDate[dateKey] || [];
            console.log('üìÖ GET_MEALS: Found', meals.length, 'meals for date key:', dateKey);
            
            // Validate meal data structure
            if (meals.length > 0) {
                const validMeals = meals.filter(meal => {
                    const isValid = meal &&
                                   typeof meal === 'object' &&
                                   meal.id &&
                                   meal.description &&
                                   meal.nutrition &&
                                   typeof meal.nutrition.calories === 'number';
                    
                    if (!isValid) {
                        console.warn('‚ö†Ô∏è GET_MEALS: Invalid meal data found:', meal);
                    }
                    return isValid;
                });
                
                if (validMeals.length !== meals.length) {
                    console.warn('‚ö†Ô∏è GET_MEALS: Filtered out', meals.length - validMeals.length, 'invalid meals');
                    // Update the stored data to remove invalid meals
                    mealsByDate[dateKey] = validMeals;
                    saveMealsToStorage();
                }
                
                console.log('üìÖ GET_MEALS: Returning', validMeals.length, 'valid meals');
                return validMeals;
            }
            
            console.log('üìÖ GET_MEALS: No meals found for date, returning empty array');
            return meals;
        }

        // Fetch meals for the selected date from the server and update local state
        async function refreshMealsFromDB() {
            try {
                const safeDate = getSafeSelectedDate();
                const dateKey = formatDateKey(safeDate);
                console.log('üîÑ REFRESH_DB: Fetching meals for date', dateKey);

                const resp = await fetch(`/api/meals?date=${encodeURIComponent(dateKey)}`);
                if (!resp.ok) {
                    console.warn('‚ö†Ô∏è REFRESH_DB: Failed to fetch meals from server:', resp.status);
                    return;
                }
                const data = await resp.json();
                
                // Handle API response format: can be array or {date: [meals]}
                let meals = [];
                if (Array.isArray(data)) {
                    meals = data;
                } else if (data && typeof data === 'object' && data[dateKey]) {
                    meals = data[dateKey];
                } else {
                    console.warn('‚ö†Ô∏è REFRESH_DB: Unexpected response format', data);
                    return;
                }

                // Update local storage structure and UI
                mealsByDate[dateKey] = meals;
                saveMealsToStorage();
                console.log('‚úÖ REFRESH_DB: Updated mealsByDate for', dateKey, 'count:', meals.length);

                displayMeals();
                updateDailySummary();
            } catch (err) {
                console.error('‚ùå REFRESH_DB: Error refreshing from DB:', err);
            }
        }

        function addMealToDate(meal) {
            const safeDate = getSafeSelectedDate();
            const dateKey = formatDateKey(safeDate);
            if (!mealsByDate[dateKey]) {
                mealsByDate[dateKey] = [];
            }

            // Add date information to meal
            meal.date = dateKey;
            meal.timestamp = new Date(safeDate.getFullYear(), safeDate.getMonth(), safeDate.getDate(),
                new Date().getHours(), new Date().getMinutes(), new Date().getSeconds()).toISOString();

            mealsByDate[dateKey].push(meal);
            saveMealsToStorage();
            
            // Auto-sync to database
            syncMealToDatabase(meal, dateKey, 'add');
        }

        function removeMealFromDate(mealId) {
            const safeDate = getSafeSelectedDate();
            const dateKey = formatDateKey(safeDate);
            if (mealsByDate[dateKey]) {
                mealsByDate[dateKey] = mealsByDate[dateKey].filter(meal => meal.id !== mealId);
                if (mealsByDate[dateKey].length === 0) {
                    delete mealsByDate[dateKey];
                }
                saveMealsToStorage();
                
                // Auto-sync to database
                syncMealToDatabase({ id: mealId }, dateKey, 'delete');
            }
        }

        function saveMealsToStorage() {
            localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));
        }
        
        // Auto-sync meal changes to database
        async function syncMealToDatabase(meal, date, operation) {
            try {
                if (operation === 'add') {
                    const response = await fetch('/api/meals', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date, meal })
                    });
                    if (response.ok) {
                        console.log('‚úÖ Meal synced to database:', meal.description);
                    }
                } else if (operation === 'delete') {
                    const response = await fetch(`/api/meals/${meal.id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        console.log('‚úÖ Meal deleted from database:', meal.id);
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Database sync failed (offline?):', error.message);
                // Fail silently - data is still in localStorage
            }
        }

        // ========================================
        // WEIGHT TRACKING FUNCTIONS
        // ========================================

        // Save weight data to localStorage
        function saveWeightData() {
            localStorage.setItem('weightByDate', JSON.stringify(weightByDate));
            localStorage.setItem('exerciseByDate', JSON.stringify(exerciseByDate));
            localStorage.setItem('userHeight', userHeight.toString());
            localStorage.setItem('userCalorieGoal', userCalorieGoal.toString());
            localStorage.setItem('exerciseCalorieSettings', JSON.stringify(exerciseCalorieSettings));
        }

        // Load weight data from localStorage
        function loadWeightData() {
            weightByDate = JSON.parse(localStorage.getItem('weightByDate') || '{}');
            exerciseByDate = JSON.parse(localStorage.getItem('exerciseByDate') || '{}');
            userHeight = parseFloat(localStorage.getItem('userHeight') || '0');
            userCalorieGoal = parseInt(localStorage.getItem('userCalorieGoal') || '0');
            exerciseCalorieSettings = JSON.parse(localStorage.getItem('exerciseCalorieSettings') || JSON.stringify({
                eatBackExercise: false,
                eatBackPercentage: 50,
                lastUpdated: new Date().toISOString()
            }));
            updateWeightDisplay();
        }

        // Calculate BMI from weight and height (supports both unit systems)
        function calculateBMI(weight, height, unitSystem = 'imperial') {
            console.log('üßÆ BMI_CALC: calculateBMI called', { weight, height, unitSystem });
            
            if (!weight || !height || weight <= 0 || height <= 0) {
                console.log('‚ùå BMI_CALC: Invalid input values');
                return null;
            }
            
            let bmi;
            if (unitSystem === 'metric') {
                // BMI = weight in kg / (height in meters)¬≤
                const heightInMeters = height / 100; // Convert cm to meters
                bmi = weight / (heightInMeters * heightInMeters);
                console.log('üìä BMI_CALC: Metric calculation', {
                    weightKg: weight,
                    heightCm: height,
                    heightMeters: heightInMeters.toFixed(3),
                    calculation: `${weight} / (${heightInMeters.toFixed(3)})¬≤ = ${bmi.toFixed(3)}`
                });
            } else {
                // BMI = (weight in pounds / (height in inches)¬≤) √ó 703
                const heightSquared = height * height;
                bmi = (weight / heightSquared) * 703;
                console.log('üìä BMI_CALC: Imperial calculation', {
                    weightLbs: weight,
                    heightInches: height,
                    heightSquared: heightSquared,
                    calculation: `(${weight} / ${heightSquared}) √ó 703 = ${bmi.toFixed(3)}`
                });
                
                // Manual verification for debugging
                console.log('üìä BMI_CALC: Step-by-step verification:');
                console.log(`  Step 1: ${weight} √∑ ${heightSquared} = ${(weight / heightSquared).toFixed(6)}`);
                console.log(`  Step 2: ${(weight / heightSquared).toFixed(6)} √ó 703 = ${bmi.toFixed(3)}`);
            }
            
            return bmi;
        }

        // Calculate BMI with automatic unit detection
        function calculateBMIAuto(weightValue, heightValue, isMetric = false) {
            console.log('üßÆ BMI_AUTO: calculateBMIAuto called', { weightValue, heightValue, isMetric });
            
            let result;
            if (isMetric) {
                console.log('üßÆ BMI_AUTO: Using metric calculation');
                result = calculateBMI(weightValue, heightValue, 'metric');
            } else {
                console.log('üßÆ BMI_AUTO: Using imperial calculation');
                result = calculateBMI(weightValue, heightValue, 'imperial');
            }
            
            console.log('üßÆ BMI_AUTO: Result:', result?.toFixed(3));
            return result;
        }

        // Get BMI category and color
        function getBMICategory(bmi) {
            if (!bmi || bmi <= 0) {
                return { category: 'Unknown', color: 'gray', bgColor: 'bg-gray-100', textColor: 'text-gray-600' };
            }
            
            if (bmi < 18.5) {
                return { category: 'Underweight', color: 'blue', bgColor: 'bg-blue-100', textColor: 'text-blue-600' };
            } else if (bmi < 25) {
                return { category: 'Normal', color: 'green', bgColor: 'bg-green-100', textColor: 'text-green-600' };
            } else if (bmi < 30) {
                return { category: 'Overweight', color: 'yellow', bgColor: 'bg-yellow-100', textColor: 'text-yellow-600' };
            } else {
                return { category: 'Obese', color: 'red', bgColor: 'bg-red-100', textColor: 'text-red-600' };
            }
        }

        // Map BMI to percentage for visual bar (0-100%)
        function getBMIBarPosition(bmi) {
            if (!bmi || bmi <= 0) return 0;
            
            // Map BMI ranges to percentage positions
            // Underweight: 0-25%, Normal: 25-50%, Overweight: 50-75%, Obese: 75-100%
            if (bmi < 18.5) {
                // Underweight: map 15-18.5 to 0-25%
                return Math.max(0, Math.min(25, ((bmi - 15) / 3.5) * 25));
            } else if (bmi < 25) {
                // Normal: map 18.5-25 to 25-50%
                return 25 + ((bmi - 18.5) / 6.5) * 25;
            } else if (bmi < 30) {
                // Overweight: map 25-30 to 50-75%
                return 50 + ((bmi - 25) / 5) * 25;
            } else {
                // Obese: map 30-40 to 75-100%
                return Math.min(100, 75 + ((bmi - 30) / 10) * 25);
            }
        }

        // ========================================
        // BMR CALCULATION FUNCTIONS
        // ========================================

        // Calculate BMR using Mifflin-St Jeor equation (more accurate)
        function calculateBMRMifflinStJeor(weight, height, age, gender, unitSystem = 'imperial', isNursing = false) {
            console.log('üßÆ BMR_MIFFLIN: calculateBMRMifflinStJeor called', { weight, height, age, gender, unitSystem, isNursing });
            
            if (!weight || !height || !age || !gender || weight <= 0 || height <= 0 || age <= 0) {
                console.log('‚ùå BMR_MIFFLIN: Invalid input values');
                return null;
            }
            
            let weightKg, heightCm;
            
            if (unitSystem === 'metric') {
                weightKg = weight;
                heightCm = height;
            } else {
                // Convert imperial to metric for calculation
                weightKg = lbsToKg(weight);
                heightCm = inchesToCm(height);
            }
            
            console.log('üìä BMR_MIFFLIN: Converted values', {
                weightKg: weightKg.toFixed(2),
                heightCm: heightCm.toFixed(2),
                age,
                gender,
                isNursing
            });
            
            let bmr;
            if (gender.toLowerCase() === 'male' || gender.toLowerCase() === 'm') {
                // Men: BMR = (10 √ó weight_kg) + (6.25 √ó height_cm) - (5 √ó age) + 5
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
                console.log('üìä BMR_MIFFLIN: Male calculation', {
                    calculation: `(10 √ó ${weightKg.toFixed(2)}) + (6.25 √ó ${heightCm.toFixed(2)}) - (5 √ó ${age}) + 5`,
                    result: bmr.toFixed(2)
                });
            } else {
                // Women: BMR = (10 √ó weight_kg) + (6.25 √ó height_cm) - (5 √ó age) - 161
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
                console.log('üìä BMR_MIFFLIN: Female calculation', {
                    calculation: `(10 √ó ${weightKg.toFixed(2)}) + (6.25 √ó ${heightCm.toFixed(2)}) - (5 √ó ${age}) - 161`,
                    result: bmr.toFixed(2)
                });
            }
            
            // Add nursing mother adjustment (400 calories - middle of 300-500 range)
            if (isNursing && (gender.toLowerCase() === 'female' || gender.toLowerCase() === 'f')) {
                const nursingAdjustment = 400;
                bmr += nursingAdjustment;
                console.log('ü§± BMR_MIFFLIN: Nursing mother adjustment applied', {
                    originalBMR: (bmr - nursingAdjustment).toFixed(2),
                    nursingAdjustment,
                    adjustedBMR: bmr.toFixed(2)
                });
            }
            
            console.log('‚úÖ BMR_MIFFLIN: Final BMR:', bmr.toFixed(2), 'calories/day');
            return bmr;
        }

        // Calculate BMR using Harris-Benedict equation (traditional)
        function calculateBMRHarrisBenedict(weight, height, age, gender, unitSystem = 'imperial', isNursing = false) {
            console.log('üßÆ BMR_HARRIS: calculateBMRHarrisBenedict called', { weight, height, age, gender, unitSystem, isNursing });
            
            if (!weight || !height || !age || !gender || weight <= 0 || height <= 0 || age <= 0) {
                console.log('‚ùå BMR_HARRIS: Invalid input values');
                return null;
            }
            
            let weightKg, heightCm;
            
            if (unitSystem === 'metric') {
                weightKg = weight;
                heightCm = height;
            } else {
                // Convert imperial to metric for calculation
                weightKg = lbsToKg(weight);
                heightCm = inchesToCm(height);
            }
            
            console.log('üìä BMR_HARRIS: Converted values', {
                weightKg: weightKg.toFixed(2),
                heightCm: heightCm.toFixed(2),
                age,
                gender,
                isNursing
            });
            
            let bmr;
            if (gender.toLowerCase() === 'male' || gender.toLowerCase() === 'm') {
                // Men: BMR = 88.362 + (13.397 √ó weight_kg) + (4.799 √ó height_cm) - (5.677 √ó age)
                bmr = 88.362 + (13.397 * weightKg) + (4.799 * heightCm) - (5.677 * age);
                console.log('üìä BMR_HARRIS: Male calculation', {
                    calculation: `88.362 + (13.397 √ó ${weightKg.toFixed(2)}) + (4.799 √ó ${heightCm.toFixed(2)}) - (5.677 √ó ${age})`,
                    result: bmr.toFixed(2)
                });
            } else {
                // Women: BMR = 447.593 + (9.247 √ó weight_kg) + (3.098 √ó height_cm) - (4.330 √ó age)
                bmr = 447.593 + (9.247 * weightKg) + (3.098 * heightCm) - (4.330 * age);
                console.log('üìä BMR_HARRIS: Female calculation', {
                    calculation: `447.593 + (9.247 √ó ${weightKg.toFixed(2)}) + (3.098 √ó ${heightCm.toFixed(2)}) - (4.330 √ó ${age})`,
                    result: bmr.toFixed(2)
                });
            }
            
            // Add nursing mother adjustment (400 calories - middle of 300-500 range)
            if (isNursing && (gender.toLowerCase() === 'female' || gender.toLowerCase() === 'f')) {
                const nursingAdjustment = 400;
                bmr += nursingAdjustment;
                console.log('ü§± BMR_HARRIS: Nursing mother adjustment applied', {
                    originalBMR: (bmr - nursingAdjustment).toFixed(2),
                    nursingAdjustment,
                    adjustedBMR: bmr.toFixed(2)
                });
            }
            
            console.log('‚úÖ BMR_HARRIS: Final BMR:', bmr.toFixed(2), 'calories/day');
            return bmr;
        }

        // Calculate BMR with automatic unit detection (defaults to Mifflin-St Jeor)
        function calculateBMRAuto(weightValue, heightValue, age, gender, isMetric = false, method = 'mifflin', isNursing = false) {
            console.log('üßÆ BMR_AUTO: calculateBMRAuto called', { weightValue, heightValue, age, gender, isMetric, method, isNursing });
            
            const unitSystem = isMetric ? 'metric' : 'imperial';
            
            if (method === 'harris') {
                return calculateBMRHarrisBenedict(weightValue, heightValue, age, gender, unitSystem, isNursing);
            } else {
                return calculateBMRMifflinStJeor(weightValue, heightValue, age, gender, unitSystem, isNursing);
            }
        }

        // Get BMR method description
        function getBMRMethodInfo(method = 'mifflin') {
            if (method === 'harris') {
                return {
                    name: 'Harris-Benedict',
                    description: 'Traditional equation (1919)',
                    accuracy: 'Good for general population',
                    note: 'May overestimate for very active or obese individuals'
                };
            } else {
                return {
                    name: 'Mifflin-St Jeor',
                    description: 'Modern equation (1990)',
                    accuracy: 'More accurate for modern lifestyles',
                    note: 'Recommended by most nutritionists'
                };
            }
        }

        // Calculate Total Daily Energy Expenditure (TDEE) from BMR
        function calculateTDEE(bmr, activityLevel = 'sedentary') {
            if (!bmr || bmr <= 0) return null;
            
            const activityMultipliers = {
                'sedentary': 1.2,        // Little/no exercise
                'light': 1.375,          // Light exercise 1-3 days/week
                'moderate': 1.55,        // Moderate exercise 3-5 days/week
                'active': 1.725,         // Hard exercise 6-7 days/week
                'very_active': 1.9       // Very hard exercise, physical job
            };
            
            const multiplier = activityMultipliers[activityLevel] || 1.2;
            const tdee = bmr * multiplier;
            
            console.log('üìä TDEE: Calculated TDEE', {
                bmr: bmr.toFixed(2),
                activityLevel,
                multiplier,
                tdee: tdee.toFixed(2)
            });
            
            return tdee;
        }

        // Switch between metric and imperial units
        function switchUnits() {
            const isMetric = document.getElementById('metricUnits').checked;
            const imperialSection = document.getElementById('imperialHeightSection');
            const metricSection = document.getElementById('metricHeightSection');
            const weightLabel = document.getElementById('weightLabel');
            const weightInput = document.getElementById('weightInput');
            
            if (isMetric) {
                // Switch to metric
                imperialSection.classList.add('hidden');
                metricSection.classList.remove('hidden');
                weightLabel.textContent = 'Current Weight (kg):';
                weightInput.placeholder = 'Enter weight in kilograms';
                weightInput.min = '20';
                weightInput.max = '300';
                weightInput.step = '0.1';
                userUnitSystem = 'metric';
            } else {
                // Switch to imperial
                imperialSection.classList.remove('hidden');
                metricSection.classList.add('hidden');
                weightLabel.textContent = 'Current Weight (lbs):';
                weightInput.placeholder = 'Enter weight in pounds';
                weightInput.min = '50';
                weightInput.max = '500';
                weightInput.step = '0.1';
                userUnitSystem = 'imperial';
            }
            
            // Save unit preference
            localStorage.setItem('userUnitSystem', userUnitSystem);
            
            // Update BMI preview if inputs have values
            updateBMIPreview();
        }

        // Open weight entry modal
        function openWeightEntryModal() {
            const modal = document.getElementById('weightEntryModal');
            const weightInput = document.getElementById('weightInput');
            const calorieGoalInput = document.getElementById('calorieGoalInput');
            
            // Set unit system preference
            if (userUnitSystem === 'metric') {
                document.getElementById('metricUnits').checked = true;
            } else {
                document.getElementById('imperialUnits').checked = true;
            }
            switchUnits(); // Apply unit system
            
            // Pre-fill height based on unit system
            if (userUnitSystem === 'metric' && userHeightCm > 0) {
                document.getElementById('heightCm').value = userHeightCm;
            } else if (userUnitSystem === 'imperial' && userHeight > 0) {
                const feetInches = cmToFeetInches(inchesToCm(userHeight));
                document.getElementById('heightFeet').value = Math.floor(feetInches.feet);
                document.getElementById('heightInches').value = Math.round(feetInches.inches * 2) / 2;
            }
            
            // Pre-fill calorie goal if we have it
            if (userCalorieGoal > 0) {
                calorieGoalInput.value = userCalorieGoal;
            }
            
            // Get current weight if available and convert to display units
            const dateKey = formatDateKey(selectedDate);
            if (weightByDate[dateKey]) {
                const storedWeight = weightByDate[dateKey].weight; // Always stored in lbs
                if (userUnitSystem === 'metric') {
                    weightInput.value = Math.round(lbsToKg(storedWeight) * 10) / 10;
                } else {
                    weightInput.value = storedWeight;
                }
            }
            
            // Add event listeners for real-time BMI and BMR preview
            weightInput.addEventListener('input', updateBMIPreview);
            document.getElementById('heightFeet')?.addEventListener('input', updateBMIPreview);
            document.getElementById('heightInches')?.addEventListener('input', updateBMIPreview);
            document.getElementById('heightCm')?.addEventListener('input', updateBMIPreview);
            document.getElementById('ageInput')?.addEventListener('input', updateBMIPreview);
            document.getElementById('genderSelect')?.addEventListener('change', updateBMIPreview);
            document.getElementById('nursingMotherCheckbox')?.addEventListener('change', updateNursingStatus);
            document.getElementById('calorieGoalInput')?.addEventListener('input', validateCalorieGoalInput);
            
            modal.classList.add('active');
            weightInput.focus();
        }

        // Validate calorie goal input in real-time
        function validateCalorieGoalInput() {
            const calorieGoalInput = document.getElementById('calorieGoalInput');
            const warningDiv = document.getElementById('calorieGoalWarning');
            const warningText = document.getElementById('calorieGoalWarningText');
            const nursingCheckbox = document.getElementById('nursingMotherCheckbox');
            
            if (!calorieGoalInput || !warningDiv || !warningText) return;
            
            const goalValue = parseInt(calorieGoalInput.value);
            const isNursing = nursingCheckbox && nursingCheckbox.checked;
            const minCalories = isNursing ? 1800 : 1200;
            
            if (goalValue && goalValue < minCalories) {
                // Show warning for unsafe calorie goal
                warningDiv.classList.remove('hidden');
                if (isNursing) {
                    warningText.textContent = `‚ö†Ô∏è Nursing mothers need at least 1,800 calories daily for milk production and maternal health. Your goal of ${goalValue.toLocaleString()} calories is too low.`;
                } else {
                    warningText.textContent = `‚ö†Ô∏è For safe weight loss, you need at least 1,200 calories daily. Your goal of ${goalValue.toLocaleString()} calories is too low.`;
                }
                calorieGoalInput.classList.add('border-red-500');
                calorieGoalInput.classList.remove('border-gray-300');
            } else {
                // Hide warning for safe calorie goal
                warningDiv.classList.add('hidden');
                calorieGoalInput.classList.remove('border-red-500');
                calorieGoalInput.classList.add('border-gray-300');
            }
        }

        // Update nursing status and show/hide warning
        function updateNursingStatus() {
            const checkbox = document.getElementById('nursingMotherCheckbox');
            const warningDiv = document.getElementById('nursingWarning');
            
            if (checkbox && warningDiv) {
                if (checkbox.checked) {
                    warningDiv.classList.remove('hidden');
                } else {
                    warningDiv.classList.add('hidden');
                }
            }
            
            // Re-validate calorie goal when nursing status changes
            validateCalorieGoalInput();
        }

        // Close weight entry modal
        function closeWeightEntryModal() {
            const modal = document.getElementById('weightEntryModal');
            modal.classList.remove('active');
            
            // Clear form
            document.getElementById('weightInput').value = '';
            document.getElementById('heightInput').value = userHeight || '';
            document.getElementById('calorieGoalInput').value = userCalorieGoal || '';
            document.getElementById('weightNotesInput').value = '';
            document.getElementById('bmiPreviewSection').classList.add('hidden');
        }

        // Update BMI and BMR preview in modal
        function updateBMIPreview() {
            const weightInput = document.getElementById('weightInput');
            const ageInput = document.getElementById('ageInput');
            const genderSelect = document.getElementById('genderSelect');
            const bmiPreviewSection = document.getElementById('bmiPreviewSection');
            const bmrPreviewSection = document.getElementById('bmrPreviewSection');
            const previewBMI = document.getElementById('previewBMI');
            const previewCategory = document.getElementById('previewBMICategory');
            const bmiIndicator = document.getElementById('bmiIndicator');
            
            const weight = parseFloat(weightInput.value);
            const age = parseInt(ageInput.value);
            const gender = genderSelect.value;
            const isMetric = document.getElementById('metricUnits').checked;
            
            let height = 0;
            if (isMetric) {
                const heightCm = parseFloat(document.getElementById('heightCm').value);
                height = heightCm;
            } else {
                const feet = parseFloat(document.getElementById('heightFeet').value) || 0;
                const inches = parseFloat(document.getElementById('heightInches').value) || 0;
                height = (feet * 12) + inches; // Convert to total inches
            }
            
            // Update BMI Preview
            if (weight > 0 && height > 0) {
                const bmi = calculateBMIAuto(weight, height, isMetric);
                const category = getBMICategory(bmi);
                const position = getBMIBarPosition(bmi);
                
                previewBMI.textContent = bmi.toFixed(1);
                previewCategory.textContent = category.category;
                previewCategory.className = `text-sm px-2 py-1 rounded ${category.bgColor} ${category.textColor}`;
                bmiIndicator.style.left = position + '%';
                
                bmiPreviewSection.classList.remove('hidden');
            } else {
                bmiPreviewSection.classList.add('hidden');
            }
            
            // Update BMR Preview
            if (weight > 0 && height > 0 && age > 0 && gender) {
                console.log('üî• BMR_PREVIEW: Calculating BMR preview', { weight, height, age, gender, isMetric });
                
                // Check nursing status
                const nursingCheckbox = document.getElementById('nursingMotherCheckbox');
                const isNursing = nursingCheckbox ? nursingCheckbox.checked : false;
                
                const bmrMifflin = calculateBMRAuto(weight, height, age, gender, isMetric, 'mifflin', isNursing);
                const bmrHarris = calculateBMRAuto(weight, height, age, gender, isMetric, 'harris', isNursing);
                
                if (bmrMifflin && bmrHarris) {
                    let mifflinText = Math.round(bmrMifflin) + ' cal/day';
                    let harrisText = Math.round(bmrHarris) + ' cal/day';
                    
                    // Add nursing indicator if applicable
                    if (isNursing && (gender.toLowerCase() === 'female' || gender.toLowerCase() === 'f')) {
                        mifflinText += ' ü§±';
                        harrisText += ' ü§±';
                    }
                    
                    document.getElementById('previewBMRMifflin').textContent = mifflinText;
                    document.getElementById('previewBMRHarris').textContent = harrisText;
                    
                    // Calculate TDEE estimates using Mifflin-St Jeor (more accurate)
                    const tdeeSedentary = calculateTDEE(bmrMifflin, 'sedentary');
                    const tdeeLight = calculateTDEE(bmrMifflin, 'light');
                    const tdeeModerate = calculateTDEE(bmrMifflin, 'moderate');
                    const tdeeActive = calculateTDEE(bmrMifflin, 'active');
                    
                    document.getElementById('tdeeSedentary').textContent = Math.round(tdeeSedentary);
                    document.getElementById('tdeeLight').textContent = Math.round(tdeeLight);
                    document.getElementById('tdeeModerate').textContent = Math.round(tdeeModerate);
                    document.getElementById('tdeeActive').textContent = Math.round(tdeeActive);
                    
                    document.getElementById('tdeePreview').classList.remove('hidden');
                    bmrPreviewSection.classList.remove('hidden');
                    
                    console.log('‚úÖ BMR_PREVIEW: BMR preview updated successfully', { isNursing });
                } else {
                    console.log('‚ùå BMR_PREVIEW: BMR calculation failed');
                    bmrPreviewSection.classList.add('hidden');
                }
            } else {
                bmrPreviewSection.classList.add('hidden');
                console.log('‚ö†Ô∏è BMR_PREVIEW: Missing required fields for BMR calculation');
            }
        }

        // Save weight entry
        function saveWeightEntry() {
            console.log('üíæ WEIGHT_SAVE: saveWeightEntry called');
            
            const weightInput = document.getElementById('weightInput');
            const calorieGoalInput = document.getElementById('calorieGoalInput');
            const notesInput = document.getElementById('weightNotesInput');
            const ageInput = document.getElementById('ageInput');
            const genderSelect = document.getElementById('genderSelect');
            const isMetric = document.getElementById('metricUnits').checked;
            
            const inputWeight = parseFloat(weightInput.value);
            const calorieGoal = parseInt(calorieGoalInput.value) || 0;
            const notes = notesInput.value.trim();
            const age = parseInt(ageInput.value);
            const gender = genderSelect.value;
            
            console.log('üíæ WEIGHT_SAVE: Input values', { inputWeight, isMetric, calorieGoal, age, gender });
            
            // Get height based on unit system
            let inputHeight = 0;
            if (isMetric) {
                inputHeight = parseFloat(document.getElementById('heightCm').value);
                console.log('üíæ WEIGHT_SAVE: Metric height input', { heightCm: inputHeight });
            } else {
                const feet = parseFloat(document.getElementById('heightFeet').value) || 0;
                const inches = parseFloat(document.getElementById('heightInches').value) || 0;
                inputHeight = (feet * 12) + inches; // Convert to total inches
                console.log('üíæ WEIGHT_SAVE: Imperial height input', { feet, inches, totalInches: inputHeight });
            }
            
            // Validation
            if (!inputWeight || inputWeight <= 0) {
                console.log('‚ùå WEIGHT_SAVE: Invalid weight');
                alert('Please enter a valid weight');
                weightInput.focus();
                return;
            }
            
            if (!inputHeight || inputHeight <= 0) {
                console.log('‚ùå WEIGHT_SAVE: Invalid height');
                alert('Please enter a valid height');
                if (isMetric) {
                    document.getElementById('heightCm').focus();
                } else {
                    document.getElementById('heightFeet').focus();
                }
                return;
            }
            
            // Convert and store weight consistently (always in lbs for internal storage)
            const weightInLbs = isMetric ? kgToLbs(inputWeight) : inputWeight;
            console.log('üíæ WEIGHT_SAVE: Weight conversion', {
                inputWeight,
                isMetric,
                weightInLbs: weightInLbs.toFixed(2)
            });
            
            // Convert and store height consistently (always in inches for internal storage)
            const heightInInches = isMetric ? cmToInches(inputHeight) : inputHeight;
            console.log('üíæ WEIGHT_SAVE: Height conversion', {
                inputHeight,
                isMetric,
                heightInInches: heightInInches.toFixed(2)
            });
            
            // Update user settings
            userHeight = heightInInches;
            userCalorieGoal = calorieGoal;
            userUnitSystem = isMetric ? 'metric' : 'imperial';
            
            // Store metric height separately for metric users
            if (isMetric) {
                userHeightCm = inputHeight;
                localStorage.setItem('userHeightCm', userHeightCm.toString());
            }
            
            // Calculate BMI using the input values in their original units
            const bmi = calculateBMIAuto(inputWeight, inputHeight, isMetric);
            const category = getBMICategory(bmi);
            console.log('üíæ WEIGHT_SAVE: BMI calculation result', {
                bmi: bmi?.toFixed(2),
                category: category.category
            });
            
            // Calculate BMR if age and gender are provided
            let bmrMifflin = null;
            let bmrHarris = null;
            if (age > 0 && gender) {
                // Check nursing status
                const nursingCheckbox = document.getElementById('nursingMotherCheckbox');
                const isNursing = nursingCheckbox ? nursingCheckbox.checked : false;
                
                bmrMifflin = calculateBMRAuto(inputWeight, inputHeight, age, gender, isMetric, 'mifflin', isNursing);
                bmrHarris = calculateBMRAuto(inputWeight, inputHeight, age, gender, isMetric, 'harris', isNursing);
                console.log('üíæ WEIGHT_SAVE: BMR calculation result', {
                    bmrMifflin: bmrMifflin?.toFixed(2),
                    bmrHarris: bmrHarris?.toFixed(2),
                    isNursing
                });
            }
            
            // Create weight entry (store in consistent units internally)
            const dateKey = formatDateKey(selectedDate);
            const nursingCheckbox = document.getElementById('nursingMotherCheckbox');
            const isNursing = nursingCheckbox ? nursingCheckbox.checked : false;
            
            const weightEntry = {
                weight: weightInLbs, // Always store in lbs
                height: heightInInches, // Always store in inches
                bmi: bmi,
                bmiCategory: category.category,
                age: age || null,
                gender: gender || null,
                bmrMifflin: bmrMifflin,
                bmrHarris: bmrHarris,
                calorieGoal: calorieGoal,
                notes: notes,
                isNursing: isNursing, // Store nursing status
                timestamp: new Date().toISOString(),
                date: dateKey,
                unitSystem: userUnitSystem, // Remember what units were used for entry
                originalWeight: inputWeight, // Store original input for reference
                originalHeight: inputHeight
            };
            
            console.log('üíæ WEIGHT_SAVE: Weight entry created', weightEntry);
            
            // Save to weight data
            weightByDate[dateKey] = weightEntry;
            console.log('üíæ WEIGHT_SAVE: Weight entry saved to weightByDate');
            
            // Save to localStorage
            saveWeightData();
            
            // Update display
            updateWeightDisplay();
            
            // Close modal
            closeWeightEntryModal();
            
            // Show success message with appropriate units
            const displayWeight = isMetric ? `${inputWeight} kg` : `${inputWeight} lbs`;
            let successMessage = `‚úÖ Weight entry saved! ${displayWeight}, BMI: ${bmi.toFixed(1)} (${category.category})`;
            
            if (bmrMifflin && bmrHarris) {
                successMessage += `, BMR: ${Math.round(bmrMifflin)} cal/day`;
            }
            
            showSuccessMessage(successMessage);
        }

        // Open exercise modal
        function openExerciseModal() {
            const modal = document.getElementById('exerciseModal');
            modal.classList.add('active');
            
            // Reset form
            document.getElementById('exerciseTypeSelect').value = '';
            document.getElementById('exerciseDuration').value = '';
            document.getElementById('customExerciseName').value = '';
            document.getElementById('exerciseCalories').value = '';
            document.getElementById('exerciseNotesInput').value = '';
            document.getElementById('customExerciseSection').classList.add('hidden');
            document.getElementById('calorieHint').textContent = 'Select exercise type and duration for auto-calculation';
        }

        // Close exercise modal
        function closeExerciseModal() {
            const modal = document.getElementById('exerciseModal');
            modal.classList.remove('active');
        }

        // Update exercise calories based on type and duration
        function updateExerciseCalories() {
            const typeSelect = document.getElementById('exerciseTypeSelect');
            const durationInput = document.getElementById('exerciseDuration');
            const caloriesInput = document.getElementById('exerciseCalories');
            const customSection = document.getElementById('customExerciseSection');
            const calorieHint = document.getElementById('calorieHint');
            
            const selectedOption = typeSelect.options[typeSelect.selectedIndex];
            const duration = parseFloat(durationInput.value) || 0;
            
            if (typeSelect.value === 'custom') {
                customSection.classList.remove('hidden');
                caloriesInput.readOnly = false;
                calorieHint.textContent = 'Enter calories burned manually for custom exercise';
                caloriesInput.value = '';
            } else if (typeSelect.value && duration > 0) {
                customSection.classList.add('hidden');
                const caloriesPerMin = parseFloat(selectedOption.dataset.calories) || 0;
                const totalCalories = Math.round(caloriesPerMin * duration);
                caloriesInput.value = totalCalories;
                caloriesInput.readOnly = true;
                calorieHint.textContent = `Auto-calculated: ${caloriesPerMin} cal/min √ó ${duration} min = ${totalCalories} calories`;
            } else {
                customSection.classList.add('hidden');
                caloriesInput.value = '';
                caloriesInput.readOnly = false;
                calorieHint.textContent = 'Select exercise type and duration for auto-calculation';
            }
        }

        // Save exercise entry
        function saveExerciseEntry() {
            const typeSelect = document.getElementById('exerciseTypeSelect');
            const durationInput = document.getElementById('exerciseDuration');
            const customNameInput = document.getElementById('customExerciseName');
            const caloriesInput = document.getElementById('exerciseCalories');
            const notesInput = document.getElementById('exerciseNotesInput');
            
            const exerciseType = typeSelect.value;
            const duration = parseFloat(durationInput.value);
            const calories = parseInt(caloriesInput.value);
            const notes = notesInput.value.trim();
            
            // Validation
            if (!exerciseType) {
                alert('Please select an exercise type');
                typeSelect.focus();
                return;
            }
            
            if (!duration || duration <= 0) {
                alert('Please enter a valid duration');
                durationInput.focus();
                return;
            }
            
            if (!calories || calories <= 0) {
                alert('Please enter valid calories burned');
                caloriesInput.focus();
                return;
            }
            
            if (exerciseType === 'custom' && !customNameInput.value.trim()) {
                alert('Please enter a name for the custom exercise');
                customNameInput.focus();
                return;
            }
            
            // Get exercise name
            let exerciseName;
            if (exerciseType === 'custom') {
                exerciseName = customNameInput.value.trim();
            } else {
                exerciseName = typeSelect.options[typeSelect.selectedIndex].text.split(' (')[0];
            }
            
            // Create exercise entry
            const dateKey = formatDateKey(selectedDate);
            const exerciseEntry = {
                id: Date.now(),
                type: exerciseType,
                name: exerciseName,
                duration: duration,
                calories: calories,
                notes: notes,
                timestamp: new Date().toISOString(),
                date: dateKey
            };
            
            // Add to exercise data
            if (!exerciseByDate[dateKey]) {
                exerciseByDate[dateKey] = [];
            }
            exerciseByDate[dateKey].push(exerciseEntry);
            
            // Save to localStorage
            saveWeightData();
            
            // Update display
            updateWeightDisplay();
            
            // Close modal
            closeExerciseModal();
            
            // Show success message
            showSuccessMessage(`‚úÖ Exercise logged! ${exerciseName} - ${calories} calories burned`);
        }

        // ========================================
        // EXERCISE MANAGEMENT FUNCTIONS
        // ========================================

        // Display today's exercises in the exercises section
        function displayTodaysExercises() {
            console.log('üèÉ‚Äç‚ôÇÔ∏è EXERCISES: displayTodaysExercises() called');
            const exercisesList = document.getElementById('exercisesList');
            const exercisesSectionTitle = document.getElementById('exercisesSectionTitle');
            const dateKey = formatDateKey(selectedDate);
            const todaysExercises = exerciseByDate[dateKey] || [];
            
            // Update section title with date
            const today = new Date();
            const isToday = formatDateKey(selectedDate) === formatDateKey(today);
            const isYesterday = formatDateKey(selectedDate) === formatDateKey(new Date(today.getTime() - 24 * 60 * 60 * 1000));
            
            let titleText = 'üèÉ‚Äç‚ôÇÔ∏è Today\'s Exercises';
            if (!isToday) {
                if (isYesterday) {
                    titleText = 'üèÉ‚Äç‚ôÇÔ∏è Yesterday\'s Exercises';
                } else {
                    titleText = `üèÉ‚Äç‚ôÇÔ∏è Exercises - ${selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                }
            }
            
            // Add nursing indicator to exercises title if applicable
            const exerciseDateKey = formatDateKey(getSafeSelectedDate());
            const weightData = weightByDate[exerciseDateKey] || getRecentWeightData();
            if (weightData && weightData.isNursing) {
                titleText += ' ü§±';
            }
            
            exercisesSectionTitle.textContent = titleText;
            
            if (todaysExercises.length === 0) {
                exercisesList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No exercises logged yet. Add an exercise to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Sort exercises by timestamp (newest first)
            const sortedExercises = [...todaysExercises].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            exercisesList.innerHTML = sortedExercises.map(exercise => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm fade-in">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 text-lg">${exercise.name}</h4>
                            <div class="text-sm text-gray-600 mt-1">
                                <span class="inline-flex items-center">
                                    ‚è±Ô∏è ${exercise.duration} minutes
                                </span>
                                <span class="mx-2">‚Ä¢</span>
                                <span class="inline-flex items-center">
                                    üî• ${exercise.calories} calories burned
                                </span>
                                <span class="mx-2">‚Ä¢</span>
                                <span class="inline-flex items-center">
                                    üïê ${formatTime(new Date(exercise.timestamp))}
                                </span>
                            </div>
                            ${exercise.notes ? `
                                <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                                    üí≠ ${exercise.notes}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="editExercise(${exercise.id})"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200"
                                    title="Edit exercise">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="confirmDeleteExercise(${exercise.id}, '${exercise.name.replace(/'/g, "\\'")}', ${exercise.calories})"
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200"
                                    title="Delete exercise">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Exercise type badge -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getExerciseTypeBadge(exercise.type)}">
                                ${getExerciseTypeIcon(exercise.type)} ${getExerciseTypeLabel(exercise.type)}
                            </span>
                            <span class="text-xs text-gray-500">
                                ${(exercise.calories / exercise.duration).toFixed(1)} cal/min
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            console.log('‚úÖ EXERCISES: Displayed', todaysExercises.length, 'exercises');
        }

        // Get exercise type badge styling
        function getExerciseTypeBadge(type) {
            const badges = {
                'walking': 'bg-green-100 text-green-800',
                'jogging': 'bg-blue-100 text-blue-800',
                'running': 'bg-red-100 text-red-800',
                'cycling': 'bg-yellow-100 text-yellow-800',
                'swimming': 'bg-cyan-100 text-cyan-800',
                'yoga': 'bg-purple-100 text-purple-800',
                'weightlifting': 'bg-orange-100 text-orange-800',
                'dancing': 'bg-pink-100 text-pink-800',
                'hiking': 'bg-emerald-100 text-emerald-800',
                'custom': 'bg-gray-100 text-gray-800'
            };
            return badges[type] || badges['custom'];
        }

        // Get exercise type icon
        function getExerciseTypeIcon(type) {
            const icons = {
                'walking': 'üö∂‚Äç‚ôÇÔ∏è',
                'jogging': 'üèÉ‚Äç‚ôÇÔ∏è',
                'running': 'üèÉ‚Äç‚ôÇÔ∏èüí®',
                'cycling': 'üö¥‚Äç‚ôÇÔ∏è',
                'swimming': 'üèä‚Äç‚ôÇÔ∏è',
                'yoga': 'üßò‚Äç‚ôÇÔ∏è',
                'weightlifting': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
                'dancing': 'üíÉ',
                'hiking': 'ü•æ',
                'custom': 'üí™'
            };
            return icons[type] || icons['custom'];
        }

        // Get exercise type label
        function getExerciseTypeLabel(type) {
            const labels = {
                'walking': 'Walking',
                'jogging': 'Jogging',
                'running': 'Running',
                'cycling': 'Cycling',
                'swimming': 'Swimming',
                'yoga': 'Yoga',
                'weightlifting': 'Weight Lifting',
                'dancing': 'Dancing',
                'hiking': 'Hiking',
                'custom': 'Custom'
            };
            return labels[type] || 'Exercise';
        }

        // Confirm exercise deletion with modal
        function confirmDeleteExercise(exerciseId, exerciseName, calories) {
            console.log('üóëÔ∏è DELETE: confirmDeleteExercise() called', { exerciseId, exerciseName, calories });
            
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteExerciseModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <div class="text-center mb-6">
                        <div class="text-red-600 text-5xl mb-3">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Exercise?</h3>
                        <p class="text-gray-600">
                            Are you sure you want to delete "<strong>${exerciseName}</strong>"?
                        </p>
                        <div class="mt-3 text-sm text-gray-500">
                            This will remove ${calories} calories from your daily burn total.
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="deleteExercise(${exerciseId}); closeDeleteExerciseModal();"
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            üóëÔ∏è Yes, Delete
                        </button>
                        <button onclick="closeDeleteExerciseModal()"
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close delete exercise modal
        function closeDeleteExerciseModal() {
            const modal = document.getElementById('deleteExerciseModal');
            if (modal) {
                modal.remove();
            }
        }

        // Delete exercise
        function deleteExercise(exerciseId) {
            console.log('üóëÔ∏è DELETE: deleteExercise() called for ID:', exerciseId);
            
            const dateKey = formatDateKey(selectedDate);
            if (!exerciseByDate[dateKey]) {
                console.log('‚ùå DELETE: No exercises found for date:', dateKey);
                return;
            }
            
            // Find and remove the exercise
            const exerciseIndex = exerciseByDate[dateKey].findIndex(ex => ex.id === exerciseId);
            if (exerciseIndex === -1) {
                console.log('‚ùå DELETE: Exercise not found with ID:', exerciseId);
                showErrorMessage('Exercise not found');
                return;
            }
            
            const deletedExercise = exerciseByDate[dateKey][exerciseIndex];
            exerciseByDate[dateKey].splice(exerciseIndex, 1);
            
            // Remove the date entry if no exercises left
            if (exerciseByDate[dateKey].length === 0) {
                delete exerciseByDate[dateKey];
            }
            
            // Save to localStorage
            saveWeightData();
            
            // Update displays
            displayTodaysExercises();
            updateWeightDisplay();
            
            console.log('‚úÖ DELETE: Exercise deleted successfully');
            showSuccessMessage(`‚úÖ Deleted "${deletedExercise.name}" - ${deletedExercise.calories} calories removed`);
        }

        // Edit exercise
        function editExercise(exerciseId) {
            console.log('‚úèÔ∏è EDIT: editExercise() called for ID:', exerciseId);
            
            const dateKey = formatDateKey(selectedDate);
            if (!exerciseByDate[dateKey]) {
                console.log('‚ùå EDIT: No exercises found for date:', dateKey);
                return;
            }
            
            // Find the exercise
            const exercise = exerciseByDate[dateKey].find(ex => ex.id === exerciseId);
            if (!exercise) {
                console.log('‚ùå EDIT: Exercise not found with ID:', exerciseId);
                showErrorMessage('Exercise not found');
                return;
            }
            
            console.log('‚úèÔ∏è EDIT: Found exercise to edit:', exercise);
            
            // Store the exercise ID for editing
            window.editingExerciseId = exerciseId;
            
            // Open exercise modal and populate with existing data
            document.getElementById('exerciseModal').classList.add('active');
            
            // Update modal title
            const modalTitle = document.querySelector('#exerciseModal h3');
            if (modalTitle) {
                modalTitle.textContent = '‚úèÔ∏è Edit Exercise';
            }
            
            // Populate form fields
            document.getElementById('exerciseTypeSelect').value = exercise.type;
            document.getElementById('exerciseDuration').value = exercise.duration;
            document.getElementById('exerciseCalories').value = exercise.calories;
            document.getElementById('exerciseNotesInput').value = exercise.notes || '';
            
            // Handle custom exercise
            if (exercise.type === 'custom') {
                document.getElementById('customExerciseSection').classList.remove('hidden');
                document.getElementById('customExerciseName').value = exercise.name;
                document.getElementById('exerciseCalories').readOnly = false;
                document.getElementById('calorieHint').textContent = 'Enter calories burned manually for custom exercise';
            } else {
                document.getElementById('customExerciseSection').classList.add('hidden');
                document.getElementById('exerciseCalories').readOnly = true;
                const selectedOption = document.getElementById('exerciseTypeSelect').options[document.getElementById('exerciseTypeSelect').selectedIndex];
                const caloriesPerMin = parseFloat(selectedOption.dataset.calories) || 0;
                document.getElementById('calorieHint').textContent = `Auto-calculated: ${caloriesPerMin} cal/min √ó ${exercise.duration} min = ${exercise.calories} calories`;
            }
            
            // Update save button
            const saveButton = document.querySelector('#exerciseModal button[onclick="saveExerciseEntry()"]');
            if (saveButton) {
                saveButton.textContent = '‚úèÔ∏è Update Exercise';
                saveButton.onclick = updateExerciseEntry;
            }
            
            console.log('‚úÖ EDIT: Exercise modal opened for editing');
            showSuccessMessage('‚úèÔ∏è Exercise loaded for editing');
        }

        // Update exercise entry (for editing)
        function updateExerciseEntry() {
            console.log('üíæ UPDATE: updateExerciseEntry() called');
            
            if (!window.editingExerciseId) {
                console.log('‚ùå UPDATE: No exercise ID found for editing');
                showErrorMessage('No exercise selected for editing');
                return;
            }
            
            const typeSelect = document.getElementById('exerciseTypeSelect');
            const durationInput = document.getElementById('exerciseDuration');
            const customNameInput = document.getElementById('customExerciseName');
            const caloriesInput = document.getElementById('exerciseCalories');
            const notesInput = document.getElementById('exerciseNotesInput');
            
            const exerciseType = typeSelect.value;
            const duration = parseFloat(durationInput.value);
            const calories = parseInt(caloriesInput.value);
            const notes = notesInput.value.trim();
            
            // Validation
            if (!exerciseType) {
                alert('Please select an exercise type');
                typeSelect.focus();
                return;
            }
            
            if (!duration || duration <= 0) {
                alert('Please enter a valid duration');
                durationInput.focus();
                return;
            }
            
            if (!calories || calories <= 0) {
                alert('Please enter valid calories burned');
                caloriesInput.focus();
                return;
            }
            
            if (exerciseType === 'custom' && !customNameInput.value.trim()) {
                alert('Please enter a name for the custom exercise');
                customNameInput.focus();
                return;
            }
            
            // Get exercise name
            let exerciseName;
            if (exerciseType === 'custom') {
                exerciseName = customNameInput.value.trim();
            } else {
                exerciseName = typeSelect.options[typeSelect.selectedIndex].text.split(' (')[0];
            }
            
            // Find and update the exercise
            const dateKey = formatDateKey(selectedDate);
            const exerciseIndex = exerciseByDate[dateKey].findIndex(ex => ex.id === window.editingExerciseId);
            
            if (exerciseIndex === -1) {
                console.log('‚ùå UPDATE: Exercise not found for updating');
                showErrorMessage('Exercise not found');
                return;
            }
            
            // Update exercise data
            exerciseByDate[dateKey][exerciseIndex] = {
                ...exerciseByDate[dateKey][exerciseIndex],
                type: exerciseType,
                name: exerciseName,
                duration: duration,
                calories: calories,
                notes: notes,
                timestamp: new Date().toISOString() // Update timestamp to show it was modified
            };
            
            // Save to localStorage
            saveWeightData();
            
            // Update displays
            displayTodaysExercises();
            updateWeightDisplay();
            
            // Reset modal and close
            resetExerciseModal();
            closeExerciseModal();
            
            console.log('‚úÖ UPDATE: Exercise updated successfully');
            showSuccessMessage(`‚úÖ Updated "${exerciseName}" - ${calories} calories burned`);
        }

        // Reset exercise modal to add mode
        function resetExerciseModal() {
            // Reset modal title
            const modalTitle = document.querySelector('#exerciseModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'üèÉ‚Äç‚ôÇÔ∏è Log Exercise';
            }
            
            // Reset save button
            const saveButton = document.querySelector('#exerciseModal button[onclick*="updateExerciseEntry"], button[onclick="saveExerciseEntry()"]');
            if (saveButton) {
                saveButton.textContent = 'üí™ Save Exercise';
                saveButton.onclick = saveExerciseEntry;
            }
            
            // Clear editing ID
            delete window.editingExerciseId;
        }

        // Override the original saveExerciseEntry to also update exercise display and calorie goals
        const originalSaveExerciseEntry = saveExerciseEntry;
        saveExerciseEntry = function() {
            originalSaveExerciseEntry();
            // Update the exercises display after saving
            displayTodaysExercises();
            // Update calorie goal display if exercise adjustment is enabled
            if (exerciseCalorieSettings.eatBackExercise) {
                updateWeightDisplay();
                updateDailySummary();
            }
        };

        // Override the original closeExerciseModal to reset modal state
        const originalCloseExerciseModal = closeExerciseModal;
        closeExerciseModal = function() {
            resetExerciseModal();
            originalCloseExerciseModal();
        };

        // Update weight tracking display
        function updateWeightDisplay() {
            console.log('üìä WEIGHT_DISPLAY: updateWeightDisplay called');
            const dateKey = formatDateKey(selectedDate);
            console.log('üìä WEIGHT_DISPLAY: Date key', dateKey);
            console.log('üìä WEIGHT_DISPLAY: User unit system', userUnitSystem);
            
            // Update weight tracking section title with nursing indicator
            const weightTrackingTitle = document.getElementById('weightTrackingTitle');
            if (weightTrackingTitle) {
                let titleText = '‚öñÔ∏è Weight Tracking & Goals';
                const weightDateKey = formatDateKey(getSafeSelectedDate());
                const weightData = weightByDate[weightDateKey] || getRecentWeightData();
                if (weightData && weightData.isNursing) {
                    titleText += ' ü§±';
                }
                weightTrackingTitle.textContent = titleText;
            }
            
            // Update current weight
            const currentWeightEl = document.getElementById('currentWeight');
            const weightDateEl = document.getElementById('weightDate');
            
            if (weightByDate[dateKey]) {
                const weightData = weightByDate[dateKey];
                console.log('üìä WEIGHT_DISPLAY: Found weight data for date', weightData);
                
                // Convert weight for display based on user preference
                let displayWeight = weightData.weight; // Stored in lbs
                if (userUnitSystem === 'metric') {
                    displayWeight = lbsToKg(weightData.weight);
                    console.log('üìä WEIGHT_DISPLAY: Converting to metric', {
                        storedLbs: weightData.weight,
                        displayKg: displayWeight.toFixed(1)
                    });
                } else {
                    console.log('üìä WEIGHT_DISPLAY: Using imperial', {
                        storedLbs: weightData.weight,
                        displayLbs: displayWeight.toFixed(1)
                    });
                }
                
                currentWeightEl.textContent = displayWeight.toFixed(1);
                weightDateEl.textContent = formatDateDisplay(selectedDate);
            } else {
                console.log('üìä WEIGHT_DISPLAY: No weight data for date, searching for recent');
                // Try to find the most recent weight entry
                const sortedDates = Object.keys(weightByDate).sort().reverse();
                const recentDate = sortedDates.find(date => date <= dateKey);
                console.log('üìä WEIGHT_DISPLAY: Recent date search', { sortedDates, recentDate });
                
                if (recentDate) {
                    const weightData = weightByDate[recentDate];
                    console.log('üìä WEIGHT_DISPLAY: Found recent weight data', weightData);
                    
                    // Convert weight for display based on user preference
                    let displayWeight = weightData.weight; // Stored in lbs
                    if (userUnitSystem === 'metric') {
                        displayWeight = lbsToKg(weightData.weight);
                        console.log('üìä WEIGHT_DISPLAY: Converting recent to metric', {
                            storedLbs: weightData.weight,
                            displayKg: displayWeight.toFixed(1)
                        });
                    }
                    
                    currentWeightEl.textContent = displayWeight.toFixed(1);
                    const recentDateObj = new Date(recentDate + 'T00:00:00');
                    weightDateEl.textContent = `Last: ${formatDateDisplay(recentDateObj)}`;
                } else {
                    console.log('üìä WEIGHT_DISPLAY: No weight data found');
                    currentWeightEl.textContent = '--';
                    weightDateEl.textContent = 'No data';
                }
            }
            
            // Update BMI
            const currentBMIEl = document.getElementById('currentBMI');
            const bmiCategoryEl = document.getElementById('bmiCategory');
            
            // Update BMR
            const currentBMREl = document.getElementById('currentBMR');
            const bmrMethodEl = document.getElementById('bmrMethod');
            
            let currentWeight = null;
            let currentWeightData = null;
            if (weightByDate[dateKey]) {
                currentWeight = weightByDate[dateKey].weight;
                currentWeightData = weightByDate[dateKey];
            } else {
                // Use most recent weight
                const sortedDates = Object.keys(weightByDate).sort().reverse();
                const recentDate = sortedDates.find(date => date <= dateKey);
                if (recentDate) {
                    currentWeight = weightByDate[recentDate].weight;
                    currentWeightData = weightByDate[recentDate];
                }
            }
            
            if (currentWeight && userHeight > 0) {
                const bmi = calculateBMI(currentWeight, userHeight);
                const category = getBMICategory(bmi);
                currentBMIEl.textContent = bmi.toFixed(1);
                bmiCategoryEl.textContent = category.category;
                bmiCategoryEl.className = `text-xs mt-1 ${category.textColor}`;
            } else {
                currentBMIEl.textContent = '--';
                bmiCategoryEl.textContent = 'No data';
                bmiCategoryEl.className = 'text-xs mt-1 text-gray-500';
            }
            
            // Update BMR display
            if (currentWeightData && currentWeightData.bmrMifflin && currentWeightData.age && currentWeightData.gender) {
                const bmr = Math.round(currentWeightData.bmrMifflin);
                let bmrText = bmr.toString();
                let methodText = `${currentWeightData.gender}, age ${currentWeightData.age}`;
                
                // Add nursing indicator if applicable
                if (currentWeightData.isNursing && (currentWeightData.gender.toLowerCase() === 'female' || currentWeightData.gender.toLowerCase() === 'f')) {
                    bmrText += ' ü§±';
                    methodText += ' (nursing +400 cal)';
                }
                
                currentBMREl.textContent = bmrText;
                bmrMethodEl.textContent = methodText;
                bmrMethodEl.className = 'text-xs text-gray-500 mt-1';
                
                console.log('üìä WEIGHT_DISPLAY: BMR displayed', {
                    bmr,
                    age: currentWeightData.age,
                    gender: currentWeightData.gender,
                    isNursing: currentWeightData.isNursing
                });
            } else {
                currentBMREl.textContent = '--';
                bmrMethodEl.textContent = 'Add age & gender';
                bmrMethodEl.className = 'text-xs text-gray-500 mt-1';
                console.log('‚ö†Ô∏è WEIGHT_DISPLAY: BMR data not available');
            }
            
            // Show/hide BMR info button based on nursing status
            const bmrInfoButton = document.getElementById('bmrInfoButton');
            if (bmrInfoButton) {
                if (currentWeightData && currentWeightData.isNursing && currentWeightData.bmrMifflin) {
                    bmrInfoButton.style.display = 'inline-block';
                } else {
                    bmrInfoButton.style.display = 'none';
                }
            }
            
            // Update calorie goal with dynamic adjustment
            const calorieGoalEl = document.getElementById('calorieGoal');
            const calorieDeficitEl = document.getElementById('calorieDeficit');
            
            let baseGoal = userCalorieGoal;
            if (baseGoal <= 0 && currentWeight && userHeight > 0) {
                // Auto-calculate based on BMR (simplified)
                const weightKg = currentWeight * 0.453592;
                const heightCm = userHeight * 2.54;
                const estimatedBMR = 1500 + (weightKg * 10) + (heightCm * 2); // Simplified
                baseGoal = Math.round(estimatedBMR * 1.4); // Moderate activity multiplier
            }
            
            if (baseGoal > 0) {
                // Get adjusted goal based on exercise calorie settings
                const goalData = getAdjustedCalorieGoal(dateKey);
                const displayGoal = goalData.adjustedGoal;
                
                // Update goal display with breakdown if exercise calories are being eaten back
                if (exerciseCalorieSettings.eatBackExercise && goalData.exerciseCalories > 0) {
                    calorieGoalEl.innerHTML = `
                        <span title="Base: ${goalData.baseGoal.toLocaleString()} + Exercise: ${goalData.eatBackAmount} = ${displayGoal.toLocaleString()}">${displayGoal.toLocaleString()}</span>
                    `;
                } else {
                    calorieGoalEl.textContent = displayGoal.toLocaleString();
                }
                
                // Calculate deficit/surplus using adjusted goal
                const currentMeals = getCurrentDateMeals();
                const totalCalories = currentMeals.reduce((sum, meal) => sum + meal.nutrition.calories, 0);
                const exerciseCalories = getTotalExerciseCalories(dateKey);
                const netCalories = totalCalories - exerciseCalories;
                const deficit = displayGoal - netCalories;
                
                if (deficit > 0) {
                    calorieDeficitEl.textContent = `Deficit: ${deficit}`;
                    calorieDeficitEl.className = 'text-xs text-green-500 mt-1';
                } else {
                    calorieDeficitEl.textContent = `Surplus: ${Math.abs(deficit)}`;
                    calorieDeficitEl.className = 'text-xs text-red-500 mt-1';
                }
            } else {
                calorieGoalEl.textContent = '--';
                calorieDeficitEl.textContent = 'Set goal';
                calorieDeficitEl.className = 'text-xs text-gray-500 mt-1';
            }
            
            // Update calories burned
            const caloriesBurnedEl = document.getElementById('caloriesBurned');
            const exerciseCalories = getTotalExerciseCalories(dateKey);
            caloriesBurnedEl.textContent = exerciseCalories;
        }

        // Get total exercise calories for a date
        function getTotalExerciseCalories(dateKey) {
            if (!exerciseByDate[dateKey]) return 0;
            return exerciseByDate[dateKey].reduce((total, exercise) => total + exercise.calories, 0);
        }

        // ========================================
        // DYNAMIC CALORIE GOAL ADJUSTMENT FUNCTIONS
        // ========================================

        // Calculate daily calorie goal (simplified - no exercise adjustment)
        function getAdjustedCalorieGoal(dateKey = null) {
            const baseGoal = userCalorieGoal || dailyCalorieTarget || 2000;
            
            return {
                baseGoal: baseGoal,
                exerciseCalories: 0,
                adjustedGoal: baseGoal,
                percentage: 0
            };
        }

        // Clear all exercises for the current date
        function clearAllExercises() {
            const dateKey = formatDateKey(selectedDate);
            const todaysExercises = exerciseByDate[dateKey] || [];
            
            if (todaysExercises.length === 0) {
                showErrorMessage('No exercises to clear for this date');
                return;
            }
            
            if (!confirm(`Are you sure you want to clear all ${todaysExercises.length} exercise(s) for ${formatDateDisplay(selectedDate)}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            // Remove all exercises for this date
            delete exerciseByDate[dateKey];
            
            // Save to localStorage
            saveWeightData();
            
            // Update displays
            displayTodaysExercises();
            updateWeightDisplay();
            
            showSuccessMessage(`‚úÖ Cleared all exercises for ${formatDateDisplay(selectedDate)}`);
        }

        // Enhanced database loading with robust error handling and loading indicators
        function loadDatabases() {
            // Return existing promise if already loading
            if (databaseLoadingPromise) {
                console.log('üîÑ LOADDB: Database loading already in progress, returning existing promise');
                return databaseLoadingPromise;
            }

            const timestamp = new Date().getTime();
            console.log('üîÑ LOADDB: Starting loadDatabases() with timestamp:', timestamp);
            console.log('üîÑ LOADDB: Current rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Show loading indicator
            showLoadingIndicator('Loading ingredients and recipes...');
            
            // Create a single promise that handles both API and file loading
            databaseLoadingPromise = Promise.resolve()
                .then(async () => {
                    console.log('üîÑ LOADDB: Starting ingredient loading process...');
                    updateLoadingIndicator('Loading ingredients...');
                    
                    // DB-only: Load ingredients via API (no JSON fallback)
                    let rawData;
                    console.log('üîÑ LOADDB: Loading ingredients via API...');
                    const apiResponse = await fetch('/api/ingredients', { timeout: 10000 });
                    if (!apiResponse.ok) {
                        hideLoadingIndicator();
                        throw new Error(`Ingredients API failed: ${apiResponse.status} ${apiResponse.statusText}`);
                    }
                    const apiData = await apiResponse.json();
                    console.log('‚úÖ LOADDB: Ingredients API load successful');
                    rawData = { basic_ingredients: apiData.basic_ingredients || apiData };
                    
                    // DB-only: Load recipes via API (no JSON fallback)
                    console.log('üîÑ LOADDB: Loading recipes via API...');
                    updateLoadingIndicator('Loading recipes...');
                    let foodData;
                    const recipesApiResponse = await fetch('/api/recipes', { timeout: 10000 });
                    if (!recipesApiResponse.ok) {
                        hideLoadingIndicator();
                        throw new Error(`Recipes API failed: ${recipesApiResponse.status} ${recipesApiResponse.statusText}`);
                    }
                    foodData = await recipesApiResponse.json();
                    console.log('‚úÖ LOADDB: Recipes API load successful');
                    
                    return { rawData, foodData };
                })
                .then(({ rawData, foodData }) => {
                    console.log('üéâ LOADDB: Both databases loaded, processing data...');
                    updateLoadingIndicator('Processing data...');
                    
                    // Safely assign the data
                    const newRawIngredients = rawData.basic_ingredients;
                    const newFoodDatabase = foodData;
                    
                    // Validate the data before assignment
                    if (!newRawIngredients || typeof newRawIngredients !== 'object') {
                        hideLoadingIndicator();
                        throw new Error('Invalid rawIngredients data structure');
                    }
                    
                    if (!newFoodDatabase || typeof newFoodDatabase !== 'object') {
                        hideLoadingIndicator();
                        throw new Error('Invalid foodDatabase data structure');
                    }
                    
                    // Merge server recipes with local recipes
                    console.log('üîÑ LOADDB: Merging server recipes with local recipes...');
                    updateLoadingIndicator('Merging recipes...');
                    
                    // Load local recipes from localStorage
                    const localRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
                    console.log('üì± LOADDB: Local recipes loaded:', Object.keys(localRecipes).length);
                    
                    // Update customRecipes with merged data
                    // Server recipes take precedence, but keep local-only recipes
                    customRecipes = { ...localRecipes };
                    
                    // Add server recipes to customRecipes for unified access
                    if (newFoodDatabase.dishes) {
                        Object.entries(newFoodDatabase.dishes).forEach(([key, recipe]) => {
                            // Only add server recipes that aren't already in customRecipes
                            // This allows local modifications to take precedence
                            if (!customRecipes[key]) {
                                customRecipes[key] = recipe;
                            }
                        });
                    }
                    
                    console.log('‚úÖ LOADDB: Recipe merging completed');
                    console.log('üìä LOADDB: Total recipes available:', Object.keys(customRecipes).length);
                    
                    // Atomic assignment to prevent race conditions
                    rawIngredients = newRawIngredients;
                    foodDatabase = newFoodDatabase;
                    
                    console.log('‚úÖ LOADDB: Data assigned successfully');
                    console.log('üìä LOADDB: Categories loaded:', Object.keys(rawIngredients));
                    console.log('üìä LOADDB: Total ingredients:',
                        Object.values(rawIngredients).reduce((total, category) =>
                            total + Object.keys(category).length, 0));
                    
                    // Verify critical ingredients
                    if (rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                        console.log('‚úÖ LOADDB: Lauki verified:', rawIngredients.vegetables.lauki.name);
                    } else {
                        console.warn('‚ö†Ô∏è LOADDB: Lauki not found in loaded data');
                    }
                    
                    // Initialize app components that depend on the data
                    console.log('üîÑ LOADDB: Initializing dependent components...');
                    updateLoadingIndicator('Initializing components...');
                    initializeApp();
                    
                    // Hide loading indicator on success
                    hideLoadingIndicator();
                    showSuccessMessage('‚úÖ All data loaded successfully!');
                    
                    return { rawIngredients, foodDatabase };
                })
                .catch(error => {
                    console.error('üí• LOADDB: Critical error loading databases:', error);
                    console.log('üîÑ LOADDB: Attempting fallback to embedded data...');
                    updateLoadingIndicator('Loading fallback data...');
                    
                    try {
                        initializeWithFallback();
                        console.log('‚úÖ LOADDB: Fallback initialization completed');
                        hideLoadingIndicator();
                        showErrorMessage('‚ö†Ô∏è Using offline data - some features may be limited');
                        return { rawIngredients, foodDatabase };
                    } catch (fallbackError) {
                        console.error('üí• LOADDB: Fallback also failed:', fallbackError);
                        hideLoadingIndicator();
                        showCriticalError(`Failed to load food data: ${error.message}. Please refresh the page or check your internet connection.`);
                        throw new Error(`All loading methods failed: ${error.message}`);
                    }
                })
                .finally(() => {
                    // Clear the promise when complete (success or failure)
                    console.log('üèÅ LOADDB: Database loading process completed');
                    databaseLoadingPromise = null;
                });

            return databaseLoadingPromise;
        }

        // Loading indicator functions
        function showLoadingIndicator(message) {
            // Remove existing indicator
            hideLoadingIndicator();
            
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3';
            indicator.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                <span id="loadingMessage">${message}</span>
            `;
            document.body.appendChild(indicator);
        }

        function updateLoadingIndicator(message) {
            const messageElement = document.getElementById('loadingMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showCriticalError(message) {
            // Remove any existing critical error
            const existingError = document.getElementById('criticalError');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'criticalError';
            errorDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            errorDiv.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
                    <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Critical Error</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="space-y-3">
                        <button onclick="location.reload()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üîÑ Refresh Page
                        </button>
                        <button onclick="document.getElementById('criticalError').remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Continue Anyway
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
        }

        // Initial load with comprehensive logging
        console.log('üöÄ INITIALIZATION: Starting app initialization...');
        console.log('üöÄ INITIALIZATION: Calling loadDatabases()...');
        loadDatabases();

        // Improved reload function with proper error handling
        function reloadIngredients() {
            console.log('üîÑ RELOAD: Manual reload requested...');
            console.log('üîÑ RELOAD: Current state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
            
            showSuccessMessage('üîÑ Reloading ingredients...');
            
            // Force a fresh load by clearing existing data
            rawIngredients = null;
            foodDatabase = null;
            
            return loadDatabases()
                .then(() => {
                    console.log('‚úÖ RELOAD: Reload completed successfully');
                    console.log('‚úÖ RELOAD: New state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
                    
                    // Verify critical data
                    if (rawIngredients && rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                        console.log('‚úÖ RELOAD: Lauki verified after reload:', rawIngredients.vegetables.lauki.name);
                    } else {
                        console.warn('‚ö†Ô∏è RELOAD: Lauki verification failed after reload');
                    }
                    
                    // Update all UI components that depend on ingredients
                    console.log('üîÑ RELOAD: Updating UI components...');
                    populateQuickDishes();
                    populateIngredientSelect();
                    
                    showSuccessMessage('‚úÖ Ingredients reloaded successfully!');
                    return { rawIngredients, foodDatabase };
                })
                .catch(error => {
                    console.error('‚ùå RELOAD: Manual reload failed:', error);
                    showErrorMessage('Failed to reload ingredients: ' + error.message);
                    throw error;
                });
        }

        function initializeWithFallback() {
            // Embedded fallback data for raw ingredients
            rawIngredients = {
                grains: {
                    rice: {
                        name: "Rice",
                        measurements: {
                            "1_cup_cooked": { calories: 205, protein: 4.3, carbs: 45, fat: 0.4, fiber: 0.6 },
                            "1_cup_uncooked": { calories: 685, protein: 12.9, carbs: 150, fat: 1.1, fiber: 2.2 }
                        }
                    },
                    quinoa: {
                        name: "Quinoa",
                        measurements: {
                            "1_cup_cooked": { calories: 222, protein: 8, carbs: 39, fat: 3.6, fiber: 5.2 }
                        }
                    }
                },
                dals_legumes: {
                    toor_dal: {
                        name: "Toor Dal",
                        measurements: {
                            "1_cup_cooked": { calories: 230, protein: 15, carbs: 38, fat: 1, fiber: 10 },
                            "1_cup_uncooked": { calories: 343, protein: 22, carbs: 57, fat: 1.5, fiber: 15 }
                        }
                    }
                },
                spices_seasonings: {
                    turmeric: {
                        name: "Turmeric Powder",
                        measurements: {
                            "1_tsp": { calories: 8, protein: 0.2, carbs: 1.8, fat: 0.2, fiber: 0.4 },
                            "1_tbsp": { calories: 24, protein: 0.6, carbs: 5.4, fat: 0.7, fiber: 1.4 }
                        }
                    }
                },
                oils_fats: {
                    cooking_oil: {
                        name: "Cooking Oil",
                        measurements: {
                            "1_tsp": { calories: 40, protein: 0, carbs: 0, fat: 4.5, fiber: 0 },
                            "1_tbsp": { calories: 120, protein: 0, carbs: 0, fat: 13.5, fiber: 0 }
                        }
                    }
                }
            };

            // Embedded fallback data (subset of the full database)
            foodDatabase = {
                dishes: {
                    dal_tadka: {
                        name: "Dal Tadka",
                        category: "dal",
                        servings: 4,
                        total_per_serving: { calories: 175, protein: 6.6, carbs: 20.4, fat: 7.4, fiber: 5.1 }
                    },
                    sambar: {
                        name: "Sambar",
                        category: "sambar", 
                        servings: 6,
                        total_per_serving: { calories: 129, protein: 4.6, carbs: 18.0, fat: 5.1, fiber: 4.7 }
                    },
                    aloo_gobi: {
                        name: "Aloo Gobi",
                        category: "sabji",
                        servings: 4,
                        total_per_serving: { calories: 209, protein: 5.4, carbs: 25.9, fat: 10.8, fiber: 5.4 }
                    },
                    rajma: {
                        name: "Rajma",
                        category: "dal",
                        servings: 4,
                        total_per_serving: { calories: 194, protein: 7.5, carbs: 25.7, fat: 7.3, fiber: 6.6 }
                    },
                    rice_plain: {
                        name: "Plain Rice",
                        category: "rice",
                        servings: 4,
                        total_per_serving: { calories: 171, protein: 3.2, carbs: 37.5, fat: 0.3, fiber: 0.6 }
                    },
                    chapati: {
                        name: "Chapati",
                        category: "bread",
                        servings: 1,
                        total_per_serving: { calories: 122, protein: 3.6, carbs: 20.7, fat: 2.8, fiber: 2.7 }
                    }
                },
                ingredients_database: {
                    vegetables: {
                        onion_medium: {calories: 44, protein: 1.2, carbs: 10, fat: 0.1, fiber: 1.9},
                        tomato_medium: {calories: 22, protein: 1.1, carbs: 4.8, fat: 0.2, fiber: 1.4},
                        potato_medium: {calories: 77, protein: 2.1, carbs: 17.6, fat: 0.1, fiber: 1.6}
                    },
                    dals_legumes: {
                        toor_dal_100g: {calories: 343, protein: 22, carbs: 57, fat: 1.5, fiber: 15}
                    },
                    spices_condiments: {
                        oil_1tbsp: {calories: 120, protein: 0, carbs: 0, fat: 13.5, fiber: 0}
                    }
                }
            };
            initializeApp();
        }

        function initializeApp() {
            console.log('üöÄ INITAPP: Starting initializeApp()...');
            console.log('üöÄ INITAPP: rawIngredients state:', rawIngredients ? 'LOADED' : 'NOT_LOADED');
            console.log('üöÄ INITAPP: foodDatabase state:', foodDatabase ? 'LOADED' : 'NOT_LOADED');
            
            populateIngredientSelect();
            initializeDateSystem();
            loadWeightData(); // Load weight tracking data
            
            console.log('‚úÖ INITAPP: initializeApp() completed');
        }


        function populateQuickDishes() {
            const container = document.getElementById('quickDishes');
            if (!container) {
                console.log('‚ö†Ô∏è populateQuickDishes: quickDishes element not found, skipping population');
                return;
            }
            
            // Ensure databases are loaded before populating
            if (!foodDatabase || !foodDatabase.dishes) {
                console.log('‚ö†Ô∏è populateQuickDishes: foodDatabase not loaded yet');
                return;
            }
            
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            
            container.innerHTML = Object.entries(allDishes).map(([key, dish]) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-200">
                    <div>
                        <div class="font-medium text-gray-800">${dish.name}</div>
                        <div class="text-sm text-gray-600">${dish.total_per_serving.calories} cal/serving ‚Ä¢ ${dish.category}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${customRecipes[key] ? `<button onclick="editRecipe('${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>` : ''}
                        <input type="number" value="1" min="0.5" step="0.5" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm" id="servings_${key}">
                        <button onclick="addQuickDish('${key}')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Add
                        </button>
                        ${customRecipes[key] ? `<button onclick="deleteRecipe('${key}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">&times;</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // --- Recipe Ingredient Search Functions ---
        let selectedRecipeIngredient = null;
        
        function filterRecipeIngredients() {
            const input = document.getElementById('recipeIngredientSearch');
            const dropdown = document.getElementById('recipeIngredientDropdown');
            const query = input.value.trim().toLowerCase();
            
            selectedRecipeIngredient = null;
            
            if (!query) {
                dropdown.classList.add('hidden');
                return;
            }
            
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500">Loading ingredients...</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            // Search through all ingredients
            const matches = [];
            Object.entries(rawIngredients).forEach(([category, items]) => {
                Object.entries(items).forEach(([key, item]) => {
                    if (item.name.toLowerCase().includes(query)) {
                        matches.push({
                            key: `${category}.${key}`,
                            name: item.name,
                            category: category,
                            ingredient: item
                        });
                    }
                });
            });
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500">No ingredients found</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            dropdown.innerHTML = matches.map(match => 
                `<div class='px-3 py-2 hover:bg-blue-100 cursor-pointer' onclick='selectRecipeIngredient("${match.key}", "${match.name.replace(/"/g, "&quot;")}", "${match.category}")'>${match.name}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        }
        
        function selectRecipeIngredient(ingredientKey, ingredientName, category) {
            const [cat, key] = ingredientKey.split('.');
            selectedRecipeIngredient = {
                key: ingredientKey,
                name: ingredientName,
                category: cat,
                ingredient: rawIngredients[cat][key]
            };
            
            // Update UI
            document.getElementById('recipeIngredientSearch').value = ingredientName;
            document.getElementById('recipeIngredientDropdown').classList.add('hidden');
            document.getElementById('selectedRecipeIngredientDisplay').classList.remove('hidden');
            document.getElementById('selectedRecipeIngredientName').textContent = ingredientName;
            
            // Populate measurements
            const measurementSelect = document.getElementById('recipeIngredientMeasurement');
            let options = '<option value="">Select measurement...</option>';
            Object.entries(selectedRecipeIngredient.ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            measurementSelect.innerHTML = options;
            
            // Show measurement section
            document.getElementById('recipeIngredientMeasurementSection').classList.remove('hidden');
            document.getElementById('recipeIngredientQuantity').value = '1';
        }
        
        function clearRecipeIngredientSelection() {
            selectedRecipeIngredient = null;
            document.getElementById('recipeIngredientSearch').value = '';
            document.getElementById('selectedRecipeIngredientDisplay').classList.add('hidden');
            document.getElementById('recipeIngredientMeasurementSection').classList.add('hidden');
            document.getElementById('recipeIngredientDropdown').classList.add('hidden');
        }
        
        function addRecipeIngredientFromSearch() {
            if (!selectedRecipeIngredient) {
                alert('Please select an ingredient');
                return;
            }
            
            const measurementSelect = document.getElementById('recipeIngredientMeasurement');
            const quantityInput = document.getElementById('recipeIngredientQuantity');
            
            if (!measurementSelect.value) {
                alert('Please select a measurement');
                return;
            }
            
            const quantity = parseFloat(quantityInput.value);
            const measurement = selectedRecipeIngredient.ingredient.measurements[measurementSelect.value];
            
            const ingredientEntry = {
                key: selectedRecipeIngredient.key,
                name: selectedRecipeIngredient.name,
                amount: `${quantity}x ${measurementSelect.options[measurementSelect.selectedIndex].text}`,
                nutrition: {
                    calories: measurement.calories * quantity,
                    protein: measurement.protein * quantity,
                    carbs: measurement.carbs * quantity,
                    fat: measurement.fat * quantity,
                    fiber: measurement.fiber * quantity
                }
            };
            
            currentRecipeIngredients.push(ingredientEntry);
            
            // Clear and reset
            clearRecipeIngredientSelection();
            updateRecipePreview();
            
            showSuccessMessage(`Added ${selectedRecipeIngredient.name} to recipe!`);
        }

        function populateIngredientSelect() {
            console.log('üîÑ POPULATE: populateIngredientSelect() called');
            console.log('üîÑ POPULATE: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            const select = document.getElementById('recipeIngredientSelect');
            if (!select) {
                console.log('‚ùå POPULATE: Recipe ingredient select not found');
                return;
            }
            
            // Check if ingredients are loaded
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('‚ö†Ô∏è POPULATE: Raw ingredients not available, setting up listener...');
                select.innerHTML = '<option value="">Loading ingredients...</option>';
                
                // Set up a one-time listener for when ingredients are ready
                const handleIngredientsReady = () => {
                    console.log('‚úÖ POPULATE: Ingredients ready event received');
                    populateIngredientSelectInternal(select);
                    window.removeEventListener('ingredientsReady', handleIngredientsReady);
                };
                
                window.addEventListener('ingredientsReady', handleIngredientsReady);
                
                // Also try to load databases if not already loading
                if (!databaseLoadingPromise) {
                    console.log('üîÑ POPULATE: Triggering database load...');
                    loadDatabases().catch(error => {
                        console.error('‚ùå POPULATE: Failed to load databases:', error);
                        select.innerHTML = '<option value="">Failed to load ingredients</option>';
                    });
                }
                return;
            }
            
            console.log('‚úÖ POPULATE: Raw ingredients available, proceeding with population');
            populateIngredientSelectInternal(select);
        }
        
        function populateIngredientSelectInternal(select) {
            console.log('üîÑ POPULATE_INTERNAL: Starting internal population');
            console.log('üîÑ POPULATE_INTERNAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üîÑ POPULATE_INTERNAL: rawIngredients categories:', rawIngredients ? Object.keys(rawIngredients) : 'N/A');
            
            let options = '<option value="">Select ingredient...</option>';
            let totalIngredients = 0;
            
            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                console.log(`üîÑ POPULATE_INTERNAL: Processing category ${categoryName} with ${Object.keys(items).length} items`);
                options += `<optgroup label="${categoryName}">`;
                Object.entries(items).forEach(([key, item]) => {
                    options += `<option value="${category}.${key}">${item.name}</option>`;
                    totalIngredients++;
                });
                options += '</optgroup>';
            });
            
            select.innerHTML = options;
            // Remove existing event listener to avoid duplicates
            select.removeEventListener('change', onRecipeIngredientChange);
            select.addEventListener('change', onRecipeIngredientChange);
            console.log('‚úÖ POPULATE_INTERNAL: Recipe ingredient select populated with', Object.keys(rawIngredients).length, 'categories and', totalIngredients, 'total ingredients');
            
            // Test if lauki is in the select
            const laukiOption = select.querySelector('option[value="vegetables.lauki"]');
            if (laukiOption) {
                console.log('‚úÖ POPULATE_INTERNAL: Lauki option found in select:', laukiOption.textContent);
            } else {
                console.warn('‚ö†Ô∏è POPULATE_INTERNAL: Lauki option NOT found in select');
            }
        }

        function onRecipeIngredientChange() {
            const select = document.getElementById('recipeIngredientSelect');
            const measurementSelect = document.getElementById('recipeMeasurementSelect');
            
            if (!select.value) {
                measurementSelect.innerHTML = '<option value="">Select ingredient first...</option>';
                measurementSelect.disabled = true;
                return;
            }

            const [category, ingredientKey] = select.value.split('.');
            const ingredient = rawIngredients[category][ingredientKey];
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
            measurementSelect.disabled = false;
        }

        function addRecipeIngredient() {
            const ingredientSelect = document.getElementById('recipeIngredientSelect');
            const measurementSelect = document.getElementById('recipeMeasurementSelect');
            const quantityInput = document.getElementById('recipeQuantity');
            
            if (!ingredientSelect.value || !measurementSelect.value || !quantityInput.value) {
                alert('Please select ingredient, measurement, and quantity');
                return;
            }

            const quantity = parseFloat(quantityInput.value);
            const [category, ingredientKey] = ingredientSelect.value.split('.');
            const ingredient = rawIngredients[category][ingredientKey];
            const measurement = ingredient.measurements[measurementSelect.value];
            
            const ingredientEntry = {
                key: ingredientSelect.value,
                name: ingredient.name,
                amount: `${quantity}x ${measurementSelect.options[measurementSelect.selectedIndex].text}`,
                nutrition: {
                    calories: measurement.calories * quantity,
                    protein: measurement.protein * quantity,
                    carbs: measurement.carbs * quantity,
                    fat: measurement.fat * quantity,
                    fiber: measurement.fiber * quantity
                }
            };

            currentRecipeIngredients.push(ingredientEntry);
            
            // Clear inputs
            ingredientSelect.value = '';
            measurementSelect.innerHTML = '<option value="">Select ingredient first...</option>';
            measurementSelect.disabled = true;
            quantityInput.value = 1;
            
            updateRecipePreview();
        }

        function addQuickDish(dishKey) {
            console.log('üçΩÔ∏è QUICKDISH: addQuickDish() called for:', dishKey);
            console.log('üçΩÔ∏è QUICKDISH: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üçΩÔ∏è QUICKDISH: foodDatabase state:', foodDatabase ? 'EXISTS' : 'NULL');
            
            const servingsElement = document.getElementById(`servings_${dishKey}`);
            if (!servingsElement) {
                console.error('‚ùå QUICKDISH: Servings element not found for:', dishKey);
                showErrorMessage('Error: Could not find serving size input');
                return;
            }
            
            const servings = parseFloat(servingsElement.value);
            if (!foodDatabase || !foodDatabase.dishes) {
                console.error('‚ùå QUICKDISH: foodDatabase not loaded');
                showErrorMessage('Food database not loaded. Please wait and try again.');
                return;
            }
            
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            const dish = allDishes[dishKey];
            
            if (!dish) {
                console.error('‚ùå QUICKDISH: Dish not found:', dishKey);
                showErrorMessage('Dish not found: ' + dishKey);
                return;
            }
            
            const nutrition = dish.total_per_serving;
            const selectedMealType = getSelectedMealType();
            const meal = {
                id: Date.now(),
                description: `${dish.name} (${servings} serving${servings !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(nutrition.calories * servings),
                    protein: Math.round(nutrition.protein * servings * 10) / 10,
                    carbs: Math.round(nutrition.carbs * servings * 10) / 10,
                    fat: Math.round(nutrition.fat * servings * 10) / 10,
                    fiber: Math.round(nutrition.fiber * servings * 10) / 10
                },
                source: 'database',
                mealType: selectedMealType
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_added');
            
            // Reset serving size
            document.getElementById(`servings_${dishKey}`).value = 1;
            
            showSuccessMessage(`Added ${dish.name}!`);
        }

        function addCustomEntry() {
            const description = document.getElementById('customDish').value.trim();
            const servings = parseFloat(document.getElementById('customServings').value);
            const calories = parseInt(document.getElementById('customCalories').value) || estimateCalories(description);
            
            if (!description) {
                alert('Please enter a dish description');
                return;
            }
            
            const selectedMealType = getSelectedMealType();
            const meal = {
                id: Date.now(),
                description: description,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(calories * servings),
                    protein: Math.round(calories * 0.15 / 4), // Rough estimate
                    carbs: Math.round(calories * 0.55 / 4),
                    fat: Math.round(calories * 0.30 / 9),
                    fiber: Math.round(calories * 0.02)
                },
                source: 'custom',
                mealType: selectedMealType
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_added');
            
            // Clear form
            document.getElementById('customDish').value = '';
            document.getElementById('customServings').value = 1;
            document.getElementById('customCalories').value = '';
            
            showSuccessMessage('Added custom entry!');
        }

        function estimateCalories(description) {
            // Simple calorie estimation based on keywords
            const desc = description.toLowerCase();
            let calories = 200; // Base calories
            
            if (desc.includes('dal') || desc.includes('sambar')) calories = 150;
            if (desc.includes('rice')) calories += 170;
            if (desc.includes('chapati') || desc.includes('roti')) calories += 120;
            if (desc.includes('paneer')) calories += 200;
            if (desc.includes('oil') || desc.includes('ghee')) calories += 100;
            if (desc.includes('large') || desc.includes('big')) calories *= 1.5;
            if (desc.includes('small')) calories *= 0.7;
            
            return Math.round(calories);
        }

        function openRecipeBuilder() {
            console.log('üë®‚Äçüç≥ RECIPE: openRecipeBuilder() called');
            console.log('üë®‚Äçüç≥ RECIPE: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Always ensure databases are loaded before opening recipe builder
            console.log('üîÑ RECIPE: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ RECIPE: Databases loaded, opening recipe builder');
                document.getElementById('recipeModal').classList.add('active');
                currentRecipeIngredients = [];
                updateRecipePreview();
                // Ensure ingredient select is populated with loaded data
                populateIngredientSelect();
                // Populate template dropdown with existing recipes
                populateRecipeTemplateDropdown();
                showSuccessMessage('‚úÖ Recipe builder ready!');
            }).catch(error => {
                console.error('‚ùå RECIPE: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function closeRecipeBuilder() {
            document.getElementById('recipeModal').classList.remove('active');
            // Clear form
            document.getElementById('recipeName').value = '';
            document.getElementById('recipeServings').value = 4;
            currentRecipeIngredients = [];
            // Reset template dropdown
            const templateSelect = document.getElementById('recipeTemplateSelect');
            if (templateSelect) templateSelect.value = '';
            const templateServings = document.getElementById('recipeTemplateServings');
            if (templateServings) templateServings.value = 1;
            // Reset modal to create mode
            resetRecipeBuilderModal();
        }

        // This function is now replaced by addRecipeIngredient above

        function updateRecipePreview() {
            const preview = document.getElementById('recipePreview');
            const servings = parseInt(document.getElementById('recipeServings').value) || 4;
            
            if (currentRecipeIngredients.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving
            const perServing = {
                calories: Math.round(totals.calories / servings),
                protein: Math.round(totals.protein / servings * 10) / 10,
                carbs: Math.round(totals.carbs / servings * 10) / 10,
                fat: Math.round(totals.fat / servings * 10) / 10,
                fiber: Math.round(totals.fiber / servings * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Ingredients:</h5>
                    ${currentRecipeIngredients.map(ing => `
                        <div class="flex justify-between items-center text-sm">
                            <span>${ing.name} (${ing.amount})</span>
                            <button onclick="removeIngredient('${ing.key}')" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${servings} total):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function removeIngredient(key) {
            currentRecipeIngredients = currentRecipeIngredients.filter(ing => ing.key !== key);
            updateRecipePreview();
        }

        async function saveRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            const category = document.getElementById('recipeCategory').value;
            const servings = parseInt(document.getElementById('recipeServings').value);
            
            if (!name || currentRecipeIngredients.length === 0) {
                alert('Please enter recipe name and add ingredients');
                return;
            }
            
            // Calculate nutrition per serving
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            const recipeKey = name.toLowerCase().replace(/\s+/g, '_');
            const recipe = {
                name: name,
                category: category,
                servings: servings,
                ingredients: currentRecipeIngredients,
                total_per_serving: {
                    calories: Math.round(totals.calories / servings),
                    protein: Math.round(totals.protein / servings * 10) / 10,
                    carbs: Math.round(totals.carbs / servings * 10) / 10,
                    fat: Math.round(totals.fat / servings * 10) / 10,
                    fiber: Math.round(totals.fiber / servings * 10) / 10
                }
            };
            
            try {
                // Try to save to server first
                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipeKey: recipeKey,
                        recipeData: recipe
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe saved to server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${name}" saved to server!`);
                    
                    // Also save to localStorage as backup/cache
                    customRecipes[recipeKey] = recipe;
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to save recipe to server, saving to localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe saved locally only');
                
                // Fallback to localStorage only
                customRecipes[recipeKey] = recipe;
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${name}" saved locally!`);
            }
            
            populateQuickDishes();
            closeRecipeBuilder();
        }

        function addRecipeToLog() {
            saveRecipe();
            // Add the recipe to today's log
            const name = document.getElementById('recipeName').value.trim();
            const recipeKey = name.toLowerCase().replace(/\s+/g, '_');
            if (customRecipes[recipeKey]) {
                addQuickDish(recipeKey);
            }
        }

        // Edit Recipe Function
        function editRecipe(key) {
            console.log('‚úèÔ∏è EDIT: editRecipe() called for key:', key);
            
            // Check if the recipe exists in customRecipes
            if (!customRecipes[key]) {
                showErrorMessage('Recipe not found: ' + key);
                return;
            }
            
            const recipe = customRecipes[key];
            console.log('‚úèÔ∏è EDIT: Found recipe:', recipe.name);
            
            // Ensure databases are loaded before opening recipe builder
            loadDatabases().then(() => {
                console.log('‚úÖ EDIT: Databases loaded, opening recipe builder in edit mode');
                
                // Open the recipe builder modal
                document.getElementById('recipeModal').classList.add('active');
                
                // Update modal title to indicate edit mode
                const modalTitle = document.querySelector('#recipeModal h3');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Recipe';
                }
                
                // Populate form with existing recipe data
                document.getElementById('recipeName').value = recipe.name;
                document.getElementById('recipeCategory').value = recipe.category;
                document.getElementById('recipeServings').value = recipe.servings;
                
                // Clear and populate ingredients
                currentRecipeIngredients = [...recipe.ingredients];
                
                // Update the save button to handle editing
                const saveButton = document.querySelector('button[onclick="saveRecipe()"]');
                if (saveButton) {
                    saveButton.textContent = 'Update Recipe';
                    saveButton.onclick = () => updateExistingRecipe(key);
                }
                
                // Update the save & add button
                const saveAddButton = document.querySelector('button[onclick="addRecipeToLog()"]');
                if (saveAddButton) {
                    saveAddButton.textContent = 'Update & Add to Today\'s Log';
                    saveAddButton.onclick = () => updateAndAddRecipeToLog(key);
                }
                
                // Ensure ingredient select is populated
                populateIngredientSelect();
                
                // Update preview
                updateRecipePreview();
                
                showSuccessMessage('‚úÖ Recipe loaded for editing!');
                
            }).catch(error => {
                console.error('‚ùå EDIT: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        // Create Recipe from Template Function
        function createFromRecipe(key) {
            console.log('üìã TEMPLATE: createFromRecipe() called for key:', key);

            // Check if the recipe exists in customRecipes
            if (!customRecipes[key]) {
                showErrorMessage('Recipe not found: ' + key);
                return;
            }

            const recipe = customRecipes[key];
            console.log('üìã TEMPLATE: Found recipe:', recipe.name);

            // Ensure databases are loaded before opening recipe builder
            loadDatabases().then(() => {
                console.log('‚úÖ TEMPLATE: Databases loaded, opening recipe builder in template mode');

                // Open the recipe builder modal
                document.getElementById('recipeModal').classList.add('active');

                // Update modal title to indicate template mode
                const modalTitle = document.querySelector('#recipeModal h3');
                if (modalTitle) {
                    modalTitle.textContent = 'Create Recipe from Template';
                }

                // Populate form with template data
                // Add "(Copy)" to name to indicate this is a new recipe
                document.getElementById('recipeName').value = recipe.name + ' (Copy)';
                document.getElementById('recipeCategory').value = recipe.category;
                document.getElementById('recipeServings').value = recipe.servings;

                // IMPORTANT: Deep copy ingredients to prevent mutation of original
                currentRecipeIngredients = JSON.parse(JSON.stringify(recipe.ingredients));

                // CRITICAL: Keep save buttons in CREATE mode (not update mode)
                // This is the key difference from editRecipe()
                const saveButton = document.querySelector('button[onclick*="updateExistingRecipe"], button[onclick="saveRecipe()"]');
                if (saveButton) {
                    saveButton.textContent = 'Save Recipe';
                    saveButton.onclick = () => saveRecipe();
                }

                const saveAddButton = document.querySelector('button[onclick*="updateAndAddRecipeToLog"], button[onclick="addRecipeToLog()"]');
                if (saveAddButton) {
                    saveAddButton.textContent = 'Save & Add to Today\'s Log';
                    saveAddButton.onclick = () => addRecipeToLog();
                }

                // Ensure ingredient select is populated
                populateIngredientSelect();

                // Update preview
                updateRecipePreview();

                showSuccessMessage('‚úÖ Template loaded! Modify ingredients and save as new recipe.');

            }).catch(error => {
                console.error('‚ùå TEMPLATE: Failed to load ingredients:', error);
                showErrorMessage('Failed to load recipe template: ' + error.message);
            });
        }

        // Populate Recipe Template Dropdown
        function populateRecipeTemplateDropdown() {
            const templateSelect = document.getElementById('recipeTemplateSelect');
            if (!templateSelect) return;

            // Get all available recipes
            const recipeKeys = Object.keys(customRecipes);

            // Clear existing options (except the first placeholder)
            templateSelect.innerHTML = '<option value="">-- Select a recipe to copy --</option>';

            // Add recipes to dropdown
            recipeKeys.forEach(key => {
                const recipe = customRecipes[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = recipe.name + ` (${recipe.servings} servings, ${recipe.ingredients.length} ingredients)`;
                templateSelect.appendChild(option);
            });
        }

        // Load Recipe Template (called when user selects from dropdown)
        function loadRecipeTemplate() {
            const templateSelect = document.getElementById('recipeTemplateSelect');
            const selectedKey = templateSelect.value;

            if (!selectedKey) {
                // If no recipe selected, just clear the form
                return;
            }

            console.log('üìã TEMPLATE: loadRecipeTemplate() called for key:', selectedKey);

            // Check if the recipe exists
            if (!customRecipes[selectedKey]) {
                showErrorMessage('Recipe not found: ' + selectedKey);
                return;
            }

            const recipe = customRecipes[selectedKey];
            const requestedServings = parseFloat(document.getElementById('recipeTemplateServings').value) || 1;
            const originalServings = recipe.servings || 1;
            const scaleFactor = requestedServings / originalServings;

            console.log('üìã TEMPLATE: Loading recipe:', recipe.name);
            console.log('üìã TEMPLATE: Original servings:', originalServings, 'Requested:', requestedServings, 'Scale:', scaleFactor);

            // Set recipe name to indicate it's based on the original
            document.getElementById('recipeName').value = recipe.name + ' + More';
            document.getElementById('recipeCategory').value = recipe.category;
            // Keep servings at 1 since we're scaling ingredients to the requested amount
            document.getElementById('recipeServings').value = 1;

            // Deep copy and scale ingredients
            const scaledIngredients = recipe.ingredients.map(ingredient => {
                const scaledIng = JSON.parse(JSON.stringify(ingredient));

                // Scale the amount string (e.g., "1.33x 1 cup uncooked")
                if (scaledIng.amount) {
                    // Parse the multiplier from the amount string
                    const amountMatch = scaledIng.amount.match(/^([\d.]+)x\s+(.+)$/);
                    if (amountMatch) {
                        const currentMultiplier = parseFloat(amountMatch[1]);
                        const measurement = amountMatch[2];
                        const newMultiplier = (currentMultiplier * scaleFactor).toFixed(2);
                        scaledIng.amount = `${newMultiplier}x ${measurement}`;
                    }
                }

                // Scale nutrition values
                if (scaledIng.nutrition) {
                    Object.keys(scaledIng.nutrition).forEach(key => {
                        scaledIng.nutrition[key] = scaledIng.nutrition[key] * scaleFactor;
                    });
                }

                return scaledIng;
            });

            // Set the scaled ingredients
            currentRecipeIngredients = scaledIngredients;

            // Update preview
            updateRecipePreview();

            showSuccessMessage(`‚úÖ Loaded ${requestedServings} serving(s) of ${recipe.name}! Add more ingredients if needed.`);
        }

        // Delete Recipe Function
        async function deleteRecipe(key) {
            console.log('üóëÔ∏è DELETE: deleteRecipe() called for key:', key);
            
            // Check if the recipe exists in customRecipes
            if (!customRecipes[key]) {
                showErrorMessage('Recipe not found: ' + key);
                return;
            }
            
            const recipe = customRecipes[key];
            console.log('üóëÔ∏è DELETE: Found recipe:', recipe.name);
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete the recipe "${recipe.name}"?\n\nThis action cannot be undone.`)) {
                console.log('üóëÔ∏è DELETE: User cancelled deletion');
                return;
            }
            
            try {
                // Try to delete from server first
                const response = await fetch(`/api/recipes/${key}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe deleted from server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${recipe.name}" deleted from server!`);
                    
                    // Also remove from localStorage
                    delete customRecipes[key];
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to delete recipe from server, deleting from localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe deleted locally only');
                
                // Fallback to localStorage only
                delete customRecipes[key];
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${recipe.name}" deleted locally!`);
            }
            
            console.log('‚úÖ DELETE: Recipe deletion completed');
            
            // Refresh the quick dishes display
            populateQuickDishes();
            
            // Also update modal quick dishes if it exists
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
        }

        // Helper function to update existing recipe
        async function updateExistingRecipe(originalKey) {
            const name = document.getElementById('recipeName').value.trim();
            const category = document.getElementById('recipeCategory').value;
            const servings = parseInt(document.getElementById('recipeServings').value);
            
            if (!name || currentRecipeIngredients.length === 0) {
                alert('Please enter recipe name and add ingredients');
                return;
            }
            
            // Calculate nutrition per serving
            const totals = currentRecipeIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            const recipe = {
                name: name,
                category: category,
                servings: servings,
                ingredients: currentRecipeIngredients,
                total_per_serving: {
                    calories: Math.round(totals.calories / servings),
                    protein: Math.round(totals.protein / servings * 10) / 10,
                    carbs: Math.round(totals.carbs / servings * 10) / 10,
                    fat: Math.round(totals.fat / servings * 10) / 10,
                    fiber: Math.round(totals.fiber / servings * 10) / 10
                }
            };
            
            try {
                // Try to update on server first
                const response = await fetch(`/api/recipes/${originalKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipeData: recipe
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Recipe updated on server:', result.message);
                    showSuccessMessage(`‚úÖ Recipe "${name}" updated on server!`);
                    
                    // Also update localStorage as backup/cache
                    customRecipes[originalKey] = recipe;
                    localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to update recipe on server, updating localStorage only:', error);
                showErrorMessage('‚ö†Ô∏è Server unavailable - recipe updated locally only');
                
                // Fallback to localStorage only
                customRecipes[originalKey] = recipe;
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                showSuccessMessage(`üì± Recipe "${name}" updated locally!`);
            }
            
            // Refresh displays
            populateQuickDishes();
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
            
            // Reset the modal
            resetRecipeBuilderModal();
            closeRecipeBuilder();
        }

        // Helper function to update and add recipe to log
        function updateAndAddRecipeToLog(originalKey) {
            updateExistingRecipe(originalKey);
            // Add the updated recipe to today's log
            if (customRecipes[originalKey]) {
                addQuickDish(originalKey);
            }
        }

        // Helper function to reset recipe builder modal to create mode
        function resetRecipeBuilderModal() {
            // Reset modal title
            const modalTitle = document.querySelector('#recipeModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'Create New Recipe';
            }
            
            // Reset save button
            const saveButton = document.querySelector('button[onclick*="updateExistingRecipe"], button[onclick="saveRecipe()"]');
            if (saveButton) {
                saveButton.textContent = 'Save Recipe';
                saveButton.onclick = saveRecipe;
            }
            
            // Reset save & add button
            const saveAddButton = document.querySelector('button[onclick*="updateAndAddRecipeToLog"], button[onclick="addRecipeToLog()"]');
            if (saveAddButton) {
                saveAddButton.textContent = 'Save & Add to Today\'s Log';
                saveAddButton.onclick = addRecipeToLog;
            }
        }

        function updateDailySummary() {
            console.log('üìÖ UPDATE_SUMMARY: updateDailySummary() called');
            console.log('üìÖ UPDATE_SUMMARY: selectedDate:', selectedDate.toISOString().split('T')[0]);
            
            const currentMeals = getCurrentDateMeals();
            const safeDate = getSafeSelectedDate();
            const dateKey = formatDateKey(safeDate);

            console.log('üìÖ UPDATE_SUMMARY: dateKey generated:', dateKey);
            console.log('üìÖ UPDATE_SUMMARY: currentMeals found:', currentMeals.length);
            console.log('üìÖ UPDATE_SUMMARY: currentMeals data:', currentMeals);

            const totals = currentMeals.reduce((acc, meal) => {
                console.log('üìÖ UPDATE_SUMMARY: Processing meal:', meal.description, 'calories:', meal.nutrition.calories);
                acc.calories += meal.nutrition.calories;
                acc.protein += meal.nutrition.protein;
                acc.fiber += meal.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, fiber: 0});

            console.log('üìÖ UPDATE_SUMMARY: Calculated totals:', totals);
            console.log('üìÖ UPDATE_SUMMARY: Setting totalCalories to:', totals.calories);
            console.log('üìÖ UPDATE_SUMMARY: Setting mealCount to:', currentMeals.length);

            document.getElementById('totalCalories').textContent = totals.calories;
            document.getElementById('mealCount').textContent = currentMeals.length;
            document.getElementById('totalProtein').textContent = Math.round(totals.protein * 10) / 10 + 'g';
            document.getElementById('totalFiber').textContent = Math.round(totals.fiber * 10) / 10 + 'g';
            
            console.log('üìÖ UPDATE_SUMMARY: UI elements updated successfully');
            
            // Update calorie goal display with dynamic adjustment
            updateCalorieGoalDisplay(totals.calories, dateKey);
            
            // Update weight tracking display when date changes
            updateWeightDisplay();
            
            console.log('üìÖ UPDATE_SUMMARY: updateDailySummary() completed');
        }

        // Enhanced calorie goal display function
        function updateCalorieGoalDisplay(consumedCalories, dateKey) {
            const goalData = getAdjustedCalorieGoal(dateKey);
            const exerciseCalories = getTotalExerciseCalories(dateKey);
            const netCalories = consumedCalories - exerciseCalories;
            const remaining = goalData.adjustedGoal - netCalories;
            
            // Update the calorie goal card with enhanced information
            const calorieGoalEl = document.getElementById('calorieGoal');
            const calorieDeficitEl = document.getElementById('calorieDeficit');
            const goalSourceEl = document.getElementById('goalSource');
            const exerciseStatusEl = document.getElementById('exerciseAdjustmentStatus');
            
            if (goalData.adjustedGoal > 0) {
                // Show adjusted goal with breakdown if exercise calories are being eaten back
                if (exerciseCalorieSettings.eatBackExercise && goalData.exerciseCalories > 0) {
                    calorieGoalEl.innerHTML = `
                        <span title="Base: ${goalData.baseGoal.toLocaleString()} + Exercise: ${goalData.eatBackAmount} = ${goalData.adjustedGoal.toLocaleString()}">${goalData.adjustedGoal.toLocaleString()}</span>
                    `;
                } else {
                    calorieGoalEl.textContent = goalData.adjustedGoal.toLocaleString();
                }
                
                // Update remaining/deficit display
                if (remaining > 0) {
                    calorieDeficitEl.textContent = `Remaining: ${remaining}`;
                    calorieDeficitEl.className = 'text-xs text-blue-500 mt-1';
                } else {
                    calorieDeficitEl.textContent = `Over by: ${Math.abs(remaining)}`;
                    calorieDeficitEl.className = 'text-xs text-red-500 mt-1';
                }
                
                // Update goal source
                if (goalSourceEl) {
                    let sourceText = '';
                    if (weightLossGoals && weightLossGoals.dailyTarget > 0) {
                        sourceText = `${weightLossGoals.weeklyLoss} lbs/week goal`;
                    } else if (userCalorieGoal > 0) {
                        sourceText = 'Manually set';
                    } else {
                        sourceText = 'Auto-calculated';
                    }
                    goalSourceEl.textContent = sourceText;
                }
                
                // Update exercise adjustment status
                if (exerciseStatusEl) {
                    if (exerciseCalorieSettings.eatBackExercise) {
                        if (goalData.exerciseCalories > 0) {
                            exerciseStatusEl.textContent = `+${goalData.eatBackAmount} from exercise (${exerciseCalorieSettings.eatBackPercentage}%)`;
                            exerciseStatusEl.className = 'text-xs text-green-600 mt-1';
                        } else {
                            exerciseStatusEl.textContent = `Exercise adjustment enabled (${exerciseCalorieSettings.eatBackPercentage}%)`;
                            exerciseStatusEl.className = 'text-xs text-blue-600 mt-1';
                        }
                    } else {
                        exerciseStatusEl.textContent = 'Fixed goal (no exercise adjustment)';
                        exerciseStatusEl.className = 'text-xs text-gray-500 mt-1';
                    }
                }
            } else {
                calorieGoalEl.textContent = '--';
                calorieDeficitEl.textContent = 'Set goal';
                calorieDeficitEl.className = 'text-xs text-gray-500 mt-1';
                
                if (goalSourceEl) goalSourceEl.textContent = '--';
                if (exerciseStatusEl) {
                    exerciseStatusEl.textContent = '--';
                    exerciseStatusEl.className = 'text-xs text-gray-500 mt-1';
                }
            }
        }

        function displayMeals() {
            const foodLog = document.getElementById('foodLog');
            const currentMeals = getCurrentDateMeals();
            
            if (currentMeals.length === 0) {
                foodLog.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No meals logged yet. Try adding a dish above!</p>
                    </div>
                `;
                return;
            }

            // Group meals by meal type
            const mealTypes = ['Breakfast', 'Morning Snack', 'Lunch', 'Evening Snack','Dessert', 'Dinner'];
            const groupedMeals = {};
            
            // Initialize all meal types
            mealTypes.forEach(type => {
                groupedMeals[type] = [];
            });
            
            // Group meals by their meal type
            currentMeals.forEach(meal => {
                const mealType = meal.mealType || 'Lunch'; // Default to Lunch if no meal type
                if (groupedMeals[mealType]) {
                    groupedMeals[mealType].push(meal);
                } else {
                    // Handle any unexpected meal types by adding to Lunch
                    groupedMeals['Lunch'].push(meal);
                }
            });
            
            // Sort meals within each group by timestamp (newest first)
            Object.keys(groupedMeals).forEach(mealType => {
                groupedMeals[mealType].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            });
            
            // Generate HTML for each meal type group
            let html = '';
            mealTypes.forEach(mealType => {
                const mealsInType = groupedMeals[mealType];
                
                if (mealsInType.length === 0) return; // Skip empty meal types
                
                // Calculate subtotals for this meal type
                const subtotals = mealsInType.reduce((totals, meal) => {
                    totals.calories += meal.nutrition.calories;
                    totals.protein += meal.nutrition.protein;
                    totals.carbs += meal.nutrition.carbs;
                    totals.fat += meal.nutrition.fat;
                    totals.fiber += meal.nutrition.fiber;
                    return totals;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });
                
                // Round subtotals
                subtotals.protein = Math.round(subtotals.protein * 10) / 10;
                subtotals.carbs = Math.round(subtotals.carbs * 10) / 10;
                subtotals.fat = Math.round(subtotals.fat * 10) / 10;
                subtotals.fiber = Math.round(subtotals.fiber * 10) / 10;
                
                // Meal type header with subtotals
                html += `
                    <div class="meal-type-group mb-6">
                        <div class="meal-type-header bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-3 border border-blue-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-lg font-semibold text-gray-800">${mealType}</h2>
                                <span class="text-sm text-gray-600">${mealsInType.length} item${mealsInType.length !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm mt-2">
                                <div class="bg-orange-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-orange-600">${subtotals.calories}</div>
                                    <div class="text-orange-500 text-xs">Calories</div>
                                </div>
                                <div class="bg-blue-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-blue-600">${subtotals.protein}g</div>
                                    <div class="text-blue-500 text-xs">Protein</div>
                                </div>
                                <div class="bg-yellow-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-yellow-600">${subtotals.carbs}g</div>
                                    <div class="text-yellow-500 text-xs">Carbs</div>
                                </div>
                                <div class="bg-green-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-green-600">${subtotals.fat}g</div>
                                    <div class="text-green-500 text-xs">Fat</div>
                                </div>
                                <div class="bg-purple-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-purple-600">${subtotals.fiber}g</div>
                                    <div class="text-purple-500 text-xs">Fiber</div>
                                </div>
                            </div>
                        </div>
                `;
                
                // Individual meals in this type
                mealsInType.forEach(meal => {
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 fade-in ml-4 mb-3">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-gray-800">${meal.description}</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-500">${formatTime(new Date(meal.timestamp))}</span>
                                    <button onclick="removeMeal(${meal.id})" class="text-red-500 hover:text-red-700 text-sm">&times;</button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2 text-sm">
                                <div class="bg-orange-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-orange-600">${meal.nutrition.calories}</div>
                                    <div class="text-orange-500 text-xs">Calories</div>
                                </div>
                                <div class="bg-blue-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-blue-600">${meal.nutrition.protein}g</div>
                                    <div class="text-blue-500 text-xs">Protein</div>
                                </div>
                                <div class="bg-yellow-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-yellow-600">${meal.nutrition.carbs}g</div>
                                    <div class="text-yellow-500 text-xs">Carbs</div>
                                </div>
                                <div class="bg-green-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-green-600">${meal.nutrition.fat}g</div>
                                    <div class="text-green-500 text-xs">Fat</div>
                                </div>
                                <div class="bg-purple-50 px-2 py-1 rounded text-center">
                                    <div class="font-semibold text-purple-600">${meal.nutrition.fiber}g</div>
                                    <div class="text-purple-500 text-xs">Fiber</div>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-500">
                                Source: ${meal.source === 'database' ? 'Indian Food Database' : meal.source === 'ingredients' ? 'Basic Ingredients' : 'Custom Entry'}
                                ${meal.ingredients ? `
                                    <details class="mt-2">
                                        <summary class="cursor-pointer text-gray-600 hover:text-gray-800">View ingredients (${meal.ingredients.length})</summary>
                                        <div class="mt-1 space-y-1 pl-4">
                                            ${meal.ingredients.map(ing => `
                                                <div class="flex justify-between text-xs">
                                                    <span>${ing.name} (${ing.quantity}x ${ing.measurement})</span>
                                                    <span class="text-gray-500">${ing.nutrition.calories} cal</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>'; // Close meal-type-group
            });
            
            foodLog.innerHTML = html;
        }

        function removeMeal(mealId) {
            removeMealFromDate(mealId);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_deleted');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function showSuccessMessage(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            successMsg.textContent = '‚úÖ ' + message;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        // CONSOLIDATED INITIALIZATION - Single DOMContentLoaded listener to prevent race conditions
        // AI Assistant: robust initialization to avoid race conditions and ensure clicks are captured
        function initAIAssistant() {
            const btn = document.getElementById('aiAssistantBtn');
            const panel = document.getElementById('aiAssistantPanel');
            if (panel) {
                panel.style.pointerEvents = 'auto';
                // Instrumentation: capture clicks inside the panel for diagnostics
                panel.addEventListener('click', (e) => {
                    console.log('üß™ AI Panel Click:', { tag: e.target?.tagName, id: e.target?.id, classes: e.target?.className });
                }, true);
            }
            if (btn) {
                // Ensure click binding is reliable (supports CSP that blocks inline handlers)
                btn.style.pointerEvents = 'auto';
                btn.addEventListener('click', (e) => {
                    try {
                        e.preventDefault();
                        e.stopPropagation();
                    } catch {}
                    if (typeof window.toggleAIAssistant === 'function') {
                        window.toggleAIAssistant();
                    } else if (typeof toggleAIAssistant === 'function') {
                        toggleAIAssistant();
                    } else {
                        console.warn('AI: toggleAIAssistant not available');
                    }
                });
            }
            // Sync AI date selector if available
            if (typeof syncAIDate === 'function') {
                try { syncAIDate(); } catch (e) { console.warn('AI: syncAIDate failed', e); }
            }
            console.log('‚úÖ AI Assistant initialized');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ INIT: Starting consolidated app initialization...');
            console.log('üöÄ INIT: Current time:', new Date().toISOString());
            console.log('üöÄ INIT: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üöÄ INIT: foodDatabase state:', foodDatabase ? 'EXISTS' : 'NULL');
            
            // Ensure selectedDate exists; default to today
            if (!selectedDate || !(selectedDate instanceof Date) || isNaN(selectedDate.getTime())) {
                selectedDate = new Date();
                console.log('üöÄ INIT: Set selectedDate to today:', selectedDate.toString());
            }
            
            // Initialize the date-based system FIRST to prevent race conditions
            initializeDateSystem();

            // Initialize AI Assistant bindings and diagnostics
            try { initAIAssistant(); } catch (e) { console.warn('AI: initAIAssistant failed', e); }
            
            // Initialize meal preview updates for servings changes
            const mealServingsInput = document.getElementById('mealServings');
            const mealServingsToLogInput = document.getElementById('mealServingsToLog');
            if (mealServingsInput) {
                mealServingsInput.addEventListener('input', updateMealPreview);
            }
            if (mealServingsToLogInput) {
                mealServingsToLogInput.addEventListener('input', updateMealPreview);
            }
            
            // Initialize export preview updates for custom dates (consolidated from line 5747)
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');
            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', updateExportPreview);
                endDateInput.addEventListener('change', updateExportPreview);
            }
            
            // Initialize enhanced tracking for loading saved goals (consolidated from line 8489)
            if (weightLossGoals.dailyTarget > 0) {
                dailyCalorieTarget = weightLossGoals.dailyTarget;
                weeklyDeficitGoal = weightLossGoals.weeklyDeficitGoal || 3500;
                
                // Update userCalorieGoal if not set
                if (userCalorieGoal === 0) {
                    userCalorieGoal = dailyCalorieTarget;
                }
            }
            
            // Update displays after initialization is complete
            setTimeout(() => {
                updateWeeklyDeficitDisplay();
            }, 500);
            
            // Hide dropdown when clicking outside (for ingredient searches)
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('mealIngredientDropdown');
                const searchInput = document.getElementById('mealIngredientSearch');
                
                if (dropdown && searchInput && !dropdown.contains(event.target) && event.target !== searchInput) {
                    dropdown.classList.add('hidden');
                }
            });
            
            console.log('‚úÖ INIT: Consolidated app initialization completed');
        });

        // Ingredient Management Functions
        let currentIngredients = {};
        let serverMode = false;

        // Check if server is available
        async function checkServerMode() {
            try {
                // Check if we're running from file:// protocol
                if (window.location.protocol === 'file:') {
                    console.log('‚ö†Ô∏è Running from file system - server features disabled');
                    console.log('üí° To enable ingredient management, access via: http://localhost:3000');
                    serverMode = false;
                    showServerModeWarning();
                    return;
                }

                const response = await fetch('/api/ingredients');
                if (response.ok) {
                    serverMode = true;
                    console.log('‚úÖ Server mode enabled - ingredient management available');
                    hideServerModeWarning();
                } else {
                    serverMode = false;
                    console.log('‚ö†Ô∏è Server responded with error - ingredient management disabled');
                    showServerModeWarning();
                }
            } catch (error) {
                serverMode = false;
                console.log('‚ö†Ô∏è Server not available - ingredient management disabled');
                console.log('üí° Make sure server is running with "npm start" and access via: http://localhost:3000');
                showServerModeWarning();
            }
        }

        // Show warning about server mode
        function showServerModeWarning() {
            const existingWarning = document.getElementById('serverModeWarning');
            if (existingWarning) return; // Don't show multiple warnings

            const warning = document.createElement('div');
            warning.id = 'serverModeWarning';
            warning.className = 'fixed top-4 left-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-lg z-50';
            warning.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-yellow-800">Server Mode Required</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>Ingredient management features are disabled. To enable them:</p>
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                <li>Make sure the server is running with <code class="bg-yellow-200 px-1 rounded">npm start</code></li>
                                <li>Access the app via <a href="http://localhost:3000" class="underline font-semibold">http://localhost:3000</a></li>
                            </ol>
                        </div>
                        <div class="mt-3">
                            <button onclick="retryServerConnection()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                                üîÑ Retry Connection
                            </button>
                            <button onclick="hideServerModeWarning()" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                                Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(warning);
        }

        // Hide server mode warning
        function hideServerModeWarning() {
            const warning = document.getElementById('serverModeWarning');
            if (warning) {
                warning.remove();
            }
        }

        // Retry server connection
        async function retryServerConnection() {
            console.log('üîÑ Retrying server connection...');
            await checkServerMode();
            if (serverMode) {
                showSuccessMessage('‚úÖ Server connection established!');
            }
        }

        // Initialize server check
        checkServerMode();

        function openIngredientModal() {
            console.log('ü•¨ MODAL: openIngredientModal() called');
            console.log('ü•¨ MODAL: serverMode:', serverMode);
            console.log('ü•¨ MODAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            if (!serverMode) {
                // Show a more helpful message based on the current context
                if (window.location.protocol === 'file:') {
                    showErrorMessage('Please access the app via http://localhost:3000 to use ingredient management features.');
                } else {
                    showErrorMessage('Server connection required. Make sure the server is running with "npm start".');
                }
                // Also show the server mode warning if it's not already visible
                showServerModeWarning();
                return;
            }
            
            // Always ensure databases are loaded before opening modal
            console.log('üîÑ MODAL: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MODAL: Databases loaded, opening modal');
                // Now open the modal with loaded data
                document.getElementById('ingredientModal').classList.add('active');
                showIngredientLoadingState();
                loadExistingIngredients();
                showSuccessMessage('‚úÖ Ingredients loaded successfully!');
            }).catch(error => {
                console.error('‚ùå MODAL: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function showIngredientLoadingState() {
            console.log('üîÑ LOADING_STATE: showIngredientLoadingState() called');
            const container = document.getElementById('ingredientsList');
            console.log('üîÑ LOADING_STATE: ingredientsList element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è LOADING_STATE: ingredientsList not found - skipping loading state display');
                return;
            }
            
            container.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mr-3"></div>
                    <span class="text-gray-600">Loading ingredients...</span>
                </div>
            `;
        }

        function closeIngredientModal() {
            document.getElementById('ingredientModal').classList.remove('active');
            clearIngredientForm();
        }

        async function loadExistingIngredients() {
            try {
                console.log('üîÑ LOAD_EXISTING: Loading ingredients from server...');
                console.log('üîÑ LOAD_EXISTING: Checking if ingredientsList element exists...');
                const container = document.getElementById('ingredientsList');
                console.log('üîÑ LOAD_EXISTING: ingredientsList element:', container ? 'EXISTS' : 'NULL');
                
                if (!container) {
                    console.error('‚ùå LOAD_EXISTING: ingredientsList element not found - this will cause innerHTML error');
                    throw new Error('ingredientsList container not found in DOM');
                }
                
                const startTime = performance.now();
                
                const response = await fetch('/api/ingredients');
                if (!response.ok) throw new Error('Failed to load ingredients');
                
                const data = await response.json();
                currentIngredients = data.basic_ingredients;
                
                const loadTime = performance.now() - startTime;
                console.log(`‚úÖ LOAD_EXISTING: Ingredients loaded in ${loadTime.toFixed(2)}ms`);
                
                // Use setTimeout to allow UI to update before processing
                setTimeout(() => {
                    displayIngredientsList();
                }, 10);
                
            } catch (error) {
                console.error('‚ùå LOAD_EXISTING: Error loading ingredients:', error);
                const container = document.getElementById('ingredientsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-red-500 mb-2">‚ùå Failed to load ingredients</div>
                            <div class="text-sm text-gray-600">${error.message}</div>
                            <button onclick="loadExistingIngredients()" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                Retry
                            </button>
                        </div>
                    `;
                } else {
                    console.error('‚ùå LOAD_EXISTING: Cannot display error - ingredientsList container not found');
                }
                showErrorMessage('Failed to load ingredients: ' + error.message);
            }
        }

        function displayIngredientsList() {
            console.log('üé® DISPLAY_LIST: displayIngredientsList() called');
            const container = document.getElementById('ingredientsList');
            console.log('üé® DISPLAY_LIST: ingredientsList element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è DISPLAY_LIST: ingredientsList not found - skipping ingredients list display');
                return;
            }
            
            const filterCategory = document.getElementById('filterCategory')?.value || '';
            
            console.log('üé® DISPLAY_LIST: Rendering ingredients list...');
            const startTime = performance.now();
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            let hasContent = false;
            
            Object.entries(currentIngredients).forEach(([category, ingredients]) => {
                if (filterCategory && category !== filterCategory) return;
                
                const categoryName = category.replace(/_/g, ' ').toUpperCase();
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-4';
                
                const categoryHeader = document.createElement('h6');
                categoryHeader.className = 'font-semibold text-gray-700 mb-2';
                categoryHeader.textContent = categoryName;
                categoryDiv.appendChild(categoryHeader);
                
                Object.entries(ingredients).forEach(([key, ingredient]) => {
                    hasContent = true;
                    const measurementCount = Object.keys(ingredient.measurements).length;
                    
                    const ingredientDiv = document.createElement('div');
                    ingredientDiv.className = 'bg-gray-50 p-3 rounded-lg mb-2';
                    ingredientDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-gray-800">${ingredient.name}</div>
                                <div class="text-sm text-gray-600">${measurementCount} measurement${measurementCount !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editIngredient('${category}', '${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>
                                <button onclick="deleteIngredient('${category}', '${key}', '${ingredient.name}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Delete</button>
                            </div>
                        </div>
                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">View measurements</summary>
                            <div class="mt-1 space-y-1 pl-4">
                                ${Object.entries(ingredient.measurements).map(([measureKey, nutrition]) => `
                                    <div class="flex justify-between text-xs">
                                        <span>${measureKey.replace(/_/g, ' ')}</span>
                                        <span class="text-gray-500">${nutrition.calories} cal</span>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    `;
                    
                    categoryDiv.appendChild(ingredientDiv);
                });
                
                if (categoryDiv.children.length > 1) { // Has header + ingredients
                    fragment.appendChild(categoryDiv);
                }
            });
            
            // Clear container and add content
            container.innerHTML = '';
            
            if (!hasContent) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No ingredients found</p>';
            } else {
                container.appendChild(fragment);
            }
            
            const renderTime = performance.now() - startTime;
            console.log(`‚úÖ DISPLAY_LIST: Ingredients rendered in ${renderTime.toFixed(2)}ms`);
        }

        function filterIngredients() {
            displayIngredientsList();
        }

        function addMeasurementInput() {
            const container = document.getElementById('measurementInputs');
            const measurementDiv = document.createElement('div');
            measurementDiv.className = 'bg-gray-50 p-4 rounded-lg';
            measurementDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                        <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                        <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-2">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                        <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                        <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                        <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                        <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                        <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                    </div>
                </div>
                <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
            `;
            container.appendChild(measurementDiv);
        }

        function removeMeasurement(button) {
            const container = document.getElementById('measurementInputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('At least one measurement is required');
            }
        }

        function clearIngredientForm() {
            document.getElementById('ingredientName').value = '';
            document.getElementById('ingredientCategory').value = '';
            
            // Reset to single measurement input
            const container = document.getElementById('measurementInputs');
            container.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1_cup_chopped">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 1 cup chopped">
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="0" min="0" step="0.1">
                        </div>
                    </div>
                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                </div>
            `;
        }

        async function saveIngredient() {
            const name = document.getElementById('ingredientName').value.trim();
            const category = document.getElementById('ingredientCategory').value;
            
            if (!name || !category) {
                alert('Please enter ingredient name and select a category');
                return;
            }
            
            // Collect measurements
            const measurementInputs = document.getElementById('measurementInputs').children;
            const measurements = {};
            
            for (let i = 0; i < measurementInputs.length; i++) {
                const measurementDiv = measurementInputs[i];
                const measurementName = measurementDiv.querySelector('.measurement-name').value.trim();
                const calories = parseFloat(measurementDiv.querySelector('.nutrition-calories').value) || 0;
                const protein = parseFloat(measurementDiv.querySelector('.nutrition-protein').value) || 0;
                const carbs = parseFloat(measurementDiv.querySelector('.nutrition-carbs').value) || 0;
                const fat = parseFloat(measurementDiv.querySelector('.nutrition-fat').value) || 0;
                const fiber = parseFloat(measurementDiv.querySelector('.nutrition-fiber').value) || 0;
                
                if (!measurementName) {
                    alert(`Please enter measurement name for measurement ${i + 1}`);
                    return;
                }
                
                measurements[measurementName] = {
                    calories,
                    protein,
                    carbs,
                    fat,
                    fiber
                };
            }
            
            const ingredientKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const ingredientData = {
                name,
                measurements
            };
            
            try {
                const response = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category,
                        ingredientKey,
                        ingredientData
                    })
                });
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    result = { error: 'Invalid server response' };
                }
                
                if (response.ok && result && result.success) {
                    showSuccessMessage(`Ingredient "${name}" added successfully!`);
                    clearIngredientForm();
                    loadExistingIngredients();
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    const detail = result && result.error ? result.error : `HTTP ${response.status}`;
                    throw new Error(detail || 'Failed to save ingredient');
                }
            } catch (error) {
                console.error('Error saving ingredient:', error);
                showErrorMessage('Failed to save ingredient: ' + error.message);
            }
        }

        async function deleteIngredient(category, ingredientKey, ingredientName) {
            if (!confirm(`Are you sure you want to delete "${ingredientName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ingredients/${category}/${ingredientKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`Ingredient "${ingredientName}" deleted successfully!`);
                    loadExistingIngredients();
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to delete ingredient');
                }
            } catch (error) {
                console.error('Error deleting ingredient:', error);
                showErrorMessage('Failed to delete ingredient: ' + error.message);
            }
        }

        function editIngredient(category, ingredientKey) {
            const ingredient = currentIngredients[category][ingredientKey];
            
            // Fill form with existing data
            document.getElementById('ingredientName').value = ingredient.name;
            document.getElementById('ingredientCategory').value = category;
            
            // Clear and populate measurements
            const container = document.getElementById('measurementInputs');
            container.innerHTML = '';
            
            Object.entries(ingredient.measurements).forEach(([measureKey, nutrition]) => {
                const measurementDiv = document.createElement('div');
                measurementDiv.className = 'bg-gray-50 p-4 rounded-lg';
                measurementDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Measurement:</label>
                            <input type="text" class="measurement-name w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${measureKey}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Display Name:</label>
                            <input type="text" class="measurement-display w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${measureKey.replace(/_/g, ' ')}">
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Calories:</label>
                            <input type="number" class="nutrition-calories w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.calories}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Protein (g):</label>
                            <input type="number" class="nutrition-protein w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.protein}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Carbs (g):</label>
                            <input type="number" class="nutrition-carbs w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.carbs}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fat (g):</label>
                            <input type="number" class="nutrition-fat w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.fat}" min="0" step="0.1">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Fiber (g):</label>
                            <input type="number" class="nutrition-fiber w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" value="${nutrition.fiber}" min="0" step="0.1">
                        </div>
                    </div>
                    <button onclick="removeMeasurement(this)" class="mt-2 text-red-500 hover:text-red-700 text-sm">&times; Remove</button>
                `;
                container.appendChild(measurementDiv);
            });
            
            // Change save button to update mode
            const saveButton = document.querySelector('button[onclick="saveIngredient()"]');
            saveButton.textContent = 'Update Ingredient';
            saveButton.onclick = () => updateIngredient(category, ingredientKey);
        }

        async function updateIngredient(originalCategory, originalKey) {
            const name = document.getElementById('ingredientName').value.trim();
            const category = document.getElementById('ingredientCategory').value;
            
            if (!name || !category) {
                alert('Please enter ingredient name and select a category');
                return;
            }
            
            // Collect measurements
            const measurementInputs = document.getElementById('measurementInputs').children;
            const measurements = {};
            
            for (let i = 0; i < measurementInputs.length; i++) {
                const measurementDiv = measurementInputs[i];
                const measurementName = measurementDiv.querySelector('.measurement-name').value.trim();
                const calories = parseFloat(measurementDiv.querySelector('.nutrition-calories').value) || 0;
                const protein = parseFloat(measurementDiv.querySelector('.nutrition-protein').value) || 0;
                const carbs = parseFloat(measurementDiv.querySelector('.nutrition-carbs').value) || 0;
                const fat = parseFloat(measurementDiv.querySelector('.nutrition-fat').value) || 0;
                const fiber = parseFloat(measurementDiv.querySelector('.nutrition-fiber').value) || 0;
                
                if (!measurementName) {
                    alert(`Please enter measurement name for measurement ${i + 1}`);
                    return;
                }
                
                measurements[measurementName] = {
                    calories,
                    protein,
                    carbs,
                    fat,
                    fiber
                };
            }
            
            const ingredientData = {
                name,
                measurements
            };
            
            try {
                const response = await fetch(`/api/ingredients/${originalCategory}/${originalKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingredientData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`Ingredient "${name}" updated successfully!`);
                    clearIngredientForm();
                    loadExistingIngredients();
                    // Reset save button
                    const saveButton = document.querySelector('button[onclick*="updateIngredient"]');
                    if (saveButton) {
                        saveButton.textContent = 'Save Ingredient';
                        saveButton.onclick = saveIngredient;
                    }
                    // Reload ingredients in the main app
                    reloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to update ingredient');
                }
            } catch (error) {
                console.error('Error updating ingredient:', error);
                showErrorMessage('Failed to update ingredient: ' + error.message);
            }
        }

        function showErrorMessage(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            errorMsg.textContent = '‚ùå ' + message;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 5000);
        }

        // Meal Builder Functions
        function openMealBuilder() {
            console.log('üçΩÔ∏è MEAL: openMealBuilder() called');
            console.log('üçΩÔ∏è MEAL: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            // Always ensure databases are loaded before opening meal builder
            console.log('üîÑ MEAL: Ensuring databases are loaded...');
            showSuccessMessage('üîÑ Loading ingredients...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MEAL: Databases loaded, opening meal builder');
                document.getElementById('mealModal').classList.add('active');
                currentMealIngredients = [];
                selectedMealIngredient = null;
                clearMealForm();
                updateMealPreview();
                populateMealIngredientDropdown();
                showSuccessMessage('‚úÖ Meal builder ready!');
            }).catch(error => {
                console.error('‚ùå MEAL: Failed to load ingredients:', error);
                showErrorMessage('Failed to load ingredients: ' + error.message);
            });
        }

        function closeMealBuilder() {
            document.getElementById('mealModal').classList.remove('active');
            clearMealForm();
        }

        function clearMealForm() {
            document.getElementById('mealName').value = '';
            document.getElementById('mealServings').value = 1;
            document.getElementById('mealServingsToLog').value = 1;
            document.getElementById('mealIngredientSearch').value = '';
            document.getElementById('selectedMealIngredient').value = '';
            document.getElementById('mealQuantity').value = 1;
            document.getElementById('mealIngredientDropdown').classList.add('hidden');
            document.getElementById('mealIngredientInputs').style.display = 'none';
            selectedMealIngredient = null;
        }

        function clearMealBuilder() {
            currentMealIngredients = [];
            clearMealForm();
            updateMealPreview();
        }

        function populateMealIngredientDropdown() {
            const dropdown = document.getElementById('mealIngredientDropdown');
            if (!rawIngredients) {
                console.log('Raw ingredients not loaded yet');
                return;
            }

            let html = '';
            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    html += `
                        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             onclick="selectMealIngredient('${category}', '${key}', '${item.name}')">
                            <div class="font-medium text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500">${categoryName}</div>
                        </div>
                    `;
                });
            });
            dropdown.innerHTML = html;
        }

        function filterMealIngredients() {
            const searchTerm = document.getElementById('mealIngredientSearch').value.toLowerCase();
            const dropdown = document.getElementById('mealIngredientDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                document.getElementById('mealIngredientInputs').style.display = 'none';
                return;
            }

            if (!rawIngredients) {
                console.log('Raw ingredients not loaded yet');
                return;
            }

            let html = '';
            let hasResults = false;

            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    if (item.name.toLowerCase().includes(searchTerm)) {
                        hasResults = true;
                        html += `
                            <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                                 onclick="selectMealIngredient('${category}', '${key}', '${item.name}')">
                                <div class="font-medium text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500">${categoryName}</div>
                            </div>
                        `;
                    }
                });
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No ingredients found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function selectMealIngredient(category, key, name) {
            selectedMealIngredient = { category, key, name };
            
            // Update the search input and hide dropdown
            document.getElementById('mealIngredientSearch').value = name;
            document.getElementById('mealIngredientDropdown').classList.add('hidden');
            
            // Show the ingredient inputs
            document.getElementById('selectedMealIngredient').value = name;
            document.getElementById('mealIngredientInputs').style.display = 'grid';
            
            // Populate measurements
            populateMealMeasurements(category, key);
        }

        function populateMealMeasurements(category, key) {
            const measurementSelect = document.getElementById('mealMeasurementSelect');
            const ingredient = rawIngredients[category][key];
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
        }

        function addMealIngredient() {
            if (!selectedMealIngredient) {
                alert('Please select an ingredient first');
                return;
            }

            const measurementSelect = document.getElementById('mealMeasurementSelect');
            const quantityInput = document.getElementById('mealQuantity');
            
            if (!measurementSelect.value || !quantityInput.value) {
                alert('Please select measurement and enter quantity');
                return;
            }

            const quantity = parseFloat(quantityInput.value);
            const { category, key, name } = selectedMealIngredient;
            const ingredient = rawIngredients[category][key];
            const measurement = ingredient.measurements[measurementSelect.value];
            
            const ingredientEntry = {
                key: `${category}.${key}`,
                name: name,
                category: category,
                ingredientKey: key,
                measurementKey: measurementSelect.value,
                measurementDisplay: measurementSelect.options[measurementSelect.selectedIndex].text,
                quantity: quantity,
                nutrition: {
                    calories: measurement.calories * quantity,
                    protein: measurement.protein * quantity,
                    carbs: measurement.carbs * quantity,
                    fat: measurement.fat * quantity,
                    fiber: measurement.fiber * quantity
                }
            };

            currentMealIngredients.push(ingredientEntry);
            
            // Clear inputs
            clearMealForm();
            updateMealPreview();
            
            showSuccessMessage(`Added ${name} to meal!`);
        }

        function removeMealIngredient(index) {
            currentMealIngredients.splice(index, 1);
            updateMealPreview();
        }

        function updateMealPreview() {
            const preview = document.getElementById('mealPreview');
            const totalServings = parseFloat(document.getElementById('mealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('mealServingsToLog').value) || 1;
            
            if (currentMealIngredients.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = currentMealIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Ingredients (${currentMealIngredients.length}):</h5>
                    ${currentMealIngredients.map((ing, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <span>${ing.name} (${ing.quantity}x ${ing.measurementDisplay})</span>
                            <button onclick="removeMealIngredient(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addMealToLog() {
            const mealName = document.getElementById('mealName').value.trim();
            const totalServings = parseFloat(document.getElementById('mealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('mealServingsToLog').value) || 1;
            
            if (currentMealIngredients.length === 0) {
                alert('Please add ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${currentMealIngredients.length} ingredients)`;
            
            // Calculate totals for the entire meal
            const totals = currentMealIngredients.reduce((acc, ing) => {
                acc.calories += ing.nutrition.calories;
                acc.protein += ing.nutrition.protein;
                acc.carbs += ing.nutrition.carbs;
                acc.fat += ing.nutrition.fat;
                acc.fiber += ing.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const selectedMealType = getSelectedMealType();
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'ingredients',
                mealType: selectedMealType,
                ingredients: currentMealIngredients.map(ing => ({
                    name: ing.name,
                    quantity: ing.quantity,
                    measurement: ing.measurementDisplay,
                    nutrition: ing.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_added');
            
            closeMealBuilder();
            showSuccessMessage(`Added "${finalMealName}" to your food log!`);
        }

        // REMOVED: Duplicate DOMContentLoaded listener - functionality moved to consolidated initialization

        // Excel Export Functions
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
            updateExportPreview();
            
            // Set default dates
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('exportStartDate').value = formatDateKey(firstOfMonth);
            document.getElementById('exportEndDate').value = formatDateKey(today);
            
            // Add event listeners for export range radio buttons
            const rangeInputs = document.querySelectorAll('input[name="exportRange"]');
            rangeInputs.forEach(input => {
                input.addEventListener('change', handleExportRangeChange);
            });
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('exportProgress').classList.add('hidden');
            document.getElementById('exportButton').disabled = false;
            
            // Remove event listeners
            const rangeInputs = document.querySelectorAll('input[name="exportRange"]');
            rangeInputs.forEach(input => {
                input.removeEventListener('change', handleExportRangeChange);
            });
        }

        function handleExportRangeChange() {
            const selectedRange = document.querySelector('input[name="exportRange"]:checked').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (selectedRange === 'custom') {
                customDateRange.classList.remove('hidden');
            } else {
                customDateRange.classList.add('hidden');
            }
            
            updateExportPreview();
        }

        function updateExportPreview() {
            const selectedRange = document.querySelector('input[name="exportRange"]:checked')?.value || 'all';
            const preview = document.getElementById('exportPreview');
            
            // Get data to export based on selection
            const dataToExport = getExportData(selectedRange);
            const totalDates = Object.keys(dataToExport).length;
            const totalMeals = Object.values(dataToExport).reduce((total, meals) => total + meals.length, 0);
            
            // Group by months for preview
            const monthsMap = {};
            Object.keys(dataToExport).forEach(dateKey => {
                const date = new Date(dateKey + 'T00:00:00');
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                if (!monthsMap[monthKey]) {
                    monthsMap[monthKey] = 0;
                }
                monthsMap[monthKey] += dataToExport[dateKey].length;
            });
            
            const monthsList = Object.entries(monthsMap).map(([month, count]) =>
                `<li class="flex justify-between"><span>${month}</span><span>${count} meals</span></li>`
            ).join('');
            
            let previewHtml = '';
            if (totalDates === 0) {
                previewHtml = '<p class="text-gray-500">No data found for selected range</p>';
            } else {
                previewHtml = `
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-white p-3 rounded border">
                                <div class="font-semibold text-gray-800">üìÖ Total Days</div>
                                <div class="text-2xl font-bold text-purple-600">${totalDates}</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-semibold text-gray-800">üçΩÔ∏è Total Meals</div>
                                <div class="text-2xl font-bold text-purple-600">${totalMeals}</div>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold text-gray-800 mb-2">üìä Excel Sheets to be created:</h5>
                            <ul class="text-sm space-y-1 bg-white p-3 rounded border max-h-32 overflow-y-auto">
                                ${monthsList || '<li class="text-gray-500">No months to export</li>'}
                            </ul>
                        </div>
                        
                        <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
                            <strong>üìã Export will include:</strong> Date, time, meal descriptions, detailed nutrition info (calories, protein, carbs, fat, fiber), ingredient lists, daily summaries, and monthly totals with averages.
                        </div>
                    </div>
                `;
            }
            
            preview.innerHTML = previewHtml;
        }

        function getExportData(rangeType) {
            let dataToExport = {};
            const today = new Date();
            
            switch (rangeType) {
                case 'all':
                    dataToExport = { ...mealsByDate };
                    break;
                    
                case 'month':
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    
                    Object.entries(mealsByDate).forEach(([dateKey, meals]) => {
                        const date = new Date(dateKey + 'T00:00:00');
                        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                            dataToExport[dateKey] = meals;
                        }
                    });
                    break;
                    
                case 'custom':
                    const startDate = document.getElementById('exportStartDate').value;
                    const endDate = document.getElementById('exportEndDate').value;
                    
                    if (startDate && endDate) {
                        Object.entries(mealsByDate).forEach(([dateKey, meals]) => {
                            if (dateKey >= startDate && dateKey <= endDate) {
                                dataToExport[dateKey] = meals;
                            }
                        });
                    }
                    break;
            }
            
            return dataToExport;
        }

        async function startExport() {
            console.log('üöÄ EXPORT_DEBUG: ===== STARTING EXPORT PROCESS =====');
            console.log('üöÄ EXPORT_DEBUG: Export button clicked at:', new Date().toISOString());
            
            const exportButton = document.getElementById('exportButton');
            const exportProgress = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            
            console.log('üîç EXPORT_DEBUG: DOM elements found:', {
                exportButton: !!exportButton,
                exportProgress: !!exportProgress,
                progressText: !!progressText
            });
            
            try {
                console.log('üîÑ EXPORT_DEBUG: Step 1 - Disabling button and showing progress');
                // Disable button and show progress
                exportButton.disabled = true;
                exportProgress.classList.remove('hidden');
                progressText.textContent = 'Preparing data...';
                console.log('‚úÖ EXPORT_DEBUG: UI updated - button disabled, progress shown');
                
                console.log('üîÑ EXPORT_DEBUG: Step 2 - Getting export range selection');
                // Get export data
                const selectedRangeElement = document.querySelector('input[name="exportRange"]:checked');
                console.log('üîç EXPORT_DEBUG: Selected range element:', selectedRangeElement);
                
                if (!selectedRangeElement) {
                    throw new Error('No export range selected');
                }
                
                const selectedRange = selectedRangeElement.value;
                console.log('üìä EXPORT_DEBUG: Selected range:', selectedRange);
                
                console.log('üîÑ EXPORT_DEBUG: Step 3 - Getting export data from localStorage');
                console.log('üìä EXPORT_DEBUG: Current mealsByDate keys:', Object.keys(mealsByDate || {}));
                console.log('üìä EXPORT_DEBUG: Total meals in storage:', Object.values(mealsByDate || {}).reduce((total, meals) => total + (meals?.length || 0), 0));
                
                const dataToExport = getExportData(selectedRange);
                console.log('üìä EXPORT_DEBUG: Export data retrieved:', {
                    selectedRange: selectedRange,
                    totalDates: Object.keys(dataToExport).length,
                    totalMeals: Object.values(dataToExport).reduce((total, meals) => total + (meals?.length || 0), 0),
                    dateKeys: Object.keys(dataToExport),
                    sampleData: Object.keys(dataToExport).length > 0 ? {
                        firstDate: Object.keys(dataToExport)[0],
                        firstDateMealCount: dataToExport[Object.keys(dataToExport)[0]]?.length || 0
                    } : null
                });
                
                if (Object.keys(dataToExport).length === 0) {
                    console.error('‚ùå EXPORT_DEBUG: No data found for export');
                    throw new Error('No data found for the selected date range');
                }
                
                console.log('üîÑ EXPORT_DEBUG: Step 4 - Preparing filename');
                // Get filename
                let filename = document.getElementById('exportFilename').value.trim();
                console.log('üìù EXPORT_DEBUG: User filename input:', filename);
                
                if (!filename) {
                    const today = new Date();
                    const yearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    filename = `${yearMonth}.xlsx`;
                    console.log('üìù EXPORT_DEBUG: Generated filename:', filename);
                }
                
                // Ensure .xlsx extension
                if (!filename.toLowerCase().endsWith('.xlsx')) {
                    filename += '.xlsx';
                    console.log('üìù EXPORT_DEBUG: Added .xlsx extension:', filename);
                }
                
                console.log('üîÑ EXPORT_DEBUG: Step 5 - Preparing request data');
                progressText.textContent = 'Sending data to server...';
                
                // Prepare request data
                const requestData = {
                    mealsByDate: dataToExport,
                    startDate: selectedRange === 'custom' ? document.getElementById('exportStartDate').value : null,
                    endDate: selectedRange === 'custom' ? document.getElementById('exportEndDate').value : null,
                    filename: filename
                };
                
                console.log('üì§ EXPORT_DEBUG: Request data prepared:', {
                    totalDates: Object.keys(dataToExport).length,
                    totalMeals: Object.values(dataToExport).reduce((total, meals) => total + meals.length, 0),
                    filename: filename,
                    startDate: requestData.startDate,
                    endDate: requestData.endDate,
                    payloadSize: JSON.stringify(requestData).length
                });
                
                progressText.textContent = 'Generating Excel file...';
                
                console.log('üîÑ EXPORT_DEBUG: Step 6 - Making API request to server');
                console.log('üåê EXPORT_DEBUG: Sending POST request to /api/export-excel');
                console.log('üåê EXPORT_DEBUG: Request headers: Content-Type: application/json');
                console.log('üåê EXPORT_DEBUG: Request body size:', JSON.stringify(requestData).length, 'characters');
                
                // Make request to server
                const fetchStartTime = performance.now();
                const response = await fetch('/api/export-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                const fetchEndTime = performance.now();
                
                console.log('üì° EXPORT_DEBUG: Server response received in', (fetchEndTime - fetchStartTime).toFixed(2), 'ms');
                console.log('üì° EXPORT_DEBUG: Response details:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    contentType: response.headers.get('content-type'),
                    contentLength: response.headers.get('content-length'),
                    contentDisposition: response.headers.get('content-disposition')
                });
                
                if (!response.ok) {
                    console.error('‚ùå EXPORT_DEBUG: Server returned error status:', response.status);
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.error('üìÑ EXPORT_DEBUG: Error response data:', errorData);
                    } catch (parseError) {
                        console.error('üìÑ EXPORT_DEBUG: Could not parse error response as JSON:', parseError);
                        const errorText = await response.text();
                        console.error('üìÑ EXPORT_DEBUG: Raw error response:', errorText.substring(0, 500));
                        throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 200)}`);
                    }
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                console.log('üîÑ EXPORT_DEBUG: Step 7 - Processing server response');
                progressText.textContent = 'Processing server response...';
                
                // Handle JSON response from new trackers folder system
                const responseStartTime = performance.now();
                const result = await response.json();
                const responseEndTime = performance.now();
                
                console.log('üìÑ EXPORT_DEBUG: JSON response parsed in', (responseEndTime - responseStartTime).toFixed(2), 'ms');
                console.log('üìÑ EXPORT_DEBUG: Server response:', {
                    success: result.success,
                    message: result.message,
                    filePath: result.filePath,
                    fileSize: result.fileSize,
                    isNewFile: result.isNewFile,
                    appendedData: result.appendedData
                });
                
                if (!result.success) {
                    console.error('‚ùå EXPORT_DEBUG: Server reported export failure');
                    throw new Error(result.message || 'Export failed on server');
                }
                
                console.log('üéâ EXPORT_DEBUG: ===== EXPORT COMPLETED SUCCESSFULLY =====');
                console.log('‚úÖ EXPORT_DEBUG: Final summary:', {
                    filename: result.filePath ? result.filePath.split('/').pop() : filename,
                    fileSize: result.fileSize,
                    fileSizeKB: result.fileSize ? (result.fileSize / 1024).toFixed(2) + ' KB' : 'Unknown',
                    totalDates: Object.keys(dataToExport).length,
                    totalMeals: Object.values(dataToExport).reduce((total, meals) => total + meals.length, 0),
                    savedToTrackers: true,
                    isNewFile: result.isNewFile,
                    appendedData: result.appendedData,
                    timestamp: new Date().toISOString()
                });
                
                // Create success message based on whether file was new or appended
                let successMessage;
                if (result.isNewFile) {
                    successMessage = `üìä New Excel file created: "${result.filePath.split('/').pop()}"`;
                } else {
                    successMessage = `üìä Data appended to existing file: "${result.filePath.split('/').pop()}"`;
                }
                
                if (result.fileSize) {
                    successMessage += ` (${(result.fileSize / 1024).toFixed(1)} KB)`;
                }
                
                showSuccessMessage(successMessage);
                
                // Show success status for direct export with file location info
                const statusDetails = `File saved to: ${result.filePath}${result.appendedData ? ' (data appended)' : ' (new file)'}`;
                showExportStatus('success', 'Export Complete!', statusDetails);
                
                // Close modal after successful export
                setTimeout(() => {
                    closeExportModal();
                }, 1500);
                
            } catch (error) {
                console.error('üí• EXPORT_DEBUG: ===== EXPORT FAILED =====');
                console.error('‚ùå EXPORT_DEBUG: Error details:', {
                    errorMessage: error.message,
                    errorStack: error.stack,
                    errorName: error.name,
                    errorType: typeof error,
                    timestamp: new Date().toISOString()
                });
                
                // Log current state for debugging
                console.error('üîç EXPORT_DEBUG: Current state when error occurred:', {
                    mealsByDateExists: !!mealsByDate,
                    mealsByDateKeys: Object.keys(mealsByDate || {}),
                    totalMealsInStorage: Object.values(mealsByDate || {}).reduce((total, meals) => total + (meals?.length || 0), 0),
                    selectedDate: selectedDate?.toISOString?.() || 'Invalid date',
                    currentURL: window.location.href,
                    userAgent: navigator.userAgent
                });
                
                showErrorMessage('Export failed: ' + error.message);
                
                // Show error status for direct export
                showExportStatus('error', 'Export Failed', error.message || 'An unexpected error occurred');
                
                // Re-enable button and hide progress
                exportButton.disabled = false;
                exportProgress.classList.add('hidden');
                
                console.error('üí• EXPORT_DEBUG: ===== END ERROR REPORT =====');
            }
        }

        // ========================================
        // DIRECT EXPORT FUNCTIONS
        // ========================================
        
        // Direct export function - no modal required
        function startDirectExport() {
            console.log('üöÄ EXPORT_DIRECT: Starting direct export...');
            showExportStatus('loading', 'Preparing Export...', 'Gathering your food diary data');
            
            // Set up default export parameters for direct export
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Create a temporary form state for direct export
            const tempModal = document.createElement('div');
            tempModal.innerHTML = `
                <input type="radio" name="exportRange" value="all" checked>
                <input type="date" id="exportStartDate" value="${formatDateKey(firstOfMonth)}">
                <input type="date" id="exportEndDate" value="${formatDateKey(today)}">
                <input type="text" id="exportFilename" value="">
                <div id="exportProgress" class="hidden">
                    <div id="exportProgressText">Preparing...</div>
                </div>
                <button id="exportButton" disabled="false">Export</button>
            `;
            
            // Temporarily add to DOM for startExport to find elements
            tempModal.style.display = 'none';
            document.body.appendChild(tempModal);
            
            // Use the existing startExport function with our temporary elements
            try {
                startExport().finally(() => {
                    // Clean up temporary elements
                    document.body.removeChild(tempModal);
                });
            } catch (error) {
                console.error('‚ùå EXPORT_DIRECT: Direct export failed:', error);
                showExportStatus('error', 'Export Failed', error.message || 'An unexpected error occurred');
                // Clean up on error too
                if (document.body.contains(tempModal)) {
                    document.body.removeChild(tempModal);
                }
            }
        }
        
        // Show export status to user
        function showExportStatus(type, message, details = '') {
            const statusDisplay = document.getElementById('exportStatusDisplay');
            const statusContent = document.getElementById('exportStatusContent');
            const statusIcon = document.getElementById('exportStatusIcon');
            const statusMessage = document.getElementById('exportStatusMessage');
            const statusDetails = document.getElementById('exportStatusDetails');
            
            // Show the status display
            statusDisplay.classList.remove('hidden');
            
            // Configure based on status type
            switch (type) {
                case 'loading':
                    statusContent.className = 'p-4 rounded-lg border border-blue-200 bg-blue-50 text-blue-800 text-center';
                    statusIcon.textContent = '‚è≥';
                    break;
                case 'success':
                    statusContent.className = 'p-4 rounded-lg border border-green-200 bg-green-50 text-green-800 text-center';
                    statusIcon.textContent = '‚úÖ';
                    // Auto-hide success message after 5 seconds
                    setTimeout(() => hideExportStatus(), 5000);
                    break;
                case 'error':
                    statusContent.className = 'p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-center';
                    statusIcon.textContent = '‚ùå';
                    // Auto-hide error message after 10 seconds
                    setTimeout(() => hideExportStatus(), 10000);
                    break;
            }
            
            statusMessage.textContent = message;
            statusDetails.textContent = details;
        }
        
        // Hide export status
        function hideExportStatus() {
            const statusDisplay = document.getElementById('exportStatusDisplay');
            statusDisplay.classList.add('hidden');
        }

        // ========================================
        // JSON EXPORT/IMPORT FUNCTIONS
        // ========================================

        // Auto-sync meals to server (runs on page load)
        // Load meals from server on startup
        async function loadMealsFromServer() {
            try {
                console.log('üìÇ LOAD_MEALS: Loading meals from server...');
                
                // First, get local meals from localStorage
                const localMeals = localStorage.getItem('indianFoodMealsByDate') ? JSON.parse(localStorage.getItem('indianFoodMealsByDate')) : {};
                console.log('üìÇ LOAD_MEALS: Local meals loaded:', { dates: Object.keys(localMeals).length });
                
                const response = await fetch('/api/load-meals');
                if (response.ok) {
                    const result = await response.json();
                    const serverMeals = result.meals || {};
                    const totalServerMeals = Object.values(serverMeals).reduce((sum, meals) => sum + (meals?.length || 0), 0);
                    
                    console.log('üìÇ LOAD_MEALS: Server meals loaded:', { totalMeals: totalServerMeals, dates: Object.keys(serverMeals).length });
                    
                    // Intelligent merge: combine local and server meals for each date
                    const mergedMeals = { ...localMeals };
                    
                    Object.entries(serverMeals).forEach(([date, serverDayMeals]) => {
                        if (!mergedMeals[date]) {
                            // Date doesn't exist locally, use server meals
                            mergedMeals[date] = serverDayMeals;
                        } else {
                            // Date exists locally, merge arrays and deduplicate by meal ID
                            const localDayMeals = mergedMeals[date];
                            const mealIds = new Set(localDayMeals.map(m => m.id));
                            
                            serverDayMeals.forEach(meal => {
                                if (!mealIds.has(meal.id)) {
                                    // Server has a meal that local doesn't have, add it
                                    localDayMeals.push(meal);
                                }
                            });
                            mergedMeals[date] = localDayMeals;
                        }
                    });
                    
                    mealsByDate = mergedMeals;
                    localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));
                    
                    const totalMerged = Object.values(mealsByDate).reduce((sum, meals) => sum + (meals?.length || 0), 0);
                    console.log('‚úÖ LOAD_MEALS: Merge complete:', { totalMeals: totalMerged, dates: Object.keys(mealsByDate).length });
                } else {
                    console.log('‚ö†Ô∏è LOAD_MEALS: Server returned error, using local storage only');
                    mealsByDate = localMeals;
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è LOAD_MEALS: Server not available, using local storage only:', error.message);
                const localMeals = localStorage.getItem('indianFoodMealsByDate') ? JSON.parse(localStorage.getItem('indianFoodMealsByDate')) : {};
                mealsByDate = localMeals;
            }
        }
        
        // Save meals to server whenever they change
        async function saveMealsToServer(reason = 'update') {
            try {
                const totalMeals = Object.values(mealsByDate || {}).reduce((sum, meals) => sum + (meals?.length || 0), 0);
                
                // Always save, even if empty (to sync deletions)
                console.log('üíæ SAVE_MEALS: Saving meals to server (' + reason + ')...');
                
                const response = await fetch('/api/save-meals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mealsByDate: mealsByDate
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ SAVE_MEALS: Successfully saved to server:', { totalMeals, reason });
                } else {
                    const error = await response.json();
                    console.warn('‚ö†Ô∏è SAVE_MEALS: Server returned error:', error);
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è SAVE_MEALS: Server not available, meals saved to browser only:', error.message);
            }
        }
        
        async function autoSyncMealsToServer() {
            // This is called on page load to sync with server
            await loadMealsFromServer();
        }

        // Quick export - directly download JSON without modal
        async function quickExportJson() {
            try {
                const filename = `food-diary-${new Date().toISOString().split('T')[0]}.json`;
                
                const exportData = {
                    metadata: {
                        exportedAt: new Date().toISOString(),
                        version: '1.0',
                        appName: 'Food Diary',
                        format: 'json',
                        totalDays: Object.keys(mealsByDate).length,
                        totalMeals: Object.values(mealsByDate).reduce((sum, meals) => sum + (meals?.length || 0), 0)
                    },
                    meals: mealsByDate
                };
                
                // Create and download file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Also auto-save to tracker_json folder on server
                try {
                    const autoExportResponse = await fetch('/api/auto-export-json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mealsByDate
                        })
                    });
                    
                    if (autoExportResponse.ok) {
                        const autoExportResult = await autoExportResponse.json();
                        console.log(`‚úÖ JSON export completed: ${exportData.metadata.totalMeals} meals exported and auto-saved to tracker_json/${autoExportResult.filename}`);
                    } else {
                        console.log(`‚úÖ JSON export completed: ${exportData.metadata.totalMeals} meals exported to ${filename}`);
                    }
                } catch (error) {
                    console.log(`‚úÖ JSON export completed: ${exportData.metadata.totalMeals} meals exported to ${filename}`);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to export JSON:', error.message);
            }
        }

        function openJsonExportModal() {
            document.getElementById('jsonExportModal').classList.add('active');
            updateJsonExportPreview();
            
            // Add event listeners for radio buttons
            document.querySelectorAll('input[name="jsonExportRange"]').forEach(input => {
                input.addEventListener('change', () => {
                    const customRange = document.getElementById('jsonCustomDateRange');
                    if (input.value === 'custom') {
                        customRange.classList.remove('hidden');
                    } else {
                        customRange.classList.add('hidden');
                    }
                    updateJsonExportPreview();
                });
            });
        }

        function closeJsonExportModal() {
            document.getElementById('jsonExportModal').classList.remove('active');
        }

        function updateJsonExportPreview() {
            const selectedRange = document.querySelector('input[name="jsonExportRange"]:checked')?.value;
            const totalDays = Object.keys(mealsByDate || {}).length;
            const totalMeals = Object.values(mealsByDate || {}).reduce((sum, meals) => sum + (meals?.length || 0), 0);
            
            let preview = `Total: ${totalDays} days, ${totalMeals} meals`;
            
            if (selectedRange === 'month') {
                const today = new Date();
                const monthStart = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
                const monthEnd = today.toISOString().split('T')[0];
                preview += ` (${monthStart} to ${monthEnd})`;
            }
            
            document.getElementById('jsonExportPreview').textContent = preview;
        }

        async function exportMealsAsJson() {
            try {
                const selectedRange = document.querySelector('input[name="jsonExportRange"]:checked').value;
                let startDate = null;
                let endDate = null;
                
                if (selectedRange === 'month') {
                    const today = new Date();
                    startDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;
                    endDate = today.toISOString().split('T')[0];
                } else if (selectedRange === 'custom') {
                    startDate = document.getElementById('jsonExportStartDate').value;
                    endDate = document.getElementById('jsonExportEndDate').value;
                    if (!startDate || !endDate) {
                        alert('Please select both start and end dates');
                        return;
                    }
                }
                
                const filename = `food-diary-${new Date().toISOString().split('T')[0]}.json`;
                
                const response = await fetch('/api/export-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mealsByDate,
                        startDate,
                        endDate,
                        filename
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                // Download the JSON file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Also auto-save to tracker_json folder on server
                try {
                    const autoExportResponse = await fetch('/api/auto-export-json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mealsByDate,
                            startDate,
                            endDate
                        })
                    });
                    
                    if (autoExportResponse.ok) {
                        const autoExportResult = await autoExportResponse.json();
                        console.log(`‚úÖ JSON export downloaded and auto-saved to tracker_json/${autoExportResult.filename}`);
                    } else {
                        console.warn('‚ö†Ô∏è Auto-save to tracker_json failed, but file was downloaded');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not auto-save to tracker_json folder:', error.message);
                }
                
                closeJsonExportModal();
                
            } catch (error) {
                console.error('‚ùå Failed to export JSON:', error.message);

            }
        }

        function openJsonImportModal() {
            document.getElementById('jsonImportModal').classList.add('active');

            // Ensure we attach a single change handler (avoid duplicate listeners on repeated opens)
            const fileInput = document.getElementById('jsonImportFile');
            fileInput.value = '';
            fileInput.onchange = null;
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        const importedMeals = data.meals || {};
                        const totalDays = Object.keys(importedMeals).length;
                        const totalMeals = Object.values(importedMeals).reduce((sum, meals) => sum + (meals?.length || 0), 0);

                        document.getElementById('jsonImportPreview').innerHTML = `\
                            ‚úÖ File loaded: ${totalDays} days, ${totalMeals} meals<br>\
                            <small>Exported: ${data.metadata?.exportedAt || 'Unknown'}</small>\
                        `;
                    } catch (error) {
                        document.getElementById('jsonImportPreview').textContent = '‚ùå Invalid JSON file';
                    }
                };
                reader.readAsText(file);
            };
        }

        function closeJsonImportModal() {
            document.getElementById('jsonImportModal').classList.remove('active');
            document.getElementById('jsonImportFile').value = '';
        }

        async function importMealsFromJson() {
            try {
                const file = document.getElementById('jsonImportFile').files[0];
                if (!file) {
                    alert('Please select a file');
                    return;
                }

                const fileContent = await file.text();
                const data = JSON.parse(fileContent);
                const importedMeals = data.meals || {};

                const mergeStrategy = document.querySelector('input[name="mergeStrategy"]:checked').value;

                // Attempt to send to server, but if server is not available, fall back to local merge
                let serverResult = null;
                let serverOk = false;
                try {
                    const response = await fetch('/api/import-json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            meals: importedMeals,
                            mergeStrategy
                        })
                    });

                    serverResult = await response.json().catch(() => null);
                    serverOk = response.ok;

                    if (!response.ok) {
                        console.error('‚ùå Server import error:', serverResult?.error || 'Unknown');
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Could not reach import endpoint:', err.message);
                }

                // Always merge locally so host without server still loads imported logs
                if (mergeStrategy === 'replace') {
                    mealsByDate = importedMeals;
                } else {
                    Object.entries(importedMeals).forEach(([date, meals]) => {
                        if (!mealsByDate[date]) {
                            mealsByDate[date] = [];
                        }
                        if (mergeStrategy === 'merge') {
                            meals.forEach(meal => {
                                if (!mealsByDate[date].some(m => m.id === meal.id)) {
                                    mealsByDate[date].push(meal);
                                }
                            });
                        } else {
                            // merge-duplicates
                            meals.forEach(meal => {
                                const existingIndex = mealsByDate[date].findIndex(m => m.id === meal.id);
                                if (existingIndex === -1) {
                                    mealsByDate[date].push(meal);
                                } else {
                                    mealsByDate[date][existingIndex] = meal;
                                }
                            });
                        }
                    });
                }

                localStorage.setItem('indianFoodMealsByDate', JSON.stringify(mealsByDate));

                // Inform user of outcome
                if (serverOk) {
                    console.log(`‚úÖ Successfully imported ${serverResult?.importedCount ?? 'N/A'} meals (server)`);
                    alert(`Import completed on server: ${serverResult?.importedCount ?? 0} meals imported.`);
                } else {
                    console.warn('‚ö†Ô∏è Server import failed or not available; data merged locally only');
                    alert('Warning: import merged locally only (server unavailable). Your data is saved in this browser.');
                }

                updateDateDisplay();
                closeJsonImportModal();

            } catch (error) {
                console.error('‚ùå Failed to import JSON:', error.message);
                alert('Failed to import JSON: ' + (error.message || 'Unknown error'));
            }
        }

        // ========================================
        // EXPORT BUTTON DIAGNOSTIC FUNCTIONS
        // ========================================
        
        // Add diagnostic function to test export button functionality
        function testExportButton() {
            console.log('üß™ EXPORT_TEST: ===== TESTING EXPORT BUTTON FUNCTIONALITY =====');
            console.log('üß™ EXPORT_TEST: Test initiated at:', new Date().toISOString());
            
            // Test 1: Check if modal is open and accessible
            const modal = document.getElementById('exportModal');
            const isModalVisible = modal && modal.classList.contains('active');
            const modalDisplay = modal ? window.getComputedStyle(modal).display : 'not found';
            console.log('üìã EXPORT_TEST: Modal state:', {
                exists: !!modal,
                hasActiveClass: modal ? modal.classList.contains('active') : false,
                computedDisplay: modalDisplay,
                isVisible: isModalVisible
            });
            
            // Test 2: Check if button exists and is clickable
            const button = document.getElementById('exportButton');
            const buttonExists = !!button;
            const buttonVisible = button ? window.getComputedStyle(button).display !== 'none' : false;
            const buttonDisabled = button ? button.disabled : true;
            console.log('üîò EXPORT_TEST: Button state:', {
                exists: buttonExists,
                visible: buttonVisible,
                disabled: buttonDisabled,
                hasOnClick: button ? !!button.onclick || button.hasAttribute('onclick') : false,
                onClickValue: button ? button.getAttribute('onclick') : null
            });
            
            // Test 3: Check server connectivity
            console.log('üåê EXPORT_TEST: Testing server connectivity...');
            fetch('/api/export-excel', { method: 'HEAD' })
                .then(response => {
                    console.log('üåê EXPORT_TEST: Server response:', {
                        ok: response.ok,
                        status: response.status,
                        statusText: response.statusText
                    });
                })
                .catch(error => {
                    console.log('‚ùå EXPORT_TEST: Server connection failed:', {
                        error: error.message,
                        type: error.name
                    });
                });
            
            // Test 4: Check for meal data availability
            const hasMealData = mealsByDate && Object.keys(mealsByDate).length > 0;
            const totalMeals = hasMealData ? Object.values(mealsByDate).reduce((total, meals) => total + meals.length, 0) : 0;
            console.log('üìä EXPORT_TEST: Data availability:', {
                mealsByDateExists: !!mealsByDate,
                totalDates: hasMealData ? Object.keys(mealsByDate).length : 0,
                totalMeals: totalMeals,
                hasExportableData: hasMealData && totalMeals > 0
            });
            
            // Test 5: Check DOM elements required by startExport()
            const exportProgress = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            console.log('üîß EXPORT_TEST: Required DOM elements:', {
                exportProgress: !!exportProgress,
                progressText: !!progressText,
                allElementsPresent: !!exportProgress && !!progressText
            });
            
            // Test 6: Try to manually trigger the function
            console.log('üß™ EXPORT_TEST: Testing manual function call...');
            try {
                if (typeof startExport === 'function') {
                    console.log('‚úÖ EXPORT_TEST: startExport function exists and is callable');
                    // Don't actually call it, just verify it exists
                } else {
                    console.log('‚ùå EXPORT_TEST: startExport function not found or not callable');
                }
            } catch (error) {
                console.log('‚ùå EXPORT_TEST: Error testing startExport function:', error.message);
            }
            
            // Test 7: Check for JavaScript errors in console
            console.log('üîç EXPORT_TEST: Check browser console for any JavaScript errors');
            console.log('üîç EXPORT_TEST: Look for errors related to: fetch, DOM manipulation, or async functions');
            
            // Summary
            const diagnosis = {
                modalAccessible: isModalVisible,
                buttonClickable: buttonExists && buttonVisible && !buttonDisabled,
                serverReachable: 'testing...', // Will be updated by fetch result
                dataAvailable: hasMealData && totalMeals > 0,
                domElementsReady: !!exportProgress && !!progressText,
                functionExists: typeof startExport === 'function'
            };
            
            console.log('üìã EXPORT_TEST: DIAGNOSIS SUMMARY:', diagnosis);
            console.log('üß™ EXPORT_TEST: ===== TEST COMPLETED =====');
            
            return diagnosis;
        }
        
        // Add function to open export modal and test button
        function testExportFlow() {
            console.log('üöÄ EXPORT_FLOW_TEST: Testing complete export flow...');
            
            // Step 1: Open the export modal
            console.log('üìÇ EXPORT_FLOW_TEST: Opening export modal...');
            openExportModal();
            
            // Step 2: Wait a moment for modal to open, then test
            setTimeout(() => {
                console.log('üß™ EXPORT_FLOW_TEST: Modal should be open now, testing button...');
                const testResults = testExportButton();
                
                // Step 3: Provide recommendations based on test results
                console.log('üí° EXPORT_FLOW_TEST: RECOMMENDATIONS:');
                if (!testResults.modalAccessible) {
                    console.log('‚ùå ISSUE: Export modal is not accessible - check openExportModal() function');
                }
                if (!testResults.buttonClickable) {
                    console.log('‚ùå ISSUE: Export button is not clickable - check button state and CSS');
                }
                if (!testResults.dataAvailable) {
                    console.log('‚ùå ISSUE: No meal data available for export - add some meals first');
                }
                if (!testResults.domElementsReady) {
                    console.log('‚ùå ISSUE: Required DOM elements missing - check HTML structure');
                }
                if (!testResults.functionExists) {
                    console.log('‚ùå ISSUE: startExport function not found - check JavaScript loading');
                }
                
                console.log('üöÄ EXPORT_FLOW_TEST: Flow test completed');
            }, 500);
        }

        // Export preview event listeners moved to consolidated initialization

        // Unified Modal Functions
        function openUnifiedAddModal(defaultTab = 'quickDishes') {
            document.getElementById('unifiedAddModal').classList.add('active');
            
            // Switch to the specified tab
            if (defaultTab === 'recipe') {
                switchAddTab('recipe');
            } else {
                // Default to quick dishes tab
                switchAddTab('quickDishes');
                // Populate quick dishes in modal
                populateQuickDishesInModal();
            }
        }

        function closeUnifiedAddModal() {
            document.getElementById('unifiedAddModal').classList.remove('active');
            // Clear any form data
            clearModalForms();
        }

        function openUnifiedLogModal() {
            document.getElementById('unifiedLogModal').classList.add('active');
            // Default to today's meals tab
            switchLogTab('todaysMeals');
            // Update modal content
            updateModalContent();
        }

        function closeUnifiedLogModal() {
            document.getElementById('unifiedLogModal').classList.remove('active');
        }

        // Tab switching functions
        function switchAddTab(tabName) {
            console.log('üîÑ TAB: Switching to tab:', tabName);
            
            // Hide all tab contents
            const contents = document.querySelectorAll('.add-tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('.add-tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-orange-500', 'text-orange-600');
            
            // Handle specific tab initialization
            if (tabName === 'addIngredient') {
                console.log('ü•¨ TAB: Enhanced Add Ingredient tab opened');
                // Ensure ingredients are loaded for the enhanced functionality
                if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                    console.log('üîÑ TAB: Loading ingredients for enhanced ingredient tab...');
                    showSuccessMessage('üîÑ Loading ingredient database...');
                    
                    loadDatabases().then(() => {
                        console.log('‚úÖ TAB: Ingredients loaded for enhanced tab');
                        showSuccessMessage('‚úÖ Enhanced ingredient selection ready! Search for ingredients with real nutrition data.');
                        // Focus on the search input
                        setTimeout(() => {
                            const searchInput = document.getElementById('enhancedIngredientSearch');
                            if (searchInput) {
                                searchInput.focus();
                            }
                        }, 100);
                    }).catch(error => {
                        console.error('‚ùå TAB: Failed to load ingredients:', error);
                        showErrorMessage('Failed to load ingredients: ' + error.message);
                    });
                } else {
                    console.log('‚úÖ TAB: Ingredients already loaded');
                    showSuccessMessage('‚úÖ Enhanced ingredient selection ready! Search from our ingredient database.');
                    // Focus on the search input for immediate use
                    setTimeout(() => {
                        const searchInput = document.getElementById('enhancedIngredientSearch');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 100);
                }
            }
            // If switching to meal builder tab, ensure ingredients are loaded
            else if (tabName === 'mealBuilder') {
                console.log('üîÑ TAB: Meal builder tab opened, checking ingredients...');
                console.log('üîÑ TAB: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
                
                // Always ensure ingredients are loaded for meal builder
                if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                    console.log('‚ö†Ô∏è TAB: Ingredients not loaded, loading now...');
                    showSuccessMessage('üîÑ Loading ingredients for meal builder...');
                    
                    loadDatabases().then(() => {
                        console.log('‚úÖ TAB: Ingredients loaded successfully');
                        console.log('üìä TAB: Available categories:', rawIngredients ? Object.keys(rawIngredients) : 'NONE');
                        
                        // Verify specific ingredients for testing
                        if (rawIngredients && rawIngredients.vegetables && rawIngredients.vegetables.lauki) {
                            console.log('‚úÖ TAB: Test ingredient "Lauki" found:', rawIngredients.vegetables.lauki.name);
                        }
                        
                        showSuccessMessage('‚úÖ Ingredients loaded! You can now search for ingredients like "Egg", "Rice", etc.');
                    }).catch(error => {
                        console.error('‚ùå TAB: Failed to load ingredients:', error);
                        showErrorMessage('Failed to load ingredients: ' + error.message);
                    });
                } else {
                    console.log('‚úÖ TAB: Ingredients already loaded');
                    console.log('üìä TAB: Available categories:', Object.keys(rawIngredients));
                    
                    // Show helpful message to user
                    showSuccessMessage('‚úÖ Meal builder ready! Search for ingredients to get started.');
                }
                
            } else if (tabName === 'manageIngredients') {
                console.log('ü•¨ TAB: Manage Ingredients tab opened');
                showSuccessMessage('‚úÖ Ingredients management ready!');
            }
        }

        function switchLogTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.log-tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active state from all tabs
            const tabs = document.querySelectorAll('.log-tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('border-orange-500', 'text-orange-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-orange-500', 'text-orange-600');
            
            // Update content based on tab
            if (tabName === 'todaysMeals') {
                updateModalFoodLog();
            } else if (tabName === 'dailySummary') {
                updateModalDailySummary();
            }
        }

        // Populate quick dishes in modal
        function populateQuickDishesInModal() {
            console.log('üçΩÔ∏è MODAL_DISHES: populateQuickDishesInModal() called');
            const container = document.getElementById('quickDishesInModal');
            console.log('üçΩÔ∏è MODAL_DISHES: quickDishesInModal element:', container ? 'EXISTS' : 'NULL');
            
            if (!container) {
                console.log('‚ö†Ô∏è MODAL_DISHES: quickDishesInModal not found - skipping population');
                return;
            }
            
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            
            container.innerHTML = Object.entries(allDishes).map(([key, dish]) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-200">
                    <div>
                        <div class="font-medium text-gray-800">${dish.name}</div>
                        <div class="text-sm text-gray-600">${dish.total_per_serving.calories} cal/serving ‚Ä¢ ${dish.category}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${customRecipes[key] ? `<button onclick="editRecipe('${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>` : ''}
                        <input type="number" value="1" min="0.5" step="0.5" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm" id="modal_servings_${key}">
                        <button onclick="addQuickDishFromModal('${key}')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Add
                        </button>
                        ${customRecipes[key] ? `<button onclick="deleteRecipe('${key}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">&times;</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            console.log('‚úÖ MODAL_DISHES: Quick dishes populated successfully');
        }

        // Modal-specific functions
        function addQuickDishFromModal(dishKey) {
            const servings = parseFloat(document.getElementById(`modal_servings_${dishKey}`).value);
            const allDishes = {...foodDatabase.dishes, ...customRecipes};
            const dish = allDishes[dishKey];
            
            if (!dish) return;
            
            // Get selected meal type from the modal
            const selectedMealType = getSelectedMealType();
            
            const nutrition = dish.total_per_serving;
            const meal = {
                id: Date.now(),
                description: `${dish.name} (${servings} serving${servings !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(nutrition.calories * servings),
                    protein: Math.round(nutrition.protein * servings * 10) / 10,
                    carbs: Math.round(nutrition.carbs * servings * 10) / 10,
                    fat: Math.round(nutrition.fat * servings * 10) / 10,
                    fiber: Math.round(nutrition.fiber * servings * 10) / 10
                },
                source: 'database',
                mealType: selectedMealType // Use selected meal type from modal
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_added');
            updateModalContent(); // Update modal content too
            
            // Reset serving size
            document.getElementById(`modal_servings_${dishKey}`).value = 1;
            
            showSuccessMessage(`Added ${dish.name} to ${selectedMealType}!`);
        }

        function addCustomEntryFromModal() {
            const description = document.getElementById('modalCustomDish').value.trim();
            const mealType = document.getElementById('modalCustomMealType').value;
            const servings = parseFloat(document.getElementById('modalCustomServings').value);
            const caloriesPerServing = parseInt(document.getElementById('modalCustomCalories').value);
            
            if (!description) {
                alert('Please enter a dish description');
                return;
            }

            if (!caloriesPerServing || caloriesPerServing <= 0) {
                alert('Please enter the calories per serving');
                return;
            }
            
            const totalCalories = Math.round(caloriesPerServing * servings);
            
            const meal = {
                id: Date.now(),
                description: description,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: totalCalories,
                    protein: Math.round(totalCalories * 0.15 / 4), // Rough estimate
                    carbs: Math.round(totalCalories * 0.55 / 4),
                    fat: Math.round(totalCalories * 0.30 / 9),
                    fiber: Math.round(totalCalories * 0.02)
                },
                source: 'custom',
                mealType: mealType
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            saveMealsToServer('meal_added');
            updateModalContent(); // Update modal content too
            
            // Clear form
            document.getElementById('modalCustomDish').value = '';
            document.getElementById('modalCustomMealType').value = 'Lunch';
            document.getElementById('modalCustomServings').value = 1;
            document.getElementById('modalCustomCalories').value = '';
            
            showSuccessMessage(`Added custom entry to ${mealType}!`);
        }

        // Functions to open existing modals from unified modal
        function openRecipeBuilderFromModal() {
            closeUnifiedAddModal();
            openRecipeBuilder();
        }

        function openMealBuilderFromModal() {
            closeUnifiedAddModal();
            openMealBuilder();
        }

        function openIngredientModalFromModal() {
            closeUnifiedAddModal();
            openIngredientModal();
        }

        function reloadIngredientsFromModal() {
            console.log('üîÑ MODAL_RELOAD: reloadIngredientsFromModal() called');
            console.log('üîÑ MODAL_RELOAD: This function should only reload the database, not update UI elements');
            
            // Only reload the database without trying to update UI elements that don't exist in this context
            console.log('üîÑ MODAL_RELOAD: Reloading database only...');
            showSuccessMessage('üîÑ Reloading ingredients database...');
            
            loadDatabases().then(() => {
                console.log('‚úÖ MODAL_RELOAD: Database reload completed successfully');
                showSuccessMessage('‚úÖ Ingredients database reloaded successfully!');
                // Update any UI elements that exist in the current modal context
                const quickDishesContainer = document.getElementById('quickDishesInModal');
                if (quickDishesContainer) {
                    populateQuickDishesInModal();
                } else {
                    console.log('‚ö†Ô∏è MODAL_RELOAD: quickDishesInModal not found, skipping UI update');
                }
            }).catch(error => {
                console.error('‚ùå MODAL_RELOAD: Database reload failed:', error);
                showErrorMessage('Error reloading ingredients database: ' + error.message);
            });
        }

        function reloadIngredientsInModal() {
            console.log('üîÑ MODAL_RELOAD: reloadIngredientsInModal() called');
            console.log('üîÑ MODAL_RELOAD: This function reloads ingredients specifically for the recipe builder modal');
            
            // Show loading feedback
            showSuccessMessage('üîÑ Reloading ingredients for recipe builder...');
            
            // Force reload of ingredients database
            rawIngredients = null;
            foodDatabase = null;
            
            loadDatabases().then(() => {
                console.log('‚úÖ MODAL_RELOAD: Ingredients reloaded successfully for recipe builder');
                
                // Update the recipe ingredient select dropdown if it exists
                const recipeIngredientSelect = document.getElementById('recipeIngredientSelect');
                if (recipeIngredientSelect) {
                    populateIngredientSelect();
                    console.log('‚úÖ MODAL_RELOAD: Recipe ingredient select updated');
                } else {
                    console.log('‚ö†Ô∏è MODAL_RELOAD: recipeIngredientSelect not found');
                }
                
                // Update any other ingredient-related UI elements in the modal
                const quickDishesContainer = document.getElementById('quickDishesInModal');
                if (quickDishesContainer) {
                    populateQuickDishesInModal();
                    console.log('‚úÖ MODAL_RELOAD: Quick dishes updated');
                }
                
                showSuccessMessage('‚úÖ Ingredients reloaded successfully for recipe builder!');
                
            }).catch(error => {
                console.error('‚ùå MODAL_RELOAD: Failed to reload ingredients for recipe builder:', error);
                showErrorMessage('Error reloading ingredients: ' + error.message);
            });
        }

        function openExportModalFromModal() {
            closeUnifiedLogModal();
            openExportModal();
        }

        // Update modal content
        function updateModalContent() {
            updateModalFoodLog();
            updateModalDailySummary();
        }

        function updateModalFoodLog() {
            const modalFoodLog = document.getElementById('modalFoodLog');
            const currentMeals = getCurrentDateMeals();
            
            if (currentMeals.length === 0) {
                modalFoodLog.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No meals logged yet. Use the "Add Meal or Ingredient" button to add meals!</p>
                    </div>
                `;
                return;
            }

            const sortedMeals = [...currentMeals].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            modalFoodLog.innerHTML = sortedMeals.map(meal => `
                <div class="border border-gray-200 rounded-lg p-4 fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${meal.description}</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${formatTime(new Date(meal.timestamp))}</span>
                            <button onclick="removeMeal(${meal.id}); updateModalContent();" class="text-red-500 hover:text-red-700 text-sm">&times;</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2 text-sm">
                        <div class="bg-orange-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-orange-600">${meal.nutrition.calories}</div>
                            <div class="text-orange-500 text-xs">Calories</div>
                        </div>
                        <div class="bg-blue-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-blue-600">${meal.nutrition.protein}g</div>
                            <div class="text-blue-500 text-xs">Protein</div>
                        </div>
                        <div class="bg-yellow-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-yellow-600">${meal.nutrition.carbs}g</div>
                            <div class="text-yellow-500 text-xs">Carbs</div>
                        </div>
                        <div class="bg-green-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-green-600">${meal.nutrition.fat}g</div>
                            <div class="text-green-500 text-xs">Fat</div>
                        </div>
                        <div class="bg-purple-50 px-2 py-1 rounded text-center">
                            <div class="font-semibold text-purple-600">${meal.nutrition.fiber}g</div>
                            <div class="text-purple-500 text-xs">Fiber</div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500">
                        Source: ${meal.source === 'database' ? 'Indian Food Database' : meal.source === 'ingredients' ? 'Basic Ingredients' : 'Custom Entry'}
                        ${meal.ingredients ? `
                            <details class="mt-2">
                                <summary class="cursor-pointer text-gray-600 hover:text-gray-800">View ingredients (${meal.ingredients.length})</summary>
                                <div class="mt-1 space-y-1 pl-4">
                                    ${meal.ingredients.map(ing => `
                                        <div class="flex justify-between text-xs">
                                            <span>${ing.name} (${ing.quantity}x ${ing.measurement})</span>
                                            <span class="text-gray-500">${ing.nutrition.calories} cal</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateModalDailySummary() {
            const currentMeals = getCurrentDateMeals();

            const totals = currentMeals.reduce((acc, meal) => {
                acc.calories += meal.nutrition.calories;
                acc.protein += meal.nutrition.protein;
                acc.fiber += meal.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, fiber: 0});

            document.getElementById('modalTotalCalories').textContent = totals.calories;
            document.getElementById('modalMealCount').textContent = currentMeals.length;
            document.getElementById('modalTotalProtein').textContent = Math.round(totals.protein * 10) / 10 + 'g';
            document.getElementById('modalTotalFiber').textContent = Math.round(totals.fiber * 10) / 10 + 'g';
            
            // Update selected date display
            const modalSelectedDate = document.getElementById('modalSelectedDate');
            if (modalSelectedDate) {
                modalSelectedDate.textContent = formatDateDisplay(selectedDate);
            }
        }

        function clearModalForms() {
            // Clear custom entry form
            const customDish = document.getElementById('modalCustomDish');
            const customServings = document.getElementById('modalCustomServings');
            const customCalories = document.getElementById('modalCustomCalories');
            
            if (customDish) customDish.value = '';
            if (customServings) customServings.value = 1;
            if (customCalories) customCalories.value = '';
        }

        // Update populateQuickDishes to also update modal when called
        const originalPopulateQuickDishes = populateQuickDishes;
        populateQuickDishes = function() {
            originalPopulateQuickDishes();
            // Also update modal if it exists
            const modalContainer = document.getElementById('quickDishesInModal');
            if (modalContainer) {
                populateQuickDishesInModal();
            }
        };

        // ========================================
        // SIMPLE INGREDIENT MANAGEMENT FUNCTIONS
        // ========================================
        
        // Global variable to store simple ingredients data
        let simpleIngredientsData = null;
        
        // Simple function to load ingredients from server
        async function simpleLoadIngredients() {
            console.log('üîÑ SIMPLE: Loading ingredients from server...');
            
            try {
                const response = await fetch('/api/ingredients');
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                simpleIngredientsData = data.basic_ingredients;
                
                console.log('‚úÖ SIMPLE: Ingredients loaded successfully');
                console.log('üìä SIMPLE: Categories:', Object.keys(simpleIngredientsData));
                
                return simpleIngredientsData;
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Failed to load ingredients:', error);
                throw error;
            }
        }
        
        // Simple function to display ingredients in the list
        function simpleDisplayIngredients() {
            console.log('üé® SIMPLE: Displaying ingredients...');
            
            const container = document.getElementById('simpleIngredientsList');
            if (!container) {
                console.error('‚ùå SIMPLE: simpleIngredientsList container not found');
                return;
            }
            
            if (!simpleIngredientsData) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No ingredients loaded. Click "Reload" to load ingredients.</div>';
                return;
            }
            
            const filterCategory = document.getElementById('simpleFilterCategory')?.value || '';
            let html = '';
            let totalCount = 0;
            
            Object.entries(simpleIngredientsData).forEach(([category, ingredients]) => {
                if (filterCategory && category !== filterCategory) return;
                
                const categoryName = category.replace(/_/g, ' ').toUpperCase();
                html += `<div class="mb-4">`;
                html += `<h6 class="font-semibold text-gray-700 mb-2 text-sm">${categoryName}</h6>`;
                
                Object.entries(ingredients).forEach(([key, ingredient]) => {
                    const measurementCount = Object.keys(ingredient.measurements).length;
                    totalCount++;
                    
                    html += `
                        <div class="bg-gray-50 p-3 rounded-lg mb-2 border">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-gray-800">${ingredient.name}</div>
                                    <div class="text-sm text-gray-600">${measurementCount} measurement${measurementCount !== 1 ? 's' : ''}</div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="simpleEditIngredient('${category}', '${key}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition duration-200">Edit</button>
                                    <button onclick="simpleDeleteIngredient('${category}', '${key}', '${ingredient.name}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition duration-200">Delete</button>
                                </div>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">View measurements</summary>
                                <div class="mt-1 space-y-1 pl-4">
                                    ${Object.entries(ingredient.measurements).map(([measureKey, nutrition]) => `
                                        <div class="flex justify-between text-xs">
                                            <span>${measureKey.replace(/_/g, ' ')}</span>
                                            <span class="text-gray-500">${nutrition.calories} cal</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            if (totalCount === 0) {
                html = '<div class="text-center text-gray-500 py-4">No ingredients found for the selected category.</div>';
            }
            
            container.innerHTML = html;
            console.log(`‚úÖ SIMPLE: Displayed ${totalCount} ingredients`);
        }
        
        // Simple reload function
        async function simpleReloadIngredients() {
            console.log('üîÑ SIMPLE: Reload requested...');
            
            const container = document.getElementById('simpleIngredientsList');
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-gray-600">Loading ingredients...</span>
                    </div>
                `;
            }
            
            try {
                await simpleLoadIngredients();
                simpleDisplayIngredients();
                
                // Also update the main app's ingredients if needed
                rawIngredients = simpleIngredientsData;
                populateIngredientSelect();
                
                showSuccessMessage('‚úÖ Ingredients reloaded successfully!');
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Reload failed:', error);
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-red-500 mb-2">‚ùå Failed to load ingredients</div>
                            <div class="text-sm text-gray-600">${error.message}</div>
                            <button onclick="simpleReloadIngredients()" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                Retry
                            </button>
                        </div>
                    `;
                }
                showErrorMessage('Failed to reload ingredients: ' + error.message);
            }
        }
        
        // Simple filter function
        function simpleFilterIngredients() {
            simpleDisplayIngredients();
        }
        
        // Simple add/update ingredient function (handles duplicates by updating)
        async function simpleAddIngredient() {
            const name = document.getElementById('simpleIngredientName').value.trim();
            const category = document.getElementById('simpleIngredientCategory').value;
            const measurementKey = document.getElementById('simpleMeasurementKey').value.trim();
            const calories = parseFloat(document.getElementById('simpleCalories').value) || 0;
            const protein = parseFloat(document.getElementById('simpleProtein').value) || 0;
            const carbs = parseFloat(document.getElementById('simpleCarbs').value) || 0;
            const fat = parseFloat(document.getElementById('simpleFat').value) || 0;
            const fiber = parseFloat(document.getElementById('simpleFiber').value) || 0;
            
            if (!name || !category || !measurementKey) {
                alert('Please fill in ingredient name, category, and measurement key');
                return;
            }
            
            const ingredientKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            
            // Ensure we have the latest ingredients loaded
            if (!simpleIngredientsData) {
                try { await simpleLoadIngredients(); } catch (_) {}
            }
            
            const exists = simpleIngredientsData
                && simpleIngredientsData[category]
                && simpleIngredientsData[category][ingredientKey];
            
            // Build base measurement payload from form
            const newMeasurement = {
                [measurementKey]: { calories, protein, carbs, fat, fiber }
            };
            
            try {
                if (!exists) {
                    // Create new ingredient
                    const ingredientData = { name, measurements: newMeasurement };
                    const response = await fetch('/api/ingredients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category, ingredientKey, ingredientData })
                    });
                    let result; try { result = await response.json(); } catch { result = { error: 'Invalid server response' }; }
                    if (response.ok && result && result.success) {
                        showSuccessMessage(`‚úÖ Ingredient "${name}" added successfully!`);
                        simpleClearForm();
                        simpleReloadIngredients();
                    } else {
                        const detail = result && result.error ? result.error : `HTTP ${response.status}`;
                        throw new Error(detail || 'Failed to add ingredient');
                    }
                } else {
                    // Update existing ingredient by merging measurements
                    const existing = simpleIngredientsData[category][ingredientKey];
                    const mergedMeasurements = { ...existing.measurements, ...newMeasurement };
                    const response = await fetch(`/api/ingredients/${category}/${ingredientKey}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ingredientData: { name, measurements: mergedMeasurements } })
                    });
                    let result; try { result = await response.json(); } catch { result = { error: 'Invalid server response' }; }
                    if (response.ok && result && result.success) {
                        showSuccessMessage(`‚úÖ Ingredient "${name}" updated successfully!`);
                        simpleClearForm();
                        simpleReloadIngredients();
                    } else {
                        const detail = result && result.error ? result.error : `HTTP ${response.status}`;
                        throw new Error(detail || 'Failed to update ingredient');
                    }
                }
            } catch (error) {
                console.error('‚ùå SIMPLE: Add/Update ingredient failed:', error);
                showErrorMessage((exists ? 'Failed to update ingredient: ' : 'Failed to add ingredient: ') + error.message);
            }
        }
        
        // Simple delete ingredient function
        async function simpleDeleteIngredient(category, ingredientKey, ingredientName) {
            if (!confirm(`Are you sure you want to delete "${ingredientName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ingredients/${category}/${ingredientKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessMessage(`‚úÖ Ingredient "${ingredientName}" deleted successfully!`);
                    simpleReloadIngredients();
                } else {
                    throw new Error(result.error || 'Failed to delete ingredient');
                }
                
            } catch (error) {
                console.error('‚ùå SIMPLE: Failed to delete ingredient:', error);
                showErrorMessage('Failed to delete ingredient: ' + error.message);
            }
        }
        
        // Simple edit ingredient function (basic implementation)
        function simpleEditIngredient(category, ingredientKey) {
            const ingredient = simpleIngredientsData[category][ingredientKey];
            
            // Fill form with existing data
            document.getElementById('simpleIngredientName').value = ingredient.name;
            document.getElementById('simpleIngredientCategory').value = category;
            
            // For simplicity, just fill with the first measurement
            const firstMeasurement = Object.entries(ingredient.measurements)[0];
            if (firstMeasurement) {
                const [measureKey, nutrition] = firstMeasurement;
                document.getElementById('simpleMeasurementKey').value = measureKey;
                document.getElementById('simpleCalories').value = nutrition.calories;
                document.getElementById('simpleProtein').value = nutrition.protein;
                document.getElementById('simpleCarbs').value = nutrition.carbs;
                document.getElementById('simpleFat').value = nutrition.fat;
                document.getElementById('simpleFiber').value = nutrition.fiber;
            }
            
            showSuccessMessage(`üìù Loaded "${ingredient.name}" for editing. Modify and click "Add Ingredient" to add/merge measurements.`);
        }
        
        // Simple clear form function
        function simpleClearForm() {
            document.getElementById('simpleIngredientName').value = '';
            document.getElementById('simpleIngredientCategory').value = '';
            document.getElementById('simpleMeasurementKey').value = '';
            document.getElementById('simpleCalories').value = '';
            document.getElementById('simpleProtein').value = '';
            document.getElementById('simpleCarbs').value = '';
            document.getElementById('simpleFat').value = '';
            document.getElementById('simpleFiber').value = '';
        }

        // ========================================
        // ENHANCED DATA LOADING FOR MEAL CREATION
        // ========================================
        
        // Function to ensure data is loaded before meal creation operations
        async function ensureDataLoadedForMealCreation() {
            // Clear both arrays to ensure compatibility
            inlineCurrentMealIngredients = [];
            inlineMealItems = [];
            document.getElementById('inlineMealName').value = '';
            document.getElementById('inlineMealServings').value = 1;
            document.getElementById('inlineMealServingsToLog').value = 1;
            clearInlineMealRecipeForm();
            updateInlineMealPreview();
        }

        function removeInlineMealItem(index) {
            // Remove from both arrays to maintain compatibility
            if (inlineCurrentMealIngredients.length > index) {
                inlineCurrentMealIngredients.splice(index, 1);
            }
            if (inlineMealItems.length > index) {
                inlineMealItems.splice(index, 1);
            }
            updateInlineMealPreview();
        }

        // Keep the old function name for backward compatibility
        function removeInlineMealIngredient(index) {
            removeInlineMealItem(index);
        }

        function updateInlineMealPreview() {
            const preview = document.getElementById('inlineMealPreview');
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add recipes to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Items in Meal (${inlineMealItems.length}):</h5>
                    ${inlineMealItems.map((item, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <div>
                                <span class="font-medium">${item.displayText || (item.name + ' (' + item.quantity + 'x ' + item.measurementDisplay + ')')}</span>
                                <span class="text-xs text-gray-500 ml-2">${item.type === 'recipe' ? 'üçΩÔ∏è' : 'ü•¨'} ${Math.round(item.nutrition.calories)} cal</span>
                            </div>
                            <button onclick="removeInlineMealItem(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addInlineMealToLog() {
            const mealName = document.getElementById('inlineMealName').value.trim();
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                alert('Please add recipes or ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${inlineMealItems.length} items)`;
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const selectedMealType = getSelectedMealType();
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'mixed_meal',
                mealType: selectedMealType,
                items: inlineMealItems.map(item => ({
                    type: item.type,
                    name: item.name,
                    displayText: item.displayText,
                    nutrition: item.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            clearInlineMealBuilder();
            showSuccessMessage(`Added "${finalMealName}" to your food log!`);
        }

        // ========================================
        // ENHANCED MEAL BUILDER WITH RECIPES & INGREDIENTS
        // ========================================
        
        let inlineMealItems = []; // Combined array for both recipes and ingredients
        let inlineSelectedMealRecipe = null;
        let currentMealItemType = 'recipes'; // 'recipes' or 'ingredients'
        
        
        // Ensure recipes are loaded
        function ensureRecipesLoaded() {
            if (!foodDatabase || !foodDatabase.dishes || Object.keys(foodDatabase.dishes).length === 0) {
                console.log('üîÑ RECIPES: Loading recipes database...');
                loadDatabases().then(() => {
                    console.log('‚úÖ RECIPES: Recipes loaded successfully');
                }).catch(error => {
                    console.error('‚ùå RECIPES: Failed to load recipes:', error);
                    showErrorMessage('Failed to load recipes: ' + error.message);
                });
            }
        }
        
        // Ensure ingredients are loaded
        function ensureIngredientsLoaded() {
            console.log('üîÑ ENSURE_INGREDIENTS: ensureIngredientsLoaded() called');
            console.log('üîÑ ENSURE_INGREDIENTS: rawIngredients state:', rawIngredients ? 'EXISTS' : 'NULL');
            
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('üîÑ ENSURE_INGREDIENTS: Loading ingredients database...');
                showSuccessMessage('üîÑ Loading ingredients for meal builder...');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ ENSURE_INGREDIENTS: Ingredients loaded successfully');
                    console.log('üìä ENSURE_INGREDIENTS: Categories loaded:', rawIngredients ? Object.keys(rawIngredients) : 'NONE');
                    showSuccessMessage('‚úÖ Ingredients loaded! You can now search and add ingredients.');
                }).catch(error => {
                    console.error('‚ùå ENSURE_INGREDIENTS: Failed to load ingredients:', error);
                    showErrorMessage('Failed to load ingredients: ' + error.message);
                });
            } else {
                console.log('‚úÖ ENSURE_INGREDIENTS: Ingredients already loaded');
                console.log('üìä ENSURE_INGREDIENTS: Categories available:', Object.keys(rawIngredients));
            }
        }
        
        // Filter recipes for meal builder
        function filterInlineMealRecipes() {
            const searchTerm = document.getElementById('inlineMealRecipeSearch').value.toLowerCase();
            const dropdown = document.getElementById('inlineMealRecipeDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                document.getElementById('inlineMealRecipeInputs').style.display = 'none';
                return;
            }

            if (!foodDatabase || !foodDatabase.dishes || Object.keys(foodDatabase.dishes).length === 0) {
                console.log('üîÑ FILTER_RECIPES: Recipes not loaded, loading now...');
                dropdown.innerHTML = '<div class="px-3 py-2 text-blue-600 text-center">üîÑ Loading recipes...</div>';
                dropdown.classList.remove('hidden');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ FILTER_RECIPES: Recipes loaded, retrying filter');
                    filterInlineMealRecipes();
                }).catch(error => {
                    console.error('‚ùå FILTER_RECIPES: Failed to load recipes:', error);
                    dropdown.innerHTML = '<div class="px-3 py-2 text-red-600 text-center">‚ùå Failed to load recipes</div>';
                });
                return;
            }

            let html = '';
            let hasResults = false;
            
            // Combine server recipes and custom recipes
            const allRecipes = {...foodDatabase.dishes, ...customRecipes};

            Object.entries(allRecipes).forEach(([key, recipe]) => {
                if (recipe.name.toLowerCase().includes(searchTerm)) {
                    hasResults = true;
                    html += `
                        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             onclick="selectInlineMealRecipe('${key}', '${recipe.name}')">
                            <div class="font-medium text-gray-800">${recipe.name}</div>
                            <div class="text-xs text-gray-500">${recipe.total_per_serving.calories} cal/serving ‚Ä¢ ${recipe.category}</div>
                        </div>
                    `;
                }
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No recipes found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }
        
        // Select a recipe for the meal
        function selectInlineMealRecipe(recipeKey, recipeName) {
            inlineSelectedMealRecipe = { key: recipeKey, name: recipeName };
            
            // Update the search input and hide dropdown
            document.getElementById('inlineMealRecipeSearch').value = recipeName;
            document.getElementById('inlineMealRecipeDropdown').classList.add('hidden');
            
            // Show the recipe inputs
            document.getElementById('inlineSelectedMealRecipe').value = recipeName;
            document.getElementById('inlineMealRecipeInputs').style.display = 'grid';
        }
        
        // Add recipe to meal
        function addInlineMealRecipe() {
            console.log('üîÑ ADD_RECIPE: addInlineMealRecipe() called');
            
            if (!inlineSelectedMealRecipe) {
                showErrorMessage('Please search for and select a recipe first');
                return;
            }
            
            const servingsInput = document.getElementById('inlineMealRecipeServings');
            if (!servingsInput.value) {
                showErrorMessage('Please enter number of servings');
                return;
            }
            
            const servings = parseFloat(servingsInput.value);
            const { key, name } = inlineSelectedMealRecipe;
            
            // Get recipe data
            const allRecipes = {...foodDatabase.dishes, ...customRecipes};
            const recipe = allRecipes[key];
            
            if (!recipe) {
                showErrorMessage(`Recipe ${name} not found`);
                return;
            }
            
            const recipeEntry = {
                type: 'recipe',
                key: key,
                name: name,
                servings: servings,
                nutrition: {
                    calories: recipe.total_per_serving.calories * servings,
                    protein: recipe.total_per_serving.protein * servings,
                    carbs: recipe.total_per_serving.carbs * servings,
                    fat: recipe.total_per_serving.fat * servings,
                    fiber: recipe.total_per_serving.fiber * servings
                },
                displayText: `${name} (${servings} serving${servings !== 1 ? 's' : ''})`
            };
            
            inlineMealItems.push(recipeEntry);
            
            // Clear inputs
            clearInlineMealRecipeForm();
            updateEnhancedInlineMealPreview();
            
            showSuccessMessage(`‚úÖ Added ${name} to meal!`);
        }
        
        // Clear recipe form
        function clearInlineMealRecipeForm() {
            document.getElementById('inlineMealRecipeSearch').value = '';
            document.getElementById('inlineSelectedMealRecipe').value = '';
            document.getElementById('inlineMealRecipeServings').value = 1;
            document.getElementById('inlineMealRecipeDropdown').classList.add('hidden');
            document.getElementById('inlineMealRecipeInputs').style.display = 'none';
            inlineSelectedMealRecipe = null;
        }
        
        // Enhanced clear function (this will override the previous one)
        function clearInlineMealBuilder() {
            inlineMealItems = [];
            inlineCurrentMealIngredients = []; // Keep compatibility with old system
            document.getElementById('inlineMealName').value = '';
            document.getElementById('inlineMealServings').value = 1;
            document.getElementById('inlineMealServingsToLog').value = 1;
            clearInlineMealRecipeForm();
            clearInlineMealIngredientForm();
            updateInlineMealPreview(); // Use the overridden version that handles both systems
        }
        
        // Remove item from meal
        function removeInlineMealItem(index) {
            inlineMealItems.splice(index, 1);
            updateEnhancedInlineMealPreview();
        }
        
        // Enhanced preview function
        function updateEnhancedInlineMealPreview() {
            const preview = document.getElementById('inlineMealPreview');
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                preview.innerHTML = '<p class="text-gray-500">Add recipes and ingredients to see nutritional breakdown...</p>';
                return;
            }
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving (for the meal recipe)
            const perServing = {
                calories: Math.round(totals.calories / totalServings),
                protein: Math.round(totals.protein / totalServings * 10) / 10,
                carbs: Math.round(totals.carbs / totalServings * 10) / 10,
                fat: Math.round(totals.fat / totalServings * 10) / 10,
                fiber: Math.round(totals.fiber / totalServings * 10) / 10
            };

            // What will be logged (servings to log)
            const toLog = {
                calories: Math.round(perServing.calories * servingsToLog),
                protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
            };
            
            preview.innerHTML = `
                <div class="space-y-3">
                    <h5 class="font-semibold text-gray-800">Items in Meal (${inlineMealItems.length}):</h5>
                    ${inlineMealItems.map((item, index) => `
                        <div class="flex justify-between items-center text-sm bg-white p-2 rounded border">
                            <div>
                                <span class="font-medium">${item.displayText}</span>
                                <span class="text-xs text-gray-500 ml-2">${item.type === 'recipe' ? 'üçΩÔ∏è' : 'ü•¨'} ${Math.round(item.nutrition.calories)} cal</span>
                            </div>
                            <button onclick="removeInlineMealItem(${index})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `).join('')}
                    
                    <div class="border-t pt-3 mt-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Per Serving (${totalServings} total servings):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>Calories: <span class="font-semibold">${perServing.calories}</span></div>
                            <div>Protein: <span class="font-semibold">${perServing.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold">${perServing.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold">${perServing.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold">${perServing.fiber}g</span></div>
                        </div>
                        
                        <h5 class="font-semibold text-gray-800 mb-2">Will be logged (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''}):</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm bg-green-50 p-2 rounded">
                            <div>Calories: <span class="font-semibold text-green-700">${toLog.calories}</span></div>
                            <div>Protein: <span class="font-semibold text-green-700">${toLog.protein}g</span></div>
                            <div>Carbs: <span class="font-semibold text-green-700">${toLog.carbs}g</span></div>
                            <div>Fat: <span class="font-semibold text-green-700">${toLog.fat}g</span></div>
                            <div>Fiber: <span class="font-semibold text-green-700">${toLog.fiber}g</span></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Enhanced add to log function
        function addInlineMealToLog() {
            const mealName = document.getElementById('inlineMealName').value.trim();
            const totalServings = parseFloat(document.getElementById('inlineMealServings').value) || 1;
            const servingsToLog = parseFloat(document.getElementById('inlineMealServingsToLog').value) || 1;
            
            if (inlineMealItems.length === 0) {
                alert('Please add recipes or ingredients to the meal');
                return;
            }
            
            const finalMealName = mealName || `Custom Meal (${inlineMealItems.length} items)`;
            
            // Calculate totals for the entire meal
            const totals = inlineMealItems.reduce((acc, item) => {
                acc.calories += item.nutrition.calories;
                acc.protein += item.nutrition.protein;
                acc.carbs += item.nutrition.carbs;
                acc.fat += item.nutrition.fat;
                acc.fiber += item.nutrition.fiber;
                return acc;
            }, {calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0});
            
            // Per serving nutrition
            const perServing = {
                calories: totals.calories / totalServings,
                protein: totals.protein / totalServings,
                carbs: totals.carbs / totalServings,
                fat: totals.fat / totalServings,
                fiber: totals.fiber / totalServings
            };

            // Create meal entry for logging
            const meal = {
                id: Date.now(),
                description: `${finalMealName} (${servingsToLog} serving${servingsToLog !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(perServing.calories * servingsToLog),
                    protein: Math.round(perServing.protein * servingsToLog * 10) / 10,
                    carbs: Math.round(perServing.carbs * servingsToLog * 10) / 10,
                    fat: Math.round(perServing.fat * servingsToLog * 10) / 10,
                    fiber: Math.round(perServing.fiber * servingsToLog * 10) / 10
                },
                source: 'mixed_meal',
                mealType: 'Lunch', // Default meal type for mixed meals
                items: inlineMealItems.map(item => ({
                    type: item.type,
                    name: item.name,
                    displayText: item.displayText,
                    nutrition: item.nutrition
                }))
            };
            
            addMealToDate(meal);
            updateDailySummary();
            displayMeals();
            
            clearInlineMealBuilder();
            showSuccessMessage(`‚úÖ Added "${finalMealName}" to your food log!`);
        }
        
        

        // ========================================
        // ENHANCED DATA LOADING FOR MEAL CREATION
        // ========================================
        
        // Function to ensure data is loaded before meal creation operations
        async function ensureDataLoadedForMealCreation() {
            console.log('üîÑ ENSURE_DATA: ensureDataLoadedForMealCreation() called');
            console.log('üîÑ ENSURE_DATA: Current state - rawIngredients:', rawIngredients ? 'EXISTS' : 'NULL');
            console.log('üîÑ ENSURE_DATA: Current state - foodDatabase:', foodDatabase ? 'EXISTS' : 'NULL');
            
            // Check if data is already loaded
            const ingredientsLoaded = rawIngredients && Object.keys(rawIngredients).length > 0;
            const recipesLoaded = foodDatabase && foodDatabase.dishes && Object.keys(foodDatabase.dishes).length > 0;
            
            if (ingredientsLoaded && recipesLoaded) {
                console.log('‚úÖ ENSURE_DATA: All data already loaded');
                return { success: true, message: 'Data already loaded' };
            }
            
            console.log('üîÑ ENSURE_DATA: Loading missing data...');
            showLoadingIndicator('Preparing meal creation tools...');
            
            try {
                await loadDatabases();
                
                // Verify data was loaded successfully
                const finalIngredientsCheck = rawIngredients && Object.keys(rawIngredients).length > 0;
                const finalRecipesCheck = foodDatabase && foodDatabase.dishes && Object.keys(foodDatabase.dishes).length > 0;
                
                if (!finalIngredientsCheck) {
                    throw new Error('Failed to load ingredients database');
                }
                
                if (!finalRecipesCheck) {
                    throw new Error('Failed to load recipes database');
                }
                
                console.log('‚úÖ ENSURE_DATA: All data loaded successfully');
                console.log('üìä ENSURE_DATA: Ingredients categories:', Object.keys(rawIngredients));
                console.log('üìä ENSURE_DATA: Recipes count:', Object.keys(foodDatabase.dishes).length);
                
                hideLoadingIndicator();
                return {
                    success: true,
                    message: 'All data loaded successfully',
                    ingredientsCount: Object.values(rawIngredients).reduce((total, category) => total + Object.keys(category).length, 0),
                    recipesCount: Object.keys(foodDatabase.dishes).length
                };
                
            } catch (error) {
                console.error('‚ùå ENSURE_DATA: Failed to load data:', error);
                hideLoadingIndicator();
                return {
                    success: false,
                    error: error.message,
                    message: 'Failed to load required data for meal creation'
                };
            }
        }
        
        // Enhanced meal creation workflow with data validation
        async function startMealCreationWorkflow(workflowType = 'ingredient') {
            console.log('üöÄ WORKFLOW: Starting meal creation workflow:', workflowType);
            
            // Show immediate feedback
            showSuccessMessage('üîÑ Preparing meal creation tools...');
            
            try {
                // Ensure all required data is loaded
                const dataResult = await ensureDataLoadedForMealCreation();
                
                if (!dataResult.success) {
                    throw new Error(dataResult.message || 'Failed to load required data');
                }
                
                console.log('‚úÖ WORKFLOW: Data validation passed');
                
                // Provide success feedback with data stats
                if (dataResult.ingredientsCount && dataResult.recipesCount) {
                    showSuccessMessage(`‚úÖ Ready! Loaded ${dataResult.ingredientsCount} ingredients and ${dataResult.recipesCount} recipes.`);
                } else {
                    showSuccessMessage('‚úÖ Meal creation tools ready!');
                }
                
                // Return success status for calling functions
                return { success: true, data: dataResult };
                
            } catch (error) {
                console.error('‚ùå WORKFLOW: Meal creation workflow failed:', error);
                
                // Show user-friendly error with actionable guidance
                const errorMessage = error.message.includes('internet') || error.message.includes('network')
                    ? 'Network connection issue. Please check your internet connection and try again.'
                    : error.message.includes('server')
                    ? 'Server connection issue. Please make sure the server is running and try again.'
                    : `Unable to load meal creation data: ${error.message}`;
                
                showCriticalError(`${errorMessage}\n\nTry these solutions:\n‚Ä¢ Refresh the page\n‚Ä¢ Check your internet connection\n‚Ä¢ Make sure the server is running\n‚Ä¢ Contact support if the issue persists`);
                
                return { success: false, error: error.message };
            }
        }
        
        // Enhanced error messages for specific meal creation scenarios
        function showMealCreationError(errorType, context = {}) {
            console.log('‚ùå MEAL_ERROR: showMealCreationError() called:', errorType, context);
            
            let title = 'Meal Creation Error';
            let message = 'An error occurred while creating your meal.';
            let suggestions = [];
            
            switch (errorType) {
                case 'ingredients_not_loaded':
                    title = 'Ingredients Not Available';
                    message = 'The ingredients database is not loaded yet.';
                    suggestions = [
                        'Wait a moment for ingredients to load automatically',
                        'Click "Reload" to manually refresh ingredients',
                        'Check your internet connection',
                        'Refresh the page if the problem persists'
                    ];
                    break;
                    
                case 'recipes_not_loaded':
                    title = 'Recipes Not Available';
                    message = 'The recipes database is not loaded yet.';
                    suggestions = [
                        'Wait a moment for recipes to load automatically',
                        'Try refreshing the page',
                        'Check your internet connection',
                        'Contact support if the issue continues'
                    ];
                    break;
                    
                case 'ingredient_not_found':
                    title = 'Ingredient Not Found';
                    message = `The ingredient "${context.ingredientName || 'selected ingredient'}" could not be found in the database.`;
                    suggestions = [
                        'Try searching for a different ingredient',
                        'Check the spelling of the ingredient name',
                        'Reload ingredients to refresh the database',
                        'Add the ingredient manually if you have server access'
                    ];
                    break;
                    
                case 'measurement_not_found':
                    title = 'Measurement Not Available';
                    message = `The measurement "${context.measurement || 'selected measurement'}" is not available for "${context.ingredientName || 'this ingredient'}".`;
                    suggestions = [
                        'Try selecting a different measurement option',
                        'Check if the ingredient data is complete',
                        'Contact support to add missing measurements'
                    ];
                    break;
                    
                case 'network_error':
                    title = 'Connection Problem';
                    message = 'Unable to connect to the server to load meal data.';
                    suggestions = [
                        'Check your internet connection',
                        'Make sure the server is running (npm start)',
                        'Try refreshing the page',
                        'Wait a moment and try again'
                    ];
                    break;
                    
                case 'validation_error':
                    title = 'Input Validation Error';
                    message = context.message || 'Please check your input and try again.';
                    suggestions = [
                        'Make sure all required fields are filled',
                        'Check that quantities are positive numbers',
                        'Verify that measurements are selected',
                        'Try clearing the form and starting over'
                    ];
                    break;
                    
                default:
                    title = 'Unexpected Error';
                    message = context.message || 'An unexpected error occurred during meal creation.';
                    suggestions = [
                        'Try refreshing the page',
                        'Clear your browser cache',
                        'Check the browser console for more details',
                        'Contact support if the problem persists'
                    ];
            }
            
            // Create enhanced error display
            const errorHtml = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-red-600 text-5xl mb-3">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 class="font-semibold text-blue-800 mb-2">üí° Try these solutions:</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            ${suggestions.map(suggestion => `<li>‚Ä¢ ${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="location.reload()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üîÑ Refresh Page
                        </button>
                        <button onclick="reloadIngredients().catch(console.error)" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            üì• Reload Data
                        </button>
                        <button onclick="document.getElementById('mealCreationError').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Continue Anyway
                        </button>
                    </div>
                </div>
            `;
            
            // Remove existing error if present
            const existingError = document.getElementById('mealCreationError');
            if (existingError) {
                existingError.remove();
            }
            
            // Create and show error modal
            const errorDiv = document.createElement('div');
            errorDiv.id = 'mealCreationError';
            errorDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            errorDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    ${errorHtml}
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Also show a toast notification
            showErrorMessage(`${title}: ${message}`);
        }



        // ========================================
        // ENHANCED INGREDIENT ADDITION FUNCTIONS
        // ========================================
        
        let selectedEnhancedIngredient = null;
        
        function filterEnhancedIngredients() {
            console.log('üîÑ ENHANCED_INGREDIENT: filterEnhancedIngredients() called');
            const searchTerm = document.getElementById('enhancedIngredientSearch').value.toLowerCase();
            const dropdown = document.getElementById('enhancedIngredientDropdown');
            
            if (searchTerm.length === 0) {
                dropdown.classList.add('hidden');
                clearEnhancedIngredientSelection();
                return;
            }

            // Check if rawIngredients is loaded
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('üîÑ ENHANCED_INGREDIENT: Raw ingredients not loaded, loading now...');
                dropdown.innerHTML = '<div class="px-3 py-2 text-blue-600 text-center">üîÑ Loading ingredients...</div>';
                dropdown.classList.remove('hidden');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ ENHANCED_INGREDIENT: Ingredients loaded, retrying filter');
                    filterEnhancedIngredients();
                }).catch(error => {
                    console.error('‚ùå ENHANCED_INGREDIENT: Failed to load ingredients:', error);
                    dropdown.innerHTML = '<div class="px-3 py-2 text-red-600 text-center">‚ùå Failed to load ingredients</div>';
                });
                return;
            }

            let html = '';
            let hasResults = false;

            Object.entries(rawIngredients).forEach(([category, items]) => {
                const categoryName = category.replace('_', ' ').toUpperCase();
                Object.entries(items).forEach(([key, item]) => {
                    if (item.name.toLowerCase().includes(searchTerm)) {
                        hasResults = true;
                        html += `
                            <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                                 onclick="selectEnhancedIngredient('${category}', '${key}', '${item.name.replace(/'/g, "\\'")}')">
                                <div class="font-medium text-gray-800">${item.name}</div>
                                <div class="text-xs text-gray-500">${categoryName} ‚Ä¢ ${Object.keys(item.measurements).length} measurement${Object.keys(item.measurements).length !== 1 ? 's' : ''}</div>
                            </div>
                        `;
                    }
                });
            });

            if (!hasResults) {
                html = '<div class="px-3 py-2 text-gray-500 text-center">No ingredients found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }
        
        function selectEnhancedIngredient(category, key, name) {
            console.log('üîÑ ENHANCED_INGREDIENT: selectEnhancedIngredient() called', { category, key, name });
            
            // Validate that ingredient exists
            if (!rawIngredients || !rawIngredients[category] || !rawIngredients[category][key]) {
                console.error('‚ùå ENHANCED_INGREDIENT: Ingredient not found:', { category, key, name });
                showErrorMessage(`Ingredient "${name}" not found. Please try reloading ingredients.`);
                return;
            }
            
            selectedEnhancedIngredient = { category, key, name };
            const ingredient = rawIngredients[category][key];
            
            // Update search input and hide dropdown
            document.getElementById('enhancedIngredientSearch').value = name;
            document.getElementById('enhancedIngredientDropdown').classList.add('hidden');
            
            // Show selected ingredient section
            document.getElementById('selectedIngredientSection').classList.remove('hidden');
            document.getElementById('selectedIngredientName').textContent = name;
            
            // Populate measurements
            populateEnhancedMeasurements(ingredient);
            
            // Show measurement section
            document.getElementById('measurementSection').classList.remove('hidden');
            
            console.log('‚úÖ ENHANCED_INGREDIENT: Ingredient selected successfully');
            showSuccessMessage(`‚úÖ Selected "${name}" - choose measurement and quantity!`);
        }
        
        function populateEnhancedMeasurements(ingredient) {
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            
            let options = '<option value="">Choose measurement...</option>';
            Object.entries(ingredient.measurements).forEach(([measurementKey, nutrition]) => {
                const displayName = measurementKey.replace(/_/g, ' ').replace(/(\d+)/, '$1 ');
                options += `<option value="${measurementKey}">${displayName}</option>`;
            });
            
            measurementSelect.innerHTML = options;
            
            // Add event listener for measurement selection
            measurementSelect.onchange = function() {
                if (this.value) {
                    document.getElementById('quantitySection').classList.remove('hidden');
                    updateEnhancedNutritionPreview();
                } else {
                    document.getElementById('quantitySection').classList.add('hidden');
                    document.getElementById('nutritionPreview').classList.add('hidden');
                    document.getElementById('addButtonSection').classList.add('hidden');
                }
            };
            
            // Add event listener for quantity changes
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            quantityInput.oninput = updateEnhancedNutritionPreview;
        }
        
        function updateEnhancedNutritionPreview() {
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            
            if (!selectedEnhancedIngredient || !measurementSelect.value || !quantityInput.value) {
                document.getElementById('nutritionPreview').classList.add('hidden');
                document.getElementById('addButtonSection').classList.add('hidden');
                return;
            }
            
            const ingredient = rawIngredients[selectedEnhancedIngredient.category][selectedEnhancedIngredient.key];
            const measurement = ingredient.measurements[measurementSelect.value];
            const quantity = parseFloat(quantityInput.value) || 1;
            
            // Calculate nutrition
            const nutrition = {
                calories: Math.round(measurement.calories * quantity),
                protein: Math.round(measurement.protein * quantity * 10) / 10,
                carbs: Math.round(measurement.carbs * quantity * 10) / 10,
                fat: Math.round(measurement.fat * quantity * 10) / 10,
                fiber: Math.round(measurement.fiber * quantity * 10) / 10
            };
            
            // Update nutrition preview
            const nutritionDetails = document.getElementById('nutritionDetails');
            nutritionDetails.innerHTML = `
                <div>Calories: <span class="font-semibold">${nutrition.calories}</span></div>
                <div>Protein: <span class="font-semibold">${nutrition.protein}g</span></div>
                <div>Carbs: <span class="font-semibold">${nutrition.carbs}g</span></div>
                <div>Fat: <span class="font-semibold">${nutrition.fat}g</span></div>
                <div>Fiber: <span class="font-semibold">${nutrition.fiber}g</span></div>
            `;
            
            // Show preview and add button
            document.getElementById('nutritionPreview').classList.remove('hidden');
            document.getElementById('addButtonSection').classList.remove('hidden');
        }
        
        function addEnhancedIngredientToLog() {
            console.log('ü•¨ ENHANCED_INGREDIENT: addEnhancedIngredientToLog() called');
            
            if (!selectedEnhancedIngredient) {
                showErrorMessage('Please select an ingredient first');
                return;
            }
            
            const measurementSelect = document.getElementById('enhancedMeasurementSelect');
            const quantityInput = document.getElementById('enhancedIngredientQuantity');
            
            if (!measurementSelect.value) {
                showErrorMessage('Please select a measurement');
                return;
            }
            
            if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                showErrorMessage('Please enter a valid quantity');
                return;
            }
            
            const ingredient = rawIngredients[selectedEnhancedIngredient.category][selectedEnhancedIngredient.key];
            const measurement = ingredient.measurements[measurementSelect.value];
            const quantity = parseFloat(quantityInput.value);
            const measurementDisplay = measurementSelect.options[measurementSelect.selectedIndex].text;
            
            // Get selected meal type from the modal
            const selectedMealType = getSelectedMealType();
            
            // Create ingredient entry with real nutrition data
            const ingredientMeal = {
                id: Date.now(),
                description: `${selectedEnhancedIngredient.name} (${quantity}x ${measurementDisplay})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    calories: Math.round(measurement.calories * quantity),
                    protein: Math.round(measurement.protein * quantity * 10) / 10,
                    carbs: Math.round(measurement.carbs * quantity * 10) / 10,
                    fat: Math.round(measurement.fat * quantity * 10) / 10,
                    fiber: Math.round(measurement.fiber * quantity * 10) / 10
                },
                source: 'enhanced_ingredient',
                mealType: selectedMealType, // Use selected meal type from modal
                ingredient_data: {
                    category: selectedEnhancedIngredient.category,
                    key: selectedEnhancedIngredient.key,
                    measurement: measurementSelect.value,
                    quantity: quantity
                }
            };
            
            // Add to today's meals
            addMealToDate(ingredientMeal);
            
            // Update displays
            updateDailySummary();
            displayMeals();
            updateModalContent();
            
            console.log('‚úÖ ENHANCED_INGREDIENT: Ingredient added successfully with real nutrition data');
            
            // Clear form
            clearEnhancedIngredientForm();
            
            // Show success message
            showSuccessMessage(`‚úÖ Added ${selectedEnhancedIngredient.name} to ${selectedMealType} with accurate nutrition data!`);
        }
        
        function clearEnhancedIngredientSelection() {
            selectedEnhancedIngredient = null;
            document.getElementById('selectedIngredientSection').classList.add('hidden');
            document.getElementById('measurementSection').classList.add('hidden');
            document.getElementById('quantitySection').classList.add('hidden');
            document.getElementById('nutritionPreview').classList.add('hidden');
            document.getElementById('addButtonSection').classList.add('hidden');
        }
        
        function clearEnhancedIngredientForm() {
            console.log('üßπ ENHANCED_INGREDIENT: Clearing form');
            
            document.getElementById('enhancedIngredientSearch').value = '';
            document.getElementById('enhancedIngredientDropdown').classList.add('hidden');
            document.getElementById('enhancedMeasurementSelect').innerHTML = '<option value="">Choose measurement...</option>';
            document.getElementById('enhancedIngredientQuantity').value = 1;
            
            clearEnhancedIngredientSelection();
            
            // Focus on search input for easy next entry
            document.getElementById('enhancedIngredientSearch').focus();
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('enhancedIngredientDropdown');
            const searchInput = document.getElementById('enhancedIngredientSearch');
            
            if (dropdown && searchInput && !dropdown.contains(event.target) && event.target !== searchInput) {
                dropdown.classList.add('hidden');
            }
        });

        // ========================================
        // SIMPLE INGREDIENT ADDITION FUNCTIONS (LEGACY)
        // ========================================
        
        function addSimpleIngredientToLog() {
            console.log('ü•¨ SIMPLE_INGREDIENT: addSimpleIngredientToLog() called');
            
            // Get form values
            const nameInput = document.getElementById('simpleIngredientName');
            const quantityInput = document.getElementById('simpleIngredientQuantity');
            
            if (!nameInput || !quantityInput) {
                alert('Form elements not found. Please refresh the page.');
                return;
            }
            
            const ingredientName = nameInput.value.trim();
            const quantity = parseFloat(quantityInput.value) || 1;
            
            // Simple validation
            if (!ingredientName) {
                alert('Please enter an ingredient name (e.g., "Egg", "Rice", "Oil")');
                nameInput.focus();
                return;
            }
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                quantityInput.focus();
                return;
            }
            
            // Create ingredient entry using the SAME SIMPLE PATTERN as the working test button
            const ingredientMeal = {
                id: Date.now(),
                description: `${ingredientName} (${quantity} serving${quantity !== 1 ? 's' : ''})`,
                timestamp: new Date().toISOString(),
                nutrition: {
                    // Use simple default nutrition values (like test button)
                    calories: Math.round(50 * quantity), // 50 calories per serving default
                    protein: Math.round(3 * quantity * 10) / 10,
                    carbs: Math.round(5 * quantity * 10) / 10,
                    fat: Math.round(2 * quantity * 10) / 10,
                    fiber: Math.round(1 * quantity * 10) / 10
                },
                source: 'simple_ingredient'
            };
            
            // Add to today's meals using the SAME FUNCTION as the working test button
            addMealToDate(ingredientMeal);
            
            // Update displays using the SAME FUNCTIONS as the working test button
            updateDailySummary();
            displayMeals();
            
            // Update modal content if it's open
            updateModalContent();
            
            console.log('‚úÖ SIMPLE_INGREDIENT: Ingredient added successfully');
            
            // Clear form
            clearSimpleIngredientForm();
            
            // Show success message using the SAME FUNCTION as the working test button
            showSuccessMessage(`‚úÖ Added ${ingredientName} to your daily log!`);
        }
        
        function clearSimpleIngredientForm() {
            console.log('üßπ SIMPLE_INGREDIENT: Clearing form');
            
            const nameInput = document.getElementById('simpleIngredientName');
            const quantityInput = document.getElementById('simpleIngredientQuantity');
            
            if (nameInput) nameInput.value = '';
            if (quantityInput) quantityInput.value = 1;
            
            // Focus on name input for easy next entry
            if (nameInput) nameInput.focus();
        }

        // ========================================
        // BMI CALCULATION TESTING FUNCTIONS
        // ========================================
        
        function testBMICalculationAccuracy() {
            console.log('üß™ BMI_TEST: Starting BMI calculation accuracy test');
            console.log('='.repeat(60));
            
            // Test cases: [weight_kg, height_cm, expected_bmi, description]
            const testCases = [
                [70, 175, 22.86, "Normal weight adult"],
                [85, 180, 26.23, "Slightly overweight adult"],
                [60, 165, 22.04, "Normal weight shorter person"],
                [90, 170, 31.14, "Obese classification"],
                [55, 160, 21.48, "Lower normal weight"],
                [100, 185, 29.22, "High overweight"],
                // User's specific test case
                [77.11, 157.48, 31.1, "User test: 5ft 2in, 170lbs"]
            ];
            
            // Also test the specific imperial case directly
            console.log('\nüß™ BMI_TEST: Testing user-reported case directly');
            console.log('üìä BMI_TEST: 5ft 2in (62 inches), 170 lbs ‚Üí Expected BMI: 31.1');
            
            const userBMI = calculateBMI(170, 62, 'imperial');
            console.log(`üìä BMI_TEST: Calculated BMI: ${userBMI?.toFixed(2)}`);
            console.log(`üìä BMI_TEST: Expected BMI: 31.1`);
            console.log(`üìä BMI_TEST: Difference: ${Math.abs(userBMI - 31.1).toFixed(3)}`);
            
            if (Math.abs(userBMI - 31.1) > 0.1) {
                console.log('‚ùå BMI_TEST: USER CASE FAILED - BMI calculation is incorrect!');
            } else {
                console.log('‚úÖ BMI_TEST: USER CASE PASSED');
            }
            
            let allTestsPassed = true;
            const tolerance = 0.05; // Allow 0.05 BMI difference
            
            testCases.forEach((testCase, index) => {
                const [weightKg, heightCm, expectedBMI, description] = testCase;
                
                console.log(`\nüß™ BMI_TEST: Test Case ${index + 1}: ${description}`);
                console.log(`üìä BMI_TEST: Input - ${weightKg}kg, ${heightCm}cm`);
                
                // Convert to imperial for comparison
                const weightLbs = kgToLbs(weightKg);
                const heightInches = cmToInches(heightCm);
                
                console.log(`üìä BMI_TEST: Converted - ${weightLbs.toFixed(2)}lbs, ${heightInches.toFixed(2)}inches`);
                
                // Calculate BMI using both methods
                const bmiMetric = calculateBMI(weightKg, heightCm, 'metric');
                const bmiImperial = calculateBMI(weightLbs, heightInches, 'imperial');
                const bmiAuto = calculateBMIAuto(weightKg, heightCm, true);
                
                console.log(`üìä BMI_TEST: Results:`);
                console.log(`  - Metric BMI: ${bmiMetric?.toFixed(2)}`);
                console.log(`  - Imperial BMI: ${bmiImperial?.toFixed(2)}`);
                console.log(`  - Auto BMI: ${bmiAuto?.toFixed(2)}`);
                console.log(`  - Expected BMI: ${expectedBMI}`);
                
                // Check accuracy
                const metricDiff = Math.abs(bmiMetric - expectedBMI);
                const imperialDiff = Math.abs(bmiImperial - expectedBMI);
                const autoDiff = Math.abs(bmiAuto - expectedBMI);
                const consistencyDiff = Math.abs(bmiMetric - bmiImperial);
                
                console.log(`üìä BMI_TEST: Differences from expected:`);
                console.log(`  - Metric diff: ${metricDiff.toFixed(3)}`);
                console.log(`  - Imperial diff: ${imperialDiff.toFixed(3)}`);
                console.log(`  - Auto diff: ${autoDiff.toFixed(3)}`);
                console.log(`  - Consistency diff: ${consistencyDiff.toFixed(3)}`);
                
                // Validate results
                const metricAccurate = metricDiff <= tolerance;
                const imperialAccurate = imperialDiff <= tolerance;
                const autoAccurate = autoDiff <= tolerance;
                const consistent = consistencyDiff <= tolerance;
                
                if (metricAccurate && imperialAccurate && autoAccurate && consistent) {
                    console.log(`‚úÖ BMI_TEST: Test Case ${index + 1} PASSED`);
                } else {
                    console.log(`‚ùå BMI_TEST: Test Case ${index + 1} FAILED`);
                    if (!metricAccurate) console.log(`  - Metric calculation inaccurate`);
                    if (!imperialAccurate) console.log(`  - Imperial calculation inaccurate`);
                    if (!autoAccurate) console.log(`  - Auto calculation inaccurate`);
                    if (!consistent) console.log(`  - Metric/Imperial inconsistent`);
                    allTestsPassed = false;
                }
            });
            
            console.log('\n' + '='.repeat(60));
            if (allTestsPassed) {
                console.log('‚úÖ BMI_TEST: ALL TESTS PASSED - BMI calculations are accurate and consistent');
            } else {
                console.log('‚ùå BMI_TEST: SOME TESTS FAILED - BMI calculation issues detected');
            }
            console.log('='.repeat(60));
            
            return allTestsPassed;
        }
        
        // Test buttons removed as requested

        // ========================================
        // BMR CALCULATION TESTING FUNCTIONS
        // ========================================
        
        function testBMRCalculationAccuracy() {
            console.log('üß™ BMR_TEST: Starting BMR calculation accuracy test');
            console.log('='.repeat(60));
            
            // Test cases: [weight_kg, height_cm, age, gender, expected_mifflin, expected_harris, description]
            const testCases = [
                [70, 175, 30, 'male', 1728, 1801, "30-year-old male, 70kg, 175cm"],
                [60, 165, 25, 'female', 1379, 1409, "25-year-old female, 60kg, 165cm"],
                [85, 180, 40, 'male', 1898, 1967, "40-year-old male, 85kg, 180cm"],
                [55, 160, 35, 'female', 1281, 1311, "35-year-old female, 55kg, 160cm"],
                [90, 185, 50, 'male', 1948, 2013, "50-year-old male, 90kg, 185cm"],
                [65, 170, 45, 'female', 1398, 1428, "45-year-old female, 65kg, 170cm"]
            ];
            
            let allTestsPassed = true;
            const tolerance = 5; // Allow 5 calorie difference
            
            testCases.forEach((testCase, index) => {
                const [weight, height, age, gender, expectedMifflin, expectedHarris, description] = testCase;
                
                console.log(`\nüß™ BMR_TEST: Test Case ${index + 1}: ${description}`);
                
                // Test metric calculation
                const bmrMifflinMetric = calculateBMRMifflinStJeor(weight, height, age, gender, 'metric');
                const bmrHarrisMetric = calculateBMRHarrisBenedict(weight, height, age, gender, 'metric');
                
                console.log(`üìä BMR_TEST: Results:`);
                console.log(`  - Mifflin-St Jeor: ${bmrMifflinMetric?.toFixed(2)} (expected: ${expectedMifflin})`);
                console.log(`  - Harris-Benedict: ${bmrHarrisMetric?.toFixed(2)} (expected: ${expectedHarris})`);
                
                // Check accuracy
                const mifflinDiff = Math.abs(bmrMifflinMetric - expectedMifflin);
                const harrisDiff = Math.abs(bmrHarrisMetric - expectedHarris);
                
                console.log(`üìä BMR_TEST: Differences from expected:`);
                console.log(`  - Mifflin diff: ${mifflinDiff.toFixed(2)} cal`);
                console.log(`  - Harris diff: ${harrisDiff.toFixed(2)} cal`);
                
                if (mifflinDiff <= tolerance && harrisDiff <= tolerance) {
                    console.log(`‚úÖ BMR_TEST: Test Case ${index + 1} PASSED`);
                } else {
                    console.log(`‚ùå BMR_TEST: Test Case ${index + 1} FAILED`);
                    if (mifflinDiff > tolerance) console.log(`  - Mifflin-St Jeor inaccurate (diff: ${mifflinDiff.toFixed(2)})`);
                    if (harrisDiff > tolerance) console.log(`  - Harris-Benedict inaccurate (diff: ${harrisDiff.toFixed(2)})`);
                    allTestsPassed = false;
                }
            });
            
            console.log('\n' + '='.repeat(60));
            if (allTestsPassed) {
                console.log('‚úÖ BMR_TEST: ALL TESTS PASSED - BMR calculations are accurate');
            } else {
                console.log('‚ùå BMR_TEST: SOME TESTS FAILED - BMR calculation issues detected');
            }
            console.log('='.repeat(60));
            
            return allTestsPassed;
        }
        
        function testBMRUnitConversions() {
            console.log('üß™ BMR_UNIT_TEST: Starting BMR unit conversion test');
            console.log('='.repeat(50));
            
            // Test same person in both metric and imperial
            const testPerson = {
                weightKg: 70,
                weightLbs: 154.32, // 70 * 2.20462
                heightCm: 175,
                heightInches: 68.9, // 175 / 2.54
                age: 30,
                gender: 'male'
            };
            
            console.log('üìä BMR_UNIT_TEST: Test person:', testPerson);
            
            // Calculate BMR using both unit systems
            const bmrMetric = calculateBMRMifflinStJeor(testPerson.weightKg, testPerson.heightCm, testPerson.age, testPerson.gender, 'metric');
            const bmrImperial = calculateBMRMifflinStJeor(testPerson.weightLbs, testPerson.heightInches, testPerson.age, testPerson.gender, 'imperial');
            
            console.log(`üìä BMR_UNIT_TEST: Metric BMR: ${bmrMetric?.toFixed(2)}`);
            console.log(`üìä BMR_UNIT_TEST: Imperial BMR: ${bmrImperial?.toFixed(2)}`);
            
            const difference = Math.abs(bmrMetric - bmrImperial);
            console.log(`üìä BMR_UNIT_TEST: Difference: ${difference.toFixed(2)} calories`);
            
            const tolerance = 2; // Allow 2 calorie difference due to rounding
            const passed = difference <= tolerance;
            
            console.log('='.repeat(50));
            if (passed) {
                console.log('‚úÖ BMR_UNIT_TEST: PASSED - Unit conversions are consistent');
            } else {
                console.log('‚ùå BMR_UNIT_TEST: FAILED - Unit conversion inconsistency detected');
            }
            
            return passed;
        }
        
        // BMR test button removed as requested

        // ========================================
        // ENHANCED CALORIE TRACKING TEST FUNCTIONS
        // ========================================
        
        function testEnhancedCalorieTracking() {
            console.log('üß™ ENHANCED_TEST: Starting enhanced calorie tracking test');
            console.log('='.repeat(60));
            
            let allTestsPassed = true;
            
            // Test 1: Goal Setting Functions
            console.log('\nüß™ TEST 1: Goal Setting Functions');
            try {
                // Test goal calculations
                weightLossGoals = { weeklyLoss: 1, dailyDeficit: 500 };
                weeklyDeficitGoal = 3500;
                dailyCalorieTarget = 1800;
                
                console.log('‚úÖ Goal variables initialized successfully');
                
                // Test modal functions exist
                if (typeof openGoalSettingModal === 'function' &&
                    typeof closeGoalSettingModal === 'function' &&
                    typeof updateGoalCalculations === 'function') {
                    console.log('‚úÖ Goal setting modal functions exist');
                } else {
                    throw new Error('Goal setting modal functions missing');
                }
                
            } catch (error) {
                console.log('‚ùå TEST 1 FAILED:', error.message);
                allTestsPassed = false;
            }
            
            // Test 2: Weekly Deficit Calculations
            console.log('\nüß™ TEST 2: Weekly Deficit Calculations');
            try {
                const testWeek = getCurrentWeekDates();
                if (testWeek.length === 7) {
                    console.log('‚úÖ Weekly date calculation works');
                } else {
                    throw new Error('Weekly date calculation failed');
                }
                
                // Test deficit calculation with mock data
                const mockWeeklyData = calculateWeeklyDeficit(testWeek);
                if (typeof mockWeeklyData.totalDeficit === 'number' &&
                    Array.isArray(mockWeeklyData.dailyDeficits)) {
                    console.log('‚úÖ Weekly deficit calculation works');
                } else {
                    throw new Error('Weekly deficit calculation failed');
                }
                
            } catch (error) {
                console.log('‚ùå TEST 2 FAILED:', error.message);
                allTestsPassed = false;
            }
            
            // Test 3: UI Elements Exist
            console.log('\nüß™ TEST 3: UI Elements');
            const requiredElements = [
                'goalSettingModal',
                'goalExplanationModal',
                'weeklyDeficitCurrent',
                'weeklyDeficitGoal',
                'weeklyDeficitProgressBar',
                'calorieGoal',
                'goalSource'
            ];
            
            let missingElements = [];
            requiredElements.forEach(elementId => {
                if (!document.getElementById(elementId)) {
                    missingElements.push(elementId);
                }
            });
            
            if (missingElements.length === 0) {
                console.log('‚úÖ All required UI elements exist');
            } else {
                console.log('‚ùå Missing UI elements:', missingElements);
                allTestsPassed = false;
            }
            
            // Test 4: Goal Explanation Function
            console.log('\nüß™ TEST 4: Goal Explanation');
            try {
                if (typeof showGoalExplanation === 'function' &&
                    typeof closeGoalExplanationModal === 'function') {
                    console.log('‚úÖ Goal explanation functions exist');
                } else {
                    throw new Error('Goal explanation functions missing');
                }
            } catch (error) {
                console.log('‚ùå TEST 4 FAILED:', error.message);
                allTestsPassed = false;
            }
            
            // Test 5: Integration with Existing Functions
            console.log('\nüß™ TEST 5: Integration Test');
            try {
                // Test that enhanced functions don't break existing functionality
                if (typeof updateWeightDisplay === 'function' &&
                    typeof updateDailySummary === 'function' &&
                    typeof updateWeeklyDeficitDisplay === 'function') {
                    console.log('‚úÖ Integration functions exist');
                    
                    // Test calling the functions (they should not throw errors)
                    updateWeeklyDeficitDisplay();
                    console.log('‚úÖ Weekly deficit display function works');
                } else {
                    throw new Error('Integration functions missing');
                }
            } catch (error) {
                console.log('‚ùå TEST 5 FAILED:', error.message);
                allTestsPassed = false;
            }
            
            // Test 6: LocalStorage Integration
            console.log('\nüß™ TEST 6: LocalStorage Integration');
            try {
                // Test saving and loading goals
                const testGoals = {
                    weeklyLoss: 1.5,
                    dailyDeficit: 750,
                    dailyTarget: 1500,
                    weeklyDeficitGoal: 5250
                };
                
                localStorage.setItem('weightLossGoals', JSON.stringify(testGoals));
                const loadedGoals = JSON.parse(localStorage.getItem('weightLossGoals'));
                
                if (loadedGoals.weeklyLoss === testGoals.weeklyLoss) {
                    console.log('‚úÖ LocalStorage integration works');
                } else {
                    throw new Error('LocalStorage integration failed');
                }
                
                // Restore original goals
                localStorage.setItem('weightLossGoals', JSON.stringify(weightLossGoals));
                
            } catch (error) {
                console.log('‚ùå TEST 6 FAILED:', error.message);
                allTestsPassed = false;
            }
            
            console.log('\n' + '='.repeat(60));
            if (allTestsPassed) {
                console.log('üéâ ALL ENHANCED CALORIE TRACKING TESTS PASSED!');
                console.log('‚úÖ Enhanced calorie tracking system is working correctly');
                console.log('\nüìã Features Available:');
                console.log('‚Ä¢ Enhanced daily goal display with explanations');
                console.log('‚Ä¢ Weekly deficit tracking with 7-day breakdown');
                console.log('‚Ä¢ Smart calorie recommendations based on goals');
                console.log('‚Ä¢ Goal setting modal with preset options');
                console.log('‚Ä¢ Weekly deficit progress bar and visualization');
                console.log('‚Ä¢ Full integration with existing weight tracking');
            } else {
                console.log('‚ö†Ô∏è SOME ENHANCED CALORIE TRACKING TESTS FAILED!');
                console.log('‚ùå Check individual test results above for details');
            }
            console.log('='.repeat(60));
            
            return allTestsPassed;
        }
        
        // Enhanced tracking test button removed as requested

        // ========================================
        // ENHANCED CALORIE TRACKING FUNCTIONS
        // ========================================
        
        // Global variables for enhanced tracking
        let weeklyDeficitGoal = 3500; // Default: 1 lb per week
        let dailyCalorieTarget = 0;
        let weeklyDeficitData = JSON.parse(localStorage.getItem('weeklyDeficitData') || '{}');
        let weightLossGoals = JSON.parse(localStorage.getItem('weightLossGoals') || '{"weeklyLoss": 1, "dailyDeficit": 500}');
        
        // Goal Setting Modal Functions
        function openGoalSettingModal() {
            console.log('üéØ GOAL: Opening goal setting modal');
            
            // Update current stats display
            updateGoalModalStats();
            
            // Set current selection
            const currentGoal = weightLossGoals.weeklyLoss;
            const radioButtons = document.querySelectorAll('input[name="weightLossGoal"]');
            radioButtons.forEach(radio => {
                if (parseFloat(radio.value) === currentGoal) {
                    radio.checked = true;
                }
            });
            
            // Update calculations
            updateGoalCalculations();
            
            document.getElementById('goalSettingModal').classList.add('active');
        }
        
        function closeGoalSettingModal() {
            document.getElementById('goalSettingModal').classList.remove('active');
        }
        
        function updateGoalModalStats() {
            const dateKey = formatDateKey(selectedDate);
            const weightData = weightByDate[dateKey] || getRecentWeightData();
            
            // Update current stats
            document.getElementById('goalCurrentWeight').textContent = weightData ?
                (userUnitSystem === 'metric' ? (lbsToKg(weightData.weight)).toFixed(1) + ' kg' : weightData.weight.toFixed(1) + ' lbs') : '--';
            document.getElementById('goalCurrentBMR').textContent = weightData && weightData.bmrMifflin ?
                Math.round(weightData.bmrMifflin) + ' cal/day' : '--';
            document.getElementById('goalCurrentGoal').textContent = userCalorieGoal > 0 ?
                userCalorieGoal.toLocaleString() + ' cal/day' : 'Not set';
            document.getElementById('goalCurrentDeficit').textContent = weightLossGoals.dailyDeficit + ' cal/day';
            
            // Show/hide nursing mother warning
            const nursingWarning = document.getElementById('nursingGoalWarning');
            if (nursingWarning) {
                if (weightData && weightData.isNursing) {
                    nursingWarning.classList.remove('hidden');
                    console.log('ü§± GOAL_MODAL: Showing nursing mother guidance');
                } else {
                    nursingWarning.classList.add('hidden');
                }
            }
        }
        
        function updateGoalCalculations() {
            const selectedGoal = document.querySelector('input[name="weightLossGoal"]:checked');
            const customSection = document.getElementById('customGoalSection');
            
            if (!selectedGoal) return;
            
            let weeklyLoss, dailyDeficit, dailyTarget;
            
            if (selectedGoal.value === 'custom') {
                customSection.classList.remove('hidden');
                const customGoal = parseInt(document.getElementById('customCalorieGoal').value);
                if (customGoal > 0) {
                    dailyTarget = customGoal;
                    // Calculate deficit based on BMR/TDEE
                    const weightData = getRecentWeightData();
                    if (weightData && weightData.bmrMifflin) {
                        const estimatedTDEE = weightData.bmrMifflin * 1.4; // Moderate activity
                        dailyDeficit = Math.max(0, estimatedTDEE - customGoal);
                        weeklyLoss = (dailyDeficit * 7) / 3500;
                    } else {
                        dailyDeficit = 0;
                        weeklyLoss = 0;
                    }
                } else {
                    dailyTarget = 0;
                    dailyDeficit = 0;
                    weeklyLoss = 0;
                }
            } else {
                customSection.classList.add('hidden');
                weeklyLoss = parseFloat(selectedGoal.value);
                dailyDeficit = weeklyLoss * 500; // 500 cal per lb
                
                // Calculate daily target based on BMR/TDEE
                const weightData = getRecentWeightData();
                if (weightData && weightData.bmrMifflin) {
                    const estimatedTDEE = weightData.bmrMifflin * 1.4; // Moderate activity
                    dailyTarget = Math.round(estimatedTDEE - dailyDeficit);
                } else {
                    dailyTarget = 2000 - dailyDeficit; // Fallback
                }
            }
            
            // Update preview
            document.getElementById('previewDailyTarget').textContent = dailyTarget > 0 ? dailyTarget.toLocaleString() + ' cal' : '--';
            document.getElementById('previewWeeklyDeficit').textContent = Math.round(dailyDeficit * 7).toLocaleString() + ' cal';
            document.getElementById('previewWeeklyLoss').textContent = weeklyLoss.toFixed(1) + ' lbs';
            document.getElementById('previewDailyDeficit').textContent = Math.round(dailyDeficit) + ' cal';
            
            // Update explanation
            const explanation = `To lose ${weeklyLoss.toFixed(1)} lbs per week, you need a deficit of ${Math.round(dailyDeficit * 7).toLocaleString()} calories per week (${Math.round(dailyDeficit)} per day). Your daily calorie target is ${dailyTarget.toLocaleString()} calories.`;
            document.getElementById('goalExplanation').textContent = explanation;
        }
        
        function saveWeightLossGoals() {
            const selectedGoal = document.querySelector('input[name="weightLossGoal"]:checked');
            if (!selectedGoal) {
                alert('Please select a weight loss goal');
                return;
            }
            
            let weeklyLoss, dailyDeficit, dailyTarget;
            
            if (selectedGoal.value === 'custom') {
                const customGoal = parseInt(document.getElementById('customCalorieGoal').value);
                if (!customGoal || customGoal < 1000) {
                    alert('Please enter a valid daily calorie goal (minimum 1000 calories)');
                    return;
                }
                dailyTarget = customGoal;
                
                // Calculate deficit based on BMR/TDEE
                const weightData = getRecentWeightData();
                if (weightData && weightData.bmrMifflin) {
                    const estimatedTDEE = weightData.bmrMifflin * 1.4;
                    dailyDeficit = Math.max(0, estimatedTDEE - customGoal);
                    weeklyLoss = (dailyDeficit * 7) / 3500;
                } else {
                    dailyDeficit = 0;
                    weeklyLoss = 0;
                }
            } else {
                weeklyLoss = parseFloat(selectedGoal.value);
                dailyDeficit = weeklyLoss * 500;
                
                const weightData = getRecentWeightData();
                if (weightData && weightData.bmrMifflin) {
                    const estimatedTDEE = weightData.bmrMifflin * 1.4;
                    dailyTarget = Math.round(estimatedTDEE - dailyDeficit);
                } else {
                    dailyTarget = 2000 - dailyDeficit;
                }
            }
            
            // MINIMUM CALORIE SAFETY VALIDATION
            console.log('üõ°Ô∏è SAFETY: Validating minimum calorie requirements');
            
            // Check if user is currently nursing
            const weightData = getRecentWeightData();
            const isNursing = weightData && weightData.isNursing;
            const minCalories = isNursing ? 1800 : 1200;
            
            console.log('üõ°Ô∏è SAFETY: User nursing status:', isNursing);
            console.log('üõ°Ô∏è SAFETY: Minimum calories required:', minCalories);
            console.log('üõ°Ô∏è SAFETY: Proposed daily target:', dailyTarget);
            
            if (dailyTarget < minCalories) {
                console.log('‚ùå SAFETY: Calorie goal too low, showing safety warning');
                
                // Create safety warning modal
                const safetyWarning = document.createElement('div');
                safetyWarning.id = 'caloriesSafetyModal';
                safetyWarning.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                safetyWarning.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                        <div class="text-center mb-6">
                            <div class="text-red-600 text-5xl mb-3">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Unsafe Calorie Goal</h3>
                            <p class="text-gray-600">
                                ${isNursing ?
                                    `As a nursing mother, you need at least <strong>1,800 calories per day</strong> to maintain milk production and your health. Your proposed goal of ${dailyTarget.toLocaleString()} calories is too low.` :
                                    `For safe and sustainable weight loss, you need at least <strong>1,200 calories per day</strong>. Your proposed goal of ${dailyTarget.toLocaleString()} calories is too low.`
                                }
                            </p>
                        </div>
                        
                        <div class="bg-${isNursing ? 'pink' : 'yellow'}-50 border-l-4 border-${isNursing ? 'pink' : 'yellow'}-500 p-4 rounded mb-6">
                            <div class="text-sm">
                                <p class="font-semibold text-${isNursing ? 'pink' : 'yellow'}-800 mb-2">
                                    ${isNursing ? 'ü§± Important for Nursing Mothers:' : '‚öñÔ∏è Safe Weight Loss Guidelines:'}
                                </p>
                                <ul class="text-${isNursing ? 'pink' : 'yellow'}-700 space-y-1">
                                    ${isNursing ? `
                                        <li>‚Ä¢ Minimum 1,800 calories daily for milk production</li>
                                        <li>‚Ä¢ Gradual weight loss of 1-2 lbs per week maximum</li>
                                        <li>‚Ä¢ Focus on nutrient-dense foods</li>
                                        <li>‚Ä¢ Consult your healthcare provider</li>
                                    ` : `
                                        <li>‚Ä¢ Minimum 1,200 calories daily for basic body functions</li>
                                        <li>‚Ä¢ Sustainable weight loss of 1-2 lbs per week</li>
                                        <li>‚Ä¢ Maintain adequate nutrition</li>
                                        <li>‚Ä¢ Consider consulting a nutritionist</li>
                                    `}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="adjustToSafeCalories(${minCalories})" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                ‚úÖ Set Safe Goal (${minCalories.toLocaleString()} calories)
                            </button>
                            <button onclick="closeSafetyModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Cancel & Revise
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(safetyWarning);
                return; // Stop the goal saving process
            }
            
            console.log('‚úÖ SAFETY: Calorie goal passes safety validation');
            
            // Save goals
            weightLossGoals = {
                weeklyLoss: weeklyLoss,
                dailyDeficit: dailyDeficit,
                dailyTarget: dailyTarget,
                weeklyDeficitGoal: dailyDeficit * 7,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('weightLossGoals', JSON.stringify(weightLossGoals));
            
            // Update global variables
            weeklyDeficitGoal = weightLossGoals.weeklyDeficitGoal;
            dailyCalorieTarget = dailyTarget;
            userCalorieGoal = dailyTarget;
            localStorage.setItem('userCalorieGoal', userCalorieGoal.toString());
            
            // Update displays
            updateWeightDisplay();
            updateWeeklyDeficitDisplay();
            
            closeGoalSettingModal();
            showSuccessMessage(`üéØ Goals saved! Target: ${dailyTarget.toLocaleString()} cal/day for ${weeklyLoss.toFixed(1)} lbs/week loss`);
        }
        
        // Minimum Calorie Safety Functions
        function adjustToSafeCalories(minCalories) {
            console.log('üõ°Ô∏è SAFETY: Adjusting to safe calorie goal:', minCalories);
            
            // Close safety modal
            closeSafetyModal();
            
            // Calculate safe goals based on minimum calories
            const weightData = getRecentWeightData();
            let weeklyLoss, dailyDeficit;
            
            if (weightData && weightData.bmrMifflin) {
                const estimatedTDEE = weightData.bmrMifflin * 1.4;
                dailyDeficit = Math.max(0, estimatedTDEE - minCalories);
                weeklyLoss = (dailyDeficit * 7) / 3500;
            } else {
                // Fallback calculation
                const estimatedTDEE = 2000; // Conservative estimate
                dailyDeficit = Math.max(0, estimatedTDEE - minCalories);
                weeklyLoss = (dailyDeficit * 7) / 3500;
            }
            
            // Save the safe goals
            weightLossGoals = {
                weeklyLoss: weeklyLoss,
                dailyDeficit: dailyDeficit,
                dailyTarget: minCalories,
                weeklyDeficitGoal: dailyDeficit * 7,
                lastUpdated: new Date().toISOString(),
                safetyAdjusted: true // Flag to indicate this was safety-adjusted
            };
            
            localStorage.setItem('weightLossGoals', JSON.stringify(weightLossGoals));
            
            // Update global variables
            weeklyDeficitGoal = weightLossGoals.weeklyDeficitGoal;
            dailyCalorieTarget = minCalories;
            userCalorieGoal = minCalories;
            localStorage.setItem('userCalorieGoal', userCalorieGoal.toString());
            
            // Update displays
            updateWeightDisplay();
            updateWeeklyDeficitDisplay();
            
            closeGoalSettingModal();
            
            const isNursing = weightData && weightData.isNursing;
            showSuccessMessage(`üõ°Ô∏è Safe goal set! ${minCalories.toLocaleString()} cal/day for ${weeklyLoss.toFixed(1)} lbs/week loss${isNursing ? ' (nursing-safe)' : ''}`);
        }
        
        function closeSafetyModal() {
            const modal = document.getElementById('caloriesSafetyModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // BMR Explanation Function for Nursing Mothers
        function showBMRExplanation() {
            console.log('üí° BMR_EXPLAIN: Opening BMR explanation for nursing mothers');
            
            const weightData = getRecentWeightData();
            if (!weightData || !weightData.isNursing) {
                console.log('‚ö†Ô∏è BMR_EXPLAIN: Not a nursing mother, showing general BMR info');
                showGoalExplanation(); // Fallback to general explanation
                return;
            }
            
            const bmr = Math.round(weightData.bmrMifflin);
            const baseBMR = Math.round(weightData.bmrMifflin - 400); // BMR without nursing adjustment
            
            // Create nursing BMR explanation modal
            const explanationModal = document.createElement('div');
            explanationModal.id = 'nursingBMRModal';
            explanationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            explanationModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">ü§± Your Nursing Mother BMR</h3>
                        <button onclick="closeNursingBMRModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-pink-50 border-l-4 border-pink-500 p-4 rounded">
                            <h4 class="font-semibold text-pink-800 mb-2">üî• Your BMR: ${bmr.toLocaleString()} calories/day</h4>
                            <div class="text-sm text-pink-700">
                                <p><strong>Base BMR:</strong> ${baseBMR.toLocaleString()} calories</p>
                                <p><strong>Nursing Adjustment:</strong> +400 calories</p>
                                <p class="mt-2">This includes the extra energy needed for milk production!</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <h5 class="font-semibold text-gray-800">ü§± Why the Extra 400 Calories?</h5>
                                <div class="text-sm text-gray-600 mt-1">
                                    <p>Breastfeeding burns approximately 300-500 calories per day. We use 400 calories as a middle estimate to ensure adequate energy for:</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1">
                                        <li>Milk production and quality</li>
                                        <li>Maintaining your energy levels</li>
                                        <li>Supporting your recovery and health</li>
                                        <li>Ensuring adequate nutrition for both you and baby</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="font-semibold text-gray-800">üìä Your Total Daily Needs:</h5>
                                <div class="text-sm text-gray-600 mt-1">
                                    <p><strong>BMR:</strong> ${bmr.toLocaleString()} cal (basic body functions + nursing)</p>
                                    <p><strong>With light activity:</strong> ${Math.round(bmr * 1.375).toLocaleString()} cal</p>
                                    <p><strong>With moderate activity:</strong> ${Math.round(bmr * 1.55).toLocaleString()} cal</p>
                                    <p><strong>With active lifestyle:</strong> ${Math.round(bmr * 1.725).toLocaleString()} cal</p>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <h5 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Important Safety Guidelines:</h5>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>‚Ä¢ Never eat less than 1,800 calories per day while nursing</li>
                                    <li>‚Ä¢ Gradual weight loss of 1-2 lbs per week maximum</li>
                                    <li>‚Ä¢ Focus on nutrient-dense foods for milk quality</li>
                                    <li>‚Ä¢ Stay well-hydrated (extra water for milk production)</li>
                                    <li>‚Ä¢ Consult your healthcare provider before starting any diet</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="openGoalSettingModal(); closeNursingBMRModal();" class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                üéØ Set Safe Goals
                            </button>
                            <button onclick="closeNursingBMRModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                                Got It
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(explanationModal);
        }
        
        function closeNursingBMRModal() {
            const modal = document.getElementById('nursingBMRModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Goal Explanation Modal Functions
        function showGoalExplanation() {
            console.log('üí° EXPLAIN: Opening goal explanation modal');
            
            const currentGoal = userCalorieGoal || dailyCalorieTarget || 2000;
            const weightData = getRecentWeightData();
            
            // Update explanation content
            document.getElementById('explainCurrentGoal').textContent = currentGoal.toLocaleString() + ' calories/day';
            
            // Determine goal source
            let goalSource = 'Manually set';
            if (weightData && weightData.bmrMifflin && userCalorieGoal === 0) {
                goalSource = 'Auto-calculated from BMR and activity level';
            } else if (weightLossGoals.dailyTarget > 0) {
                goalSource = `Based on ${weightLossGoals.weeklyLoss} lbs/week weight loss goal`;
            }
            document.getElementById('explainGoalSource').textContent = goalSource;
            
            // Calculation explanation
            let calculation = 'This goal is set to help you maintain or lose weight based on your personal metrics.';
            if (weightData && weightData.bmrMifflin) {
                const bmr = Math.round(weightData.bmrMifflin);
                const estimatedTDEE = Math.round(bmr * 1.4);
                calculation = `Your BMR is ${bmr} cal/day. With moderate activity, your TDEE is approximately ${estimatedTDEE} cal/day. Your goal creates a ${Math.round(estimatedTDEE - currentGoal)} calorie deficit.`;
            }
            document.getElementById('explainCalculation').textContent = calculation;
            
            // BMR explanation
            let bmrText = 'BMR data not available. Log your weight, height, age, and gender to see personalized calculations.';
            if (weightData && weightData.bmrMifflin) {
                bmrText = `${Math.round(weightData.bmrMifflin)} calories/day - This is what your body burns at rest for basic functions like breathing and circulation.`;
            }
            document.getElementById('explainBMR').textContent = bmrText;
            
            // Weekly goal explanation
            const weeklyDeficit = weightLossGoals.weeklyDeficitGoal || 3500;
            const expectedLoss = weeklyDeficit / 3500;
            document.getElementById('explainWeeklyGoal').textContent =
                `${weeklyDeficit.toLocaleString()} calories per week deficit for ${expectedLoss.toFixed(1)} lbs weight loss per week.`;
            
            document.getElementById('goalExplanationModal').classList.add('active');
        }
        
        function closeGoalExplanationModal() {
            document.getElementById('goalExplanationModal').classList.remove('active');
        }
        
        // Weekly Deficit Tracking Functions
        function updateWeeklyDeficitDisplay() {
            console.log('üìà WEEKLY: Updating weekly deficit display');
            
            const currentWeek = getCurrentWeekDates();
            const weeklyData = calculateWeeklyDeficit(currentWeek);
            
            // Update week display
            const startDate = currentWeek[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endDate = currentWeek[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('weeklyDeficitDate').textContent = `${startDate} - ${endDate}`;
            
            // Update totals
            document.getElementById('weeklyDeficitCurrent').textContent = Math.round(weeklyData.totalDeficit).toLocaleString();
            document.getElementById('weeklyDeficitGoal').textContent = weeklyDeficitGoal.toLocaleString();
            document.getElementById('dailyDeficitAvg').textContent = Math.round(weeklyDeficitGoal / 7);
            
            // Update progress bar
            const progressPercent = Math.min(100, (weeklyData.totalDeficit / weeklyDeficitGoal) * 100);
            document.getElementById('weeklyDeficitPercent').textContent = Math.round(progressPercent) + '%';
            document.getElementById('weeklyDeficitProgressBar').style.width = progressPercent + '%';
            
            // Update daily breakdown
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            weeklyData.dailyDeficits.forEach((deficit, index) => {
                const dayElement = document.getElementById(`dayDeficitValue${index}`);
                if (dayElement) {
                    if (deficit === null) {
                        dayElement.textContent = '--';
                        dayElement.parentElement.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100');
                        dayElement.parentElement.classList.add('bg-white');
                    } else {
                        dayElement.textContent = deficit >= 0 ? '+' + Math.round(deficit) : Math.round(deficit);
                        
                        // Color coding
                        dayElement.parentElement.classList.remove('bg-green-100', 'bg-red-100', 'bg-yellow-100', 'bg-white');
                        if (deficit >= (weeklyDeficitGoal / 7) * 0.8) {
                            dayElement.parentElement.classList.add('bg-green-100');
                        } else if (deficit >= 0) {
                            dayElement.parentElement.classList.add('bg-yellow-100');
                        } else {
                            dayElement.parentElement.classList.add('bg-red-100');
                        }
                    }
                }
            });
        }
        
        function getCurrentWeekDates() {
            const today = new Date(selectedDate);
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust to make Monday = 0
            
            const monday = new Date(today);
            monday.setDate(today.getDate() + mondayOffset);
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date);
            }
            
            return weekDates;
        }
        
        function calculateWeeklyDeficit(weekDates) {
            let totalDeficit = 0;
            const dailyDeficits = [];
            
            weekDates.forEach(date => {
                const dateKey = formatDateKey(date);
                const dayMeals = mealsByDate[dateKey] || [];
                const dayExercise = exerciseByDate[dateKey] || [];
                
                // Calculate day's calories
                const consumedCalories = dayMeals.reduce((sum, meal) => sum + meal.nutrition.calories, 0);
                const burnedCalories = dayExercise.reduce((sum, exercise) => sum + exercise.calories, 0);
                const netCalories = consumedCalories - burnedCalories;
                
                // Calculate deficit (positive = deficit, negative = surplus)
                const targetCalories = dailyCalorieTarget || userCalorieGoal || 2000;
                const dayDeficit = targetCalories - netCalories;
                
                if (consumedCalories > 0 || burnedCalories > 0) {
                    // Only count days with logged data
                    dailyDeficits.push(dayDeficit);
                    totalDeficit += dayDeficit;
                } else {
                    dailyDeficits.push(null); // No data for this day
                }
            });
            
            return {
                totalDeficit: totalDeficit,
                dailyDeficits: dailyDeficits,
                averageDeficit: dailyDeficits.filter(d => d !== null).length > 0 ?
                    totalDeficit / dailyDeficits.filter(d => d !== null).length : 0
            };
        }
        
        function getRecentWeightData() {
            const dateKey = formatDateKey(selectedDate);
            if (weightByDate[dateKey]) {
                return weightByDate[dateKey];
            }
            
            // Find most recent weight entry
            const sortedDates = Object.keys(weightByDate).sort().reverse();
            const recentDate = sortedDates.find(date => date <= dateKey);
            return recentDate ? weightByDate[recentDate] : null;
        }
        
        // Enhanced updateWeightDisplay function to include goal source
        const originalUpdateWeightDisplay = updateWeightDisplay;
        updateWeightDisplay = function() {
            originalUpdateWeightDisplay();
            
            // Update goal source display
            const goalSourceEl = document.getElementById('goalSource');
            const exerciseStatusEl = document.getElementById('exerciseAdjustmentStatus');
            if (goalSourceEl) {
                let sourceText = '';
                if (weightLossGoals.dailyTarget > 0) {
                    sourceText = `${weightLossGoals.weeklyLoss} lbs/week goal`;
                } else if (userCalorieGoal > 0) {
                    sourceText = 'Manually set';
                } else {
                    sourceText = 'Auto-calculated';
                }
                goalSourceEl.textContent = sourceText;
            }
            
            // Update exercise adjustment status
            if (exerciseStatusEl) {
                const safeDate = getSafeSelectedDate();
                const dateKey = formatDateKey(safeDate);
                const goalData = getAdjustedCalorieGoal(dateKey);
                if (exerciseCalorieSettings.eatBackExercise) {
                    if (goalData.exerciseCalories > 0) {
                        exerciseStatusEl.textContent = `+${goalData.eatBackAmount} from exercise (${exerciseCalorieSettings.eatBackPercentage}%)`;
                        exerciseStatusEl.className = 'text-xs text-green-600 mt-1';
                    } else {
                        exerciseStatusEl.textContent = `Exercise adjustment enabled (${exerciseCalorieSettings.eatBackPercentage}%)`;
                        exerciseStatusEl.className = 'text-xs text-blue-600 mt-1';
                    }
                } else {
                    exerciseStatusEl.textContent = 'Fixed goal (no exercise adjustment)';
                    exerciseStatusEl.className = 'text-xs text-gray-500 mt-1';
                }
            }
            
            // Update weekly deficit display
            updateWeeklyDeficitDisplay();
        };
        
        // Enhanced tracking initialization moved to consolidated initialization
        
        // Override the original updateDailySummary to also update weekly tracking
        const originalUpdateDailySummary = updateDailySummary;
        updateDailySummary = function() {
            originalUpdateDailySummary();
            updateWeeklyDeficitDisplay();
        };

        // ========================================
        // MEAL TYPE FUNCTIONALITY
        // ========================================
        
        // Time-based meal type detection
        function setTimeBasedMealType() {
            const now = new Date();
            const hour = now.getHours();
            const mealTypeSelector = document.getElementById('mealTypeSelector');
            
            let mealType;
            if (hour >= 5 && hour < 10) {
                mealType = 'Breakfast';
            } else if (hour >= 10 && hour < 12) {
                mealType = 'Morning Snack';
            } else if (hour >= 12 && hour < 15) {
                mealType = 'Lunch';
            } else if (hour >= 15 && hour < 18) {
                mealType = 'Evening Snack';
            } else if (hour >= 18 && hour < 20) {
                mealType = 'Dessert';
            } else {
                mealType = 'Dinner';
            }
            
            if (mealTypeSelector) {
                mealTypeSelector.value = mealType;
                showSuccessMessage(`üïê Auto-selected ${mealType} based on current time (${hour}:${now.getMinutes().toString().padStart(2, '0')})`);
            }
        }
        
        // Get selected meal type from modal
        function getSelectedMealType() {
            const mealTypeSelector = document.getElementById('mealTypeSelector');
            return mealTypeSelector ? mealTypeSelector.value : 'Lunch';
        }

        // Goal Setting Modal
        /*
        <div id="goalSettingModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">üéØ Set Your Weight Loss Goals</h3>
                <button onclick="closeGoalSettingModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-6">
                <!-- Nursing Mother Warning (shown conditionally) -->
                <div id="nursingGoalWarning" class="hidden bg-pink-50 border-l-4 border-pink-500 p-4 rounded">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <span class="text-pink-600 text-2xl">ü§±</span>
                        </div>
                        <div class="ml-3">
                            <h4 class="font-semibold text-pink-800 mb-2">Important Guidelines for Nursing Mothers</h4>
                            <div class="text-sm text-pink-700 space-y-2">
                                <p><strong>Minimum Daily Calories:</strong> 1,800 calories (never go below this)</p>
                                <p><strong>Maximum Weight Loss:</strong> 1-2 lbs per week (gradual is safer)</p>
                                <p><strong>Your BMR includes:</strong> +400 calories for milk production</p>
                                <p><strong>Focus on:</strong> Nutrient-dense foods and adequate hydration</p>
                                <div class="mt-3 p-2 bg-pink-100 rounded text-xs">
                                    <strong>‚ö†Ô∏è Safety Note:</strong> Consult your healthcare provider before starting any weight loss program while nursing.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Stats Display -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">üìä Current Stats</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>Current Weight: <span class="font-semibold" id="goalCurrentWeight">--</span></div>
                        <div>BMR: <span class="font-semibold" id="goalCurrentBMR">--</span></div>
                        <div>Current Goal: <span class="font-semibold" id="goalCurrentGoal">--</span></div>
                        <div>Daily Deficit: <span class="font-semibold" id="goalCurrentDeficit">--</span></div>
                    </div>
                </div>
                
                <!-- Weight Loss Goal Selection -->
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">üéØ Weekly Weight Loss Goal</h4>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="weightLossGoal" value="0.5" class="mr-3" onchange="updateGoalCalculations()">
                            <div class="flex-1">
                                <div class="font-medium">0.5 lbs per week (Conservative)</div>
                                <div class="text-sm text-gray-600">250 calories deficit per day</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="weightLossGoal" value="1" class="mr-3" onchange="updateGoalCalculations()" checked>
                            <div class="flex-1">
                                <div class="font-medium">1 lb per week (Recommended)</div>
                                <div class="text-sm text-gray-600">500 calories deficit per day</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="weightLossGoal" value="1.5" class="mr-3" onchange="updateGoalCalculations()">
                            <div class="flex-1">
                                <div class="font-medium">1.5 lbs per week (Aggressive)</div>
                                <div class="text-sm text-gray-600">750 calories deficit per day</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="weightLossGoal" value="2" class="mr-3" onchange="updateGoalCalculations()">
                            <div class="flex-1">
                                <div class="font-medium">2 lbs per week (Maximum)</div>
                                <div class="text-sm text-gray-600">1000 calories deficit per day</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="weightLossGoal" value="custom" class="mr-3" onchange="updateGoalCalculations()">
                            <div class="flex-1">
                                <div class="font-medium">Custom Goal</div>
                                <div class="text-sm text-gray-600">Set your own daily calorie target</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Custom Goal Input -->
                <div id="customGoalSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Daily Calorie Goal:</label>
                    <input type="number" id="customCalorieGoal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., 1800" min="1000" max="4000" step="50" onchange="updateGoalCalculations()">
                </div>
                
                <!-- Goal Calculations Preview -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-3">üìà Your New Goals</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>Daily Calorie Target: <span class="font-semibold text-blue-700" id="previewDailyTarget">--</span></div>
                        <div>Weekly Deficit Goal: <span class="font-semibold text-blue-700" id="previewWeeklyDeficit">--</span></div>
                        <div>Expected Weekly Loss: <span class="font-semibold text-blue-700" id="previewWeeklyLoss">--</span></div>
                        <div>Deficit per Day: <span class="font-semibold text-blue-700" id="previewDailyDeficit">--</span></div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-white rounded border">
                        <div class="text-xs text-gray-600 mb-2">üí° How this works:</div>
                        <div class="text-xs text-gray-700" id="goalExplanation">
                            To lose 1 lb per week, you need a deficit of 3,500 calories per week (500 per day).
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveWeightLossGoals()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        üéØ Save Goals
                    </button>
                    <button onclick="closeGoalSettingModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal Explanation Modal -->
    <div id="goalExplanationModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">üí° Daily Calorie Goal Explanation</h3>
                <button onclick="closeGoalExplanationModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <h4 class="font-semibold text-blue-800 mb-2">üéØ Your Current Goal: <span id="explainCurrentGoal">--</span></h4>
                    <div class="text-sm text-blue-700" id="explainGoalSource">--</div>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <h5 class="font-semibold text-gray-800">üìä How it's calculated:</h5>
                        <div class="text-sm text-gray-600 mt-1" id="explainCalculation">--</div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold text-gray-800">üî• Your BMR (Base Metabolic Rate):</h5>
                        <div class="text-sm text-gray-600 mt-1" id="explainBMR">--</div>
                    </div>
                    
                    <div>
                        <h5 class="font-semibold text-gray-800">üìà Weekly Deficit Goal:</h5>
                        <div class="text-sm text-gray-600 mt-1" id="explainWeeklyGoal">--</div>
                    </div>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <h5 class="font-semibold text-green-800 mb-2">üí° Tips for Success:</h5>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>‚Ä¢ Track your food accurately using measurements</li>
                        <li>‚Ä¢ Include exercise to increase your daily calorie allowance</li>
                        <li>‚Ä¢ Aim for a consistent deficit rather than perfection</li>
                        <li>‚Ä¢ Adjust goals if you're losing weight too quickly or slowly</li>
                    </ul>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="openGoalSettingModal(); closeGoalExplanationModal();" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        üéØ Adjust Goals
                    </button>
                    <button onclick="closeGoalExplanationModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        Got It
                    </button>
                </div>
            </div>
        </div>
    </div>


        // ========================================
        // RECIPE MANAGEMENT FUNCTIONS
        // ========================================

        let currentEditingRecipe = null;

        // Open Manage Recipes Modal
        function openManageRecipesModal() {
            document.getElementById('manageRecipesModal').classList.add('active');
            // Clear search box
            const searchBox = document.getElementById('recipeSearchBox');
            if (searchBox) searchBox.value = '';
            loadRecipeList();
        }

        // Close Manage Recipes Modal
        function closeManageRecipesModal() {
            document.getElementById('manageRecipesModal').classList.remove('active');
        }

        // Load and display recipe list
        function loadRecipeList() {
            const customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
            const recipeListContainer = document.getElementById('recipeListContainer');
            const countDisplay = document.getElementById('recipeCountDisplay');
            const emptyState = document.getElementById('emptyRecipeState');
            
            const recipeNames = Object.keys(customRecipes);
            
            if (recipeNames.length === 0) {
                recipeListContainer.innerHTML = '';
                countDisplay.textContent = '';
                emptyState.style.display = 'block';
                return;
            }
            
            // Show total recipe count
            countDisplay.textContent = `${recipeNames.length} recipe${recipeNames.length !== 1 ? 's' : ''} total`;
            emptyState.style.display = 'none';
            
            recipeListContainer.innerHTML = recipeNames.map(recipeName => {
                const recipe = customRecipes[recipeName];
                const totalCalories = recipe.ingredients.reduce((sum, ing) => {
                    const ingredient = rawIngredients[ing.name] || {};
                    return sum + ((ingredient.calories || 0) * (ing.quantity || 0) / 100);
                }, 0);
                const caloriesPerServing = Math.round(totalCalories / (recipe.servings || 1));
                const ingredientCount = recipe.ingredients.length;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">${recipeName}</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <span class="text-orange-500 mr-1">üî•</span>
                                        <span>${caloriesPerServing} cal/serving</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-blue-500 mr-1">üçΩÔ∏è</span>
                                        <span>${recipe.servings || 1} servings</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-1">ü•¨</span>
                                        <span>${ingredientCount} ingredients</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="createFromRecipe('${recipeName}')"
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition duration-200"
                                        title="Create a new recipe using this as a template">
                                    üìã Copy
                                </button>
                                <button onclick="openRecipeEditModal('${recipeName}')"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteRecipeConfirm('${recipeName}')"
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter recipes based on search input
        function filterRecipes() {
            const searchInput = document.getElementById('recipeSearchBox').value.toLowerCase();
            const customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
            const recipeListContainer = document.getElementById('recipeListContainer');
            const countDisplay = document.getElementById('recipeCountDisplay');
            const emptyState = document.getElementById('emptyRecipeState');
            
            // Filter recipes
            const filteredRecipes = Object.keys(customRecipes).filter(recipeName =>
                recipeName.toLowerCase().includes(searchInput)
            );
            
            // Update count display
            if (searchInput.length > 0) {
                countDisplay.textContent = `Found ${filteredRecipes.length} recipe${filteredRecipes.length !== 1 ? 's' : ''} matching "${searchInput}"`;
            } else {
                const totalRecipes = Object.keys(customRecipes).length;
                countDisplay.textContent = totalRecipes > 0 ? `${totalRecipes} recipe${totalRecipes !== 1 ? 's' : ''} total` : '';
            }
            
            // Show empty state if no results
            if (filteredRecipes.length === 0 && searchInput.length > 0) {
                recipeListContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">üîç</div>
                        <p>No recipes found matching "${searchInput}"</p>
                        <p class="text-sm mt-2">Try a different search term</p>
                    </div>
                `;
                emptyState.style.display = 'none';
                return;
            }
            
            // Display filtered recipes
            if (filteredRecipes.length === 0 && searchInput.length === 0) {
                recipeListContainer.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            recipeListContainer.innerHTML = filteredRecipes.map(recipeName => {
                const recipe = customRecipes[recipeName];
                const totalCalories = recipe.ingredients.reduce((sum, ing) => {
                    const ingredient = rawIngredients[ing.name] || {};
                    return sum + ((ingredient.calories || 0) * (ing.quantity || 0) / 100);
                }, 0);
                const caloriesPerServing = Math.round(totalCalories / (recipe.servings || 1));
                const ingredientCount = recipe.ingredients.length;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">${recipeName}</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <span class="text-orange-500 mr-1">üî•</span>
                                        <span>${caloriesPerServing} cal/serving</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-blue-500 mr-1">üçΩÔ∏è</span>
                                        <span>${recipe.servings || 1} servings</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-1">ü•¨</span>
                                        <span>${ingredientCount} ingredients</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="createFromRecipe('${recipeName}')"
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition duration-200"
                                        title="Create a new recipe using this as a template">
                                    üìã Copy
                                </button>
                                <button onclick="openRecipeEditModal('${recipeName}')"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteRecipeConfirm('${recipeName}')"
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Recipe Edit Modal
        function openRecipeEditModal(recipeName) {
            console.log('üîç RACE_DEBUG: openRecipeEditModal called for:', recipeName);
            console.log('üîç RACE_DEBUG: rawIngredients state:', rawIngredients ? 'LOADED' : 'NOT_LOADED');
            console.log('üîç RACE_DEBUG: rawIngredients keys:', rawIngredients ? Object.keys(rawIngredients).length : 0);
            
            // RACE CONDITION FIX: Check if ingredients are loaded
            if (!rawIngredients || Object.keys(rawIngredients).length === 0) {
                console.log('‚ùå RACE_DEBUG: Ingredients not loaded, loading now...');
                showSuccessMessage('üîÑ Loading ingredients for recipe editor...');
                
                loadDatabases().then(() => {
                    console.log('‚úÖ RACE_DEBUG: Ingredients loaded, retrying recipe edit');
                    openRecipeEditModal(recipeName); // Retry after loading
                }).catch(error => {
                    console.error('‚ùå RACE_DEBUG: Failed to load ingredients:', error);
                    showErrorMessage('Failed to load ingredients: ' + error.message);
                });
                return;
            }
            
            const customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
            const recipe = customRecipes[recipeName];
            
            if (!recipe) {
                console.log('‚ùå RACE_DEBUG: Recipe not found:', recipeName);
                alert('Recipe not found!');
                return;
            }
            
            console.log('‚úÖ RACE_DEBUG: Recipe found, proceeding with modal opening');
            
            currentEditingRecipe = recipeName;
            
            // Populate form fields
            document.getElementById('editRecipeName').value = recipeName;
            document.getElementById('editRecipeServings').value = recipe.servings || 1;
            
            // Load ingredients
            loadEditIngredients(recipe.ingredients);
            
            // Calculate and display nutrition
            updateEditNutrition();
            
            // Show modal
            document.getElementById('recipeEditModal').classList.add('active');
        }

        // Close Recipe Edit Modal
        function closeRecipeEditModal() {
            document.getElementById('recipeEditModal').classList.remove('active');
            currentEditingRecipe = null;
            document.getElementById('editIngredientsContainer').innerHTML = '';
            document.getElementById('editIngredientSearch').value = '';
            document.getElementById('editSelectedIngredientDisplay').classList.add('hidden');
            document.getElementById('editIngredientQuantitySection').classList.add('hidden');
        }

        // Load ingredients into edit form
        function loadEditIngredients(ingredients) {
            const container = document.getElementById('editIngredientsContainer');
            container.innerHTML = '';
            
            ingredients.forEach((ingredient, index) => {
                addEditIngredientRow(ingredient.name, ingredient.quantity, index);
            });
            
            // Add one empty row if no ingredients
            if (ingredients.length === 0) {
                addEditIngredientRow('', '', 0);
            }
        }

        // ========================================
        // ENHANCED RECIPE EDIT INGREDIENT FUNCTIONS
        // ========================================
        
        let editRecipeSelectedIngredient = null;
        
        // Filter ingredients for recipe edit modal
        function filterEditRecipeIngredients() {
            const searchInput = document.getElementById('editIngredientSearch');
            const dropdown = document.getElementById('editIngredientDropdown');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                dropdown.classList.add('hidden');
                return;
            }
            
            // Search through ingredients
            const matchedIngredients = [];
            for (const category in rawIngredients) {
                for (const ingredientKey in rawIngredients[category]) {
                    const ingredient = rawIngredients[category][ingredientKey];
                    if (ingredient.name.toLowerCase().includes(searchTerm)) {
                        matchedIngredients.push({
                            name: ingredient.name,
                            category: category,
                            key: ingredientKey
                        });
                    }
                }
            }
            
            if (matchedIngredients.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-gray-500">No ingredients found</div>';
                dropdown.classList.remove('hidden');
                return;
            }
            
            dropdown.innerHTML = matchedIngredients.map(ing => `
                <div class="p-2 hover:bg-blue-100 cursor-pointer border-b border-gray-200 text-sm"
                     onclick="selectEditRecipeIngredient('${ing.name}', '${ing.category}', '${ing.key}')">
                    <div class="font-medium text-gray-800">${ing.name}</div>
                    <div class="text-xs text-gray-500">${ing.category.replace(/_/g, ' ')}</div>
                </div>
            `).join('');
            
            dropdown.classList.remove('hidden');
        }
        
        // Select ingredient in recipe edit modal
        function selectEditRecipeIngredient(ingredientName, category, key) {
            editRecipeSelectedIngredient = { name: ingredientName, category, key };
            document.getElementById('editIngredientSearch').value = ingredientName;
            document.getElementById('editSelectedIngredientName').textContent = ingredientName;
            document.getElementById('editSelectedIngredientDisplay').classList.remove('hidden');
            document.getElementById('editIngredientQuantitySection').classList.remove('hidden');
            document.getElementById('editAddIngredientBtn').classList.remove('hidden');
            document.getElementById('editIngredientDropdown').classList.add('hidden');
            document.getElementById('editIngredientQuantity').focus();
        }
        
        // Clear selected ingredient in recipe edit modal
        function clearEditIngredientSelection() {
            editRecipeSelectedIngredient = null;
            document.getElementById('editIngredientSearch').value = '';
            document.getElementById('editSelectedIngredientDisplay').classList.add('hidden');
            document.getElementById('editIngredientQuantitySection').classList.add('hidden');
            document.getElementById('editAddIngredientBtn').classList.add('hidden');
            document.getElementById('editIngredientQuantity').value = '1';
        }
        
        // Add selected ingredient to recipe form
        function addEditIngredientToForm() {
            if (!editRecipeSelectedIngredient) {
                showErrorMessage('Please select an ingredient first');
                return;
            }
            
            const quantity = parseFloat(document.getElementById('editIngredientQuantity').value);
            if (!quantity || quantity <= 0) {
                showErrorMessage('Please enter a valid quantity');
                return;
            }
            
            const container = document.getElementById('editIngredientsContainer');
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'flex space-x-3 items-center bg-white p-3 rounded border border-gray-200';
            
            const ingredient = rawIngredients[editRecipeSelectedIngredient.category][editRecipeSelectedIngredient.key];
            
            ingredientRow.innerHTML = `
                <div class="flex-1">
                    <div class="font-medium text-gray-800">${editRecipeSelectedIngredient.name}</div>
                    <div class="text-xs text-gray-500">${quantity}g</div>
                </div>
                <input type="hidden" value="${editRecipeSelectedIngredient.name}">
                <input type="hidden" value="${quantity}">
                <button type="button" onclick="this.parentElement.remove(); updateEditNutrition()"
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                    Remove
                </button>
            `;
            
            container.appendChild(ingredientRow);
            updateEditNutrition();
            clearEditIngredientSelection();
            
            showSuccessMessage(`Added ${editRecipeSelectedIngredient.name} to recipe`);
        }

        // Add ingredient row to edit form
        function addEditIngredient() {
            const container = document.getElementById('editIngredientsContainer');
            const index = container.children.length;
            addEditIngredientRow('', '', index);
        }

        // Add ingredient row with specific values
        function addEditIngredientRow(ingredientName, quantity, index) {
            const container = document.getElementById('editIngredientsContainer');
            
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'flex space-x-3 items-center';
            ingredientRow.innerHTML = `
                <select class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onchange="updateEditNutrition()" required>
                    <option value="">Select ingredient...</option>
                    ${Object.keys(rawIngredients).map(name =>
                        `<option value="${name}" ${name === ingredientName ? 'selected' : ''}>${name}</option>`
                    ).join('')}
                </select>
                <input type="number" placeholder="Quantity (g)" min="0" step="0.1"
                       value="${quantity}"
                       class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       onchange="updateEditNutrition()" required>
                <button type="button" onclick="removeEditIngredient(this)"
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg">
                    ‚úï
                </button>
            `;
            
            container.appendChild(ingredientRow);
        }

        // Remove ingredient row from edit form
        function removeEditIngredient(button) {
            button.parentElement.remove();
            updateEditNutrition();
        }

        // Update nutrition display in edit form
        function updateEditNutrition() {
            const container = document.getElementById('editIngredientsContainer');
            const servings = parseInt(document.getElementById('editRecipeServings').value) || 1;
            
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
            
            Array.from(container.children).forEach(row => {
                const select = row.querySelector('select');
                const input = row.querySelector('input');
                
                const ingredientName = select.value;
                const quantity = parseFloat(input.value) || 0;
                
                if (ingredientName && quantity > 0) {
                    const ingredient = rawIngredients[ingredientName];
                    if (ingredient) {
                        const multiplier = quantity / 100;
                        totalCalories += (ingredient.calories || 0) * multiplier;
                        totalProtein += (ingredient.protein || 0) * multiplier;
                        totalCarbs += (ingredient.carbs || 0) * multiplier;
                        totalFat += (ingredient.fat || 0) * multiplier;
                    }
                }
            });
            
            // Update display (per serving)
            document.getElementById('editCalories').textContent = Math.round(totalCalories / servings);
            document.getElementById('editProtein').textContent = Math.round(totalProtein / servings);
            document.getElementById('editCarbs').textContent = Math.round(totalCarbs / servings);
            document.getElementById('editFat').textContent = Math.round(totalFat / servings);
        }

        // Handle edit form submission
        document.getElementById('editRecipeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentEditingRecipe) {
                alert('No recipe selected for editing!');
                return;
            }
            
            const newRecipeName = document.getElementById('editRecipeName').value.trim();
            const servings = parseInt(document.getElementById('editRecipeServings').value) || 1;
            
            if (!newRecipeName) {
                alert('Please enter a recipe name!');
                return;
            }
            
            // Collect ingredients from both old format (select/input) and new format (hidden inputs)
            const container = document.getElementById('editIngredientsContainer');
            const ingredients = [];
            
            Array.from(container.children).forEach(row => {
                let ingredientName = '';
                let quantity = 0;
                
                // Check for new format (hidden inputs with added ingredients)
                const hiddenInputs = row.querySelectorAll('input[type="hidden"]');
                if (hiddenInputs.length >= 2) {
                    ingredientName = hiddenInputs[0].value;
                    quantity = parseFloat(hiddenInputs[1].value) || 0;
                } else {
                    // Check for old format (select and quantity input)
                    const select = row.querySelector('select');
                    const input = row.querySelector('input[type="number"]');
                    
                    if (select && input) {
                        ingredientName = select.value;
                        quantity = parseFloat(input.value) || 0;
                    }
                }
                
                if (ingredientName && quantity > 0) {
                    ingredients.push({
                        name: ingredientName,
                        quantity: quantity
                    });
                }
            });
            
            if (ingredients.length === 0) {
                alert('Please add at least one ingredient!');
                return;
            }
            
            // Save updated recipe
            const customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
            
            // If recipe name changed, delete old entry
            if (currentEditingRecipe !== newRecipeName) {
                delete customRecipes[currentEditingRecipe];
            }
            
            // Save new/updated recipe
            customRecipes[newRecipeName] = {
                ingredients: ingredients,
                servings: servings,
                lastModified: new Date().toISOString()
            };
            
            localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
            
            // Close modal and refresh list
            closeRecipeEditModal();
            loadRecipeList();
            
            showSuccessMessage(`Recipe "${newRecipeName}" updated successfully!`);
        });

        // Delete recipe with confirmation
        function deleteRecipeConfirm(recipeName) {
            if (confirm(`Are you sure you want to delete the recipe "${recipeName}"? This action cannot be undone.`)) {
                const customRecipes = JSON.parse(localStorage.getItem('customRecipes') || '{}');
                delete customRecipes[recipeName];
                localStorage.setItem('customRecipes', JSON.stringify(customRecipes));
                loadRecipeList();
                alert(`Recipe "${recipeName}" deleted successfully!`);
            }
        }

        // Update existing editRecipe function to use new popup
        function editRecipe(recipeName) {
            // Close any open modals first
            closeUnifiedAddModal();
            
            // Open the recipe edit modal instead of loading into create recipe tab
            openRecipeEditModal(recipeName);
        }

        // ========================================
        // DIAGNOSTIC EXECUTION AND INITIALIZATION
        // ========================================
        
        // Make diagnostic functions available globally for manual testing
        window.testExportButton = testExportButton;
        window.testExportFlow = testExportFlow;

        // Test function for modal layering
        window.testModalLayering = function() {
            console.log('üß™ Testing Modal Layering...');
            
            const unifiedModal = document.getElementById('unifiedAddModal');
            const recipeEditModal = document.getElementById('recipeEditModal');
            
            if (unifiedModal && recipeEditModal) {
                const unifiedZIndex = window.getComputedStyle(unifiedModal).zIndex;
                const recipeZIndex = window.getComputedStyle(recipeEditModal).zIndex;
                
                console.log('Unified Modal z-index:', unifiedZIndex);
                console.log('Recipe Edit Modal z-index:', recipeZIndex);
                
                if (parseInt(recipeZIndex) > parseInt(unifiedZIndex)) {
                    console.log('Modal Layering: ‚úÖ Recipe edit modal will appear above unified modal');
                } else {
                    console.log('Modal Layering: ‚ö†Ô∏è Check z-index values');
                }
            } else {
                console.log('Modal Layering: ‚ùå One or both modals not found');
            }
        };
        
        // Test function for race condition preservation
        window.testRaceConditionHandling = function() {
            console.log('üß™ Testing Race Condition Handling...');
            
            // Check if openRecipeEditModal has proper validation
            const openRecipeEditModalStr = openRecipeEditModal.toString();
            
            const hasDbValidation = openRecipeEditModalStr.includes('!rawIngredients || Object.keys(rawIngredients).length === 0');
            const hasRetryMechanism = openRecipeEditModalStr.includes('loadDatabases().then');
            
            console.log('Database Validation Check:', hasDbValidation ? '‚úÖ Present' : '‚ùå Missing');
            console.log('Retry Mechanism:', hasRetryMechanism ? '‚úÖ Present' : '‚ùå Missing');

            console.log('üß™ Race Condition Handling Test Complete!');
        };
        
        // Auto-run diagnostics when page loads (after a delay to ensure everything is initialized)
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('üîß AUTO_DIAGNOSTIC: Running automatic export button diagnostics...');
                console.log('üîß AUTO_DIAGNOSTIC: You can also manually run:');
                console.log('üîß AUTO_DIAGNOSTIC: - testExportButton() - Test button functionality');
                console.log('üîß AUTO_DIAGNOSTIC: - testExportFlow() - Test complete export flow');
                console.log('üîß AUTO_DIAGNOSTIC: - testModalLayering() - Test modal z-index layering');
                console.log('üîß AUTO_DIAGNOSTIC: - testRaceConditionHandling() - Test race condition preservation');
                
                // Run automatic diagnostic
                const autoTestResults = testExportButton();
                
                // Provide user-friendly feedback
                if (autoTestResults.buttonClickable && autoTestResults.functionExists) {
                    console.log('‚úÖ AUTO_DIAGNOSTIC: Export button appears to be working correctly');
                } else {
                    console.log('‚ö†Ô∏è AUTO_DIAGNOSTIC: Export button issues detected - check console for details');
                }
            }, 2000); // Wait 2 seconds for full initialization
        });
        */
    </script>

    <script>
        // Define AI Assistant toggle and helper functions BEFORE the button loads
        let aiPanelOpen = false;
        
        function syncAIDate() {
            const mainDate = document.getElementById('dateSelector');
            const aiDate = document.getElementById('aiDateSelector');
            if (mainDate && aiDate) {
                aiDate.value = mainDate.value;
            }
        }
        
        function toggleAIAssistant() {
            const panel = document.getElementById('aiAssistantPanel');
            const badge = document.getElementById('aiNotificationBadge');
            aiPanelOpen = !aiPanelOpen;
            
            if (aiPanelOpen) {
                panel.style.display = 'block';
                if (badge) badge.style.display = 'none';
                syncAIDate();
            } else {
                panel.style.display = 'none';
            }
        }
        // Ensure global access when CSP or scoping interferes
        window.toggleAIAssistant = toggleAIAssistant;
    </script>

    <!-- AI Assistant Floating Button -->
    <button id="aiAssistantBtn" onclick="toggleAIAssistant()" class="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-full p-4 shadow-2xl transition-all duration-300 hover:scale-110 z-[100]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" id="aiNotificationBadge" style="display: none;">!</span>
    </button>

    <!-- AI Assistant Chat Panel -->
    <div id="aiAssistantPanel" class="fixed bottom-24 right-6 w-96 bg-white rounded-2xl shadow-2xl overflow-hidden z-[100]" style="display: none; max-height: 600px;">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                <h3 class="font-bold text-lg">AI Nutrition Assistant</h3>
            </div>
            <button onclick="toggleAIAssistant()" class="hover:bg-white/20 rounded-full p-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Date Selector for AI -->
        <div class="bg-gray-50 p-3 border-b">
            <div class="flex items-center space-x-2 mb-2">
                <label class="text-xs font-semibold text-gray-600">Analyze Date:</label>
                <input type="date" id="aiDateSelector" class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button onclick="syncAIDate()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition-colors">
                    Use Main Date
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-gray-50 p-3 border-b">
            <div class="flex flex-wrap gap-2">
                <button onclick="analyzeSelectedDate()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-full text-sm transition-colors">
                    üìä Analyze Date
                </button>
                <button onclick="syncLocalStorageToDatabase()" class="bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-full text-sm transition-colors">
                    üîÑ Sync Data
                </button>
                <button onclick="viewDailySummary()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded-full text-sm transition-colors">
                    üìã View All Days
                </button>
                <button onclick="getWeeklyProgress()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm transition-colors">
                    üìà Weekly
                </button>
                <button onclick="getRecommendations()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full text-sm transition-colors">
                    üí° Tips
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="aiChatMessages" class="overflow-y-auto p-4 space-y-3" style="height: 320px;">
            <!-- Info message -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-3 rounded-lg">
                <p class="text-sm text-gray-700">
                    üëã Hi! Use the quick actions above to analyze a date, view weekly trends, or see your 14-day summary.
                </p>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="aiLoadingIndicator" class="px-4 py-2" style="display: none;">
            <div class="flex items-center space-x-2 text-gray-500">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600"></div>
                <span class="text-sm">Analyzing...</span>
            </div>
        </div>

        <!-- Chat Input removed by request -->
    </div>

    <!-- AI Assistant Scripts -->
    <script>
        // Note: aiPanelOpen, toggleAIAssistant, and syncAIDate are already defined earlier

        // Helper to retrieve meals-by-date from localStorage, preferring the standardized key
        function getMealsByDateStorage() {
            try {
                const primary = localStorage.getItem('indianFoodMealsByDate');
                if (primary) return JSON.parse(primary);
                const legacy = localStorage.getItem('mealsByDate');
                if (legacy) return JSON.parse(legacy);
            } catch (e) {
                console.warn('AI: Failed parsing mealsByDate storage', e);
            }
            return {};
        }

        function addAIMessage(message, type = 'assistant') {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            
            if (type === 'assistant') {
                messageDiv.className = 'bg-gradient-to-r from-purple-50 to-blue-50 p-3 rounded-lg';
                messageDiv.innerHTML = `<div class="text-sm text-gray-700">${message}</div>`;
            } else if (type === 'user') {
                messageDiv.className = 'bg-gray-100 p-3 rounded-lg ml-8';
                messageDiv.innerHTML = `<div class="text-sm text-gray-700">${message}</div>`;
            } else if (type === 'success') {
                messageDiv.className = 'bg-green-50 p-3 rounded-lg border-l-4 border-green-500';
                messageDiv.innerHTML = `<div class="text-sm text-green-700">${message}</div>`;
            } else if (type === 'warning') {
                messageDiv.className = 'bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-500';
                messageDiv.innerHTML = `<div class="text-sm text-yellow-700">${message}</div>`;
            } else if (type === 'info') {
                messageDiv.className = 'bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500';
                messageDiv.innerHTML = `<div class="text-sm text-blue-700">${message}</div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showAILoading(show) {
            document.getElementById('aiLoadingIndicator').style.display = show ? 'block' : 'none';
        }

        // Chat removed by request: input and message parsing handlers deleted

        function analyzeSelectedDate() {
            const date = document.getElementById('aiDateSelector').value;
            
            if (!date) {
                addAIMessage('‚ö†Ô∏è Please select a date first!', 'warning');
                return;
            }
            
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            addAIMessage(`Analyzing meals for ${date}...`, 'user');
            showAILoading(true);
            
            analyzeDate(date);
        }

        async function analyzeDate(date) {
            
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            showAILoading(true);
            
            try {
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date })
                });
                
                const analysis = await response.json();
                showAILoading(false);
                
                // Check if there's no meal data
                const summary = analysis.summary;
                if (summary.meal_count === 0) {
                    addAIMessage(`üì≠ <strong>No meals logged for ${date}</strong><br><br>There are no meals recorded for this date. Try selecting a different date or add some meals first!`, 'warning');
                    return;
                }
                
                // Display summary
                let summaryHTML = `<strong>üìä Daily Summary for ${date}</strong><br><br>`;
                summaryHTML += `üî• Calories: ${Math.round(summary.total_calories)} kcal<br>`;
                summaryHTML += `üí™ Protein: ${Math.round(summary.total_protein)}g<br>`;
                summaryHTML += `üåæ Carbs: ${Math.round(summary.total_carbs)}g<br>`;
                summaryHTML += `ü•ë Fat: ${Math.round(summary.total_fat)}g<br>`;
                summaryHTML += `üå± Fiber: ${Math.round(summary.total_fiber)}g<br>`;
                summaryHTML += `üçΩÔ∏è Meals logged: ${summary.meal_count}`;
                
                addAIMessage(summaryHTML, 'info');
                
                // Display macro breakdown
                if (analysis.macroBreakdown) {
                    const macro = analysis.macroBreakdown;
                    let macroHTML = `<strong>üéØ Macro Distribution</strong><br><br>`;
                    macroHTML += `Protein: ${macro.protein.percent}% (${macro.protein.grams}g)<br>`;
                    macroHTML += `Carbs: ${macro.carbs.percent}% (${macro.carbs.grams}g)<br>`;
                    macroHTML += `Fat: ${macro.fat.percent}% (${macro.fat.grams}g)`;
                    
                    addAIMessage(macroHTML, 'info');
                }
                
                // Display insights
                if (analysis.insights && analysis.insights.length > 0) {
                    analysis.insights.forEach(insight => {
                        addAIMessage(`‚úÖ ${insight.message}`, 'success');
                    });
                }
                
                // Display suggestions
                if (analysis.suggestions && analysis.suggestions.length > 0) {
                    addAIMessage('<strong>üí° Suggestions for Improvement:</strong>', 'assistant');
                    analysis.suggestions.forEach(suggestion => {
                        const type = suggestion.type === 'warning' ? 'warning' : 'info';
                        addAIMessage(`<strong>${suggestion.message}</strong><br><br>üí° ${suggestion.recommendation}`, type);
                    });
                } else {
                    addAIMessage('üéâ Great job! Your nutrition looks well-balanced today.', 'success');
                }
                
            } catch (error) {
                showAILoading(false);
                console.error('Error analyzing today:', error);
                addAIMessage('‚ùå Sorry, I couldn\'t analyze your data. Please try again.', 'warning');
            }
        }

        async function syncLocalStorageToDatabase() {
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            addAIMessage('Syncing localStorage data to database...', 'user');
            showAILoading(true);
            
            try {
                // Get meals from localStorage
                const localMeals = JSON.parse(localStorage.getItem('mealsByDate') || '{}');
                
                if (Object.keys(localMeals).length === 0) {
                    showAILoading(false);
                    addAIMessage('üì≠ No data found in localStorage to sync.', 'info');
                    return;
                }
                
                let synced = 0;
                let failed = 0;
                
                // Send each meal to the database
                for (const [date, meals] of Object.entries(localMeals)) {
                    for (const meal of meals) {
                        try {
                            const response = await fetch('/api/meals', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ date, meal })
                            });
                            
                            if (response.ok) {
                                synced++;
                            } else {
                                failed++;
                            }
                        } catch (error) {
                            console.error(`Failed to sync meal ${meal.id}:`, error);
                            failed++;
                        }
                    }
                }
                
                showAILoading(false);
                
                if (synced > 0) {
                    addAIMessage(`‚úÖ Successfully synced ${synced} meal(s) to database!${failed > 0 ? ` (${failed} failed)` : ''}`, 'success');
                    addAIMessage('üí° Now you can use AI analysis on all your data!', 'info');
                } else {
                    addAIMessage(`‚ö†Ô∏è Sync failed. ${failed} meal(s) could not be synced. Make sure the server is running.`, 'warning');
                }
                
            } catch (error) {
                showAILoading(false);
                console.error('Sync error:', error);
                addAIMessage('‚ùå Sync failed: ' + error.message, 'warning');
            }
        }

        async function viewDailySummary() {
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            addAIMessage('Fetching your daily summaries...', 'user');
            showAILoading(true);
            
            try {
                // Get last 14 days
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 13);
                
                const response = await fetch(`/api/analytics/weekly?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`);
                const summaries = await response.json();
                showAILoading(false);
                
                if (summaries.length === 0) {
                    addAIMessage('üì≠ No meal data found for the past 14 days.', 'info');
                    return;
                }
                
                // Create a table view
                let tableHTML = '<strong>üìÖ Last 14 Days Summary</strong><br><br>';
                tableHTML += '<div style="max-height: 300px; overflow-y: auto; font-size: 11px;">';
                tableHTML += '<table style="width: 100%; border-collapse: collapse;">';
                tableHTML += '<thead><tr style="background: #f3f4f6; position: sticky; top: 0;">';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Date</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Meals</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Cals</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Pro</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Carbs</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Fat</th>';
                tableHTML += '<th style="padding: 4px; border: 1px solid #ddd;">Fiber</th>';
                tableHTML += '</tr></thead><tbody>';
                
                summaries.reverse().forEach(day => {
                    const date = new Date(day.date + 'T00:00:00');
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    tableHTML += '<tr style="border-bottom: 1px solid #eee;">';
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd;"><strong>${dateStr}</strong></td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: center;">${day.meal_count}</td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${Math.round(day.total_calories)}</td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${Math.round(day.total_protein)}g</td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${Math.round(day.total_carbs)}g</td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${Math.round(day.total_fat)}g</td>`;
                    tableHTML += `<td style="padding: 4px; border: 1px solid #ddd; text-align: right;">${Math.round(day.total_fiber)}g</td>`;
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                tableHTML += '<br><small style="color: #666;">üí° Click on a date in the main page to see meal details</small>';
                
                addAIMessage(tableHTML, 'info');
                
            } catch (error) {
                showAILoading(false);
                console.error('Error fetching daily summaries:', error);
                addAIMessage('‚ùå Failed to fetch daily summaries.', 'warning');
            }
        }

        async function getWeeklyProgress() {
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            addAIMessage('Analyzing your weekly progress...', 'user');
            showAILoading(true);
            
            try {
                const response = await fetch('/api/ai/weekly-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const progress = await response.json();
                showAILoading(false);
                
                if (!progress.hasData) {
                    addAIMessage('üì≠ No data available for the past week. Start logging your meals to see weekly trends!', 'info');
                    return;
                }
                
                // Display averages
                let avgHTML = `<strong>üìà 7-Day Average</strong><br><br>`;
                avgHTML += `üî• Calories: ${progress.averages.calories} kcal/day<br>`;
                avgHTML += `üí™ Protein: ${progress.averages.protein}g/day<br>`;
                avgHTML += `üåæ Carbs: ${progress.averages.carbs}g/day<br>`;
                avgHTML += `ü•ë Fat: ${progress.averages.fat}g/day<br>`;
                avgHTML += `üå± Fiber: ${progress.averages.fiber}g/day`;
                
                addAIMessage(avgHTML, 'info');
                
                // Display suggestions
                if (progress.suggestions && progress.suggestions.length > 0) {
                    progress.suggestions.forEach(suggestion => {
                        const type = suggestion.type === 'warning' ? 'warning' : 'info';
                        addAIMessage(`<strong>${suggestion.message}</strong><br><br>${suggestion.recommendation}`, type);
                    });
                } else {
                    addAIMessage('‚ú® Excellent! You\'re maintaining consistent nutrition habits.', 'success');
                }
                
            } catch (error) {
                showAILoading(false);
                console.error('Error getting weekly progress:', error);
                addAIMessage('‚ùå Sorry, I couldn\'t retrieve your weekly progress. Please try again.', 'warning');
            }
        }

        async function getRecommendations() {
            if (!aiPanelOpen) {
                toggleAIAssistant();
            }
            
            addAIMessage('Getting nutrition tips...', 'user');
            
            const tips = [
                '<strong>ü•ó Eat the Rainbow</strong><br>Include a variety of colorful vegetables and fruits in your meals. Different colors provide different nutrients!',
                '<strong>üíß Stay Hydrated</strong><br>Drink at least 8 glasses of water daily. Proper hydration supports digestion and nutrient absorption.',
                '<strong>ü•ú Protein Power</strong><br>Include protein in every meal. It helps with satiety, muscle maintenance, and stable blood sugar levels.',
                '<strong>üåæ Choose Whole Grains</strong><br>Opt for whole grains like brown rice, quinoa, and whole wheat over refined grains for better fiber and nutrients.',
                '<strong>‚è∞ Consistent Timing</strong><br>Try to eat meals at regular times. This helps regulate your metabolism and energy levels.',
                '<strong>üçΩÔ∏è Portion Awareness</strong><br>Use smaller plates and bowls to naturally control portion sizes without feeling deprived.',
                '<strong>ü•ó Fiber First</strong><br>Start meals with vegetables or salads. Fiber helps with digestion and keeps you feeling full longer.',
                '<strong>üå∞ Healthy Fats</strong><br>Include sources of healthy fats like nuts, seeds, avocado, and olive oil for better nutrient absorption.'
            ];
            
            // Select 3 random tips
            const selectedTips = [];
            const tipIndices = new Set();
            while (tipIndices.size < 3) {
                tipIndices.add(Math.floor(Math.random() * tips.length));
            }
            
            tipIndices.forEach(index => {
                addAIMessage(tips[index], 'info');
            });
        }

        // Show notification badge for new insights
        function showAINotification() {
            const badge = document.getElementById('aiNotificationBadge');
            if (!aiPanelOpen) {
                badge.style.display = 'flex';
            }
        }
        
        // Sync all localStorage meals to database
        async function syncAllToDatabase() {
            const button = document.getElementById('syncButton');
            const originalHTML = button.innerHTML;
            
            button.innerHTML = '<div class="text-center"><div class="text-2xl mb-1">‚è≥</div><div class="font-semibold text-lg">Syncing...</div></div>';
            button.disabled = true;
            
            try {
                let syncedCount = 0;
                let totalMeals = 0;
                
                // Count total meals
                for (const date in mealsByDate) {
                    totalMeals += mealsByDate[date].length;
                }
                
                // Sync all meals
                for (const date in mealsByDate) {
                    for (const meal of mealsByDate[date]) {
                        try {
                            const response = await fetch('/api/meals', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ date, meal })
                            });
                            
                            if (response.ok) {
                                syncedCount++;
                            }
                        } catch (error) {
                            console.warn('Failed to sync meal:', meal.id);
                        }
                    }
                }
                
                button.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">‚úÖ</div><div class="font-semibold text-lg">Synced ${syncedCount}/${totalMeals}</div></div>`;
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 3000);
                
                console.log(`‚úÖ Synced ${syncedCount} meals to database`);
                
                // Show notification in AI assistant
                if (syncedCount > 0) {
                    showAINotification();
                }
                
            } catch (error) {
                console.error('Sync failed:', error);
                button.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">‚ùå</div><div class="font-semibold text-lg">Sync Failed</div></div>`;
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 3000);
            }
        }

        // Auto-analyze when a new meal is added
        const originalAddMealToDate = window.addMealToDate;
        if (typeof originalAddMealToDate === 'function') {
            window.addMealToDate = function(...args) {
                const result = originalAddMealToDate.apply(this, args);
                // Show notification after meal is added
                setTimeout(() => {
                    showAINotification();
                }, 1000);
                return result;
            };
        }
        
        // Initialize AI assistant button - no DOMContentLoaded needed as button is already in DOM
        (function() {
            console.log('üîç AI Assistant initialization starting...');
            const aiBtn = document.getElementById('aiAssistantBtn');
            console.log('üîç Button element:', aiBtn);
            console.log('üîç toggleAIAssistant function exists:', typeof toggleAIAssistant);
            
            if (aiBtn) {
                aiBtn.addEventListener('click', function(e) {
                    console.log('üîç Button clicked!', e);
                    toggleAIAssistant();
                });
                console.log('‚úÖ AI Assistant button initialized');
                
                // Test if it's actually clickable
                console.log('üîç Button styles:', window.getComputedStyle(aiBtn).display);
                console.log('üîç Button position:', aiBtn.getBoundingClientRect());
            } else {
                console.error('‚ùå AI Assistant button not found');
            }
        })();
    </script>

</body>
</html>